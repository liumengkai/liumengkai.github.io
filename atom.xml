<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Liu&#39;s blog</title>
  
  <subtitle>ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€</subtitle>
  <link href="http://example.com/atom.xml" rel="self"/>
  
  <link href="http://example.com/"/>
  <updated>2022-10-05T13:54:00.145Z</updated>
  <id>http://example.com/</id>
  
  <author>
    <name>Super Pikachu</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Hadoopæäº¤ä»»åŠ¡åˆ°Yarnæµç¨‹æºç å­¦ä¹ åˆ†æ</title>
    <link href="http://example.com/2022/10/02/Hadoop%E6%8F%90%E4%BA%A4%E4%BB%BB%E5%8A%A1%E5%88%B0Yarn%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    <id>http://example.com/2022/10/02/Hadoop%E6%8F%90%E4%BA%A4%E4%BB%BB%E5%8A%A1%E5%88%B0Yarn%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/</id>
    <published>2022-10-02T15:36:36.000Z</published>
    <updated>2022-10-05T13:54:00.145Z</updated>
    
    <content type="html"><![CDATA[<p>Talk is cheap show me the code!</p><span id="more"></span><h1 id="Hadoop-å‘-yarn-æäº¤ä»»åŠ¡æ•´ä½“æµç¨‹"><a href="#Hadoop-å‘-yarn-æäº¤ä»»åŠ¡æ•´ä½“æµç¨‹" class="headerlink" title="Hadoop å‘ yarn æäº¤ä»»åŠ¡æ•´ä½“æµç¨‹"></a>Hadoop å‘ yarn æäº¤ä»»åŠ¡æ•´ä½“æµç¨‹</h1><p>æ€»ä½“æµç¨‹ï¼š</p><p>1ï¼‰ä½œä¸šæäº¤</p><p>ç¬¬ 1 æ­¥ï¼šClient è°ƒç”¨ job.waitForCompletion æ–¹æ³•ï¼Œå‘æ•´ä¸ªé›†ç¾¤æäº¤ MapReduce ä½œä¸šã€‚</p><p>ç¬¬ 2 æ­¥ï¼šClient å‘ RM ç”³è¯·ä¸€ä¸ªä½œä¸š idã€‚</p><p>ç¬¬ 3 æ­¥ï¼šRM ç»™ Client è¿”å›è¯¥ job èµ„æºçš„æäº¤è·¯å¾„å’Œä½œä¸š idã€‚</p><p>ç¬¬ 4 æ­¥ï¼šClient æäº¤ jar åŒ…ã€åˆ‡ç‰‡ä¿¡æ¯å’Œé…ç½®æ–‡ä»¶åˆ°æŒ‡å®šçš„èµ„æºæäº¤è·¯å¾„ã€‚</p><p>ç¬¬ 5 æ­¥ï¼šClient æäº¤å®Œèµ„æºåï¼Œå‘ RM ç”³è¯·è¿è¡Œ MrAppMasterã€‚</p><p>2ï¼‰ä½œä¸šåˆå§‹åŒ–</p><p>ç¬¬ 6 æ­¥ï¼šå½“ RM æ”¶åˆ° Client çš„è¯·æ±‚åï¼Œå°†è¯¥ job æ·»åŠ åˆ°å®¹é‡è°ƒåº¦å™¨ä¸­ã€‚</p><p>ç¬¬ 7 æ­¥ï¼šæŸä¸€ä¸ªç©ºé—²çš„ NM é¢†å–åˆ°è¯¥ Jobã€‚</p><p>ç¬¬ 8 æ­¥ï¼šè¯¥ NM åˆ›å»º Containerï¼Œå¹¶äº§ç”Ÿ MRAppmasterã€‚</p><p>ç¬¬ 9 æ­¥ï¼šä¸‹è½½Client æäº¤çš„èµ„æºåˆ°æœ¬åœ°ã€‚</p><p>3ï¼‰ä»»åŠ¡åˆ†é…</p><p>ç¬¬ 10 æ­¥ï¼šMrAppMaster å‘ RM ç”³è¯·è¿è¡Œå¤šä¸ª MapTask ä»»åŠ¡èµ„æºã€‚</p><p>ç¬¬ 11 æ­¥ï¼šRM å°†è¿è¡Œ MapTask ä»»åŠ¡åˆ†é…ç»™å¦å¤–ä¸¤ä¸ªNodeManagerï¼Œå¦ä¸¤ä¸ª NodeManageråˆ†åˆ«é¢†å–ä»»åŠ¡å¹¶</p><p>åˆ›å»ºå®¹å™¨ã€‚</p><p>4ï¼‰ä»»åŠ¡è¿è¡Œ</p><p>ç¬¬ 12 æ­¥ï¼šMRå‘ä¸¤ä¸ªæ¥æ”¶åˆ°ä»»åŠ¡çš„NodeManagerå‘é€ç¨‹åºå¯åŠ¨è„šæœ¬ï¼Œè¿™ä¸¤ä¸ªNodeManageråˆ†åˆ«å¯åŠ¨</p><p>MapTaskï¼ŒMapTask å¯¹æ•°æ®åˆ†åŒºæ’åºã€‚</p><p>ç¬¬13 æ­¥ï¼šMrAppMaster ç­‰å¾…æ‰€æœ‰MapTask è¿è¡Œå®Œæ¯•åï¼Œå‘RM ç”³è¯·å®¹å™¨ï¼Œè¿è¡ŒReduceTaskã€‚</p><p>ç¬¬ 14 æ­¥ï¼šReduceTask å‘ MapTask è·å–ç›¸åº”åˆ†åŒºçš„æ•°æ®ã€‚</p><p>ç¬¬ 15 æ­¥ï¼šç¨‹åºè¿è¡Œå®Œæ¯•åï¼ŒMR ä¼šå‘ RM ç”³è¯·æ³¨é”€è‡ªå·±ã€‚</p><h2 id="ä»£ç è§£æ"><a href="#ä»£ç è§£æ" class="headerlink" title="ä»£ç è§£æ"></a>ä»£ç è§£æ</h2><p>ä»£ç ä¸­çš„æ•´ä½“æµç¨‹:</p><p>ä¸‹é¢æ¶‰åŠåˆ°çš„ç±»/æ¥å£ä¹‹é—´å…³ç³»</p><img src="/2022/10/02/Hadoop%E6%8F%90%E4%BA%A4%E4%BB%BB%E5%8A%A1%E5%88%B0Yarn%E6%B5%81%E7%A8%8B%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/class.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>Job.waitForCompletion() -&gt; Job.submit()  -&gt; Job.connect() -&gt; Cluster.Cluster() -&gt; Cluster.initialize() -&gt; YarnClientProtocolProvider.create() -&gt; JobSubmitter.sbumitJobInternal() -&gt; YARNRunner.submitJob() -&gt; ResourceMgrDelegate.submitApplication() -&gt; YarnClientImpl.submitApplication() -&gt; ApplicationClientProtocolPBClientImpl.submitApplication() -&gt; ApplicationClientProtocolPBServiceImpl.submitApplication() -&gt; ClientRMService.submitApplication() -&gt; RMAppManager.submitApplication()</p><p>(1)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é¦–å…ˆè°ƒç”¨waitForCompletionå¯åŠ¨ä»»åŠ¡</span></span><br><span class="line">JobClient.java:</span><br><span class="line"></span><br><span class="line">JobClient.waitForCompletion()</span><br></pre></td></tr></table></figure><p>(2)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// waitForCompletionæ–¹æ³•ä¸­è°ƒç”¨submit</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">waitForCompletion</span><span class="params">(<span class="keyword">boolean</span> verbose</span></span></span><br><span class="line"><span class="params"><span class="function">                                   )</span> <span class="keyword">throws</span> IOException, InterruptedException,</span></span><br><span class="line"><span class="function">                                            ClassNotFoundException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (state == JobState.DEFINE) &#123;</span><br><span class="line">      submit();</span><br><span class="line">...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Submit the job to the cluster and return immediately.</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submit</span><span class="params">()</span> </span></span><br><span class="line"><span class="function">         <span class="keyword">throws</span> IOException, InterruptedException, ClassNotFoundException </span>&#123;</span><br><span class="line">    </span><br><span class="line">ensureState(JobState.DEFINE);</span><br><span class="line">    setUseNewAPI();</span><br><span class="line"><span class="comment">// è¿™é‡Œçš„connectorä¼š ç¡®è®¤ å­˜åœ¨clusterå¯¹è±¡ï¼Œè€Œclusterå¯¹è±¡çš„ä¸»è¦ä½œç”¨æ˜¯:Provides a way to access information about the map/reduce cluster.æ˜¯æˆ‘ä»¬è®¿é—®map/reduceé›†ç¾¤çš„ä¸»è¦é€”å¾„</span></span><br><span class="line"><span class="comment">// åœ¨Cluster.initialze()æ–¹æ³•ä¸­æ ¹æ®providerListæˆ‘ä»¬åˆ›å»ºå¯¹åº”çš„clusterå¯¹è±¡ï¼Œmapreduce.framework.nameå‚æ•°æ¥ç¡®å®šä½ çš„Jobé‡‡ç”¨å“ªç±»åº”ç”¨ï¼Œæœ‰Localå’ŒYarnä¸¤ç§æ¨¡å¼ï¼ŒYarnä»»åŠ¡å¯¹åº”çš„YarnClientProtocolProviderï¼Œå„è‡ªçš„åº”ç”¨åªéœ€è¦å®ç°ç›¸åº”çš„æ¥å£å°±å¯ä»¥æŠŠè‡ªå·±çš„Jobè¿è¡Œåœ¨Yarnä¸Šï¼Œåœ¨YarnClientProtocolProvider.create()æ–¹æ³•ä¸­åˆ›å»ºäº†resMgrDelegate(ResourceMgrDelegate) åœ¨åˆ›å»ºresMgrDelegateçš„æ—¶å€™ä¼šåˆ›å»ºå…¶ç±»å˜é‡clientä¹Ÿå°±æ˜¯YarnClientImplï¼Œè€Œæˆ‘ä»¬æœ€ç»ˆæäº¤ä»»åŠ¡å°±æ˜¯é€šè¿‡YarnClientImpl.submitApplication()æ–¹æ³•æäº¤ã€‚</span></span><br><span class="line">    connect();</span><br><span class="line"></span><br><span class="line"><span class="comment">//åˆ›å»ºsubmitterå¯¹è±¡ ç„¶åç”±submitClientå¯¹è±¡è°ƒç”¨submitJobInternal</span></span><br><span class="line">    <span class="keyword">final</span> JobSubmitter submitter = </span><br><span class="line">        getJobSubmitter(cluster.getFileSystem(), cluster.getClient());</span><br><span class="line">    status = ugi.doAs(<span class="keyword">new</span> PrivilegedExceptionAction&lt;JobStatus&gt;() &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="function"><span class="keyword">public</span> JobStatus <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException,ClassNotFoundException </span></span><br><span class="line"><span class="function">      </span>&#123;</span><br><span class="line">          <span class="comment">//submitJobInternalè¿™ä¸ªæ–¹æ³•éœ€è¦æ³¨æ„</span></span><br><span class="line">        <span class="keyword">return</span> submitter.submitJobInternal(Job.<span class="keyword">this</span>, cluster);</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">    &#125;);</span><br><span class="line">    state = JobState.RUNNING;</span><br><span class="line">    LOG.info(<span class="string">&quot;The url to track the job: &quot;</span> + getTrackingURL());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// submitJobInternalæ–¹æ³•ä¸­:</span></span><br><span class="line"><span class="comment">// è®¾ç½®jobid,clientåº”è¯¥ä¸Šä¼ èµ„æºçš„è·¯å¾„ï¼Œé˜Ÿåˆ—ç­‰ä¿¡æ¯</span></span><br><span class="line"><span class="comment">// copyAndConfigureFilesæ–¹æ³• å°†jaråŒ…ä¸Šä¼ åˆ°é›†ç¾¤ä¸­ </span></span><br><span class="line"><span class="comment">// writeSplits å°†åˆ‡ç‰‡ä¿¡æ¯ä¸Šä¼ </span></span><br><span class="line"><span class="comment">// writeConf å°†é…ç½®æ–‡ä»¶ä¸Šä¼ </span></span><br><span class="line"><span class="comment">// submitClient.submitJob ç”³è¯·å‘resourcemanagerä¸­æäº¤ä¸€ä¸ªä»»åŠ¡ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¥å£æ–¹æ³•ï¼Œå…·ä½“ç”±å®ç°ç±»ä¸­é‡å†™çš„æ–¹æ³•æ¥å®ç°ï¼Œ</span></span><br><span class="line"><span class="comment">// æˆ‘ä»¬å‘Yarnæäº¤ä»»åŠ¡æ‰€ä»¥ç”¨çš„æ˜¯YarnRunnerä¸­çš„submitJob é™¤æ­¤ä¹‹å¤–è¿˜æœ‰LocalJobRunner</span></span><br><span class="line"><span class="function">JobStatus <span class="title">submitJobInternal</span><span class="params">(Job job, Cluster cluster)</span>  <span class="keyword">throws</span> ClassNotFoundException, </span></span><br><span class="line"><span class="function">InterruptedException, IOException </span>&#123;</span><br><span class="line">...</span><br><span class="line">  <span class="comment">//è·å–jobid</span></span><br><span class="line">  JobID jobId = submitClient.getNewJobID();</span><br><span class="line">  job.setJobID(jobId);</span><br><span class="line">  Path submitJobDir = <span class="keyword">new</span> Path(jobStagingArea, jobId.toString());</span><br><span class="line">  JobStatus status = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// è·å–jobèµ„æºåº”è¯¥æäº¤çš„è·¯å¾„</span></span><br><span class="line">    conf.set(MRJobConfig.USER_NAME,</span><br><span class="line">        UserGroupInformation.getCurrentUser().getShortUserName());</span><br><span class="line">    conf.set(<span class="string">&quot;hadoop.http.filter.initializers&quot;</span>, </span><br><span class="line">        <span class="string">&quot;org.apache.hadoop.yarn.server.webproxy.amfilter.AmFilterInitializer&quot;</span>);</span><br><span class="line">    conf.set(MRJobConfig.MAPREDUCE_JOB_DIR, submitJobDir.toString());</span><br><span class="line">    LOG.debug(<span class="string">&quot;Configuring job &quot;</span> + jobId + <span class="string">&quot; with &quot;</span> + submitJobDir </span><br><span class="line">        + <span class="string">&quot; as the submit dir&quot;</span>);</span><br><span class="line">...</span><br><span class="line">copyAndConfigureFiles(job, submitJobDir);</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="comment">// Create the splits for the job</span></span><br><span class="line">LOG.debug(<span class="string">&quot;Creating splits at &quot;</span> + jtFs.makeQualified(submitJobDir));</span><br><span class="line"><span class="keyword">int</span> maps = writeSplits(job, submitJobDir);</span><br><span class="line">conf.setInt(MRJobConfig.NUM_MAPS, maps);</span><br><span class="line">LOG.info(<span class="string">&quot;number of splits:&quot;</span> + maps);</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// æäº¤ä»»åŠ¡ è¿™é‡ŒsubmitClientæ˜¯ClientProtocolæ¥å£ä¸­çš„æ–¹æ³•,ClientProtocolæ¥å£ç±»å®ç°æœ‰LocalJobRunnerå’ŒYARNRunnerï¼Œæ¯«æ— ç–‘é—®æˆ‘ä»¬è¿™é‡Œè°ƒç”¨çš„æ˜¯YARNRunnerä¸­çš„submitJobæ–¹æ³•</span></span><br><span class="line"></span><br><span class="line">status = submitClient.submitJob(</span><br><span class="line">      jobId, submitJobDir.toString(), job.getCredentials());</span><br><span class="line">  <span class="keyword">if</span> (status != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Could not launch job&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (status == <span class="keyword">null</span>) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;Cleaning up the staging area &quot;</span> + submitJobDir);</span><br><span class="line">    <span class="keyword">if</span> (jtFs != <span class="keyword">null</span> &amp;&amp; submitJobDir != <span class="keyword">null</span>)</span><br><span class="line">      jtFs.delete(submitJobDir, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Cluster.javaä¸­ åˆå§‹åŒ–æ–¹æ³•</span></span><br><span class="line"><span class="comment">// è¿™é‡Œåˆå§‹åŒ–é›†ç¾¤æ–¹æ³•ç”¨åˆ°çš„ClientProtocolProvideræ¥å£ä¸­çš„å®ç°ç±»YarnClientProtocolProviderä¸­çš„createæ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(InetSocketAddress jobTrackAddr, Configuration conf)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">  initProviderList();</span><br><span class="line">  <span class="keyword">final</span> IOException initEx = <span class="keyword">new</span> IOException(</span><br><span class="line">      <span class="string">&quot;Cannot initialize Cluster. Please check your configuration for &quot;</span></span><br><span class="line">          + MRConfig.FRAMEWORK_NAME</span><br><span class="line">          + <span class="string">&quot; and the correspond server addresses.&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (jobTrackAddr != <span class="keyword">null</span>) &#123;</span><br><span class="line">    LOG.info(</span><br><span class="line">        <span class="string">&quot;Initializing cluster for Job Tracker=&quot;</span> + jobTrackAddr.toString());</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// æ¥å£ ClientProtocolProvider ClientProtocolæ˜¯å®¢æˆ·ç«¯é€šä¿¡åè®®æä¾›è€… è¿™é‡Œæˆ‘ä»¬æ˜¯å’ŒYarné€šä¿¡æ‰€ä»¥ä½¿ç”¨çš„æ˜¯YarnClientProtocolProvider</span></span><br><span class="line">  <span class="keyword">for</span> (ClientProtocolProvider provider : providerList) &#123;</span><br><span class="line">    LOG.debug(<span class="string">&quot;Trying ClientProtocolProvider : &quot;</span></span><br><span class="line">        + provider.getClass().getName());</span><br><span class="line">    ClientProtocol clientProtocol = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (jobTrackAddr == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">// è¿™é‡Œæ˜¯YarnClientProtocolProviderä¸­çš„createæ–¹æ³•ï¼Œæ³¨æ„createæ–¹æ³•ä¸­åˆ›å»ºäº†ResourceMgrDelegateï¼Œè€ŒResourceMgrDelegateæ˜¯æŠ½è±¡ç±»YarnClientçš„å®ç°ç±»ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬ä¸yarn RMçš„ä¸»è¦é€šä¿¡é€”å¾„å®ç°ç±»ã€‚</span></span><br><span class="line"><span class="comment">// å…¶ä¸­ResourceMgrDelegateçš„ç±»å˜é‡clientæ˜¯YarnClientImplï¼Œåé¢æäº¤ä»»åŠ¡è¿˜æ˜¯ä¼šç”¨åˆ°å…¶ä¸­çš„submitApplicationæ–¹æ³•</span></span><br><span class="line"><span class="comment">// YARNRunnerï¼šThis class enables the current JobClient (0.22 hadoop) to run on YARN.</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">public ResourceMgrDelegate(YarnConfiguration conf) &#123;</span></span><br><span class="line"><span class="comment">    super(ResourceMgrDelegate.class.getName());</span></span><br><span class="line"><span class="comment">    this.conf = conf;</span></span><br><span class="line"><span class="comment">    this.client = YarnClient.createYarnClient(); //è¿™é‡Œçš„clinetæ˜¯YarnClientImpl</span></span><br><span class="line"><span class="comment">    init(conf);</span></span><br><span class="line"><span class="comment">    start();</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* YarnClientProtocolProvider.create()æ–¹æ³•</span></span><br><span class="line"><span class="comment">public ClientProtocol create(Configuration conf) throws IOException &#123;</span></span><br><span class="line"><span class="comment">    if (MRConfig.YARN_FRAMEWORK_NAME.equals(conf.get(MRConfig.FRAMEWORK_NAME))) &#123;</span></span><br><span class="line"><span class="comment">      return new YARNRunner(conf);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">    return null;*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">YARNRunner.YARNRunner()æ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="comment">public YARNRunner(Configuration conf, ResourceMgrDelegate resMgrDelegate,</span></span><br><span class="line"><span class="comment">      ClientCache clientCache) &#123;</span></span><br><span class="line"><span class="comment">    this.conf = conf;</span></span><br><span class="line"><span class="comment">    try &#123;</span></span><br><span class="line"><span class="comment">      this.resMgrDelegate = resMgrDelegate; // resMgrDelegate æ˜¯RMé€šä¿¡ä¸»è¦é€”å¾„</span></span><br><span class="line"><span class="comment">      this.clientCache = clientCache;</span></span><br><span class="line"><span class="comment">      this.defaultFileContext = FileContext.getFileContext(this.conf);</span></span><br><span class="line"><span class="comment">    &#125; catch (UnsupportedFileSystemException ufe) &#123;</span></span><br><span class="line"><span class="comment">      throw new RuntimeException(&quot;Error in instantiating YarnClient&quot;, ufe);</span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">  &#125;*/</span></span><br><span class="line">        clientProtocol = provider.create(conf);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        clientProtocol = provider.create(jobTrackAddr, conf);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (clientProtocol != <span class="keyword">null</span>) &#123;</span><br><span class="line">        clientProtocolProvider = provider;</span><br><span class="line">        client = clientProtocol;</span><br><span class="line">        LOG.debug(<span class="string">&quot;Picked &quot;</span> + provider.getClass().getName()</span><br><span class="line">            + <span class="string">&quot; as the ClientProtocolProvider&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        LOG.debug(<span class="string">&quot;Cannot pick &quot;</span> + provider.getClass().getName()</span><br><span class="line">            + <span class="string">&quot; as the ClientProtocolProvider - returned null protocol&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">final</span> String errMsg = <span class="string">&quot;Failed to use &quot;</span> + provider.getClass().getName()</span><br><span class="line">          + <span class="string">&quot; due to error: &quot;</span>;</span><br><span class="line">      initEx.addSuppressed(<span class="keyword">new</span> IOException(errMsg, e));</span><br><span class="line">      LOG.info(errMsg, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">null</span> == clientProtocolProvider || <span class="keyword">null</span> == client) &#123;</span><br><span class="line">    <span class="keyword">throw</span> initEx;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Clientæäº¤å®Œèµ„æºä¹‹åéœ€è¦å‘RMç”³è¯·MRAppMaster è¿™é‡Œæ˜¯YarnRunnerä¸­submitJobæ–¹æ³•</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JobStatus <span class="title">submitJob</span><span class="params">(JobID jobId, String jobSubmitDir, Credentials ts)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">  </span><br><span class="line">  addHistoryToken(ts);</span><br><span class="line">  </span><br><span class="line"><span class="comment">// createApplicationSubmissionContext å‡†å¤‡å¥½æ‰€æœ‰åˆ›å»ºä¸€ä¸ªMR AMæ‰€éœ€çš„é…ç½®ç­‰ä¿¡æ¯ï¼Œeg:åˆ›å»ºapplicationIdï¼ŒSetup ContainerLaunchContext for AM containerç­‰æ“ä½œ</span></span><br><span class="line">  ApplicationSubmissionContext appContext =</span><br><span class="line">    createApplicationSubmissionContext(conf, jobSubmitDir, ts);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Submit to ResourceManager</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">//resMgrDelegateæ˜¯ResourceMgrDelegateç±»å¯¹è±¡ ä»–è´Ÿè´£å’ŒRMæœåŠ¡é€šä¿¡ï¼Œç»§ç»­è°ƒç”¨ä»–submitApplicationæ–¹æ³•ï¼Œä¼ é€’å‰é¢é…ç½®å¥½çš„ä»»åŠ¡ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒsubmitApplicationè¿™ä¸ªæ–¹æ³•åº•å±‚è°ƒç”¨çš„æ˜¯client.submitApplication(appContext)æ–¹æ³•ï¼Œclientæ˜¯YarnClientæŠ½è±¡ç±»ï¼Œæäº¤ä»»åŠ¡åˆ°Yarnä¼šç”¨åˆ°å®ƒçš„å®ç°ç±»YarnClientImpl.submitApplication()æ–¹æ³•</span></span><br><span class="line">    ApplicationId applicationId =</span><br><span class="line">        resMgrDelegate.submitApplication(appContext);</span><br><span class="line"></span><br><span class="line">    ApplicationReport appMaster = resMgrDelegate</span><br><span class="line">        .getApplicationReport(applicationId);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// YarnClientImpl.java:submitApplication():</span></span><br><span class="line"><span class="comment">// request.setApplicationSubmissionContext(appContext) å°†ä»»åŠ¡ä¸Šä¸‹æ–‡ä¿¡æ¯ä¼ å…¥åˆ°SubmitApplicationRequest request()ä¸­</span></span><br><span class="line"><span class="comment">// rmClient.submitApplication(request) æäº¤ä»»åŠ¡</span></span><br><span class="line"><span class="comment">// rmClientæ˜¯æ¥å£ApplicationClientProtocolï¼ŒsubmitApplicationæ˜¯è¯¥æ¥å£ä¸­çš„æ–¹æ³•ï¼ŒApplicationClientProtocolåè®®è´Ÿè´£çš„å°±æ˜¯Clientå’ŒResourceManagerçš„äº¤äº’é€»è¾‘ã€‚ä¸»è¦åŠŸèƒ½æ˜¯submit/abort jobsï¼ˆæäº¤/ç»ˆæ­¢ä»»åŠ¡ï¼‰å’Œget information from applicationsï¼ˆè·å–åº”ç”¨ä¿¡æ¯ï¼‰ä»¥åŠget cluster metricsï¼ˆè·å–é›†ç¾¤æŒ‡æ ‡ï¼‰</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ApplicationId</span></span><br><span class="line"><span class="function">    <span class="title">submitApplication</span><span class="params">(ApplicationSubmissionContext appContext)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> YarnException, IOException </span>&#123;</span><br><span class="line">...</span><br><span class="line">  SubmitApplicationRequest request =</span><br><span class="line">      Records.newRecord(SubmitApplicationRequest.class);</span><br><span class="line"></span><br><span class="line">  request.setApplicationSubmissionContext(appContext);</span><br><span class="line">...</span><br><span class="line">  <span class="comment">//<span class="doctag">TODO:</span> YARN-1763:Handle RM failovers during the submitApplication call.</span></span><br><span class="line">  rmClient.submitApplication(request);</span><br><span class="line">...</span><br><span class="line">  <span class="keyword">return</span> applicationId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åç»­æ¶‰åŠåˆ°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å’ŒæœåŠ¡ç«¯é€šä¿¡ï¼Œæ²¡æœ‰äº†è§£è¿‡ï¼Œæ‰€ä»¥å…ˆåˆ°æ­¤ä¸ºæ­¢ã€‚</p><p>å‚è€ƒèµ„æ–™:</p><p><a class="link"   href="https://cloud.tencent.com/developer/article/1889678" >https://cloud.tencent.com/developer/article/1889678<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://www.cnblogs.com/zsql/p/11276160.html" >https://www.cnblogs.com/zsql/p/11276160.html<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://max.book118.com/html/2021/1111/7110106022004041.shtm" >https://max.book118.com/html/2021/1111/7110106022004041.shtm<i class="fas fa-external-link-alt"></i></a></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;Talk is cheap show me the code!&lt;/p&gt;</summary>
    
    
    
    
    <category term="Hadoop æºç " scheme="http://example.com/tags/Hadoop-%E6%BA%90%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>Openrestyç›¸å…³</title>
    <link href="http://example.com/2022/07/20/Openresty%E7%9B%B8%E5%85%B3/"/>
    <id>http://example.com/2022/07/20/Openresty%E7%9B%B8%E5%85%B3/</id>
    <published>2022-07-20T03:52:05.000Z</published>
    <updated>2022-08-11T09:50:15.539Z</updated>
    
    <content type="html"><![CDATA[<p>ä½¿ç”¨Openrestyå®ç°druidè®¿é—®å­—æ®µçƒ­åº¦åˆ†æ</p><span id="more"></span><h1 id="å®‰è£…Openresty"><a href="#å®‰è£…Openresty" class="headerlink" title="å®‰è£…Openresty"></a>å®‰è£…Openresty</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">brew install openresty/brew/openresty</span><br><span class="line"></span><br><span class="line"># å‡ºç°ä¸‹é¢çš„æç¤ºå®‰è£…æˆåŠŸ</span><br><span class="line">You can find the configuration files for openresty under /opt/homebrew/etc/openresty/.</span><br><span class="line"></span><br><span class="line">To start openresty/brew/openresty now and restart at login:</span><br><span class="line">  brew services start openresty/brew/openresty</span><br><span class="line">Or, if you don&#x27;t want/need a background service you can just run:</span><br><span class="line">  openresty</span><br><span class="line">==&gt; Summary</span><br><span class="line">ğŸº  /opt/homebrew/Cellar/openresty/1.21.4.1_1: 307 files, 7.1MB, built in 40 seconds</span><br><span class="line">==&gt; Running `brew cleanup openresty`...</span><br><span class="line">Disable this behaviour by setting HOMEBREW_NO_INSTALL_CLEANUP.</span><br><span class="line">Hide these hints with HOMEBREW_NO_ENV_HINTS (see `man brew`).</span><br><span class="line">==&gt; Caveats</span><br><span class="line">==&gt; openresty</span><br><span class="line">You can find the configuration files for openresty under /opt/homebrew/etc/openresty/.</span><br><span class="line"></span><br><span class="line">To start openresty/brew/openresty now and restart at login:</span><br><span class="line">  brew services start openresty/brew/openresty</span><br><span class="line">Or, if you don&#x27;t want/need a background service you can just run:</span><br><span class="line">  openresty</span><br><span class="line">  </span><br></pre></td></tr></table></figure><h1 id="é…ç½®Openrestyç¯å¢ƒ"><a href="#é…ç½®Openrestyç¯å¢ƒ" class="headerlink" title="é…ç½®Openrestyç¯å¢ƒ"></a>é…ç½®Openrestyç¯å¢ƒ</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ç¼–è¾‘ ~/.zshrc å¢åŠ ä»¥ä¸‹å†…å®¹</span><br><span class="line">éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœä½ åŸå…ˆå®‰è£…è¿‡nginxï¼Œé‚£export openrestyä¸‹çš„nginxç¯å¢ƒçš„æ—¶å€™éœ€è¦å°†å®ƒå†™åˆ° $PATH å‰é¢</span><br><span class="line">è¿™æ ·nginxæ‰ç”¨çš„æ˜¯openrestyä¸­çš„</span><br><span class="line"></span><br><span class="line"># openresty</span><br><span class="line">OPENRESTY_HOME=/opt/homebrew/Cellar/openresty/1.21.4.1_1</span><br><span class="line">export PATH=$PATH:$OPENRESTY_HOME/bin</span><br><span class="line">export PATH=$OPENRESTY_HOME/nginx/sbin:$PATH</span><br><span class="line"></span><br><span class="line">(base) âœ which nginx</span><br><span class="line">/opt/homebrew/Cellar/openresty/1.21.4.1_1/nginx/sbin/nginx</span><br></pre></td></tr></table></figure><h1 id="æµ‹è¯•openresty"><a href="#æµ‹è¯•openresty" class="headerlink" title="æµ‹è¯•openresty"></a>æµ‹è¯•openresty</h1><p>åˆ›å»ºæœ¬åœ°é¡¹ç›®ç›®å½•ï¼Œè¿™é‡Œå‡è®¾ä¸ºoperesty</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /Users/liu/Documents/openresty</span><br><span class="line">mkdir /Users/liu/Documents/openresty/conf</span><br><span class="line">mkdir /Users/liu/Documents/openresty/log</span><br></pre></td></tr></table></figure><p>confä¸‹åˆ›å»ºnginx.confæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">worker_processes 1;</span><br><span class="line">error_log log/error.log;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 8080;</span><br><span class="line">        location / &#123;</span><br><span class="line">            default_type text/html;</span><br><span class="line">            content_by_lua_block &#123;</span><br><span class="line">                ngx.say(&quot;&lt;h2&gt;hello&lt;/h2&gt;&quot;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤åœ¨åå°å¯åŠ¨nginxæœåŠ¡ï¼Œå¯åŠ¨åä½¿ç”¨pså‘½ä»¤å¯ä»¥æŸ¥çœ‹nginxçš„masterå’Œworkerè¿›ç¨‹:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd openresty</span><br><span class="line">nginx -p ./ -c conf/nginx.conf</span><br><span class="line"></span><br><span class="line">ps -ef | grep nginx</span><br><span class="line">nginx: master process nginx -p ./ -c conf/nginx.conf </span><br><span class="line">nginx: worker process</span><br></pre></td></tr></table></figure><p>åœ¨æœ¬æœºä¸Šè®¿é—®8080ç«¯å£</p><img src="/2022/07/20/Openresty%E7%9B%B8%E5%85%B3/hello.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>æµ‹è¯•ä¹‹ååœæ­¢nginxæœåŠ¡</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -p ./ -s stop</span><br></pre></td></tr></table></figure><h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><h2 id="nginx-location"><a href="#nginx-location" class="headerlink" title="nginx location"></a>nginx location</h2><p>Location å—é€šè¿‡æŒ‡å®šæ¨¡å¼æ¥ä¸å®¢æˆ·ç«¯è¯·æ±‚çš„URIç›¸åŒ¹é…</p><h3 id="locationåŒ¹é…é¡ºåº"><a href="#locationåŒ¹é…é¡ºåº" class="headerlink" title="locationåŒ¹é…é¡ºåº"></a>locationåŒ¹é…é¡ºåº</h3><p>nginxæœ‰ä¸¤å±‚æŒ‡ä»¤æ¥åŒ¹é…è¯·æ±‚ URI ã€‚ç¬¬ä¸€ä¸ªå±‚æ¬¡æ˜¯ server æŒ‡ä»¤ï¼Œå®ƒé€šè¿‡åŸŸåã€ip å’Œç«¯å£æ¥åšç¬¬ä¸€å±‚çº§åŒ¹é…ï¼Œå½“æ‰¾åˆ°åŒ¹é…çš„ server åå°±è¿›å…¥æ­¤ server çš„ location åŒ¹é…ã€‚</p><p>location çš„åŒ¹é…å¹¶ä¸å®Œå…¨æŒ‰ç…§å…¶åœ¨é…ç½®æ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºæ¥åŒ¹é…ï¼Œè¯·æ±‚URI ä¼šæŒ‰å¦‚ä¸‹è§„åˆ™è¿›è¡ŒåŒ¹é…ï¼š</p><ol><li>å…ˆç²¾å‡†åŒ¹é… <strong><code>=</code></strong> ï¼Œç²¾å‡†åŒ¹é…æˆåŠŸåˆ™ä¼šç«‹å³åœæ­¢å…¶ä»–ç±»å‹åŒ¹é…ï¼›</li><li>æ²¡æœ‰ç²¾å‡†åŒ¹é…æˆåŠŸæ—¶ï¼Œè¿›è¡Œå‰ç¼€åŒ¹é…ã€‚å…ˆæŸ¥æ‰¾å¸¦æœ‰ <strong><code>^~</code></strong> çš„å‰ç¼€åŒ¹é…ï¼Œå¸¦æœ‰ <strong><code>^~</code></strong> çš„å‰ç¼€åŒ¹é…æˆåŠŸåˆ™ç«‹å³åœæ­¢å…¶ä»–ç±»å‹åŒ¹é…ï¼Œæ™®é€šå‰ç¼€åŒ¹é…ï¼ˆä¸å¸¦å‚æ•° <strong><code>^~</code></strong> ï¼‰æˆåŠŸåˆ™ä¼šæš‚å­˜ï¼Œç»§ç»­æŸ¥æ‰¾æ­£åˆ™åŒ¹é…ï¼›</li><li><strong><code>=</code></strong> å’Œ <strong><code>^~</code></strong> å‡æœªåŒ¹é…æˆåŠŸå‰æä¸‹ï¼ŒæŸ¥æ‰¾æ­£åˆ™åŒ¹é… <strong><code>~</code></strong> å’Œ <strong><code>~\*</code></strong> ã€‚å½“åŒæ—¶æœ‰å¤šä¸ªæ­£åˆ™åŒ¹é…æ—¶ï¼ŒæŒ‰å…¶åœ¨é…ç½®æ–‡ä»¶ä¸­å‡ºç°çš„å…ˆåé¡ºåºä¼˜å…ˆåŒ¹é…ï¼Œå‘½ä¸­åˆ™ç«‹å³åœæ­¢å…¶ä»–ç±»å‹åŒ¹é…ï¼›</li><li>æ‰€æœ‰æ­£åˆ™åŒ¹é…å‡æœªæˆåŠŸæ—¶ï¼Œè¿”å›æ­¥éª¤ 2 ä¸­æš‚å­˜çš„æ™®é€šå‰ç¼€åŒ¹é…ï¼ˆä¸å¸¦å‚æ•° <strong><code>^~</code></strong> ï¼‰ç»“æœ</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. location =    <span class="comment"># ç²¾å‡†åŒ¹é…</span></span><br><span class="line">2. location ^~   <span class="comment"># å¸¦å‚å‰ç¼€åŒ¹é…</span></span><br><span class="line">3. location ~    <span class="comment"># æ­£åˆ™åŒ¹é…ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰</span></span><br><span class="line">4. location ~*   <span class="comment"># æ­£åˆ™åŒ¹é…ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰</span></span><br><span class="line">5. location /a   <span class="comment"># æ™®é€šå‰ç¼€åŒ¹é…ï¼Œä¼˜å…ˆçº§ä½äºå¸¦å‚æ•°å‰ç¼€åŒ¹é…ã€‚</span></span><br><span class="line">6. location /    <span class="comment"># ä»»ä½•æ²¡æœ‰åŒ¹é…æˆåŠŸçš„ï¼Œéƒ½ä¼šåŒ¹é…è¿™é‡Œå¤„ç†</span></span><br></pre></td></tr></table></figure><h2 id="nginx-mirror"><a href="#nginx-mirror" class="headerlink" title="nginx mirror"></a>nginx mirror</h2><p>åˆ©ç”¨ mirror æ¨¡å—ï¼Œä¸šåŠ¡å¯ä»¥å°†çº¿ä¸Šå®æ—¶è®¿é—®æµé‡æ‹·è´è‡³å…¶ä»–ç¯å¢ƒï¼ŒåŸºäºè¿™äº›æµé‡å¯ä»¥åšä¸€äº›å…³äºæµé‡çš„æµ‹è¯•æˆ–è€…å…¶ä»–æ“ä½œï¼Œè¿™é‡Œæˆ‘ä»¬å°†æµé‡å¤åˆ¶å‡ºæ¥ï¼Œç„¶åè§£æå…¶ä¸­çš„å­—æ®µï¼Œæ ¸å¿ƒé…ç½®å¦‚ä¸‹:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">...</span><br><span class="line">        location / &#123;</span><br><span class="line">        mirror /mirror;       # å°†æµé‡å¤åˆ¶åˆ°/mirrorä¸‹</span><br><span class="line">        mirror_request_body on;</span><br><span class="line"></span><br><span class="line">        proxy_pass http://druid_broker; # å°†æµé‡å¤åˆ¶å®Œæ¯•ä¹‹åç»§ç»­ä¼ é€’ç»™ä¸»æœåŠ¡æä¾›æŸ¥è¯¢</span><br><span class="line">        proxy_set_header   Host             $host;</span><br><span class="line">        proxy_set_header   X-Real-IP        $remote_addr;</span><br><span class="line">        proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    location = /mirror &#123;</span><br><span class="line">        internal;             # å†…éƒ¨æœåŠ¡ å¤–éƒ¨è®¿é—®ä¼šå‡ºç°404</span><br><span class="line">        proxy_pass http://127.0.0.1:28082$request_uri;  # é•œåƒæœåŠ¡ æ“ä½œé•œåƒæµé‡</span><br><span class="line">        proxy_pass_request_body on;</span><br><span class="line">        proxy_set_header X-Original-URI $request_uri;</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¦‚ä½•å¼•ç”¨ç¬¬ä¸‰æ–¹restyåº“"><a href="#å¦‚ä½•å¼•ç”¨ç¬¬ä¸‰æ–¹restyåº“" class="headerlink" title="å¦‚ä½•å¼•ç”¨ç¬¬ä¸‰æ–¹restyåº“"></a>å¦‚ä½•å¼•ç”¨ç¬¬ä¸‰æ–¹restyåº“</h2><p>åœ¨Openresyä¸­å¼•ç”¨ç¬¬ä¸‰æ–¹luaåº“éå¸¸ç®€å•ï¼Œåªéœ€è¦å°†å¯¹åº”çš„luaæ–‡ä»¶æ‹·è´åˆ°æŒ‡å®šç›®å½•ã€‚</p><h3 id="resty-http"><a href="#resty-http" class="headerlink" title="resty.http"></a>resty.http</h3><p>æˆ‘ä»¬ä½¿ç”¨openrestyå‘èµ·httpè¯·æ±‚çš„æ—¶å€™éœ€è¦é¢å¤–çš„resty.httpåŒ…ï¼Œéœ€è¦å°†<a class="link"   href="https://github.com/ledgetech/lua-resty-http" >è¿™ä¸ªè¿æ¥<i class="fas fa-external-link-alt"></i></a>ä¸‹ <code>lua-resty-http/lib/resty/</code> ç›®å½•ä¸‹çš„ http.lua å’Œ http_headers.lua ä¸¤ä¸ªæ–‡ä»¶æ‹·è´åˆ°openrestyå®‰è£…ç›®å½•ä¸‹<code>&#123;OPENRESTY_HOME&#125;/lualib/resty</code>ç›®å½•ä¸‹å³å¯</p><h3 id="include-mime-types-æŠ¥é”™"><a href="#include-mime-types-æŠ¥é”™" class="headerlink" title="include mime.types;æŠ¥é”™"></a>include mime.types;æŠ¥é”™</h3><p>å‚è€ƒ<a class="link"   href="https://blog.csdn.net/Muxi_k/article/details/104393009" >è¿™ä¸ªè¿æ¥<i class="fas fa-external-link-alt"></i></a>è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œå¦‚æœæˆ‘ä»¬åœ¨å¯åŠ¨nginxçš„æ—¶å€™å‡ºç°è¿™ä¸ªé—®é¢˜æ˜¯å› ä¸ºï¼Œæˆ‘ä»¬openrestyè‡ªå¸¦çš„nginxä¸­æ˜¯æ²¡æœ‰<code>mime.types</code>è¿™ä¸ªæ–‡ä»¶ï¼Œä»githubä¸Šå°†è¿™ä¸ªæ–‡ä»¶è–…ä¸‹æ¥å³å¯</p><h3 id="Nginxä¸­upstream"><a href="#Nginxä¸­upstream" class="headerlink" title="Nginxä¸­upstream"></a>Nginxä¸­upstream</h3><p>ç›®å‰æˆ‘ç†è§£çš„nginxä¸­çš„upstreamæ˜¯ä¸ºäº†åˆ†æ•£è¯·æ±‚å‹åŠ›ï¼Œå¹¶ä¸”å¦‚æœä¸€å°æœºå™¨çš„æœåŠ¡æŒ‚äº†ï¼Œnginxä¼šè‡ªåŠ¨æ£€æµ‹åˆ°å¹¶ä¸”å°†éœ€æ±‚å…¨éƒ¨è½¬åˆ°å¦ä¸€å°æœåŠ¡å™¨ï¼Œåšåˆ°ä¸€å®šçš„é«˜å¯ç”¨ï¼Œä½†æ˜¯å¦‚æœnginxéƒ½æŒ‚äº†ï¼Œè¿™æ—¶å€™keepalivedå¯ä»¥ä¿è¯nginxçš„é«˜å¯ç”¨(æˆ‘è¿˜æ²¡ç”¨è¿‡)ã€‚</p><p>ç½‘ä¸ŠæŸ¥é˜…nginx upstremç›¸å…³èµ„æ–™çš„æ—¶å€™å‘ç°é™¤äº†æœ€åŸºæœ¬çš„è½®è¯¢ï¼Œè¿˜å¯ä»¥æ ¹æ®weight(æƒé‡)ï¼Œip_hashï¼Œfairï¼ˆå…¬å¹³åœ°æŒ‰ç…§åç«¯æœåŠ¡å™¨çš„å“åº”æ—¶é—´æ¥åˆ†é…è¯·æ±‚ï¼Œå“åº”æ—¶é—´çŸ­å³rtå°çš„åç«¯æœåŠ¡å™¨ä¼˜å…ˆåˆ†é…è¯·æ±‚ï¼‰ï¼Œurl_hashï¼ˆä¹Ÿå¯è§£å†³sessioné—®é¢˜ï¼Œä½†éœ€è¦æ³¨æ„ï¼Œä½¿ç”¨è¿™ç§æ–¹å¼åï¼Œserverè¯­å¥ä¸­ä¸èƒ½å†™å…¥weightç­‰å…¶ä»–å‚æ•°ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">upstream backend &#123;</span><br><span class="line">    server 192.168.1.128:8081 weight=1; // å¦‚æœè¿™ä¸ªæœåŠ¡å™¨æŒ‚æ‰äº†è¯·æ±‚ä¼šè‡ªåŠ¨ä¼ é€’ç»™ä¸‹é¢é‚£ä¸ª</span><br><span class="line">    server 192.168.1.128:8082 weight=2;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name 0.0.0.0;</span><br><span class="line">        location / &#123;</span><br><span class="line">    proxy_pass http://backend;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Nginx-Openresty-ç›‘æ§-druidæŸ¥è¯¢çƒ­åº¦"><a href="#Nginx-Openresty-ç›‘æ§-druidæŸ¥è¯¢çƒ­åº¦" class="headerlink" title="Nginx + Openresty ç›‘æ§ druidæŸ¥è¯¢çƒ­åº¦"></a>Nginx + Openresty ç›‘æ§ druidæŸ¥è¯¢çƒ­åº¦</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">80</span>;</span><br><span class="line">    client_max_body_size <span class="number">8</span>m;</span><br><span class="line">    client_body_buffer_size <span class="number">1</span>m;</span><br><span class="line">    proxy_buffers <span class="number">32</span> <span class="number">128</span>k;</span><br><span class="line">    proxy_busy_buffers_size <span class="number">1024</span>k;</span><br><span class="line">    access_log  logs/druid_broker.<span class="built_in">log</span>  main;</span><br><span class="line"></span><br><span class="line">    lua_need_request_body on;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        mirror /mirror;</span><br><span class="line">        mirror_request_body on;</span><br><span class="line"></span><br><span class="line">        proxy_pass http://druid_broker;</span><br><span class="line">        proxy_set_header   Host             $host;</span><br><span class="line">        proxy_set_header   X-Real-IP        $remote_addr;</span><br><span class="line">        proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    # éœ€è¦ resty.http mo</span><br><span class="line">    location = /check &#123;</span><br><span class="line">        content_by_lua_block &#123;</span><br><span class="line">            <span class="keyword">local</span> httpc = <span class="built_in">require</span>(<span class="string">&quot;resty.http&quot;</span>).new()</span><br><span class="line">            <span class="keyword">local</span> res, err = httpc:request_uri(<span class="string">&quot;http://127.0.0.1:8082/druid/v2/sql/&quot;</span>, &#123;</span><br><span class="line">                method = <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">                body = <span class="string">&#x27;&#123;&quot;query&quot;: &quot;SELECT CURRENT_TIMESTAMP&quot;&#125;&#x27;</span>,</span><br><span class="line">                headers = &#123;</span><br><span class="line">                    [<span class="string">&quot;Content-Type&quot;</span>] = <span class="string">&quot;application/json&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">if</span> err <span class="keyword">then</span></span><br><span class="line">                ngx.<span class="built_in">status</span> = <span class="number">500</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                ngx.<span class="built_in">status</span> = <span class="number">200</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            ngx.header.content_type = <span class="string">&#x27;application/json&#x27;</span></span><br><span class="line">            ngx.say(res.body)</span><br><span class="line">            ngx.eof()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location = /mirror &#123;   # è¿™å—æ˜¯å°†ä¸Šé¢å¤åˆ¶åˆ°/mirrorä¸­çš„æµé‡å‘é€åˆ°<span class="number">28082</span>ç«¯å£ï¼Œä¸‹é¢serverä¼šå¤„ç†è¿™ä¸ªç«¯å£æ¥æ”¶åˆ°çš„æ•°æ®</span><br><span class="line">        internal;</span><br><span class="line">        proxy_pass http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">28082</span>$request_uri;</span><br><span class="line">        proxy_pass_request_body on;</span><br><span class="line">        proxy_set_header X-Original-URI $request_uri;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">28082</span>;</span><br><span class="line"></span><br><span class="line">    lua_need_request_body on;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line"></span><br><span class="line">        content_by_lua_block &#123;</span><br><span class="line">            <span class="keyword">local</span> dataSource=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">local</span> request_uri = ngx.var.request_uri</span><br><span class="line">            <span class="keyword">local</span> data = ngx.req.get_body_data()</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">string</span>.<span class="built_in">find</span>(request_uri, <span class="string">&quot;^/druid/v2/sql&quot;</span>) <span class="keyword">then</span>  # å¦‚æœurlæ˜¯sqlç»“å°¾çš„ ï¼Œé‚£ä¹ˆéœ€è¦è¿›è¡Œè§£æ å¹¶ä¸”å°†å­—æ®µå‘é€åˆ°kafkaä¸­</span><br><span class="line">                data = <span class="built_in">string</span>.<span class="built_in">lower</span>(data)</span><br><span class="line">                data = <span class="built_in">string</span>.<span class="built_in">gsub</span>(data, <span class="string">&#x27;\\n&#x27;</span>, <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                data = <span class="built_in">string</span>.<span class="built_in">gsub</span>(data, <span class="string">&#x27;/[*].*[*]/&#x27;</span>, <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                fromIndex, endIndex = <span class="built_in">string</span>.<span class="built_in">find</span>(data, <span class="string">&quot;from +[%a_]+[ ]&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> fromIndex ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">                    dataSource = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="built_in">string</span>.<span class="built_in">sub</span>(data, fromIndex+<span class="number">4</span>, endIndex), <span class="string">&#x27;%s&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">local</span> json = <span class="built_in">require</span> <span class="string">&quot;cjson.safe&quot;</span></span><br><span class="line">                jsonBody = json.decode(data)</span><br><span class="line">                <span class="keyword">if</span> jsonBody.dataSource ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">                    dataSource = jsonBody.dataSource</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">local</span> producer = <span class="built_in">require</span> <span class="string">&quot;resty.kafka.producer&quot;</span></span><br><span class="line">            <span class="keyword">local</span> broker_list = &#123;</span><br><span class="line">                &#123; host = <span class="string">&quot;kfk01&quot;</span>, port = <span class="number">9092</span> &#125;,</span><br><span class="line">                &#123; host = <span class="string">&quot;kfk02&quot;</span>, port = <span class="number">9092</span> &#125;,</span><br><span class="line">                &#123; host = <span class="string">&quot;kfk03&quot;</span>, port = <span class="number">9092</span> &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> dataSource ~= <span class="string">&#x27;&#x27;</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">local</span> bp = producer:new(broker_list, &#123; producer_type = <span class="string">&quot;async&quot;</span>, flush_time= <span class="string">&#x27;5000&#x27;</span> &#125;)</span><br><span class="line">                <span class="keyword">local</span> ok, err = bp:send(<span class="string">&quot;druid_monitor&quot;</span>, <span class="literal">nil</span>, <span class="string">&#x27;&#123;&quot;ts&quot;:&#x27;</span>.. ngx.<span class="built_in">time</span>() ..<span class="string">&#x27;,&quot;datasource&quot;:&quot;&#x27;</span>..dataSource..<span class="string">&#x27;&quot;&#125;&#x27;</span>) # è¿™è¡Œå°†æ•°æ®æºå‘é€åˆ°kafkaä¸­ topicåç§°ä¸ºdruid_monitor</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">                    ngx.<span class="built_in">log</span>(ngx.ERR, <span class="string">&#x27;kafka send err:&#x27;</span>, err)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            ngx.say(<span class="string">&#x27;ok&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">upstream druid_broker &#123;</span><br><span class="line">   server adt-bd-c1-druid-broker01.adtiming.int:<span class="number">8082</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">60</span>;</span><br><span class="line">   server adt-bd-c1-druid-broker02.adtiming.int:<span class="number">8082</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">60</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">åˆ°æ­¤ä¸ºæ­¢openrestyç›‘æ§druidæŸ¥è¯¢å°±ç»“æŸäº†ã€‚</span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;ä½¿ç”¨Openrestyå®ç°druidè®¿é—®å­—æ®µçƒ­åº¦åˆ†æ&lt;/p&gt;</summary>
    
    
    
    
    <category term="Openresty" scheme="http://example.com/tags/Openresty/"/>
    
  </entry>
  
  <entry>
    <title>Grafana</title>
    <link href="http://example.com/2022/07/12/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86Grafana%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E6%B3%95/"/>
    <id>http://example.com/2022/07/12/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86Grafana%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%96%B9%E6%B3%95/</id>
    <published>2022-07-12T12:53:21.000Z</published>
    <updated>2022-07-13T07:37:13.313Z</updated>
    
    <content type="html"><![CDATA[<h2 id="é…ç½®grafanaçš„å…å¯†åå‘ä»£ç†"><a href="#é…ç½®grafanaçš„å…å¯†åå‘ä»£ç†" class="headerlink" title="é…ç½®grafanaçš„å…å¯†åå‘ä»£ç†"></a>é…ç½®grafanaçš„å…å¯†åå‘ä»£ç†</h2><p>é…ç½®grafanaå…å¯†è®¿é—®dashboard &amp; panel</p><span id="more"></span><h3 id="grafanaå…å¯†"><a href="#grafanaå…å¯†" class="headerlink" title="grafanaå…å¯†"></a>grafanaå…å¯†</h3><p>ä»€ä¹ˆå«åšå…å¯†åå‘ä»£ç†ï¼Ÿæˆ‘ä»¬åœ¨grafanaä¸­åˆ†äº«å‡ºæ¥çš„panelçš„linkï¼Œæ˜¯ä¸‹é¢æ ·å¼çš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:3000/gf/d/173XYzd7z/clickhouse-performance-monitor?orgId=1&amp;from=1657692410493&amp;to=1657694210493&amp;viewPanel=30</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬åœ¨åˆ«çš„æœºå™¨ä¸Šæ‰“å¼€å°±éœ€è¦æˆ‘ä»¬è¾“å…¥è´¦å·å’Œå¯†ç ï¼Œå¦‚æœæˆ‘åšäº†ä¸€ä¸ªç›‘æ§é¡µé¢ï¼Œå†…åµŒäº†grafanaçš„é¡µé¢ï¼Œæˆ‘ç‚¹å¼€æˆ‘çš„ç›‘æ§ï¼Œè¿˜éœ€è¦æ‰‹åŠ¨è¾“å…¥grafanaçš„è´¦å·å¯†ç ï¼Œè¿™å°±æ¯”è¾ƒéš¾å—ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•ä¸ç”¨è¾“å…¥å‘¢ï¼Ÿ</p><p>è¿™å°±éœ€è¦ grafana çš„ <a class="link"   href="https://grafana.com/docs/grafana/v7.5/http_api/create-api-tokens-for-org/" >API tokens<i class="fas fa-external-link-alt"></i></a>ï¼Œè¿™ä¸ªAPI token å®˜æ–¹ç»™å‡ºçš„ä½¿ç”¨æ–¹æ³•æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œæ¥æ“ä½œdashboard æˆ–è€… alerté¢„è­¦ä¹‹ç±»çš„ï¼Œä½†æ˜¯æˆ‘ä»¬åªéœ€è¦ç”¨æ¥è®¤è¯å³å¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> æŒ‰ç…§æ–‡æ¡£åœ¨æœ¬æœºä¸Šç”Ÿæˆkeyçš„è¿‡ç¨‹</span></span><br><span class="line">curl -X POST -H &quot;Content-Type: application/json&quot; -d &#x27;&#123;&quot;name&quot;:&quot;apiorg&quot;&#125;&#x27; http://admin:admin@localhost:3000/api/orgs</span><br><span class="line">&#123;&quot;message&quot;:&quot;Organization created&quot;,&quot;orgId&quot;:2&#125;%</span><br><span class="line"></span><br><span class="line">curl -X POST -H &quot;Content-Type: application/json&quot; -d &#x27;&#123;&quot;loginOrEmail&quot;:&quot;admin&quot;, &quot;role&quot;: &quot;Admin&quot;&#125;&#x27; http://admin:admin@localhost:3000/api/orgs/2/users</span><br><span class="line"></span><br><span class="line">curl -X POST http://admin:admin@localhost:3000/api/user/using/1</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¸Šé¢å°±æ˜¯æˆ‘ä»¬ç”Ÿæˆçš„keyï¼Œæ³¨æ„åªå‡ºç°ä¸€æ¬¡ï¼Œè®°å½•ä¸‹æ¥</span></span><br><span class="line">curl -X POST -H &quot;Content-Type: application/json&quot; -d &#x27;&#123;&quot;name&quot;:&quot;apikeycurl&quot;, &quot;role&quot;: &quot;Admin&quot;&#125;&#x27; http://admin:admin@localhost:3000/api/auth/keys</span><br><span class="line">&#123;&quot;id&quot;:1,&quot;name&quot;:&quot;apikeycurl&quot;,&quot;key&quot;:&quot;eyJrIjoidTJPdm1mbDRBZHlzaVBTNHV1cmZiMjZ6N3l3ZG9VbTQiLCJuIjoiYXBpa2V5Y3VybCIsImlkIjoyfQ==&quot;&#125;%</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> é€šè¿‡keyè®¿é—®æˆ‘ä»¬çš„share link</span></span><br><span class="line">curl -H &quot;Authorization: Bearer eyJrIjoidTJPdm1mbDRBZHlzaVBTNHV1cmZiMjZ6N3l3ZG9VbTQiLCJuIjoiYXBpa2V5Y3VybCIsImlkIjoyfQ==&quot; http://localhost:3000/gf/d/173XYzd7z/clickhouse-performance-monitor?</span><br></pre></td></tr></table></figure><h3 id="grafanaæ‰“å¼€åå‘ä»£ç†é…ç½®"><a href="#grafanaæ‰“å¼€åå‘ä»£ç†é…ç½®" class="headerlink" title="grafanaæ‰“å¼€åå‘ä»£ç†é…ç½®"></a>grafanaæ‰“å¼€åå‘ä»£ç†é…ç½®</h3><p>å‚è€ƒ <a class="link"   href="https://grafana.com/tutorials/run-grafana-behind-a-proxy/" >å®˜æ–¹æ–‡æ¡£<i class="fas fa-external-link-alt"></i></a> è®¾ç½®æˆ‘ä»¬åœ¨grafanä¸­çš„ä»£ç†é…ç½®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> vim conf/defaults.ini</span></span><br><span class="line">domain = localhost</span><br><span class="line">root_url = %(protocol)s://%(domain)s:%(http_port)s/gf/</span><br><span class="line">serve_from_sub_path = true</span><br></pre></td></tr></table></figure><h3 id="åå‘ä»£ç†çš„ä¸¤ç§æ–¹å¼"><a href="#åå‘ä»£ç†çš„ä¸¤ç§æ–¹å¼" class="headerlink" title="åå‘ä»£ç†çš„ä¸¤ç§æ–¹å¼"></a>åå‘ä»£ç†çš„ä¸¤ç§æ–¹å¼</h3><h5 id="nginxé…ç½®åå‘ä»£ç†"><a href="#nginxé…ç½®åå‘ä»£ç†" class="headerlink" title="nginxé…ç½®åå‘ä»£ç†"></a>nginxé…ç½®åå‘ä»£ç†</h5><p>å®‰è£…nginxè¿™é‡Œä¸å†èµ˜è¿°ï¼Œè¯¦ç»†å¯ä»¥å‚è€ƒ<a class="link"   href="https://juejin.cn/post/6986190222241464350" >è¿™é‡Œ<i class="fas fa-external-link-alt"></i></a></p><p>æˆ‘çš„nginxä½¿ç”¨çš„homebrewå®‰è£…ï¼Œé¦–å…ˆæŸ¥çœ‹nginxç›¸å…³ä¿¡æ¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">(base) âœ  brew info nginx</span><br><span class="line">nginx: stable 1.21.3 (bottled), HEAD</span><br><span class="line">HTTP(S) server and reverse proxy, and IMAP/POP3 proxy server</span><br><span class="line">https://nginx.org/</span><br><span class="line">/opt/homebrew/Cellar/nginx/1.21.3 (26 files, 2.2MB) *</span><br><span class="line">  Poured from bottle on 2022-06-16 at 17:13:49</span><br><span class="line">From: https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/nginx.rb</span><br><span class="line">License: BSD-2-Clause</span><br><span class="line">==&gt; Dependencies</span><br><span class="line">Required: openssl@1.1 âœ”, pcre âœ”</span><br><span class="line">==&gt; Options</span><br><span class="line">--HEAD</span><br><span class="line">Install HEAD version</span><br><span class="line">==&gt; Caveats</span><br><span class="line">Docroot is: /opt/homebrew/var/www</span><br><span class="line"></span><br><span class="line">The default port has been set in /opt/homebrew/etc/nginx/nginx.conf to 8080 so that</span><br><span class="line">nginx can run without sudo.</span><br><span class="line"></span><br><span class="line">nginx will load all files in /opt/homebrew/etc/nginx/servers/.</span><br><span class="line"></span><br><span class="line">To restart nginx after an upgrade:</span><br><span class="line">  brew services restart nginx</span><br><span class="line">Or, if you don&#x27;t want/need a background service you can just run:</span><br><span class="line">  /opt/homebrew/opt/nginx/bin/nginx -g daemon off;</span><br><span class="line">==&gt; Analytics</span><br><span class="line">install: 38,896 (30 days), 91,488 (90 days), 455,183 (365 days)</span><br><span class="line">install-on-request: 38,823 (30 days), 91,297 (90 days), 454,267 (365 days)</span><br><span class="line">build-error: 48 (30 days)</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The default port has been set in /opt/homebrew/etc/nginx/nginx.conf to 8080 so that</span><br><span class="line">nginx can run without sudo.</span><br><span class="line">è¿™è¡Œæˆ‘ä»¬å¯ä»¥äº†è§£åˆ°é»˜è®¤nginxé…ç½®æ–‡ä»¶æ˜¯/opt/homebrew/etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">ä¿®æ”¹æˆ‘ä»¬çš„nginx.confæ–‡ä»¶</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">user  nobody;</span></span><br><span class="line">worker_processes  1;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">error_log  logs/error.log;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">error_log  logs/error.log  info;</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">pid        logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       8080;</span><br><span class="line">        server_name  localhost;</span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        error_page   500 502 503 504  /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">            root   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    # ä¸»è¦æ˜¯ä¸‹é¢çš„é…ç½®</span><br><span class="line">    server &#123;</span><br><span class="line">      listen 8888;   # æºç«¯å£</span><br><span class="line">      root /opt/homebrew/var/www;  # æ ¹ ä¸»é¡µç›®å½• ä¿æŒé»˜è®¤å³å¯</span><br><span class="line">      location /gf &#123;</span><br><span class="line">        proxy_pass http://localhost:3000; # ç›®æ ‡åŸŸåä»¥åŠç«¯å£</span><br><span class="line">        proxy_set_header Authorization &quot;Bearer  eyJrIjoiRWZOVElUTHRwYkt0VVgwVkNpMmppTElsUUgxOXpxZUIiLCJuIjoiYXBpa2V5Y3VybCIsImlkIjoxfQ==&quot;; # ç”³è¯·çš„grafana ç»„çš„ç§˜é’¥</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    include servers/*;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢å°±æ˜¯æˆ‘ä»¬çš„nginxé…ç½®ï¼Œä¸»è¦æ˜¯å…¶ä¸­çš„serveré…ç½®ï¼Œæ³¨æ„ç§˜é’¥é…ç½®ä¸­é—´éƒ½æ˜¯ç©ºæ ¼æ²¡æœ‰å†’å·ã€‚</p><p>åˆ°æ­¤ä¸ºæ­¢nginxé…ç½®åå‘ä»£ç†å°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹æ€ä¹ˆç”¨goè¯­è¨€æ¥å®ç°ä¸€ä¸ªgrafanaåå‘ä»£ç†</p><h5 id="goå®ç°åå‘ä»£ç†"><a href="#goå®ç°åå‘ä»£ç†" class="headerlink" title="goå®ç°åå‘ä»£ç†"></a>goå®ç°åå‘ä»£ç†</h5><p>åŠ å…¥ä½ ä¸æƒ³åœ¨grafanaæœåŠ¡å™¨ä¸Šå†éƒ¨ç½²ä¸€ä¸ªnginxæœåŠ¡å™¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°è¯•ç”¨goæ¥å®ç°ä¸€ä¸ªåå‘ä»£ç†æœåŠ¡ã€‚</p><p>å‚è€ƒ<a class="link"   href="https://h1z3y3.me/posts/simple-and-powerful-reverse-proxy-in-golang/" >è¿™ç¯‡æ–‡ç« <i class="fas fa-external-link-alt"></i></a>ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªç®€å•çš„goæœåŠ¡åå‘ä»£ç†ï¼Œä¸‹é¢æ˜¯ä¸»è¦çš„ä»£ç </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;log&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;net/http/httputil&quot;</span></span><br><span class="line"><span class="string">&quot;net/url&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewProxy takes target host and creates a reverse proxy</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewProxy</span><span class="params">(targetHost <span class="keyword">string</span>)</span> <span class="params">(*httputil.ReverseProxy, error)</span></span> &#123;</span><br><span class="line">url, err := url.Parse(targetHost)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">proxy := httputil.NewSingleHostReverseProxy(url)</span><br><span class="line"></span><br><span class="line">originalDirector := proxy.Director</span><br><span class="line">proxy.Director = <span class="function"><span class="keyword">func</span><span class="params">(req *http.Request)</span></span> &#123;</span><br><span class="line">originalDirector(req)</span><br><span class="line">modifyRequest(req)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//proxy.ModifyResponse = modifyResponse()</span></span><br><span class="line">proxy.ErrorHandler = errorHandler()</span><br><span class="line"><span class="keyword">return</span> proxy, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">modifyRequest</span><span class="params">(req *http.Request)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// éœ€è¦å°†è¯·æ±‚é“¾æ¥ä¸­çš„Hostæ”¹ä¸ºgrafanaçš„Host</span></span><br><span class="line"></span><br><span class="line">  req.URL.Host = <span class="string">&quot;localhost:3000&quot;</span></span><br><span class="line">req.Host = <span class="string">&quot;localhost:3000&quot;</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;url: %s \n&quot;</span>, req.URL) </span><br><span class="line">fmt.Printf(<span class="string">&quot;host: %s \n&quot;</span>, req.Host)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å°†grafana api key è®¾ç½®è¿›è¯·æ±‚çš„headerä¸­</span></span><br><span class="line">req.Header.Set(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot; Bearer eyJrIjoiRWZOVElUTHRwYkt0VVgwVkNpMmppTElsUUgxOXpxZUIiLCJuIjoiYXBpa2V5Y3VybCIsImlkIjoxfQ==&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="string">&quot;*&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Access-Control-Allow-Methods&quot;</span>, <span class="string">&quot;*&quot;</span>)</span><br><span class="line">req.Header.Set(<span class="string">&quot;Access-Control-Allow-Credentials&quot;</span>, <span class="string">&quot;true&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">errorHandler</span><span class="params">()</span> <span class="title">func</span><span class="params">(http.ResponseWriter, *http.Request, error)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, req *http.Request, err error)</span></span> &#123;</span><br><span class="line">fmt.Printf(<span class="string">&quot;Got error while modifying response: %v \n&quot;</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ProxyRequestHandler handles the http request using proxy</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ProxyRequestHandler</span><span class="params">(proxy *httputil.ReverseProxy)</span> <span class="title">func</span><span class="params">(http.ResponseWriter, *http.Request)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">proxy.ServeHTTP(w, r)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// initialize a reverse proxy and pass the actual backend server url here</span></span><br><span class="line">proxy, err := NewProxy(<span class="string">&quot;http://localhost:3000&quot;</span>)</span><br><span class="line"><span class="comment">//proxy, err := NewProxy(&quot;http://localhost:3000&quot;)</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// handle all requests to your server using the proxy</span></span><br><span class="line">http.HandleFunc(<span class="string">&quot;/&quot;</span>, ProxyRequestHandler(proxy))</span><br><span class="line">log.Fatal(http.ListenAndServe(<span class="string">&quot;:8888&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬è®¿é—®localhost:8888çš„æ—¶å€™å°±ä¼šè‡ªåŠ¨è·³è½¬åˆ°localhost:3000ï¼Œåˆ°æ­¤ä¸ºæ­¢ä¸¤ç§å…å¯†grafanaé…ç½®å°±å®Œæˆäº†ã€‚</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;é…ç½®grafanaçš„å…å¯†åå‘ä»£ç†&quot;&gt;&lt;a href=&quot;#é…ç½®grafanaçš„å…å¯†åå‘ä»£ç†&quot; class=&quot;headerlink&quot; title=&quot;é…ç½®grafanaçš„å…å¯†åå‘ä»£ç†&quot;&gt;&lt;/a&gt;é…ç½®grafanaçš„å…å¯†åå‘ä»£ç†&lt;/h2&gt;&lt;p&gt;é…ç½®grafanaå…å¯†è®¿é—®dashboard &amp;amp; panel&lt;/p&gt;</summary>
    
    
    
    
    <category term="Grafana" scheme="http://example.com/tags/Grafana/"/>
    
  </entry>
  
  <entry>
    <title>Hiveç¬”è®°</title>
    <link href="http://example.com/2022/06/09/Hive/"/>
    <id>http://example.com/2022/06/09/Hive/</id>
    <published>2022-06-09T15:10:10.000Z</published>
    <updated>2022-06-23T13:39:46.061Z</updated>
    
    <content type="html"><![CDATA[<p>Hiveç›¸å…³ç¬”è®°</p><span id="more"></span><h2 id="CTE-amp-Temporary-tables-amp-View-amp-Materialized-view"><a href="#CTE-amp-Temporary-tables-amp-View-amp-Materialized-view" class="headerlink" title="CTE &amp; Temporary tables &amp; View &amp; Materialized view"></a>CTE &amp; Temporary tables &amp; View &amp; Materialized view</h2><h3 id="CTE"><a href="#CTE" class="headerlink" title="CTE"></a>CTE</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> table_name <span class="keyword">as</span> (...)</span><br><span class="line">selece <span class="operator">*</span> <span class="keyword">from</span> table_name</span><br></pre></td></tr></table></figure><p>Hiveä¸­çš„CTEå…¨ç§°å«åšCommon Table Expression å…¬å…±è¡¨è¾¾å¼ï¼Œæ„æ€å°±æ˜¯å¤§å®¶å…¬å…±çš„ï¼Œéƒ½èƒ½ç”¨çš„ç»“æœï¼Œä¸€èˆ¬ç”¨åœ¨SQLä¸­å¯ä»¥ç®€åŒ–æˆ‘ä»¬çš„é€»è¾‘ï¼Œæé«˜å¯è¯»æ€§ï¼ŒCTEä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªä¼˜ç‚¹ã€‚</p><ol><li>å¤ç”¨å…¬å…±ä»£ç å—ï¼Œå‡å°‘è¡¨çš„ è¯»å–æ¬¡æ•°ï¼Œé™ä½IO æé«˜æ€§èƒ½ã€‚è¾¾åˆ°ä¸€æ¬¡æŸ¥è¯¢ï¼ˆè¯»ï¼‰ï¼Œå¤šæ¬¡ä½¿ç”¨ï¼Œç›®çš„æ˜¯å‡å°‘è¯»çš„æ¬¡æ•°ï¼ˆéœ€è¦é…ç½®å‚æ•°æ¥ç‰©åŒ–CTEç»“æœï¼‰</li><li>æé«˜ä»£ç çš„å¯è¯»æ€§ï¼šä½¿ä»£ç æ›´ç®€æ´ï¼Œä¾¿äºç»´æŠ¤ã€‚å¦‚å°†å­æŸ¥è¯¢æŠ½å‡ºæ¥ä»¥åï¼Œæ”¾åˆ°withè¯­å¥ï¼Œå¯æ–¹ä¾¿å®šä½ï¼Œç»´æŠ¤ä»£ç ï¼Œä»£ç çš„å¯è¯»æ€§å¢å¼ºã€‚</li><li>åš<strong>é€’å½’æŸ¥è¯¢</strong>ï¼Œè¿›è¡Œè¿­ä»£è®¡ç®—ã€‚</li></ol><p><strong>æ³¨æ„ï¼š</strong>CTEé»˜è®¤åœ¨æ¯æ¬¡è°ƒç”¨çš„æ—¶å€™éƒ½ä¼šé‡æ–°è®¡ç®—ä¸€éï¼Œè®¾ç½®hive.optimize.cte.materialize.thresholdæŒ‡æ ‡æ¥å¼ºåˆ¶ç‰©åŒ–CTEç»“æœï¼Œå½“CTEè¢«ä½¿ç”¨çš„æ¬¡æ•°å¤§äºè¯¥æŒ‡æ ‡å€¼çš„æ—¶å€™å°†è¢«å­˜å‚¨åˆ°ç£ç›˜ä¸­ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># ä¸‹é¢<span class="keyword">SQL</span>å¯ä»¥æ£€æµ‹æ˜¯å¦ç‰©åŒ–åˆ°ç£ç›˜ï¼Œè®¾ç½®hive.optimize.cte.materialize.threshold <span class="operator">=</span> <span class="number">1</span> </span><br><span class="line"># å¦‚æœä¸¤ä¸ªéšæœºæ•°æ˜¯ç›¸ç­‰çš„ï¼Œè¯æ˜è¢«ç‰©åŒ–äº†ï¼Œå¦‚æœæ˜¯ä¸ç­‰çš„ï¼Œè¯æ˜è®¡ç®—äº†ä¸¤æ¬¡</span><br><span class="line"><span class="keyword">with</span> temp <span class="keyword">as</span> (<span class="keyword">select</span> rand())</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> temp </span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span> </span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> temp</span><br></pre></td></tr></table></figure><p>CTEè¿˜æœ‰ä¸€ä¸ªä¸»è¦åŠŸèƒ½æ˜¯é€’å½’æŸ¥è¯¢ï¼Œä½†æ˜¯æ²¡æ‰¾åˆ°Hiveå¯¹è¿™æ–¹é¢çš„æ˜¯å¦æœ‰æ”¯æŒ <a class="link"   href="https://www.cnblogs.com/ljhdo/p/4580347.html" >CTEé€’å½’æŸ¥è¯¢<i class="fas fa-external-link-alt"></i></a></p><h3 id="View"><a href="#View" class="headerlink" title="View"></a>View</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># è§†å›¾æ˜¯ä¿å­˜äº†é€»è¾‘ç»“æ„ï¼Œæ²¡æœ‰çœŸæ­£çš„å­˜å‚¨æ•°æ®ï¼Œæ‰€ä»¥å¦‚æœé€»è¾‘å¤æ‚ éœ€è¦é‡å¤è®¡ç®—å¤šæ¬¡ ä¸å»ºè®®ä½¿ç”¨è§†å›¾</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">VIEW</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] view_name [(column_name [COMMENT column_comment], ...) ]</span><br><span class="line">[COMMENT table_comment]</span><br><span class="line"><span class="keyword">AS</span> <span class="keyword">SELECT</span> ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">VIEW</span> view_name</span><br></pre></td></tr></table></figure><p>è§†å›¾ä½œç”¨ï¼š</p><ol><li>ç®€åŒ–SQLï¼Œä½¿é€»è¾‘æ›´åŠ æ¸…æ™°</li><li>ä¸å¯¹å¤–å…¬å¼€æ‰€æœ‰çš„å­—æ®µï¼Œä¾‹å¦‚å¯¹ä¸åŒçš„éƒ¨é—¨å»ºç«‹ä¸åŒçš„è§†å›¾è¡¨</li><li>é™ä½æ•°æ®å†—ä½™</li></ol><p><strong>æ³¨æ„ï¼š</strong></p><ol><li>è§†å›¾å®šä¹‰åœ¨åˆ›å»ºæ—¶å†»ç»“ï¼Œå› æ­¤ï¼Œå¦‚æœè§†å›¾å®šä¹‰ä¸º select * from tï¼Œå…¶ä¸­ t æ˜¯å…·æœ‰ä¸¤åˆ— a å’Œ b çš„è¡¨ï¼Œåˆ™ç¨åè¯·æ±‚é€‰æ‹©*ä»è§†å›¾ä¸­çœ‹ï¼Œå³ä½¿ç¨åå°†æ–°åˆ— c æ·»åŠ åˆ°è¡¨ä¸­ï¼Œä¹Ÿåº”ä»…è¿”å› a å’Œ b åˆ—</li><li>è§†å›¾æ˜¯åªè¯»çš„ï¼Œä»…èƒ½æŸ¥è¯¢ï¼Œä¸èƒ½è¿›è¡Œæ•°æ®æ’å…¥å’Œä¿®æ”¹</li><li>hiveä¼˜å…ˆè§£æè§†å›¾ï¼Œæ¯”å¦‚ï¼Œå¦‚æœä½¿ç”¨è§†å›¾çš„æŸ¥è¯¢è¯­å¥å’Œè§†å›¾å‡åŒ…å«limitå­å¥ï¼Œé‚£ä¹ˆç”¨æˆ·æœ€ç»ˆè·å–çš„æ•°æ®æ¡æ•°å°†é¦–å…ˆè€ƒè™‘è§†å›¾ä¸­é™åˆ¶çš„è¾“å‡ºè®°å½•æ•°</li></ol><h3 id="Partitioned-View"><a href="#Partitioned-View" class="headerlink" title="Partitioned View"></a>Partitioned View</h3><p>Hiveè¿˜å¯ä»¥å»ºç«‹åˆ†åŒºè§†å›¾ï¼Œæœ‰äººå¯èƒ½ç–‘æƒ‘åˆ†åŒºè§†å›¾è¿™ä¸ªä¸šåŠ¡åœºæ™¯åœ¨å“ªé‡Œï¼Ÿ</p><p>éœ€è¦å¯¹åˆ†åŒºè¡¨ä¸­çš„æ•°æ®è¿›è¡Œä¸€äº›é¢„å¤„ç†ä¹‹åå†<strong>æŒ‰ç…§å¤©æ•°æ®</strong>ä¾›æŸ¥è¯¢ï¼Œæˆ‘ä»¬å°±éœ€è¦åˆ†åŒºè§†å›¾ï¼Œæ€»ä¸èƒ½é’ˆå¯¹æ¯ä¸€ä¸ªåˆ†åŒºéƒ½å»ºç«‹ä¸€å¼ è§†å›¾ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># å…ˆåˆ›å»ºè¡¨</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> if <span class="keyword">not</span> <span class="keyword">exists</span> kantlin (</span><br><span class="line">id <span class="type">int</span>,</span><br><span class="line">name string,</span><br><span class="line">age <span class="type">int</span></span><br><span class="line">)</span><br><span class="line">PARTITIONED <span class="keyword">BY</span> (date_id string)</span><br><span class="line"><span class="type">row</span> format delimited fields terminated <span class="keyword">by</span> <span class="string">&#x27;,&#x27;</span></span><br><span class="line">stored <span class="keyword">as</span> textfile;</span><br><span class="line">#æ’å…¥ä¸¤æ¡ç›¸åŒçš„æ•°æ®</span><br><span class="line"> <span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> kantlin <span class="keyword">partition</span>(date_id<span class="operator">=</span><span class="string">&#x27;20210618&#x27;</span>)   <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">&#x27;kantlin&#x27;</span>,<span class="number">3</span>);</span><br><span class="line"> <span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">table</span> kantlin <span class="keyword">partition</span>(date_id<span class="operator">=</span><span class="string">&#x27;20210618&#x27;</span>)   <span class="keyword">values</span> (<span class="number">1</span>,<span class="string">&#x27;kantlin&#x27;</span>,<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">#åˆ›å»ºåˆ†åŒºè§†å›¾</span><br><span class="line">#æ³¨æ„ PARTITIONED <span class="keyword">ON</span>åé¢è·Ÿçš„æ˜¯åˆ†åŒºå­—æ®µï¼Œè€Œä¸”è¿™ä¸ªå­—æ®µå¿…é¡»æ˜¯<span class="keyword">select</span>å’Œ<span class="keyword">group</span> <span class="keyword">by</span>çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> kantlin PARTITIONED <span class="keyword">ON</span>(date_id) <span class="keyword">AS</span> <span class="keyword">SELECT</span> id,name,age,<span class="type">time</span>,date_id  <span class="keyword">from</span> kantlin <span class="keyword">GROUP</span> <span class="keyword">BY</span> id,name,age,<span class="type">time</span>,date_id ;</span><br></pre></td></tr></table></figure><h3 id="Materialized-views"><a href="#Materialized-views" class="headerlink" title="Materialized views"></a>Materialized views</h3><p>Hive3.0.0å¼•å…¥äº†å¯¹ç‰©åŒ–è§†å›¾çš„æ”¯æŒï¼Œéœ€è¦æ³¨æ„çš„æ˜¯<strong>å¼•å…¥ç‰©åŒ–è§†å›¾çš„ç›®çš„æ˜¯ä¸ºäº†ä¼˜åŒ–æ•°æ®è®¿é—®çš„æ•ˆç‡</strong>ï¼Œç‰©åŒ–è§†å›¾ç›¸æ¯”è§†å›¾æ¥è¯´ä¿®æ”¹è¦æ›´åŠ è´´è¿‘åº•å±‚ï¼Œä»–ä¼šé‡æ–°æˆ‘ä»¬çš„æŸ¥è¯¢SQLï¼Œè‡ªåŠ¨ä¼˜åŒ–æˆ‘ä»¬çš„æŸ¥è¯¢æµç¨‹ï¼Œå¯èƒ½æˆ‘ä»¬ä¸¤å¼ è¡¨joinçš„æƒ…å†µï¼Œå­˜åœ¨æ»¡è¶³æˆ‘ä»¬ç»“æœçš„ç‰©åŒ–è§†å›¾ï¼Œé‚£ä¹ˆä»–ä¼šç›´æ¥ä»ç‰©åŒ–è§†å›¾è¡¨æ‹¿æ•°æ®ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> MATERIALIZED <span class="keyword">VIEW</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db_name.]materialized_view_name</span><br><span class="line">  [DISABLE REWRITE]</span><br><span class="line">  [COMMENT materialized_view_comment]</span><br><span class="line">  [PARTITIONED <span class="keyword">ON</span> (col_name, ...)]</span><br><span class="line">  [CLUSTERED <span class="keyword">ON</span> (col_name, ...) <span class="operator">|</span> DISTRIBUTED <span class="keyword">ON</span> (col_name, ...) SORTED <span class="keyword">ON</span> (col_name, ...)]</span><br><span class="line">  [</span><br><span class="line">    [<span class="type">ROW</span> FORMAT row_format]</span><br><span class="line">    [STORED <span class="keyword">AS</span> file_format]</span><br><span class="line">      <span class="operator">|</span> STORED <span class="keyword">BY</span> <span class="string">&#x27;storage.handler.class.name&#x27;</span> [<span class="keyword">WITH</span> SERDEPROPERTIES (...)]</span><br><span class="line">  ]</span><br><span class="line">  [LOCATION hdfs_path]</span><br><span class="line">  [TBLPROPERTIES (property_name<span class="operator">=</span>property_value, ...)]</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="operator">&lt;</span>query<span class="operator">&gt;</span>;</span><br></pre></td></tr></table></figure><p>åœ¨å®ä¾‹åŒ–è§†å›¾åˆ›å»ºè¯­å¥ä¸­æœªæŒ‡å®šçš„ SerDe å’Œå­˜å‚¨æ ¼å¼çš„é»˜è®¤å€¼(å®ƒä»¬æ˜¯å¯é€‰çš„)åˆ†åˆ«ä½¿ç”¨é…ç½®å±æ€§<code>hive.materializedview.serde</code>å’Œ<code>hive.materializedview.fileformat</code>æŒ‡å®šã€‚</p><p>å®ä¾‹åŒ–è§†å›¾å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰å­˜å‚¨å¤„ç†ç¨‹åºå­˜å‚¨åœ¨å¤–éƒ¨ç³»ç»Ÿä¸­ï¼Œä¾‹å¦‚<a class="link"   href="https://www.docs4dev.com/docs/zh/apache-hive/3.1.1/reference/Druid_Integration.html" >Druid<i class="fas fa-external-link-alt"></i></a>ã€‚ä¾‹å¦‚ï¼Œä»¥ä¸‹è¯­å¥åˆ›å»ºå­˜å‚¨åœ¨ Druid ä¸­çš„å®ä¾‹åŒ–è§†å›¾ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> MATERIALIZED <span class="keyword">VIEW</span> druid_wiki_mv</span><br><span class="line">STORED <span class="keyword">AS</span> <span class="string">&#x27;org.apache.hadoop.hive.druid.DruidStorageHandler&#x27;</span></span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">SELECT</span> __time, page, <span class="keyword">user</span>, c_added, c_removed</span><br><span class="line"><span class="keyword">FROM</span> src;</span><br></pre></td></tr></table></figure><p>å½“å®ä¾‹åŒ–è§†å›¾ä½¿ç”¨çš„æºè¡¨ä¸­çš„æ•°æ®å‘ç”Ÿæ›´æ”¹æ—¶ï¼Œä¾‹å¦‚ï¼Œæ’å…¥æ–°æ•°æ®æˆ–ä¿®æ”¹ç°æœ‰æ•°æ®æ—¶ï¼Œæˆ‘ä»¬å°†éœ€è¦åˆ·æ–°å®ä¾‹åŒ–è§†å›¾çš„å†…å®¹ï¼Œä»¥ä½¿å…¶ä¸è¿™äº›æ›´æ”¹ä¿æŒæœ€æ–°ã€‚å½“å‰ï¼Œç‰©åŒ–è§†å›¾çš„é‡å»ºæ“ä½œéœ€è¦ç”±ç”¨æˆ·è§¦å‘ã€‚ç‰¹åˆ«æ˜¯ï¼Œç”¨æˆ·åº”æ‰§è¡Œä»¥ä¸‹è¯­å¥ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> MATERIALIZED <span class="keyword">VIEW</span> [db_name.]materialized_view_name REBUILD;</span><br></pre></td></tr></table></figure><p>Hive æ”¯æŒå¢é‡è§†å›¾ç»´æŠ¤ï¼Œå³ä»…åˆ·æ–°å—åŸå§‹æºè¡¨ä¸­çš„æ›´æ”¹å½±å“çš„æ•°æ®ã€‚å¢é‡è§†å›¾ç»´æŠ¤å°†å‡å°‘é‡å»ºæ­¥éª¤çš„æ‰§è¡Œæ—¶é—´ã€‚æ­¤å¤–ï¼Œå®ƒå°†ä¸ºç‰©åŒ–è§†å›¾ä¸­çš„ç°æœ‰æ•°æ®ä¿ç•™ LLAP ç¼“å­˜ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒHive å°†å°è¯•ä»¥å¢é‡æ–¹å¼é‡å»ºå®ä¾‹åŒ–è§†å›¾ï¼Œå¦‚æœä¸å¯èƒ½çš„è¯ï¼Œå°†é€€å›åˆ°å®Œå…¨é‡å»ºã€‚å½“å‰å®ç°ä»…åœ¨æºè¡¨ä¸Šæ‰§è¡Œ<code>INSERT</code>æ“ä½œæ—¶æ”¯æŒå¢é‡é‡å»ºï¼Œè€Œ<code>UPDATE</code>å’Œ<code>DELETE</code>æ“ä½œå°†å¼ºåˆ¶å¯¹ç‰©åŒ–è§†å›¾è¿›è¡Œå®Œå…¨é‡å»ºã€‚</p><h2 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h2><h3 id="How-to-write-SQL"><a href="#How-to-write-SQL" class="headerlink" title="How to write SQL?"></a>How to write SQL?</h3><p>æœ¬ç« èŠ‚è®°å½•å†™åœ¨å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°ä¸€äº›SQLä¹¦å†™æ–¹æ³•æˆ–è€…æŠ€å·§ã€‚</p><h4 id="ç”¨Unionæ›¿ä»£Join"><a href="#ç”¨Unionæ›¿ä»£Join" class="headerlink" title="ç”¨Unionæ›¿ä»£Join"></a>ç”¨Unionæ›¿ä»£Join</h4><p>ä¸¤ç§æŠ•æ”¾ï¼Œä¸€ç§æ˜¯äººå·¥ï¼Œä¸€ç§æ˜¯ç®—æ³•ï¼Œæ¯ç§æŠ•æ”¾é’ˆå¯¹åŒä¸€ä¸ªAPPéƒ½ä¼šæœ‰å¤šä¸ªcampaignæ´»åŠ¨ï¼Œæ‰€æœ‰çš„campaignä¹‹é—´éƒ½å­˜åœ¨äº’ç›¸æŠ¢å çš„æƒ…å†µï¼Œç®—æ³•å’Œç®—æ³•æ´»åŠ¨ä¹‹é—´ï¼Œäººå·¥å’Œäººå·¥æ´»åŠ¨ä¹‹é—´ï¼Œç®—æ³•å’Œäººå·¥æ´»åŠ¨ä¹‹é—´ã€‚</p><p>éœ€æ±‚ï¼š</p><ol><li>ä¸¤ç§æŠ•æ”¾å„è‡ªçš„ç‚¹å‡»é‡ï¼ˆä¸å»é‡ï¼‰å’Œå®‰è£…çš„è®¾å¤‡æ•°é‡ï¼ˆå»é‡ï¼‰</li><li>ç®—æ³•æŠ¢å äººå·¥æŠ•æ”¾çš„è®¾å¤‡å»å……æ•°ï¼Œäººå·¥æŠ•æ”¾æŠ¢å ç®—æ³•çš„ï¼ˆæ³¨ï¼šæŠ¢å çš„å«ä¹‰æ˜¯ ç®—æ³•æŠ•æ”¾çš„è¢«æŸä¸€ä¸ªè®¾å¤‡idç‚¹å‡»è¿‡ï¼Œä½†æ˜¯å®‰è£…å½’å› åˆ°äº†äººå·¥æŠ•æ”¾ä¸Šï¼Œè¿™æ˜¯å› ä¸ºå¹¿å‘Šè¡Œä¸šçš„Last one clickåŸåˆ™ï¼‰</li><li>äººå·¥ä¸åŒæŠ•æ”¾æ´»åŠ¨ä¹‹é—´çš„æŠ¢å </li><li>äººå·¥ä¸åŒæŠ•æ”¾æ´»åŠ¨å’Œç®—æ³•ä¹‹é—´çš„æŠ¢å </li></ol><p>åŸºå‡†è¡¨ä¸¤å¼ ï¼Œåˆ†åˆ«æ˜¯clickä»¥åŠcallbackè¡¨ï¼Œå…¶ä¸­clickè¡¨åŒ…å«äº†ç®—æ³•äººå·¥æ‰€æœ‰çš„ç‚¹å‡»æ•°æ®ï¼Œcallbackè¡¨åŒ…å«äº†æ‰€æœ‰çš„å®‰è£…æ•°æ®ï¼Œåˆ¤æ–­æ˜¯ç®—æ³•è¿˜æ˜¯å®‰è£…æ˜¯é€šè¿‡ä¸¤å¼ è¡¨çš„ç®—æ³•åŒ…ç›¸å…³ä¿¡æ¯åˆ¤æ–­ã€‚</p><p>åˆšå¼€å§‹æˆ‘æƒ³çš„æ¯”è¾ƒç®€å•ï¼Œå…ˆå»ºç«‹ä¸¤å¼ ä¸´æ—¶è¡¨ï¼Œç®—æ³•ç‚¹å‡»å’Œå®‰è£…çš„æ•°æ®unionèµ·æ¥æ˜¯ä¸€å¼ ç®—æ³•è¡¨ï¼Œäººå·¥æŠ•æ”¾çš„ç‚¹å‡»å’Œå®‰è£…æ•°æ®unionä¹‹åæ˜¯äººå·¥è¡¨ï¼Œæ¥ä¸‹æ¥éœ€è¦çš„æ•°æ®å°±ä»è¿™ä¸¤å¼ è¡¨è¿›è¡ŒJoinå°±è¡Œäº†ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># ç®—æ³•è¡¨</span><br><span class="line"><span class="keyword">WITH</span> ml <span class="keyword">AS</span> (</span><br><span class="line"><span class="comment">-- ç®—æ³•ç‚¹å‡»</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           <span class="number">1</span> <span class="keyword">AS</span> type</span><br><span class="line">    <span class="keyword">FROM</span> dwd.click</span><br><span class="line">    <span class="keyword">WHERE</span> ml_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">UNION</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- ç®—æ³•å®‰è£…</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">           <span class="number">2</span> <span class="keyword">AS</span> type</span><br><span class="line">    <span class="keyword">FROM</span> dwd.callback</span><br><span class="line">    <span class="keyword">WHERE</span> ml_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>),</span><br><span class="line"># äººå·¥æŠ•æ”¾è¡¨</span><br><span class="line">    <span class="keyword">per</span> <span class="keyword">AS</span> (</span><br><span class="line"><span class="comment">-- äººå·¥ç‚¹å‡»   </span></span><br><span class="line">         <span class="keyword">SELECT</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                <span class="number">3</span> <span class="keyword">AS</span> type</span><br><span class="line">         <span class="keyword">FROM</span> dwd.click</span><br><span class="line">         <span class="keyword">WHERE</span> ml_id <span class="keyword">IS</span> <span class="keyword">NULL</span></span><br><span class="line">      </span><br><span class="line">         <span class="keyword">UNION</span></span><br><span class="line"><span class="comment">-- äººå·¥å®‰è£…</span></span><br><span class="line">         <span class="keyword">SELECT</span> <span class="operator">*</span><span class="operator">*</span><span class="operator">*</span></span><br><span class="line">                <span class="number">4</span> <span class="keyword">AS</span> type</span><br><span class="line">         <span class="keyword">FROM</span> dwd.callback</span><br><span class="line">         <span class="keyword">WHERE</span> ml_id <span class="keyword">IS</span> <span class="keyword">NULL</span>)</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚æˆ‘æƒ³è¦è®¡ç®— ç®—æ³•æŠ•æ”¾çš„è¢«äººå·¥æŠ¢å çš„æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘éœ€è¦è®¡ç®—äººå·¥çš„installçš„device_idå’Œç®—æ³•çš„clickä¸­çš„device_idè¿›è¡Œjoinæ±‚äº¤é›†ï¼Œè¿™äº›è®¾å¤‡å°±ç›¸å½“äºæ˜¯å®‰è£…å½’å› åˆ°äººå·¥ï¼Œä½†æ˜¯ç®—æ³•æ˜¯æŠ•æ”¾å¹¶è¢«ç‚¹å‡»è¿‡çš„è®¾å¤‡ï¼Œè€Œä¸”ç®—æ³•æˆ–è€…äººå·¥è¡¨ä¸­typeä¸åŒçš„æ—¶å€™ä»£è¡¨çš„æ•°æ®æ˜¯ä¸åŒçš„ï¼Œè¿™æ ·æˆ‘è¿˜éœ€è¦å°†å…¶æ‹†å¼€æˆä¸¤åˆ—ï¼Œåˆ†åˆ«æ˜¯ç‚¹å‡»æ•°æ®å’Œå®‰è£…æ•°æ®ï¼Œæ— å½¢ä¸­è¿˜å¢åŠ äº†å¾ˆå¤šé¢å¤–çš„å·¥ä½œã€‚</p><p>æŠ€æœ¯leaderåæ¥ç»™æˆ‘æä¾›æ€è·¯æ˜¯æˆ‘ä»¬åˆšå¼€å§‹çš„æ—¶å€™å°±æƒ³åŠæ³•åšæˆä¸€ä¸ªå¤§å®½è¡¨ï¼Œç„¶åå†è¿›è¡Œä¸€äº›æ“ä½œï¼Œç®€å•ç¤ºä¾‹ä¹‹åä»¤äººè±ç„¶å¼€æœ—ã€‚å…¶å®æˆ‘çš„æ€æƒ³è¿˜åœç•™åœ¨å…³ç³»å‹æ•°æ®è¡¨è¿›è¡Œè¡¨å…³è”ï¼Œleaderçš„æ€æƒ³æ›´è´´è¿‘äºæ•°ä»“ä¸­å®½è¡¨çš„æ€æƒ³ï¼Œå…·ä½“çš„æ“ä½œå°±æ˜¯æˆ‘ä»¬åœ¨åˆšå¼€å§‹çš„æ—¶å€™å°±æŠŠæ‰€æœ‰çš„æŒ‡æ ‡å’Œç»´åº¦æ”¾åˆ°ä¸€å¼ è¡¨ä¸­ï¼Œå¦‚æœä½ fromçš„è¿™å¼ è¡¨ä¸­æ²¡æœ‰è¿™ä¸ªæŒ‡æ ‡å€¼ï¼Œé‚£å°±å…ˆç»™ä»–0è¿™ç§ä¸å½±å“æˆ‘ä»¬æœ€ç»ˆèšåˆçš„é»˜è®¤å€¼ã€‚è¿™æ ·æ‰€æœ‰çš„æŒ‡æ ‡éƒ½è¢«æˆ‘ä»¬ç»“åˆåˆ°ä¸€å¼ è¡¨ä¸­äº†ï¼Œä¹‹åæˆ‘ä»¬å†è¿›è¡Œsumï¼Œå°†ä¸åŒçš„æŒ‡æ ‡è¿›è¡Œæ±‚å’Œï¼Œè¿™æ ·æŒ‡æ ‡å°±æ˜¯åœ¨æ‰€æœ‰ç»´åº¦ä¸‹è¿›è¡Œçš„ã€‚</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;Hiveç›¸å…³ç¬”è®°&lt;/p&gt;</summary>
    
    
    
    
    <category term="Hive" scheme="http://example.com/tags/Hive/"/>
    
  </entry>
  
  <entry>
    <title>è°“è¯ä¸‹æ¨</title>
    <link href="http://example.com/2022/06/07/%E8%B0%93%E8%AF%8D%E4%B8%8B%E6%8E%A8/"/>
    <id>http://example.com/2022/06/07/%E8%B0%93%E8%AF%8D%E4%B8%8B%E6%8E%A8/</id>
    <published>2022-06-07T14:28:55.000Z</published>
    <updated>2022-07-11T11:35:12.929Z</updated>
    
    <content type="html"><![CDATA[<p>å­¦ä¹ è°“è¯ä¸‹æ¨ç›¸å…³ç¬”è®°</p><span id="more"></span><h1 id="è°“è¯ä¸‹æ¨"><a href="#è°“è¯ä¸‹æ¨" class="headerlink" title="è°“è¯ä¸‹æ¨"></a>è°“è¯ä¸‹æ¨</h1><h2 id="è°“è¯"><a href="#è°“è¯" class="headerlink" title="è°“è¯"></a>è°“è¯</h2><p>â€‹    æ¦‚å¿µï¼šè®¡ç®—æœºç§‘å­¦ä¸­è°“è¯è§£é‡Šï¼Œè°“è¯ä¸æ˜¯åƒè¯­è¨€ä¸­çš„æŸä¸€ç§è¯æ€§ï¼Œæ¯”å¦‚è‹±è¯­ä¸­çš„åŠ¨è¯æˆ–è€…åè¯ï¼Œè°“è¯æ˜¯ä¸€ä¸ªè¿”å›å€¼ä¸ºçœŸã€å‡ã€æœªçŸ¥(True/False/Unknow)çš„å‡½æ•°ï¼Œä¸€èˆ¬æˆ‘ä»¬ä»¥å…ƒç´ åˆ—è¡¨çš„å½¢å¼åº”ç”¨äºç»™å®šçš„è°“è¯å‡½æ•°ï¼Œå¹¶ä¸”æ ¹æ®å‡½æ•°è¿”å›å€¼å†³å®šæ˜¯å¦è¿”å›è¯¥å…ƒç´ ï¼Œè¿™ä¸ªå‡½æ•°å°±å«åšè°“è¯ã€‚</p><p>â€‹    SQLä¸­å“ªäº›å¸¸è§çš„è°“è¯ï¼šLikeã€Betweenã€Is Nullã€Is Not Null ç­‰ç­‰</p><h2 id="ä¸‹æ¨"><a href="#ä¸‹æ¨" class="headerlink" title="ä¸‹æ¨"></a>ä¸‹æ¨</h2><p>â€‹    æ¦‚å¿µï¼š<strong>å°†è¿‡æ»¤è¡¨è¾¾å¼å°½å¯èƒ½ç§»åŠ¨è‡³é è¿‘æ•°æ®æºçš„ä½ç½®ï¼Œä»¥ä½¿çœŸæ­£æ‰§è¡Œæ—¶èƒ½ç›´æ¥è·³è¿‡æ— å…³çš„æ•°æ®ã€‚</strong></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># A,B ä¸¤è¡¨è¿›è¡Œ<span class="keyword">join</span>æ“ä½œ å¹¶ä¸”æœ‰è¿‡æ»¤æ¡ä»¶ A.a <span class="operator">&gt;</span> <span class="number">10</span> <span class="keyword">and</span> B.b <span class="operator">&lt;</span> <span class="number">100</span></span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">from</span> A <span class="keyword">Join</span> B <span class="keyword">on</span> A.id <span class="operator">=</span> B.id <span class="keyword">where</span> A.a <span class="operator">&gt;</span> <span class="number">10</span> <span class="keyword">and</span> B.b <span class="operator">&lt;</span> <span class="number">100</span>;</span><br></pre></td></tr></table></figure><p>â€‹    æ‰§è¡Œçš„æ—¶å€™ä¼šå…ˆå°†è¿‡æ»¤æ¡ä»¶å°½å¯èƒ½çš„å‰æï¼Œæ¯”å¦‚åˆ°å¯¹è¡¨è¿›è¡ŒTableScançš„æ—¶å€™è¿›è¡Œï¼Œåœ¨æå–æ¯ä¸€è¡Œæ•°æ®çš„æ—¶å€™ä¼šè¿›è¡Œä¸€ä¸ªåˆ¤æ–­è¯¥è¡¨æ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼Œå¦‚æœä¸æ»¡è¶³ç›´æ¥ä¸ä¼šè¯»å–ï¼Œæœ€åå†è¿›è¡ŒJoinæ“ä½œï¼Œè¿™æ ·å¯ä»¥å¤§å¤§é™ä½æ•°æ®é‡ï¼Œæ¯”å¦‚ä¸Šé¢ä¾‹å­æˆ‘ä»¬æ‰§è¡Œçš„æ—¶å€™ä¼˜åŒ–ç­›é€‰æ¡ä»¶ A.a &gt; 10 and B.b &lt; 100 æ”¾åˆ°æ‰«æè¡¨çš„æ—¶å€™è¿›è¡Œï¼Œå¯ä»¥æé«˜æ€§èƒ½ã€‚</p><p>â€‹    åƒParquetè¿™ç§ç‰¹æ®Šçš„æ ¼å¼å¯¹è°“è¯ä¸‹æ¨åšäº†ç‰¹æ®Šçš„å¤„ç† <a class="link"   href="https://docs.cloudera.com/documentation/enterprise/6/6.3/topics/cdh_ig_predicate_pushdown_parquet.html" >Parquetè°“è¯ä¸‹æ¨å‚è€ƒè¿æ¥<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    è¿™å—å€¼å¾—å±•å¼€å­¦ä¹ ï¼š</p><ol><li>Parquetè°“è¯ä¸‹æ¨å¦‚ä½•ä¼˜åŒ–</li><li>è¡Œå­˜å‚¨æ•°æ®åº“ä»¥åŠåˆ—å­˜å‚¨æ•°æ®åº“è°“è¯ä¸‹æ¨çš„æ–¹æ³•ä¸åŒã€‚</li></ol><h2 id="Outer-Joinä¸­çš„è°“è¯ä¸‹æ¨"><a href="#Outer-Joinä¸­çš„è°“è¯ä¸‹æ¨" class="headerlink" title="Outer Joinä¸­çš„è°“è¯ä¸‹æ¨"></a>Outer Joinä¸­çš„è°“è¯ä¸‹æ¨</h2><p>â€‹    å¦‚æœé˜…è¯»è‹±æ–‡æ–‡æ¡£æ²¡æœ‰é—®é¢˜æœ€å¥½é˜…è¯»ä¸€é<a class="link"   href="https://cwiki.apache.org/confluence/display/Hive/OuterJoinBehavior" >å®˜æ–¹æ–‡æ¡£<i class="fas fa-external-link-alt"></i></a></p><p>â€‹    åœ¨å¼„æ¸…æ¥šHiveå¦‚ä½•å¤„ç†è°“è¯ä¸‹æ¨ä¹‹å‰éœ€è¦ææ¸…æ¥šå››ä¸ªæ¦‚å¿µï¼š</p><p>â€‹    <strong>Preserved Row table</strong>ï¼šOuter Joinæ“ä½œä¸­å¿…é¡»è¿”å›æ‰€æœ‰è¡Œçš„è¡¨ï¼Œä¾‹å¦‚left joinçš„æ—¶å€™å·¦è¡¨å°±æ˜¯Preserved Row tableï¼Œç›¸å½“äºå›ºå®šä½äº†ä¸€ä¸ªè¡¨çš„å†…å®¹</p><p>â€‹    <strong>Null Supplying table</strong>ï¼šOuter Joinæ“ä½œä¸­<strong>ä¸ç”¨</strong>å¿…é¡»è¿”å›æ‰€æœ‰è¡Œçš„è¡¨ï¼Œæ¯”å¦‚left joinçš„æ—¶å€™å·¦è¡¨æ˜¯å…¨éƒ¨éƒ½è¦è¿”å›ï¼Œå½“å³è¡¨ä¸æ»¡è¶³onæ¡ä»¶çš„æ—¶å€™ä»–å°±ä¼šè¿”å›nullï¼Œæ‰€ä»¥å½¢è±¡çš„ç§°ä¸ºNull Supplying Table</p><p>â€‹    <strong>During Join predicate</strong>ï¼šæŒ‡joinâ€¦onâ€¦ä¸­çš„è°“è¯</p><p>â€‹    <strong>After Join predicate</strong>ï¼šæŒ‡åœ¨joinæ“ä½œåï¼Œwhereä¸­çš„è°“è¯</p><p>äº†è§£ä¸Šé¢å››ä¸ªæ¦‚å¿µä¹‹åï¼Œå¼€å§‹çœ‹ä¸€ä¸‹Hiveçš„è°“è¯ä¸‹æ¨åŸç†æ¦‚å¿µ(Predicate Pushdown PPD)</p><p>Hiveä¸­çš„è°“è¯ä¸‹æ¨ä¸»è¦æœ‰ä¸¤ä¸ªåŸç†ï¼Œä¸‹é¢æˆ‘ä»¬è®²è§£è¿™ä¸¤ä¸ªåŸç†</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Hive Predicate Pushdown</span></span><br><span class="line">During Join predicates cannot be pushed past Preserved Row tables.</span><br><span class="line">After Join predicates cannot be pushed past Null Supplying tables.</span><br></pre></td></tr></table></figure><ol><li><p><strong>During Join predicates</strong> cannot be pushed past <strong>Preserved Row tables</strong>.</p><p>åœ¨join..onâ€¦æ¡ä»¶ä¸­Preserved Row tablesè¡¨çš„è°“è¯ä¸èƒ½ä¸‹æ¨ï¼Œä¸¾ä¸€ä¸ªä¾‹å­å°±æ˜¯left joinçš„æ—¶å€™onä¸­çš„å·¦è¡¨çš„æ¡ä»¶ä¸èƒ½ä¸‹æ¨ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># E.eid<span class="operator">=</span><span class="string">&#x27;HZ001&#x27;</span>ä¸èƒ½ä¸‹æ¨ å› ä¸ºæ­¤æ—¶å·¦è¡¨éœ€è¦å…¨éƒ¨ä¿ç•™</span><br><span class="line"><span class="keyword">select</span> ename,dept_name <span class="keyword">from</span> E <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> D <span class="keyword">on</span> ( E.dept_id <span class="operator">=</span> D.dept_id <span class="keyword">and</span> E.eid<span class="operator">=</span><span class="string">&#x27;HZ001&#x27;</span>);</span><br></pre></td></tr></table></figure></li><li><p><strong>After Join predicates</strong> cannot be pushed past <strong>Null Supplying tables</strong>.</p><p>åœ¨After Join predicateä¸­ Null Supplying tablesè¡¨çš„è°“è¯æ˜¯ä¸èƒ½ä¸‹æ¨çš„ï¼Œè¿™ä¸ªä¹Ÿæ¯”è¾ƒå¥½ç†è§£ï¼Œè¿˜æ˜¯ä»¥left joinä¸¾ä¾‹ï¼Œå·¦å…³è”çš„æ—¶å€™å·¦è¡¨å…¨éƒ¨ä¿ç•™ï¼Œå³è¡¨æ•°æ®æ˜¯å¦ä¿ç•™åº”è¯¥å–å†³äºonä¸­çš„å…³è”æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œå…¶æ¬¡å–å†³äºwhereä¸­å³è¡¨æ¡ä»¶ï¼Œè€Œä¸èƒ½å…ˆä½¿ç”¨whereä¸­å³è¡¨çš„æ¡ä»¶è¿‡æ»¤å³è¡¨æ•°æ®ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># D.dept_id<span class="operator">=</span><span class="string">&#x27;D001&#x27;</span> ä¸èƒ½ä¸‹æ¨ å› ä¸ºæ­¤æ—¶å³è¡¨æ•°æ®åº”å–å†³äº<span class="keyword">on</span>ä¸­å…³è”</span><br><span class="line"><span class="keyword">select</span> ename,dept_name <span class="keyword">from</span> E <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> D <span class="keyword">on</span> E.dept_id <span class="operator">=</span> D.dept_id <span class="keyword">where</span> D.dept_id<span class="operator">=</span><span class="string">&#x27;D001&#x27;</span>;</span><br></pre></td></tr></table></figure></li><li><p>Full Outer Joinå½¢å¼æ˜¯ä»»ä½•æ¡ä»¶éƒ½ä¸èƒ½ä¸‹æ¨è°“è¯ï¼Œå› ä¸ºéœ€è¦å·¦å³ä¸¤è¡¨å…¨éƒ½ä¿ç•™æ•°æ®</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># <span class="keyword">full</span> <span class="keyword">outer</span> <span class="keyword">join</span> ä»»ä½•æ¡ä»¶éƒ½ä¸èƒ½ä¸‹æ¨ ä¸‹é¢å››ä¸ªéƒ½ä¸èƒ½ä¸‹æ¨</span><br><span class="line"><span class="keyword">select</span> ename,dept_name <span class="keyword">from</span> E <span class="keyword">full</span> <span class="keyword">outer</span> <span class="keyword">join</span> D <span class="keyword">on</span> ( E.dept_id <span class="operator">=</span> D.dept_id <span class="keyword">and</span> E.eid<span class="operator">=</span><span class="string">&#x27;HZ001&#x27;</span>);</span><br><span class="line"><span class="keyword">select</span> ename,dept_name <span class="keyword">from</span> E <span class="keyword">full</span> <span class="keyword">outer</span> <span class="keyword">join</span> D <span class="keyword">on</span> E.dept_id <span class="operator">=</span> D.dept_id <span class="keyword">where</span> E.eid<span class="operator">=</span><span class="string">&#x27;HZ001&#x27;</span>;</span><br><span class="line"><span class="keyword">select</span> ename,dept_name <span class="keyword">from</span> E <span class="keyword">full</span> <span class="keyword">outer</span> <span class="keyword">join</span> D <span class="keyword">on</span> ( E.dept_id <span class="operator">=</span> D.dept_id <span class="keyword">and</span> D.dept_id<span class="operator">=</span><span class="string">&#x27;D001&#x27;</span>);</span><br><span class="line"><span class="keyword">select</span> ename,dept_name <span class="keyword">from</span> E <span class="keyword">full</span> <span class="keyword">outer</span> <span class="keyword">join</span> D <span class="keyword">on</span> E.dept_id <span class="operator">=</span> D.dept_id <span class="keyword">where</span> D.dept_id<span class="operator">=</span><span class="string">&#x27;D001&#x27;</span>;</span><br></pre></td></tr></table></figure></li></ol><h2 id="Inner-Joinä¸­çš„è°“è¯ä¸‹æ¨"><a href="#Inner-Joinä¸­çš„è°“è¯ä¸‹æ¨" class="headerlink" title="Inner Joinä¸­çš„è°“è¯ä¸‹æ¨"></a>Inner Joinä¸­çš„è°“è¯ä¸‹æ¨</h2><p>â€‹    å¯¹äºinner joinæƒ…å†µï¼Œå› ä¸ºå·¦å³è¡¨éƒ½ä¸æ˜¯Preserved Row table æˆ–è€…Null Supplying tableï¼Œéƒ½éœ€è¦è¢«æ¡ä»¶è¿‡æ»¤ï¼Œæ­¤æ—¶During Join predicateæ¡ä»¶çš„è°“è¯å…¨éƒ½å¯ä»¥å‰æï¼Œä¹Ÿå°±æ˜¯join onä¸­æ¡ä»¶ï¼ŒåŒæ—¶After Join predicateï¼Œä¹Ÿå°±æ˜¯whereä¸­çš„æ¡ä»¶ä¹Ÿå¯ä»¥è¢«å‰ç½®ã€‚</p><p>å‚è€ƒæ–‡çŒ®ï¼š</p><p><a class="link"   href="https://blog.csdn.net/strongyoung88/article/details/81156271" >https://blog.csdn.net/strongyoung88/article/details/81156271<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://cwiki.apache.org/confluence/display/Hive/OuterJoinBehavior" >https://cwiki.apache.org/confluence/display/Hive/OuterJoinBehavior<i class="fas fa-external-link-alt"></i></a></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;å­¦ä¹ è°“è¯ä¸‹æ¨ç›¸å…³ç¬”è®°&lt;/p&gt;</summary>
    
    
    
    
    <category term="Sql" scheme="http://example.com/tags/Sql/"/>
    
  </entry>
  
  <entry>
    <title>goè¯­è¨€ç¬”è®°</title>
    <link href="http://example.com/2022/06/02/Go%E8%AF%AD%E8%A8%80%E7%AC%94%E8%AE%B0/"/>
    <id>http://example.com/2022/06/02/Go%E8%AF%AD%E8%A8%80%E7%AC%94%E8%AE%B0/</id>
    <published>2022-06-02T10:24:49.000Z</published>
    <updated>2022-06-15T03:22:02.511Z</updated>
    
    <content type="html"><![CDATA[<p>goè¯­è¨€å­¦ä¹ ç¬”è®°</p><span id="more"></span><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>å› ä¸ºæˆ‘æ˜¯Macæœ¬ï¼Œæ‰€ä»¥åœ¨å®‰è£…goä»¥åŠbeegoä¸Šåƒäº†ä¸å°‘äºï¼Œç½‘ä¸Šå¤§å¤šéƒ½æ˜¯é’ˆå¯¹Windowsæˆ–è€…Linuxæ¥å®‰è£…ï¼Œè¿™é‡Œæ€»ç»“ä¸€ä¸‹æ•™è®­ï¼Œå¦‚æœä½ éMacå¯ä»¥å¿½ç•¥è¿™ä¸€ç‚¹ã€‚</p><p><strong>æ³¨æ„ï¼š</strong></p><ol><li><p>Macæœ¬å®‰è£…goçš„æ—¶å€™å¯ä»¥ç”¨<a class="link"   href="https://go.dev/dl/" >å®˜ç½‘ä¸‹è½½<i class="fas fa-external-link-alt"></i></a>å®‰è£…åŒ…çš„æ–¹å¼ï¼Œæ³¨æ„m1çš„macéœ€è¦é€‰armæ¶æ„çš„ä¸‹è½½åŒ…ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼æˆ‘åœ¨å®‰è£…beegoçš„æ—¶å€™å‡ºç°é—®é¢˜ï¼Œæ‰§è¡Œå®Œä¸‹é¢çš„å®‰è£…å‘½ä»¤ä¹‹åæˆ‘çš„$GOPATH/binä¸‹é¢<strong>ä¸ä¼šå‡ºç°</strong>beeå¯æ‰§è¡Œæ–‡ä»¶ï¼Œç›¸å½“äºæ˜¾ç¤ºå®‰è£…æˆåŠŸä½†æ˜¯æ²¡æœ‰ç»“æœï¼Œç»è¿‡è®¸ä¹…æ¢ç´¢æ— æœï¼Œé‚å†³å®šæ›´æ¢homebrewå®‰è£…go &amp; beegoã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> install beego &amp;&amp; bee</span></span><br><span class="line">go get github.com/astaxie/beego</span><br><span class="line">go get github.com/beego/bee</span><br></pre></td></tr></table></figure></li><li><p>æ”¹ç”¨homebrewå®‰è£…go</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> install go with home brew</span></span><br><span class="line">brew install go</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ‰¾åˆ°goå®‰è£…è·¯å¾„</span></span><br><span class="line">brew list go</span><br><span class="line"></span><br><span class="line">/opt/homebrew/Cellar/go/1.17.2/bin/go</span><br><span class="line">/opt/homebrew/Cellar/go/1.17.2/bin/gofmt</span><br><span class="line">/opt/homebrew/Cellar/go/1.17.2/libexec/api/ (21 files)</span><br><span class="line">/opt/homebrew/Cellar/go/1.17.2/libexec/bin/ (2 files)</span><br><span class="line">/opt/homebrew/Cellar/go/1.17.2/libexec/doc/ (4 files)</span><br><span class="line">/opt/homebrew/Cellar/go/1.17.2/libexec/lib/ (3 files)</span><br><span class="line">/opt/homebrew/Cellar/go/1.17.2/libexec/misc/ (371 files)</span><br><span class="line">/opt/homebrew/Cellar/go/1.17.2/libexec/pkg/ (669 files)</span><br><span class="line">/opt/homebrew/Cellar/go/1.17.2/libexec/src/ (7192 files)</span><br><span class="line">/opt/homebrew/Cellar/go/1.17.2/libexec/test/ (2539 files)</span><br><span class="line">/opt/homebrew/Cellar/go/1.17.2/libexec/ (6 files)</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> è®¾ç½®goç›¸å…³çš„ç¯å¢ƒå˜é‡ ä¿®æ”¹ä½ æ‰€ä½¿ç”¨çš„bash</span></span><br><span class="line">vim ~/.zshrc</span><br><span class="line"><span class="meta">#</span><span class="bash"> åœ¨æœ«å°¾æ·»åŠ goç¯å¢ƒå˜é‡ æ³¨æ„æŠŠè·¯å¾„ä¿®æ”¹ä¸ºä½ çš„goå®‰è£…è·¯å¾„</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> GOROOT</span></span><br><span class="line">export GOROOT=/opt/homebrew/Cellar/go/1.17.2/libexec</span><br><span class="line"><span class="meta">#</span><span class="bash"> GOPATH</span></span><br><span class="line">export GOPATH=$HOME/go</span><br><span class="line"><span class="meta">#</span><span class="bash"> Bin</span></span><br><span class="line">export PATH=$&#123;PATH&#125;:$GOPATH/bin</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„ Bin(export PATH=${PATH}:$GOPATH/bin) å°±æ˜¯æˆ‘ä»¬å®‰è£…beegoä¼šåœ¨ä¸‹é¢ç”Ÿæˆbeeå¯æ‰§è¡Œæ–‡ä»¶</p></li><li><p>å®‰è£…beego</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å®‰è£…å®Œæˆä¹‹åbeeå¯æ‰§è¡Œæ–‡ä»¶ç”Ÿæˆåœ¨<span class="variable">$GOPATH</span>/binä¸‹</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> å¦‚æœæ‰§è¡Œå¤±è´¥è¯•è¯•å…ˆæ‰§è¡Œ go env -w GO111MODULE=on æ‰“å¼€go moduleåœ¨å®‰è£…</span></span><br><span class="line">go get github.com/beego/bee</span><br></pre></td></tr></table></figure><p>è¿™æ¬¡å®‰è£…å®Œæˆä¹‹åä¼šåœ¨GOPATH/binä¸‹å‡ºç°beeå¯æ‰§è¡Œå‘½ä»¤ï¼Œå¹¶ä¸”ç»ˆç«¯ç›´æ¥è¾“å…¥beeä¹Ÿä¼šè¾“å‡ºbeeç›¸å…³ä¿¡æ¯</p><img src="/2022/06/02/Go%E8%AF%AD%E8%A8%80%E7%AC%94%E8%AE%B0/bee.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"></li><li><p>ç›®å‰goæ¨èä½¿ç”¨go moduleè¿™ä¸ªè‡ªå¸¦çš„goä¾èµ–ç®¡ç†åº“ï¼Œé…ç½®GO111MODULE=trueæ‰“å¼€ï¼Œé»˜è®¤å°±æ˜¯æ‰“å¼€ï¼Œå…³äºgo moduleçš„è¯¦ç»†èµ„æ–™å¯ä»¥<a class="link"   href="https://www.cnblogs.com/wongbingming/p/12941021.html" >çœ‹è¿™é‡Œ<i class="fas fa-external-link-alt"></i></a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go env -w GO111MODULE=on</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºé¡¹ç›®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> åˆ›å»ºé¡¹ç›®</span></span><br><span class="line">bee new hello</span><br><span class="line">cd $GOPATH/src/hello/</span><br><span class="line">go get hello</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¿è¡Œé¡¹ç›®</span></span><br><span class="line">cd $GOPATH/src/hello/</span><br><span class="line">bee run</span><br></pre></td></tr></table></figure></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;goè¯­è¨€å­¦ä¹ ç¬”è®°&lt;/p&gt;</summary>
    
    
    
    
    <category term="Go" scheme="http://example.com/tags/Go/"/>
    
  </entry>
  
  <entry>
    <title>StarRocksç¬”è®°</title>
    <link href="http://example.com/2022/05/24/StarRocks%E7%AC%94%E8%AE%B0/"/>
    <id>http://example.com/2022/05/24/StarRocks%E7%AC%94%E8%AE%B0/</id>
    <published>2022-05-24T09:46:23.000Z</published>
    <updated>2022-06-15T03:23:07.596Z</updated>
    
    <content type="html"><![CDATA[<p>å¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´</p><span id="more"></span><h3 id="ä»€ä¹ˆæ˜¯StarRocks"><a href="#ä»€ä¹ˆæ˜¯StarRocks" class="headerlink" title="ä»€ä¹ˆæ˜¯StarRocks"></a>ä»€ä¹ˆæ˜¯StarRocks</h3><p>StarRocks æ˜¯<strong>æ–°ä¸€ä»£æé€Ÿå…¨åœºæ™¯MPPæ•°æ®åº“</strong>ã€‚StarRocks çš„æ„¿æ™¯æ˜¯èƒ½å¤Ÿè®©ç”¨æˆ·çš„<strong>æ•°æ®åˆ†æå˜å¾—æ›´åŠ ç®€å•å’Œæ•æ·</strong>ã€‚ç”¨æˆ·æ— éœ€ç»è¿‡å¤æ‚çš„é¢„å¤„ç†ï¼Œå°±å¯ä»¥ç”¨ StarRocks æ¥æ”¯æŒå¤šç§æ•°æ®åˆ†æåœºæ™¯çš„æé€Ÿåˆ†æã€‚</p><img src="/2022/05/24/StarRocks%E7%AC%94%E8%AE%B0/%E6%9E%B6%E6%9E%84.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><h3 id="StarRocksé€‚ç”¨å“ªäº›åœºæ™¯"><a href="#StarRocksé€‚ç”¨å“ªäº›åœºæ™¯" class="headerlink" title="StarRocksé€‚ç”¨å“ªäº›åœºæ™¯"></a>StarRocksé€‚ç”¨å“ªäº›åœºæ™¯</h3><p>StarRocks å¯ä»¥æ»¡è¶³ä¼ä¸šçº§ç”¨æˆ·çš„å¤šç§åˆ†æéœ€æ±‚ï¼ŒåŒ…æ‹¬ OLAP å¤šç»´åˆ†æã€å®šåˆ¶æŠ¥è¡¨ã€å®æ—¶æ•°æ®åˆ†æå’Œ Ad-hoc æ•°æ®åˆ†æç­‰ã€‚</p><h3 id="StarRocksä¸‰ç§æ•°æ®æ¨¡å‹"><a href="#StarRocksä¸‰ç§æ•°æ®æ¨¡å‹" class="headerlink" title="StarRocksä¸‰ç§æ•°æ®æ¨¡å‹"></a>StarRocksä¸‰ç§æ•°æ®æ¨¡å‹</h3><p>StarRocksæ ¹æ®æ•°æ®æ‘„å…¥æ—¶å€™çš„æ˜ å°„å…³ç³»ï¼Œåˆ†ä¸ºäº†ä¸‰ç§æ•°æ®å…³ç³»ï¼Œåˆ†åˆ«æ˜¯æ˜ç»†ã€èšåˆã€ä»¥åŠæ›´æ–°æ•°æ®å…³ç³»ï¼Œä¸‰ç§æ•°æ®å…³ç³»åœ¨StarRocksä¸­åˆ†åˆ«å¯¹åº”ç€ä¸åŒçš„æ•°æ®æ¨¡å‹:</p><p>æ˜ç»†è¡¨å¯¹åº”æ˜ç»†æ¨¡å‹ï¼ˆDuplicate Keyï¼‰</p><p>èšåˆè¡¨å¯¹åº”èšåˆæ¨¡å‹ï¼ˆAggregate Keyï¼‰</p><p>æ›´æ–°è¡¨å¯¹åº”æ›´æ–°æ¨¡å‹ï¼ˆUnique Keyï¼‰å’Œä¸»é”®æ¨¡å‹ï¼ˆPrimary Keyï¼‰</p><h4 id="æ˜ç»†æ¨¡å‹ï¼ˆDuplicate-Keyï¼‰"><a href="#æ˜ç»†æ¨¡å‹ï¼ˆDuplicate-Keyï¼‰" class="headerlink" title="æ˜ç»†æ¨¡å‹ï¼ˆDuplicate Keyï¼‰"></a>æ˜ç»†æ¨¡å‹ï¼ˆDuplicate Keyï¼‰</h4><ol><li><p>éœ€è¦ä¿ç•™åŸå§‹çš„æ•°æ®ï¼ˆä¾‹å¦‚åŸå§‹æ—¥å¿—ï¼ŒåŸå§‹æ“ä½œè®°å½•ç­‰ï¼‰æ¥è¿›è¡Œåˆ†æï¼›</p></li><li><p>æŸ¥è¯¢æ–¹å¼çµæ´», ä¸å±€é™äºé¢„å…ˆå®šä¹‰çš„åˆ†ææ–¹å¼, ä¼ ç»Ÿçš„é¢„èšåˆæ–¹å¼éš¾ä»¥å‘½ä¸­;</p></li><li><p>æ•°æ®æ›´æ–°ä¸é¢‘ç¹ã€‚å¯¼å…¥æ•°æ®çš„æ¥æºä¸€èˆ¬ä¸ºæ—¥å¿—æ•°æ®æˆ–è€…æ˜¯æ—¶åºæ•°æ®,  ä»¥è¿½åŠ å†™ä¸ºä¸»è¦ç‰¹ç‚¹, æ•°æ®äº§ç”Ÿåå°±ä¸ä¼šå‘ç”Ÿå¤ªå¤šå˜åŒ–ã€‚</p><p><strong>æ³¨æ„ï¼š</strong>æ˜ç»†æ¨¡å‹ä¸ä¼šæ ¹æ®è®¾ç½®çš„ä¸»é”®è¦†ç›–æ•°æ®ï¼Œå¯¼å…¥å®Œå…¨ç›¸åŒçš„ä¸¤è¡Œæ•°æ®ä¹Ÿä¼šè®¤ä¸ºæ˜¯ä¸åŒçš„ä¸¤è¡Œæ’å…¥è¿›æ¥ï¼Œæ¯”å¦‚æˆ‘ä»¬æ—¥å¿—ä¸­ç»å¸¸å‡ºç°å«ä¹‰ç›¸åŒçš„ä¿¡æ¯ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸€èˆ¬ä¸ä¼šå¸Œæœ›å­˜åœ¨è¦†ç›–çš„æƒ…å†µã€‚</p></li></ol><h4 id="èšåˆæ¨¡å‹ï¼ˆAggregate-Keyï¼‰"><a href="#èšåˆæ¨¡å‹ï¼ˆAggregate-Keyï¼‰" class="headerlink" title="èšåˆæ¨¡å‹ï¼ˆAggregate Keyï¼‰"></a>èšåˆæ¨¡å‹ï¼ˆAggregate Keyï¼‰</h4><ul><li><p>åˆ†æç½‘ç«™æˆ–APPè®¿é—®æµé‡ï¼Œç»Ÿè®¡ç”¨æˆ·çš„è®¿é—®æ€»æ—¶é•¿ã€è®¿é—®æ€»æ¬¡æ•°;</p></li><li><p>å¹¿å‘Šå‚å•†ä¸ºå¹¿å‘Šä¸»æä¾›çš„å¹¿å‘Šç‚¹å‡»æ€»é‡ã€å±•ç¤ºæ€»é‡ã€æ¶ˆè´¹ç»Ÿè®¡ç­‰;</p></li><li><p>åˆ†æç”µå•†çš„å…¨å¹´çš„äº¤æ˜“æ•°æ®, è·å¾—æŸæŒ‡å®šå­£åº¦æˆ–è€…æœˆä»½çš„, å„äººå£åˆ†ç±»(geographic)çš„çˆ†æ¬¾å•†å“ã€‚</p><p><strong>æ³¨æ„ï¼š</strong></p><p>1.åªè¦æ˜¯æŒ‡å®šèšåˆå‡½æ•°çš„å­—æ®µå³è§†ä¸ºæŒ‡æ ‡åˆ—ï¼Œè¡¨å³è§†ä¸ºèšåˆè¡¨ï¼Œèšåˆè¡¨ä¸­ä¸å¸¦èšåˆå‡½æ•°çš„åˆ—å³ä¸ºç»´åº¦åˆ—</p><p>2.å»ºè¡¨è¯­å¥ä¸­ç»´åº¦åˆ—å¿…é¡»åœ¨æŒ‡æ ‡åˆ—å‰é¢</p><p>3.èšåˆæ¨¡å‹æ˜¯æ ¹æ®æŒ‰ç…§ç›¸åŒçš„æŒ‡æ ‡åˆ—è¿›è¡Œèšåˆï¼Œå¤šæ¡æ•°æ®å…·æœ‰ç›¸åŒçš„ç»´åº¦åˆ—çš„æ—¶å€™ï¼Œä¼šæŒ‰ç…§èšåˆå‡½æ•°å°†æŒ‡æ ‡åˆ—æ•°æ®è¿›è¡Œèšåˆï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ•°æ®é‡</p><p>4.è§¦å‘æ•°æ®èšåˆæœ‰ä¸‰ç§æ–¹å¼ : </p><p>(1)æ•°æ®å¯¼å…¥æ—¶ï¼Œæ•°æ®è½ç›˜å‰çš„èšåˆ </p><p>(2) æ•°æ®è½ç›˜åï¼Œåå°çš„å¤šç‰ˆæœ¬å¼‚æ­¥èšåˆ </p><p>(3)æ•°æ®æŸ¥è¯¢æ—¶ï¼Œå¤šç‰ˆæœ¬å¤šè·¯å½’å¹¶èšåˆ</p></li></ul><h4 id="æ›´æ–°æ¨¡å‹-Unique-Key-amp-Primary-Key"><a href="#æ›´æ–°æ¨¡å‹-Unique-Key-amp-Primary-Key" class="headerlink" title="æ›´æ–°æ¨¡å‹(Unique Key &amp; Primary Key)"></a>æ›´æ–°æ¨¡å‹(Unique Key &amp; Primary Key)</h4><p><a class="link"   href="https://docs.starrocks.com/zh-cn/main/table_design/Data_model#%E6%9B%B4%E6%96%B0%E6%A8%A1%E5%9E%8B" >Unique Key å®˜ç½‘è®²è§£<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://docs.starrocks.com/zh-cn/main/table_design/Data_model#%E4%B8%BB%E9%94%AE%E6%A8%A1%E5%9E%8B" >Primary Keyå®˜ç½‘è®²è§£<i class="fas fa-external-link-alt"></i></a></p><p><strong>æ³¨æ„:</strong></p><p>å³ Unique æ¨¡å‹å®Œå…¨å¯ä»¥ç”¨èšåˆæ¨¡å‹ä¸­çš„ REPLACE æ–¹å¼æ›¿ä»£ã€‚</p><p>Primary Keyæ¨¡å‹æ˜¯starrockså…¨æ–°è®¾è®¡æ¨¡å‹ï¼Œä¸»é”®æ¨¡å‹çš„è¡¨è¦æ±‚æœ‰å”¯ä¸€çš„ä¸»é”®ï¼Œæ”¯æŒå¯¹è¡¨ä¸­çš„è¡ŒæŒ‰ä¸»é”®è¿›è¡Œæ›´æ–°å’Œåˆ é™¤æ“ä½œã€‚ç›¸è¾ƒæ›´æ–°æ¨¡å‹ï¼Œä¸»é”®æ¨¡å‹å¯ä»¥æ›´å¥½åœ°æ”¯æŒ<strong>å®æ—¶å’Œé¢‘ç¹æ›´æ–°</strong>ç­‰åœºæ™¯ã€‚</p><h3 id="StarRocksè¡¨è®¾è®¡"><a href="#StarRocksè¡¨è®¾è®¡" class="headerlink" title="StarRocksè¡¨è®¾è®¡"></a>StarRocksè¡¨è®¾è®¡</h3><p>StarRockså’Œå…¶ä»–OLAPæ•°æ®åº“å­˜å‚¨è®¾è®¡ç±»ä¼¼ï¼Œé‡‡ç”¨çš„åˆ—å¼å­˜å‚¨ï¼Œå¯ä»¥æé«˜æ•°æ®æŸ¥è¯¢æ•ˆç‡ï¼Œæ¯ä¸€åˆ—çš„æ•°æ®ç±»å‹ä¸€è‡´ï¼Œè¿™æ ·å¯ä»¥æé«˜æ•°æ®çš„å‹ç¼©ç‡ï¼Œ</p><p>StarRocksçš„æ•°æ®åˆ—å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯ç»´åº¦åˆ—ä»¥åŠæŒ‡æ ‡åˆ—ï¼Œç»´åº¦åˆ—ç”¨äºåˆ†ç»„å’Œæ’åºï¼ŒæŒ‡æ ‡åˆ—é€šè¿‡èšåˆå‡½æ•°åœ¨ç»´åº¦åˆ—åŸºç¡€ä¸Šè¿›è¡ŒSUMï¼ŒCOUNTï¼ŒBITMAP_UNIONç­‰æ“ä½œã€‚</p><img src="/2022/05/24/StarRocks%E7%AC%94%E8%AE%B0/SR%E8%A1%A8%E7%BB%93%E6%9E%84.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><h4 id="å‰ç¼€ç´¢å¼•"><a href="#å‰ç¼€ç´¢å¼•" class="headerlink" title="å‰ç¼€ç´¢å¼•"></a>å‰ç¼€ç´¢å¼•</h4><p>Doris ä¸æ”¯æŒåœ¨ä»»æ„åˆ—ä¸Šåˆ›å»ºç´¢å¼•ï¼Œæœ¬è´¨ä¸Šï¼ŒDoris çš„æ•°æ®å­˜å‚¨åœ¨ç±»ä¼¼ SSTableï¼ˆSorted String Tableï¼‰çš„æ•°æ®ç»“æ„ä¸­ã€‚è¯¥ç»“æ„æ˜¯ä¸€ç§æœ‰åºçš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥æŒ‰ç…§æŒ‡å®šçš„åˆ—è¿›è¡Œæ’åºå­˜å‚¨ã€‚åœ¨è¿™ç§æ•°æ®ç»“æ„ä¸Šï¼Œä»¥æ’åºåˆ—ä½œä¸ºæ¡ä»¶è¿›è¡ŒæŸ¥æ‰¾ï¼Œä¼šéå¸¸çš„é«˜æ•ˆã€‚</p><p>æ¯”å¦‚æˆ‘ä»¬å»ºç«‹çš„å‰ç¼€ç´¢å¼•ä¸º(user_id,age,message)ï¼Œé‚£ä¹ˆä¸‹é¢ç¬¬ä¸€ç§æŸ¥è¯¢è¦æ¯”ç¬¬äºŒç§å¿«å¾—å¤š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># å‘½ä¸­ç´¢å¼•</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> user_id<span class="operator">=</span><span class="number">1829239</span> <span class="keyword">and</span> age<span class="operator">=</span><span class="number">20</span>ï¼›</span><br><span class="line"># æ²¡æœ‰å‘½ä¸­ç´¢å¼•</span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="keyword">WHERE</span> age<span class="operator">=</span><span class="number">20</span>ï¼›</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ç´¢å¼•æ–‡ä»¶çš„ç»“æ„</p><img src="/2022/05/24/StarRocks%E7%AC%94%E8%AE%B0/StarRocks%E8%A1%A8%E7%B4%A2%E5%BC%95.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>æ¯ä¸ªéƒ¨åˆ†çš„æè¿°ä¸è¯¦ç»†åŠŸèƒ½ï¼š</p><p><strong>short key indexè¡¨:</strong></p><p>ç¨€ç–ç´¢å¼•å’Œè¡Œå·ä¹‹é—´çš„å¯¹åº”å…³ç³»ï¼Œé¦–å…ˆè¡¨ä¸­æ•°æ®ä¼šæŒ‰ç…§æ’åºé”®è¿›è¡Œæ’åºï¼Œç„¶åæ¯1024è¡Œä¼šæ„æˆä¸€ä¸ªé€»è¾‘å—ï¼Œå¹¶ä¸”è·å¾—ä¸€ä¸ªshortkey indexï¼Œè¿™ä¸ªkeyæ˜¯ç”±æ’åºé”®è¿›è¡Œæ‹¼æ¥è€Œæˆï¼Œä¸ä¼šè¶…è¿‡36ä¸ªå­—èŠ‚ï¼Œæˆ‘ä»¬åœ¨æŸ¥è¯¢çš„æ—¶å€™é¦–å…ˆä¼šæ ¹æ®è¦æŸ¥è¯¢çš„æ’åºé”®å€¼æ¥ç¡®å®šæ‰€å±çš„æ•°æ®å—çš„è¡Œå·ï¼Œè¿™ä¸ªè¡Œå·å°±æ˜¯æ•°æ®åœ¨ç¬¬å¤šå°‘è¡Œã€‚</p><p> <strong>Per-column cardinal index:</strong> </p><p>åˆ—å¼å­˜å‚¨ï¼Œåˆ—ä¸åˆ—ä¹‹é—´æ˜¯ç‹¬ç«‹å­˜å‚¨ï¼Œæ‰€ä»¥æ¯åˆ—éƒ½ä¼šæœ‰ä¸€ä¸ªè‡ªå·±çš„è¡Œå·å’Œå—å·çš„å¯¹åº”å…³ç³»ï¼Œåˆ’åˆ†å—æ˜¯é€šè¿‡æ¯å—å¤§æ¦‚æ˜¯64kbæ¥è¿›è¡Œåˆ’åˆ†ï¼Œæ ¹æ®å‰é¢æ‰¾åˆ°çš„è¡Œå·æ‰¾åˆ°å¯¹åº”çš„æ•°æ®å—åœ°å€</p><p><strong>Per-column data blocks:</strong></p><p>è¡¨ä¸­æ¯ä¸€åˆ—æ•°æ®æŒ‰64KBåˆ†å—å­˜å‚¨ï¼Œæ ¹æ®å‰é¢æ‰¾åˆ°çš„æ•°æ®å—åœ°å€å°±å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„å—å†…å®¹äº†ã€‚</p><p><strong>æ³¨æ„:</strong></p><p>è¿™ç§ä½¿ç”¨èŒƒå›´æŸ¥æ‰¾çš„éœ€è¦æœ‰å‰ææ¡ä»¶ï¼Œå°±æ˜¯æŸ¥è¯¢æ—¶, å¦‚æœæŒ‡å®šäº†ç»´åº¦åˆ—çš„<strong>ç­‰å€¼æ¡ä»¶</strong>æˆ–è€…<strong>èŒƒå›´æ¡ä»¶</strong>, å¹¶ä¸”è¿™äº›æ¡ä»¶ä¸­ç»´åº¦åˆ—<strong>å¯æ„æˆè¡¨ç»´åº¦åˆ—çš„å‰ç¼€</strong>, åˆ™å¯ä»¥åˆ©ç”¨æ•°æ®çš„æœ‰åºæ€§</p><p>ä½¿ç”¨ç´¢å¼•èŒƒå›´æŸ¥æ‰¾çš„æ¡ä»¶:</p><p>ï¼ˆ1ï¼‰ç»´åº¦åˆ—çš„ç­‰å€¼æˆ–è€…èŒƒå›´æ¡ä»¶ï¼Œåƒ in (â€¦) è¿™ç§æ˜¯ä¸èƒ½ç´¢å¼•</p><p>ï¼ˆ2ï¼‰æ¡ä»¶ä¸­çš„ç»´åº¦åˆ—å¯ä»¥æ„æˆå‰ç¼€</p><p>Eg: å¯¹äºè¡¨table1: (event_day, siteid, citycode, username)âœ(pv); å½“æŸ¥è¯¢æ¡ä»¶ä¸ºevent_day &gt; 2020-09-18 and siteid = 2, åˆ™å¯ä»¥ä½¿ç”¨èŒƒå›´æŸ¥æ‰¾; å¦‚æœæŒ‡å®šæ¡ä»¶ä¸ºcitycode = 4 and username in [â€œAndyâ€, â€œBobyâ€, â€œChristianâ€, â€œStarRocksâ€], åˆ™æ— æ³•ä½¿ç”¨èŒƒå›´æŸ¥æ‰¾ï¼Œæˆ–è€…æŸ¥è¯¢æ¡ä»¶æ˜¯ where code = 4è¿™ç§ä¹Ÿæ˜¯ä¸èƒ½é€‚ç”¨èŒƒå›´æŸ¥æ‰¾ï¼Œæ²¡æœ‰å‘½ä¸­ã€‚</p><h3 id="RollUpä»¥åŠç‰©åŒ–è§†å›¾"><a href="#RollUpä»¥åŠç‰©åŒ–è§†å›¾" class="headerlink" title="RollUpä»¥åŠç‰©åŒ–è§†å›¾"></a>RollUpä»¥åŠç‰©åŒ–è§†å›¾</h3><h4 id="Rollup"><a href="#Rollup" class="headerlink" title="Rollup"></a>Rollup</h4><p>Rollup å¯ä»¥ç†è§£ä¸º Table çš„ä¸€ä¸ªç‰©åŒ–ç´¢å¼•ç»“æ„ã€‚<strong>ç‰©åŒ–</strong> æ˜¯å› ä¸ºå…¶æ•°æ®åœ¨<strong>ç‰©ç†ä¸Šç‹¬ç«‹å­˜å‚¨</strong>ï¼Œè€Œ <strong>ç´¢å¼•</strong> çš„æ„æ€æ˜¯ï¼ŒRollupå¯ä»¥<strong>è°ƒæ•´åˆ—é¡ºåº</strong>ä»¥å¢åŠ å‰ç¼€ç´¢å¼•çš„å‘½ä¸­ç‡ï¼Œä¹Ÿå¯ä»¥å‡å°‘keyåˆ—ä»¥å¢åŠ æ•°æ®çš„èšåˆåº¦ã€‚</p><p>æ•°æ®ä¸ŠRollupæ„å‘³ç€åœ¨å¤šç»´åˆ†æä¸­â€œä¸Šå·æ“ä½œâ€ï¼Œä¸Šå·æ„å‘³ç€åœ¨æ•°æ®ç«‹æ–¹ä½“ä¸Šè¿›è¡Œä¸€ä¸ªç»´åº¦çš„åˆå¹¶ï¼Œä¸ä¹‹å¯¹åº”çš„è¿˜æœ‰â€œé’»å–â€æ“ä½œ(Drill-down)ï¼Œé’»å–æ„å‘³ç€åœ¨æŸäº›ç»´åº¦ä¸Šè¿›ä¸€æ­¥æ‰“å¼€æ‰©å±•ç»´åº¦ï¼Œè¯¦ç»†å¯ä»¥å‚è€ƒ<a class="link"   href="https://www.zhihu.com/question/19955124" >è¿™é‡Œ<i class="fas fa-external-link-alt"></i></a></p><h5 id="Aggregate-Key-amp-Roll-up"><a href="#Aggregate-Key-amp-Roll-up" class="headerlink" title="Aggregate Key &amp; Roll up"></a>Aggregate Key &amp; Roll up</h5><p>Rollupåœ¨èšåˆæ¨¡å‹ä¸Šå¯ä»¥å‘æŒ¥å¾ˆå¥½åœ°ä½œç”¨ï¼ŒåŸºäºBaseè¡¨åˆ›å»ºRollupå¯ä»¥è·å¾—æ›´å¥½çš„èšåˆæ•°æ®æ•ˆæœä»¥åŠè°ƒæ•´keyé¡ºåºï¼Œå¯ä»¥æé«˜Rollupå‘½ä¸­ç‡</p><h5 id="Unique-Key-amp-Roll-up"><a href="#Unique-Key-amp-Roll-up" class="headerlink" title="Unique Key &amp; Roll up"></a>Unique Key &amp; Roll up</h5><p>æ›´æ–°æ¨¡å‹ä¸­çš„Unique Keyç›¸å½“äºèšåˆæ¨¡å‹ä¸­èšåˆå‡½æ•°è¢«å›ºå®šä¸ºReplaceï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨Uniqueä¸Šåˆ›å»ºRollupçš„æ—¶å€™å¿…é¡»é€‰ä¸­æ‰€æœ‰çš„ç»´åº¦åˆ—ï¼Œå³åœ¨Unique Keyæ¨¡å‹ä¸Šåˆ›å»ºRollupåªèƒ½è°ƒæ•´ç»´åº¦keyçš„é¡ºåºï¼Œå¯ä»¥è·å¾—æ›´é«˜çš„Rollupå‘½ä¸­ç‡ï¼Œä½†æ˜¯å› ä¸ºRollupæ•°æ®æ˜¯éœ€è¦ç‹¬ç«‹å­˜å‚¨çš„ï¼Œè¿™æ ·çš„è¯æ•°æ®æ˜¯å¦ç›´æ¥å…¨éƒ¨è¢«å­˜å‚¨äº†ä¸¤éï¼Ÿè¿˜éœ€è¦åé¢éªŒè¯ä¸‹ã€‚</p><h5 id="Duplicate-Key-amp-Roll-up"><a href="#Duplicate-Key-amp-Roll-up" class="headerlink" title="Duplicate Key &amp; Roll up"></a>Duplicate Key &amp; Roll up</h5><p>Duplicate Keyæ¨¡å‹å’ŒUnique Keyæ¨¡å‹ç±»ä¼¼ï¼ŒåŒæ ·å› ä¸º Duplicate æ¨¡å‹æ²¡æœ‰èšåˆçš„è¯­æ„ã€‚æ‰€ä»¥è¯¥æ¨¡å‹ä¸­çš„ ROLLUPï¼Œå·²ç»å¤±å»äº†â€œä¸Šå·â€è¿™ä¸€å±‚å«ä¹‰ã€‚è€Œä»…ä»…æ˜¯ä½œä¸ºè°ƒæ•´åˆ—é¡ºåºï¼Œä»¥å‘½ä¸­å‰ç¼€ç´¢å¼•çš„ä½œç”¨ã€‚æˆ‘ä»¬å°†åœ¨<a class="link"   href="https://doris.apache.org/zh-CN/data-table/index/prefix-index.html" >å‰ç¼€ç´¢å¼•<i class="fas fa-external-link-alt"></i></a>è¯¦ç»†ä»‹ç»å‰ç¼€ç´¢å¼•ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨ROLLUPæ”¹å˜å‰ç¼€ç´¢å¼•ï¼Œä»¥è·å¾—æ›´å¥½çš„æŸ¥è¯¢æ•ˆç‡ã€‚</p><h4 id="ç‰©åŒ–è§†å›¾"><a href="#ç‰©åŒ–è§†å›¾" class="headerlink" title="ç‰©åŒ–è§†å›¾"></a>ç‰©åŒ–è§†å›¾</h4><p>è¯´åˆ°ç‰©åŒ–è§†å›¾å°±ä¸€å®šè¦å’ŒRollupåšä¸€ä¸ªåŒºåˆ†ï¼Œç‰©åŒ–è§†å›¾ç›¸å½“äºRollupçš„ä¸€ä¸ªè¶…é›†ï¼Œå’Œç‰©åŒ–è§†å›¾ç›¸æ¯”Rollup å…·æœ‰ä¸€å®šçš„å±€é™æ€§ï¼š</p><p>1.Rollupä¸èƒ½åšæ˜ç»†æ¨¡å‹çš„èšåˆï¼Œåªèƒ½èµ·åˆ°æ›´æ”¹å‰ç¼€ç´¢å¼•é¡ºåºæ¥åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ï¼Œå› ä¸ºæ˜ç»†æ¨¡å‹Duplicate Keyè¡¨æœ¬èº«å°±æ²¡æœ‰èšåˆçš„å«ä¹‰</p><p>2.Rollupçš„èšåˆå‡½æ•°å¿…é¡»å’ŒBase tableä¿æŒä¸€è‡´ï¼Œç‰©åŒ–è§†å›¾çš„èšåˆå‡½æ•°å¯ä»¥å’Œbaseè¡¨ä¸åŒ</p><p>3.ç‰©åŒ–è§†å›¾æ˜¯ä¸æ”¯æŒUnique Keyæ¨¡å‹ï¼Œå› ä¸ºç‰©åŒ–è§†å›¾å®é™…ä¸Šæ˜¯é¢„èšåˆè¿›è¡Œè®¡ç®—ï¼Œæ¯”å¦‚sumï¼Œcountï¼Œèšåˆå®Œæ¯•ä¹‹åæˆ‘ä»¬å°±ä¸¢å¤±äº†æ˜ç»†ä¿¡æ¯ï¼Œè¿™æ—¶å€™å¦‚æœä½ å»æ›´æ–°æ˜ç»†ä¿¡æ¯ï¼Œç‰©åŒ–è§†å›¾å°±æ²¡æ³•çŸ¥é“è¯¥å¦‚ä½•åšå‡ºæ”¹å˜ï¼Œæ¯”å¦‚ä¸¤æ¡æ˜ç»†æ•°æ®åˆ†åˆ«æ˜¯1ã€5ï¼Œæˆ‘ä»¬å»ºç«‹ç‰©åŒ–è§†å›¾æ±‚å’Œï¼Œè¿™æ—¶å€™è¿™ä¸ªå€¼æ˜¯6ï¼Œç„¶åæˆ‘ä»¬æ›´æ–°æ•°æ®ï¼Œå°†1æ›´æ”¹æˆ2ï¼Œä½†æ˜¯rollupæ‰‹é‡Œåªæœ‰ä¸€ä¸ª6ï¼Œä»–çŸ¥é“å…¶ä¸­ä¸€ä¸ªå€¼è¢«å˜æˆ2äº†ï¼Œä½†æ˜¯ä»…æ­¤è€Œå·²ï¼Œæ‰€ä»¥ç‰©åŒ–è§†å›¾æ˜¯ä¸æ”¯æŒæ›´æ–°æ¨¡å‹ã€‚</p><h5 id="æ›´æ–°ç­–ç•¥"><a href="#æ›´æ–°ç­–ç•¥" class="headerlink" title="æ›´æ–°ç­–ç•¥"></a>æ›´æ–°ç­–ç•¥</h5><p>ä¸ºä¿è¯ç‰©åŒ–è§†å›¾è¡¨å’Œ Base è¡¨çš„æ•°æ®ä¸€è‡´æ€§, Doris ä¼šå°†å¯¼å…¥ï¼Œåˆ é™¤ç­‰å¯¹ base è¡¨çš„æ“ä½œéƒ½åŒæ­¥åˆ°ç‰©åŒ–è§†å›¾è¡¨ä¸­ã€‚å¹¶ä¸”é€šè¿‡å¢é‡æ›´æ–°çš„æ–¹å¼æ¥æå‡æ›´æ–°æ•ˆç‡ã€‚é€šè¿‡äº‹åŠ¡æ–¹å¼æ¥ä¿è¯åŸå­æ€§ã€‚</p><p>æ¯”å¦‚å¦‚æœç”¨æˆ·é€šè¿‡ INSERT å‘½ä»¤æ’å…¥æ•°æ®åˆ° base è¡¨ä¸­ï¼Œåˆ™è¿™æ¡æ•°æ®ä¼šåŒæ­¥æ’å…¥åˆ°ç‰©åŒ–è§†å›¾ä¸­ã€‚å½“ base è¡¨å’Œç‰©åŒ–è§†å›¾è¡¨å‡å†™å…¥æˆåŠŸåï¼ŒINSERT å‘½ä»¤æ‰ä¼šæˆåŠŸè¿”å›ã€‚</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;å¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´&lt;/p&gt;</summary>
    
    
    
    
    <category term="StarRocks" scheme="http://example.com/tags/StarRocks/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•å¤‡ä»½hexoåšå®¢</title>
    <link href="http://example.com/2022/03/29/%E5%A6%82%E4%BD%95%E5%A4%87%E4%BB%BDhexo%E5%8D%9A%E5%AE%A2/"/>
    <id>http://example.com/2022/03/29/%E5%A6%82%E4%BD%95%E5%A4%87%E4%BB%BDhexo%E5%8D%9A%E5%AE%A2/</id>
    <published>2022-03-29T15:54:32.000Z</published>
    <updated>2022-03-29T16:25:57.300Z</updated>
    
    <content type="html"><![CDATA[<h1 id="å¤‡å¿˜"><a href="#å¤‡å¿˜" class="headerlink" title="å¤‡å¿˜"></a>å¤‡å¿˜</h1><p>1.éœ€è¦å°†æ•´ä¸ªåšå®¢æ–‡ä»¶å¤¹å’Œgithubä¸Šä¸€ä¸ªæ–°é¡¹ç›®å…³è”èµ·æ¥ å‘½ä»¤ç±»ä¼¼git set-urlâ€¦<br>2.éœ€è¦åˆ é™¤ä½ ä½¿ç”¨çš„ä¸»é¢˜ä¸»æ–‡ä»¶å¤¹ä¸­çš„.gitç›®å½• å¦åˆ™ä¼šè¢«çœ‹åšæ˜¯ä¸€ä¸ªå­module<br>3.git push origin masteræ¨é€ä¸Šå»<br>4.git pull origin masteræ‹‰ä¸‹æ¥ å¹¶ä¸”è¿˜éœ€è¦ç”¨npmä¸‹è½½ä¸€äº›åŒ…</p><p>npm install hexo-cli<br>npm install<br>npm install hexo-deployer-git</p><p>ä¸ç”¨å†æ‰§è¡Œhexo initå‘½ä»¤</p><p>å‚è€ƒ:<br><a class="link"   href="https://lrscy.github.io/2018/01/26/Hexo-Github-Backup/" >https://lrscy.github.io/2018/01/26/Hexo-Github-Backup/<i class="fas fa-external-link-alt"></i></a><br><a class="link"   href="https://finisky.github.io/2020/09/06/hexobackuptogithub/" >https://finisky.github.io/2020/09/06/hexobackuptogithub/<i class="fas fa-external-link-alt"></i></a></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;å¤‡å¿˜&quot;&gt;&lt;a href=&quot;#å¤‡å¿˜&quot; class=&quot;headerlink&quot; title=&quot;å¤‡å¿˜&quot;&gt;&lt;/a&gt;å¤‡å¿˜&lt;/h1&gt;&lt;p&gt;1.éœ€è¦å°†æ•´ä¸ªåšå®¢æ–‡ä»¶å¤¹å’Œgithubä¸Šä¸€ä¸ªæ–°é¡¹ç›®å…³è”èµ·æ¥ å‘½ä»¤ç±»ä¼¼git set-urlâ€¦&lt;br&gt;2.éœ€è¦åˆ é™¤ä½ ä½¿ç”¨çš„ä¸»é¢˜ä¸»æ–‡ä»¶å¤¹ä¸­çš„.g</summary>
      
    
    
    
    
    <category term="blog" scheme="http://example.com/tags/blog/"/>
    
  </entry>
  
  <entry>
    <title>å¦‚ä½•ä½¿ç”¨JMX_Expoter+Prometheus+Grafanaç›‘æ§Hadoopé›†ç¾¤&amp;Hbaseé›†ç¾¤</title>
    <link href="http://example.com/2021/11/03/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8JMX-Prometheus-Grafana%E7%9B%91%E6%8E%A7Hadoop%E9%9B%86%E7%BE%A4-Hbase%E9%9B%86%E7%BE%A4/"/>
    <id>http://example.com/2021/11/03/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8JMX-Prometheus-Grafana%E7%9B%91%E6%8E%A7Hadoop%E9%9B%86%E7%BE%A4-Hbase%E9%9B%86%E7%BE%A4/</id>
    <published>2021-11-03T11:49:02.000Z</published>
    <updated>2021-11-05T12:33:12.885Z</updated>
    
    <content type="html"><![CDATA[<p>å› ä¸ºç›®å‰CDHä»¥åŠHDPåç»­è¦åˆå¹¶é—­æºï¼Œå…¬å¸æ‰“ç®—èŠ±æ—¶é—´è‡ªç ”ä¸€ä¸ªç±»ä¼¼çš„å¹³å°ï¼Œæˆ‘ä¹Ÿå¯¹é›†ç¾¤ç›‘æ§è¿™å—ä¸‹äº†ç‚¹åŠŸå¤«ã€‚</p><span id="more"></span><h2 id="ç›‘æ§"><a href="#ç›‘æ§" class="headerlink" title="ç›‘æ§"></a>ç›‘æ§</h2><p>â€‹    å¯¹äºä¸€ä¸ªé›†ç¾¤ç®¡ç†å¹³å°ï¼Œé¦–å½“å…¶å†²çš„å°±æ˜¯å…¶ä¸­çš„ç›‘æ§å¦‚ä½•å®ç°ï¼Œæ¯•ç«Ÿå¾ˆå¤šæ—¶å€™æˆ‘ä»¬æ‰“å¼€å®ƒåªæ˜¯å› ä¸ºé‚®ç®±é‡Œæ”¶åˆ°äº†æŠ¥è­¦:-)ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å¦‚ä½•è·å–Hadoopç­‰é›†ç¾¤çš„ä¿¡æ¯å‘¢ï¼Ÿè¿™æ—¶å€™éœ€è¦ç®€å•äº†è§£ä¸€ä¸ªçŸ¥è¯†ç‚¹äº†ï¼šJMXã€‚</p><p>â€‹    æˆ‘ä»¬ç®€å•ä»‹ç»ä¸€ä¸‹Javaçš„JMXæ˜¯ä»€ä¹ˆï¼ŒJMXå…¨ç¨‹å«åšJava Management Extensionsï¼Œç¿»è¯‘è¿‡æ¥å°±æ˜¯Javaå†…å­˜ç®¡ç†ï¼Œæœ€å¸¸ç”¨åˆ°çš„å°±æ˜¯å¯¹äº JVM çš„ç›‘æµ‹å’Œç®¡ç†ï¼Œæ¯”å¦‚ JVM å†…å­˜ã€CPU ä½¿ç”¨ç‡ã€çº¿ç¨‹æ•°ã€åƒåœ¾æ”¶é›†æƒ…å†µç­‰ç­‰ã€‚å¦å¤–ï¼Œè¿˜å¯ä»¥ç”¨ä½œæ—¥å¿—çº§åˆ«çš„åŠ¨æ€ä¿®æ”¹ï¼Œæ¯”å¦‚ log4j å°±æ”¯æŒ JMX æ–¹å¼åŠ¨æ€ä¿®æ”¹çº¿ä¸ŠæœåŠ¡çš„æ—¥å¿—çº§åˆ«ã€‚</p><img src="/2021/11/03/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8JMX-Prometheus-Grafana%E7%9B%91%E6%8E%A7Hadoop%E9%9B%86%E7%BE%A4-Hbase%E9%9B%86%E7%BE%A4/JMX%E6%9E%B6%E6%9E%84.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>æ€»è€Œè¨€ä¹‹ï¼Œå°±æ˜¯Javaè‡ªå·±å¼€å‘çš„ç”¨äºç›‘æ§JVMæŒ‡æ ‡çš„ä¸€ä¸ªå·¥å…·ï¼Œå¯ä»¥æä¾›ç»™ä¸€äº›ç•Œé¢JConsoleï¼ŒVisualVMä½¿ç”¨ï¼Œè¯¦ç»†ä¿¡æ¯å¯ä»¥å‚è€ƒ<a class="link"   href="https://juejin.cn/post/6856949531003748365" >è¿™é‡Œ!<i class="fas fa-external-link-alt"></i></a></p><h2 id="è·å–é›†ç¾¤çš„JMXä¿¡æ¯"><a href="#è·å–é›†ç¾¤çš„JMXä¿¡æ¯" class="headerlink" title="è·å–é›†ç¾¤çš„JMXä¿¡æ¯"></a>è·å–é›†ç¾¤çš„JMXä¿¡æ¯</h2><p>â€‹    Hadoopï¼ŒHbaseé›†ç¾¤éƒ½æä¾›äº†ä¾¿æ·è·å–é›†ç¾¤JMXä¿¡æ¯çš„é€”å¾„ï¼Œå…·ä½“é€šè¿‡åœ¨è®¿é—®åœ°å€åé¢åŠ ä¸Š<code>/jmx</code>æ¥å®ç°ï¼Œæ¯”å¦‚æˆ‘ä»¬è®¿é—®hdfsçš„NameNodeé¡µé¢çš„æ—¶å€™åœ°å€æ˜¯<code>localhost:50070</code>ï¼Œé‚£ä¹ˆåœ¨åé¢åŠ ä¸Šä¸€ä¸ª<code>/jmx</code>å³ä¸º<code>localhost:50070/jmx</code>ï¼Œè®¿é—®å³å¯å¾—åˆ°ç±»ä¼¼ä¸‹é¢çš„ä¿¡æ¯ã€‚</p><img src="/2021/11/03/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8JMX-Prometheus-Grafana%E7%9B%91%E6%8E%A7Hadoop%E9%9B%86%E7%BE%A4-Hbase%E9%9B%86%E7%BE%A4/jmx%E7%9B%91%E6%8E%A7%E9%A1%B5%E9%9D%A2.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>â€‹    ä¸Šé¢å›¾ä¸­å…·ä½“æŒ‡æ ‡ä¿¡æ¯å¯ä»¥åœ¨Hadoopå®˜æ–¹æ–‡æ¡£å¯¹åº”çš„<a class="link"   href="https://hadoop.apache.org/docs/stable/hadoop-project-dist/hadoop-common/Metrics.html" >metricsç« èŠ‚<i class="fas fa-external-link-alt"></i></a>ä¸­æ‰¾åˆ°ï¼Œå…¶ä¸­åŒ…æ‹¬äº†Namenodeä»¥åŠDatanodeç›¸å…³ä¿¡æ¯ï¼ŒåŒç†å¦‚æœæˆ‘ä»¬åœ¨8088ç«¯å£åé¢åŠ ä¸Š<code>/jmx</code>å³å¯è·å¾—å…³äºYarnç›¸å…³æŒ‡æ ‡ä¿¡æ¯ã€‚</p><p>â€‹    ç°åœ¨æˆ‘ä»¬ç›‘æ§çš„ä¿¡æ¯æœ‰äº†ï¼Œæ¥ä¸‹æ¥å¦‚æœæˆ‘ä»¬æƒ³å°†æ•°æ®åœ¨ç›‘æ§æŠ˜çº¿å›¾ä¸­å±•ç°å‡ºæ¥çš„è¯å°±éœ€è¦ä¸€ä¸ªæ—¶åºæ•°æ®åº“ï¼Œå› ä¸ºç›‘æ§æŒ‡æ ‡æ•°æ®å¿…é¡»å­˜åœ¨å¯¹åº”çš„æ—¶é—´æ‰æœ‰æ„ä¹‰ï¼Œç›®å‰æ¯”è¾ƒå¸¸è§çš„æ—¶åºæ•°æ®åº“+ç•Œé¢ç»„åˆæ˜¯æ™®ç½—ç±³ä¿®æ–¯ï¼ˆæ—¶åºæ•°æ®åº“ï¼‰+ Grafanaï¼ˆç•Œé¢å±•ç¤ºï¼‰ï¼Œé‚£ä¹ˆç›®å‰çš„é—®é¢˜å°±è½¬æ¢æˆäº†å¦‚ä½•å°†Hadoopé›†ç¾¤ä¸­çš„JMXä¿¡æ¯ä¼ é€’ç»™æ™®ç½—ç±³ä¿®æ–¯ï¼Œç®€å•è°ƒç ”å°±å¯ä»¥å‘ç°ï¼Œæ™®ç½—ç±³ä¿®æ–¯è‡ªå·±å¼€å‘äº†ä¸€æ¬¾æ’ä»¶æ”¯æŒå°†javaç¨‹åºå¯¹åº”çš„jmxä¿¡æ¯ä¼ é€’åˆ°è‡ªå·±çš„æ—¶åºæ•°æ®åº“ä¸­ï¼Œ<a class="link"   href="https://github.com/prometheus/jmx_exporter" >æ’ä»¶åœ°å€<i class="fas fa-external-link-alt"></i></a>ã€‚</p><p>  æ ¹æ®è‡ªå·±Javaç¯å¢ƒç‰ˆæœ¬ä¸‹è½½æ’ä»¶ï¼Œå°†æ’ä»¶æ”¾ç½®åˆ°è‡ªå·±é€‰å®šçš„ä½ç½®ï¼Œç°åœ¨æ’ä»¶æœ‰äº†ï¼Œå°±å·®å¦‚ä½•åœ¨é›†ç¾¤ä¸­ä½¿ç”¨æ’ä»¶äº†ï¼Œæˆ‘ä»¬å¼€å§‹ç€æ‰‹ä¿®æ”¹é›†ç¾¤ä¸­çš„é…ç½®ã€‚</p><h2 id="Hadoopé›†ç¾¤é…ç½®Jmx-expoter"><a href="#Hadoopé›†ç¾¤é…ç½®Jmx-expoter" class="headerlink" title="Hadoopé›†ç¾¤é…ç½®Jmx_expoter"></a>Hadoopé›†ç¾¤é…ç½®Jmx_expoter</h2><p>åœ¨hadoop-env.shä¸­æœ€åæ·»åŠ ä»¥ä¸‹ä»£ç ï¼Œæ³¨æ„å°†å…¶ä¸­çš„è·¯å¾„ä¿®æ”¹æˆè‡ªå·±ç³»ç»Ÿä¸­çš„è·¯å¾„ï¼Œè¿™æ®µä»£ç çš„ä¸»è¦ä½œç”¨æ˜¯æ·»åŠ æˆ‘ä»¬ä¸‹è½½çš„jaråŒ…ï¼Œä»¥åŠç»™jaråŒ…ä¼ é€’é…ç½®æ–‡ä»¶ï¼Œä»¥åŠæŒ‡å®šè¯¥æœåŠ¡è¦å ç”¨çš„ç«¯å£ï¼Œè¿™é‡Œçš„å¯¹åº”ä½ç½®çš„é…ç½®æ–‡ä»¶<code>prometheus_config.yml</code>æµ‹è¯•çš„æ—¶å€™å¯ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶å³å¯ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if ! grep -q &lt;&lt;&lt;&quot;$HDFS_NAMENODE_OPTS&quot; jmx_prometheus_javaagent; then</span><br><span class="line">HDFS_NAMENODE_OPTS=&quot;$HDFS_NAMENODE_OPTS -javaagent:/usr/local/Cellar/hadoop/3.3.1/jmx_prometheus_javaagent-0.16.1.jar=27001:/usr/local/Cellar/hadoop/3.3.1/libexec/etc/hadoop/prometheus_config.yml&quot;</span><br><span class="line">fi</span><br><span class="line">if ! grep -q &lt;&lt;&lt;&quot;$HDFS_DATANODE_OPTS&quot; jmx_prometheus_javaagent; then</span><br><span class="line">HDFS_DATANODE_OPTS=&quot;$HDFS_DATANODE_OPTS -javaagent:/usr/local/Cellar/hadoop/3.3.1/jmx_prometheus_javaagent-0.16.1.jar=27002:/usr/local/Cellar/hadoop/3.3.1/libexec/etc/hadoop/prometheus_config.yml&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„äº‹é¡¹</strong> ï¼š</p><p>1.ä¸Šé¢çš„ä»£ç ä¸èƒ½ç›´æ¥å†™æˆç±»ä¼¼ä»¥ä¸‹æ¨¡å¼ï¼Œå› ä¸ºä¸èƒ½åœ¨<code>$HADOOP_OPTS</code>ä¸­å‡ºç°<code>multiple -javaagent opts</code>ï¼Œå°±æ˜¯ä¸èƒ½ç›´æ¥å‡ºç°å¤šä¸ª-javaagenté€‰é¡¹ï¼Œå¿…é¡»è¦æ¢ä¸€ç§å†™æ³•ï¼Œå°†<code>-javaagent</code>å†™åœ¨if elseä»£ç ä¸­å¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜ï¼Œè¯¦ç»†å¯ä»¥å‚è€ƒè¿™ä¸ª<a class="link"   href="https://stackoverflow.com/questions/47121498/configuring-prometheus-jmx-exporter-for-hadoop2/59837822#59837822" >stackoverflowå›ç­”<i class="fas fa-external-link-alt"></i></a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">å†™æˆè¿™ç§æ¨¡å¼ä¼šæŠ¥é”™</span></span><br><span class="line">export HADOOP_NAMENODE_OPTS=&quot;$HADOOP_NAMENODE_OPTS -javaagent:/home/ec2-user/jmx_exporter/jmx_prometheus_javaagent-0.10.jar=9102:/home/ec2-user/jmx_exporter/prometheus_config.yml&quot;</span><br><span class="line">export HADOOP_DATANODE_OPTS=&quot;$HADOOP_DATANODE_OPTS -javaagent:/home/ec2-user/jmx_exporter/jmx_prometheus_javaagent-0.10.jar=9102:/home/ec2-user/jmx_exporter/prometheus_config.yml&quot;</span><br></pre></td></tr></table></figure><p>2.åŒä¸€å°æœºå™¨çš„æ¯ä¸€ä¸ªJMXæœåŠ¡ç«¯å£å¿…é¡»åŒºåˆ†å¼€</p><p>æ¯”å¦‚ä¸Šé¢namenodeçš„jmxæœåŠ¡æ‰€å ç”¨çš„ç«¯å£ä¸º27001ï¼Œdatanodeçš„jmxæœåŠ¡æ‰€å ç”¨çš„ç«¯å£ä¸º27002ï¼Œå¦‚æœä½¿ç”¨äº†ç›¸åŒçš„ç«¯å£ï¼Œé‚£ä¹ˆåœ¨å¯åŠ¨hdfsæœåŠ¡(./start-dfs.sh)çš„æ—¶å€™ä¼šæŠ¥å¦‚ä¸‹æ‰€ç¤ºçš„é”™ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Starting namenodes on [localhost]</span><br><span class="line">Starting datanodes</span><br><span class="line">localhost: /usr/local/Cellar/hadoop/3.3.1/libexec/bin/../libexec/hadoop-functions.sh: line 1821: 11125 Abort trap: 6           hadoop_start_daemon &quot;$&#123;daemonname&#125;&quot; &quot;$class&quot; &quot;$&#123;pidfile&#125;&quot; &quot;$@&quot; &gt;&gt; &quot;$&#123;outfile&#125;&quot; 2&gt;&amp;1 &lt; /dev/null</span><br><span class="line">localhost: ERROR: Cannot set priority of datanode process 11125</span><br><span class="line">localhost: ERROR: Cannot disconnect datanode process 11125</span><br></pre></td></tr></table></figure><p>è¿™æ ·é…ç½®å®Œæˆä¹‹åï¼ŒHadoopçš„jmxä¿¡æ¯å°±è¢«é‡‡é›†åˆ°æŒ‡å®šçš„ç«¯å£ä¸­äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥åœ¨ç½‘é¡µä¸Šæµ‹è¯•ä¸€ä¸‹æˆ‘ä»¬çš„é‡‡é›†æ•°æ®ï¼Œè®¿é—®åœ°å€å°±æ˜¯å‰é¢é…ç½®çš„ç«¯å£ <code>localhost:27001</code></p><img src="/2021/11/03/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8JMX-Prometheus-Grafana%E7%9B%91%E6%8E%A7Hadoop%E9%9B%86%E7%BE%A4-Hbase%E9%9B%86%E7%BE%A4/27001.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€">    <p>åŒç†æˆ‘ä»¬çš„Yarnç›¸å…³ä¿¡æ¯é‡‡é›†ä¹Ÿè¦åœ¨yarn-env.shä¸­é…ç½®ä¸Šé¢ç±»ä¼¼çš„ä»£ç ï¼Œå…¶ä¸­åŒæ ·è¦æ³¨æ„åŒºåˆ†ç«¯å£å·ï¼Œå¹¶ä¸”ä¸è¦åŒæ—¶å‡ºç°ä¸¤ä¸ª-javaagentï¼Œå°†ä¸¤ä¸ªjavaagentæ”¾åˆ°ä¸åŒçš„if elseä¸­ã€‚</p><h2 id="Hbaseé›†ç¾¤é…ç½®"><a href="#Hbaseé›†ç¾¤é…ç½®" class="headerlink" title="Hbaseé›†ç¾¤é…ç½®"></a>Hbaseé›†ç¾¤é…ç½®</h2><p>å› ä¸ºæˆ‘æ˜¯å¯åŠ¨çš„å•æœºç‰ˆæœ¬çš„Hbaseï¼Œæ‰€ä»¥æˆ‘åªé…ç½®<code>HBASE_MASTER_OPTS</code>å’Œ<code>HBASE_JMX_BASE</code>é€‰é¡¹ï¼Œå¦‚æœæ˜¯é›†ç¾¤æ¨¡å¼å¯èƒ½è¿˜éœ€è¦é…ç½®<code>HBASE_REGIONSERVER_OPTS</code>ï¼Œå°†ä¸‹é¢å†…å®¹æ›¿æ¢æˆè‡ªå·±çš„æ–‡ä»¶è·¯å¾„ç„¶åæ·»åŠ åˆ°hbase-env.shçš„å°¾éƒ¨ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export HBASE_JMX_BASE=&quot;-Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false&quot;</span><br><span class="line">export HBASE_MASTER_OPTS=&quot;$HBASE_MASTER_OPTS $HBASE_JMX_BASE -Dcom.sun.management.jmxremote.port=20101 -javaagent:$HBASE_HOME/lib/jmx_prometheus_javaagent-0.16.1.jar=27000:$HBASE_HOME/conf/hbase_jmx_config.yaml&quot;</span><br></pre></td></tr></table></figure><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡æŒ‡å®šç«¯å£è®¿é—®å„ä¸ªé›†ç¾¤çš„JMXä¿¡æ¯äº†ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯é…ç½®Prometheuså°†æ•°æ®å¯¼å…¥åˆ°æ—¶åºæ•°æ®åº“ä¸­ã€‚</p><h2 id="é…ç½®Prometheus"><a href="#é…ç½®Prometheus" class="headerlink" title="é…ç½®Prometheus"></a>é…ç½®Prometheus</h2><p>æ‰“å¼€Prometheusé…ç½®æ–‡ä»¶ï¼Œå¹¶ä¸”åœ¨åé¢å¢åŠ å…³äºHadoopé›†ç¾¤çš„NameNodeï¼ŒDataNodeä»¥åŠHbaseçš„jmxæ•°æ®é…ç½®ï¼Œå¢åŠ å¦‚ä¸‹ä»£ç ï¼Œé‡å¯æ™®ç½—ç±³ä¿®æ–¯æœåŠ¡ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- job_name: &quot;hbase&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&quot;localhost:27000&quot;]</span><br><span class="line">      labels:</span><br><span class="line">          instance: localhost</span><br><span class="line">  - job_name: &quot;hadoop namenode&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&quot;localhost:27001&quot;]</span><br><span class="line">      labels:</span><br><span class="line">          instance: localhost</span><br><span class="line">  - job_name: &quot;hadoop datanode&quot;</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: [&quot;localhost:27002&quot;]</span><br><span class="line">      labels:</span><br><span class="line">          instance: localhost</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ‰“å¼€Prometheusçš„é¡µé¢æŸ¥çœ‹å¯¹åº”çš„targetï¼ŒæŸ¥çœ‹æˆ‘ä»¬é…ç½®çš„ä»»åŠ¡ï¼Œå¦‚æœå‡ºç°ä¸‹é¢å‡ ä¸ªé€‰é¡¹å¹¶ä¸”æ˜¯ç»¿è‰²çš„è¯´æ˜æ˜¯æ­£å¸¸çš„ï¼Œæ‰“å¼€é‡‡é›†çš„ç»“æœç½‘å€ä¼šå‘ç°å…¶ä¸­Prometheusé‡‡é›†çš„æŒ‡æ ‡åç§°ç›¸æ¯”äºåŸå…ˆé›†ç¾¤50070/jmxçš„æŒ‡æ ‡åç§°æ˜¯ç»è¿‡å¤„ç†çš„ï¼Œæ¯”å¦‚Prometheusä¸­æœ‰ä¸€ä¸ªæŒ‡æ ‡å«åš<code>hadoop_namenode_memnonheapmaxm</code>ä»–åœ¨50070/jmxä¸­æ˜¯åç§°æ˜¯<code>memnonheapmaxm</code>ï¼Œç„¶åå‰é¢åŠ ä¸Šservice nameç­‰ï¼Œå…¶ä¸­çš„åŒ¹é…è§„åˆ™åº”è¯¥åœ¨æ’ä»¶çš„é…ç½®æ–‡ä»¶<code>prometheus_config.yml</code>ä¸­è®¾ç½®çš„ï¼Œè¯¦ç»†å¯ä»¥çœ‹<a class="link"   href="https://github.com/prometheus/jmx_exporter" >æ’ä»¶åœ°å€<i class="fas fa-external-link-alt"></i></a>ã€‚</p><img src="/2021/11/03/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8JMX-Prometheus-Grafana%E7%9B%91%E6%8E%A7Hadoop%E9%9B%86%E7%BE%A4-Hbase%E9%9B%86%E7%BE%A4/prometheus.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>æœ€åé€‰å‡ºæ¥æˆ‘ä»¬éœ€è¦çš„æŒ‡æ ‡ä¹‹å’Œåœ¨Grafanaä¸­å±•ç¤ºå‡ºæ¥å³å¯ï¼Œå…·ä½“æ–¹æ³•è¿™é‡Œä¸å†å±•ç¤ºï¼Œå¯ä»¥å‚è€ƒ<a class="link"   href="https://www.daimajiaoliu.com/daima/4796909c8100406" >è¿™ç¯‡æ•™ç¨‹<i class="fas fa-external-link-alt"></i></a></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;å› ä¸ºç›®å‰CDHä»¥åŠHDPåç»­è¦åˆå¹¶é—­æºï¼Œå…¬å¸æ‰“ç®—èŠ±æ—¶é—´è‡ªç ”ä¸€ä¸ªç±»ä¼¼çš„å¹³å°ï¼Œæˆ‘ä¹Ÿå¯¹é›†ç¾¤ç›‘æ§è¿™å—ä¸‹äº†ç‚¹åŠŸå¤«ã€‚&lt;/p&gt;</summary>
    
    
    
    
    <category term="JMX_Expoter" scheme="http://example.com/tags/JMX-Expoter/"/>
    
    <category term="ç›‘æ§" scheme="http://example.com/tags/%E7%9B%91%E6%8E%A7/"/>
    
  </entry>
  
  <entry>
    <title>æ•°æ®æ¹–åŸºç¡€çŸ¥è¯†ä»¥åŠMacå®‰è£…Icebergæ•™ç¨‹</title>
    <link href="http://example.com/2021/10/20/%E6%95%B0%E6%8D%AE%E6%B9%96%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E4%B8%8E%E7%90%86%E8%AE%BA%EF%BC%8CIceberg/"/>
    <id>http://example.com/2021/10/20/%E6%95%B0%E6%8D%AE%E6%B9%96%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E4%B8%8E%E7%90%86%E8%AE%BA%EF%BC%8CIceberg/</id>
    <published>2021-10-20T11:47:14.000Z</published>
    <updated>2021-11-04T07:40:27.583Z</updated>
    
    <content type="html"><![CDATA[<p><strong>è®¡ç®—æœºç§‘å­¦é¢†åŸŸçš„ä»»ä½•é—®é¢˜éƒ½å¯ä»¥é€šè¿‡å¢åŠ ä¸€ä¸ªé—´æ¥åœ°ä¸­é—´å±‚æ¥è§£å†³</strong></p><span id="more"></span><img src="/2021/10/20/%E6%95%B0%E6%8D%AE%E6%B9%96%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E4%B8%8E%E7%90%86%E8%AE%BA%EF%BC%8CIceberg/%E6%95%B0%E6%8D%AE%E6%B9%96.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>â€‹    å…³äºæ•°æ®æ¹–ä¸ºä»€ä¹ˆä¼šå‡ºç°æˆ‘è§‰å¾—æœ‰ä¸€å¥è¯æ¦‚æ‹¬çš„éå¸¸å¥½ï¼Œ</p><p><code>å¤§æ•°æ®é¢†åŸŸå‘å±•è‡³ä»Šå·²ç»ç»å†äº†ç›¸å½“é•¿æ—¶é—´çš„å‘å±•å’Œæ¢ç´¢ï¼Œè™½ç„¶å¤§æ•°æ®æŠ€æœ¯çš„å‡ºç°å’Œè¿­ä»£é™ä½äº†ç”¨æˆ·å¤„ç†æµ·é‡æ•°æ®çš„é—¨æ§›ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜ä¸èƒ½å¿½è§†ï¼Œæ•°æ®æ ¼å¼å¯¹ä¸åŒå¼•æ“é€‚é…çš„å¯¹æ¥</code></p><p>è¿™å¥è¯æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿæˆ‘ä»¬åœ¨ä½¿ç”¨ä¸åŒçš„å¼•æ“è¿›è¡Œè®¡ç®—æ—¶ï¼Œéœ€è¦å°†æ•°æ®æ ¹æ®å¼•æ“è¿›è¡Œé€‚é…ã€‚è¿™æ˜¯ç›¸å½“æ£˜æ‰‹çš„é—®é¢˜ï¼Œæ¯”å¦‚è¯´æˆ‘ç”¨Sparkè¿›è¡Œè®¡ç®—ï¼Œä½†æ˜¯åº•å±‚çš„æ–‡ä»¶å¯èƒ½æ˜¯TXTå­˜å‚¨çš„ï¼Œå¯èƒ½æ˜¯Hive ORCå­˜å‚¨çš„ï¼Œæˆ–è€…æ˜¯ç»è¿‡HDFSçš„ä¸€äº›å‹ç¼©ç®—æ³•å¤„ç†çš„æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘Sparkå°±éœ€è¦æ”¯æŒè¯»å–TXTæ–‡ä»¶ï¼Œè¯»å–ORCæ–‡ä»¶ï¼Œè¯»å–snappyæ–‡ä»¶ and so on.ä¸ºäº†å°†è®¡ç®—å¼•æ“å’Œæ•°æ®å‰¥ç¦»å¼€æ¥ï¼Œç»“åˆçš„ä¸é‚£ä¹ˆç´§å¯†ï¼Œå¤§ç‰›ä»¬å‡ºç°äº†ä¸€ç§æ–°çš„è§£å†³æ–¹æ¡ˆï¼š</p><p><code>ä»‹äºä¸Šå±‚è®¡ç®—å¼•æ“å’Œåº•å±‚å­˜å‚¨æ ¼å¼ä¹‹é—´çš„ä¸€ä¸ªä¸­é—´å±‚ã€‚</code></p><p>è¿™ä¸ªä¸­é—´å±‚ä¸æ˜¯æ•°æ®å­˜å‚¨çš„æ–¹å¼ï¼Œåªæ˜¯å®šä¹‰äº†æ•°æ®çš„å…ƒæ•°æ®ç»„ç»‡æ–¹å¼ï¼Œå¹¶ä¸”å‘å¼•æ“å±‚é¢æä¾›ç»Ÿä¸€çš„ç±»ä¼¼ä¼ ç»Ÿæ•°æ®åº“</p><p>ä¸­â€è¡¨â€çš„è¯­ä¹‰ã€‚å®ƒçš„åº•å±‚ä»ç„¶æ˜¯Parquetã€ORCç­‰å­˜å‚¨æ ¼å¼ã€‚é‡æ–°åº”è¯äº†é‚£å¥è¯ã€‚</p><p><strong>è®¡ç®—æœºç§‘å­¦é¢†åŸŸçš„ä»»ä½•é—®é¢˜éƒ½å¯ä»¥é€šè¿‡å¢åŠ ä¸€ä¸ªé—´æ¥çš„ä¸­é—´å±‚æ¥è§£å†³</strong>ã€‚</p><p><code>åŸºäºæ­¤ï¼ŒNetflixå¼€å‘äº†Icebergæ•°æ®æ¹–ï¼ˆæ›´ä¸»è¦çš„æ˜¯åŸºäºHiveçš„æ•°æ®æ¹–æ–¹æ¡ˆä¸èƒ½æ»¡è¶³éœ€æ±‚ï¼‰ï¼Œç›®å‰å·²ç»æ˜¯Apacheçš„é¡¶çº§é¡¹ç›®ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰Hudiï¼Œdeltaæ•°æ®æ¹–æ–¹æ¡ˆã€‚</code></p><img src="/2021/10/20/%E6%95%B0%E6%8D%AE%E6%B9%96%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E4%B8%8E%E7%90%86%E8%AE%BA%EF%BC%8CIceberg/%E6%95%B0%E6%8D%AE%E6%B9%96%E6%A6%82%E5%BF%B5.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>â€‹    æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ•°æ®æ¹–æ˜¯ä¸€ä¸ªåœ¨è®¡ç®—å¹³å°å’Œå­˜å‚¨å¹³å°ä¸­é—´çš„ä¸€ä¸ªç±»ä¼¼ä¸­é—´ä»¶çš„ä¸œè¥¿ï¼Œç”¨äºè§£å†³å¤šç§æ•°æ®æºï¼Œå¤šç§è®¡ç®—å¼•æ“</p><p>ä¹‹é—´çš„è¿æ¥å…³ç³»ï¼Œæ•°æ®æ¹–ä¸­çš„æ•°æ®å¯ä»¥åŒ…æ‹¬æ¥è‡ªäºå…³ç³»å‹æ•°æ®åº“ä¸­çš„ç»“æ„åŒ–æ•°æ®ï¼ˆè¡Œå’Œåˆ—ï¼‰ã€åŠç»“æ„åŒ–æ•°æ®ï¼ˆå¦‚CSVã€æ—¥</p><p>å¿—ã€XMLã€JSONï¼‰ã€éç»“æ„åŒ–æ•°æ®ï¼ˆå¦‚emailã€æ–‡æ¡£ã€PDFç­‰ï¼‰å’ŒäºŒè¿›åˆ¶æ•°æ®ï¼ˆå¦‚å›¾åƒã€éŸ³é¢‘ã€è§†é¢‘ï¼‰ã€‚é™¤æ­¤ä¹‹å¤–å¼•ç”³å‡º</p><p>æ¥çš„è¿˜æœ‰å…³äºå…ƒæ•°æ®çš„ç®¡ç†ï¼Œæºæ•°æ®çš„å¤šç§Schemaç§ç±»æ ·å¼éƒ½è¦æ»¡è¶³ã€‚æ¦‚æ‹¬ä¸€ä¸‹æˆç†Ÿçš„æ•°æ®æ¹–åº”è¯¥æ»¡è¶³ä»¥ä¸‹éœ€æ±‚ï¼š</p><p>ï¼ˆ1ï¼‰éœ€è¦æ”¯æŒæ¯”è¾ƒä¸°å¯Œçš„æ•°æ® Schema çš„ç»„ç»‡ï¼›</p><p>ï¼ˆ2ï¼‰å®ƒåœ¨æ³¨å…¥çš„è¿‡ç¨‹ä¸­è¦æ”¯æ’‘<strong>å®æ—¶çš„æ•°æ®æŸ¥è¯¢</strong>ï¼Œæ‰€ä»¥<strong>éœ€è¦ ACID</strong> çš„ä¿è¯ï¼Œç¡®ä¿ä¸ä¼šè¯»åˆ°ä¸€äº›è¿˜æ²¡å†™å®Œçš„ä¸­é—´çŠ¶æ€çš„è„æ•°æ®ï¼›</p><p>ï¼ˆ3ï¼‰ä¾‹å¦‚æ—¥å¿—è¿™äº›æœ‰å¯èƒ½ä¸´æ—¶éœ€è¦æ”¹ä¸ªæ ¼å¼ï¼Œæˆ–è€…åŠ ä¸€åˆ—ã€‚ç±»ä¼¼è¿™ç§æƒ…å†µï¼Œéœ€è¦é¿å…åƒä¼ ç»Ÿçš„æ•°ä»“ä¸€æ ·ï¼Œå¯èƒ½è¦æŠŠæ‰€æœ‰çš„æ•°æ®é‡æ–°æå‡ºæ¥å†™ä¸€éï¼Œé‡æ–°æ³¨å…¥åˆ°å­˜å‚¨ï¼›è€Œæ˜¯éœ€è¦ä¸€ä¸ªè½»é‡çº§çš„è§£å†³æ–¹æ¡ˆæ¥è¾¾æˆéœ€æ±‚ã€‚</p><h3 id="Lambdaæ¶æ„"><a href="#Lambdaæ¶æ„" class="headerlink" title="Lambdaæ¶æ„"></a>Lambdaæ¶æ„</h3><p>â€‹        åœ¨ç»§ç»­äº†è§£æ•°æ®æ¹–ä¹‹å‰æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ç›¸å…³å¤§æ•°æ®æ¶æ„ï¼Œä¸»è¦åˆ†ä¸ºä¸¤ç§æ¶æ„ï¼Œåˆ†åˆ«æ˜¯lambda &amp; kappaï¼Œæˆ‘ä»¬å…ˆæ¥</p><p>è¯´lambdaæ¶æ„ã€‚lambdaæ˜¯ä¸€ç§æ¯”è¾ƒä¼ ç»Ÿçš„å¤§æ•°æ®æ¶æ„ï¼Œå¹¿æ³›åº”ç”¨äºç°åœ¨çš„å¤§æ•°æ®æ•°ä»“å¹³å°ä¸­ï¼Œå…¶ä¸­ä¸»è¦çš„ç‰¹ç‚¹å°±æ˜¯æµæ‰¹</p><p>åˆ†ç¦»ï¼Œæ¯”å¦‚æˆ‘ä»¬æ‰¹å¤„ç†æ•°æ®ä¼šåœ¨æ¯å¤©å¤œé—´12ç‚¹è¿è¡Œä¸€æ¬¡ï¼Œè®¡ç®—æ˜¨å¤©ä¸€å¤©çš„æ•°æ®ç„¶åè¦†ç›–åˆ°druidæˆ–è€…clickhouseä¸­ï¼Œä¿è¯æ•°</p><p>æ®çš„å‡†ç¡®æ€§ï¼Œä½†æ˜¯å¯¹äºä»Šå¤©çš„å®æ—¶æ•°æ®æŸ¥è¯¢æ¥è¯´æˆ‘ä»¬å°±åªèƒ½é€šè¿‡å®æ—¶ç¨‹åºæ¥è®¡ç®—å¥½ä¹‹åå­˜åˆ°druidæˆ–è€…clickhouseä¸­ï¼Œå› ä¸º</p><p>ç¦»çº¿å±‚é‡‡ç”¨åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿï¼Œè¿™æ ·å“ªæ€•ç¨‹åºå´©æºƒä¹Ÿä¸å¤§å¯èƒ½ä¼šæŸä¼¤åˆ°æ•°æ®ã€‚</p><img src="/2021/10/20/%E6%95%B0%E6%8D%AE%E6%B9%96%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E4%B8%8E%E7%90%86%E8%AE%BA%EF%BC%8CIceberg/lambda%E6%9E%B6%E6%9E%84.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>Lambdaæ¶æ„ä¼˜ç¼ºç‚¹å¦‚ä¸‹ï¼š</p><p>ä¼˜ç‚¹ï¼š</p><p>ï¼ˆ1ï¼‰ç¦»çº¿å±‚é‡‡ç”¨åˆ†å¸ƒå¼å­˜å‚¨ç®¡ç†å†å²ä¿¡æ¯ï¼Œå³ä½¿ç³»ç»Ÿå´©æºƒä¹Ÿä¸å¤ªå¯èƒ½æŸä¼¤åˆ°æ•°æ®</p><p>ï¼ˆ2ï¼‰æœ‰æ•ˆå¹³è¡¡äº†é€Ÿåº¦ä¸å¯é æ€§</p><p>ï¼ˆ3ï¼‰å®¹ç¾è€Œå…¼å…·å¼¹æ€§çš„æ•°æ®å¤„ç†æ¶æ„</p><p>ç¼ºç‚¹ï¼š</p><p>ï¼ˆ1ï¼‰Lambadæ¶æ„ç»´æŠ¤æˆæœ¬å¾ˆé«˜ã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™ç§æ¶æ„ä¸‹æ•°æ®å­˜åœ¨ä¸¤ä»½ã€schemaä¸ç»Ÿä¸€ã€ æ•°æ®å¤„ç†é€»è¾‘ä¸ç»Ÿä¸€ï¼Œæ•´ä¸ªæ•°ä»“ç³»ç»Ÿç»´æŠ¤æˆæœ¬å¾ˆé«˜</p><p>ï¼ˆ2ï¼‰Lambdaä¸­çš„å®æ—¶æ•°ä»“ä¸­ä¸€èˆ¬ä½¿ç”¨kafkaå½“åšä¸­é—´ä»¶ï¼Œä½†æ˜¯kafkaä¸æ”¯æŒOLAPæ“ä½œï¼Œå¤§å¤šæ•°ä¸šåŠ¡å¸Œæœ›å¯ä»¥åœ¨DWDã€DWSå±‚è¿›è¡Œå³å¸­æŸ¥è¯¢ï¼Œkafkaæ— æ³•æ»¡è¶³</p><p>ï¼ˆ3ï¼‰Lambdaå®æ—¶æ•°ä»“kafkaä»…æ”¯æŒappendä¸æ”¯æŒupdate/delete</p><h3 id="Kappaæ¶æ„"><a href="#Kappaæ¶æ„" class="headerlink" title="Kappaæ¶æ„"></a>Kappaæ¶æ„</h3><p>â€‹        Kappa æ¶æ„ä¸èƒ½è¢«ç®€å•è§†ä½œ Lambda æ¶æ„çš„æ›¿ä»£å“ï¼Œç›¸åï¼Œå®ƒæ˜¯åœ¨ç¦»çº¿å±‚å¯¹æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ä¸æ˜¯å¿…é¡»å®æ—¶çš„ä¸€ä¸ªå¤‡é€‰</p><p>é¡¹ã€‚è¯¥æ¶æ„é€‚åˆå®æ—¶å¤„ç†ä¸åŒäº‹ä»¶ï¼Œä¸‹å›¾å±•ç¤ºäº†å…¶æ•´ä½“ç»“æ„</p><img src="/2021/10/20/%E6%95%B0%E6%8D%AE%E6%B9%96%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E4%B8%8E%E7%90%86%E8%AE%BA%EF%BC%8CIceberg/kappa%E6%9E%B6%E6%9E%84.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>å…¶ä¸­ä¸­é—´çš„æ¶ˆæ¯ä»¶ä¸€èˆ¬é‡‡ç”¨kafkaï¼Œå› ä¸ºå…¶å¤šåˆ†åŒºï¼Œé¡ºåºappend dataï¼Œå¯æ°´å¹³æ‹“å±•çš„ç‰¹æ€§è¿åˆäº†å…³é”®éœ€æ±‚ã€‚ä¸€èˆ¬å®æ—¶æ¶æ„</p><p>é€‰ç”¨çš„æ˜¯Flink+Kafkaæ¶æ„ï¼Œå¦‚æœæ•°æ®é‡æå¤§çš„æƒ…å†µï¼Œä¸€èˆ¬kafkaçš„è¿‡æœŸæ—¶é—´è®¾ç½®çš„éƒ½æ¯”è¾ƒçŸ­ï¼Œæ¯”å¦‚ä¸€å¤©ç”šè‡³å‡ å°æ—¶ï¼Œä½†æ˜¯</p><p>å¦‚æœæ•°æ®å‡ºç°å³°å€¼æƒ…å†µï¼Œå¯¼è‡´æ•°æ®ç§¯å‹éªŒè¯çš„è¯ï¼Œå¯èƒ½å¯¼è‡´kafkaä¸­æ•°æ®ä¸èƒ½è¢«åŠæ—¶æ¶ˆè´¹å‡ºæ¥åœ¨Kafkaä¸­è¿‡æœŸå¯¼è‡´æ•°æ®ä¸¢</p><p>å¤±ã€‚</p><p>Kappaæ¶æ„ä¼˜ç¼ºç‚¹ï¼š</p><p>ä¼˜ç‚¹ï¼š</p><p>ï¼ˆ1ï¼‰æ— éœ€ç¦»çº¿å±‚</p><p>ï¼ˆ2ï¼‰åªæœ‰å½“ä»£ç å˜æ›´æ—¶æ‰éœ€è¦é‡æ–°å¤„ç†</p><p>ï¼ˆ3ï¼‰å¯ä»¥ä½¿ç”¨å›ºå®šå†…å­˜è¿›è¡Œéƒ¨ç½²</p><p>ï¼ˆ4ï¼‰å¯ç”¨äºå…·å¤‡æ°´å¹³æ‰©å±•æ€§çš„ç³»ç»Ÿ</p><p>ï¼ˆ5ï¼‰æœºå™¨å­¦ä¹ æ˜¯å®æ—¶çš„ï¼Œæ‰€ä»¥æ‰€éœ€èµ„æºæ›´å°‘</p><p>ç¼ºç‚¹ï¼š</p><p>ï¼ˆ1ï¼‰ç¼ºå°‘ç¦»çº¿å±‚å¯èƒ½å¯¼è‡´æ•°æ®å¤„ç†æˆ–æ•°æ®åº“æ›´æ–°æ—¶å‘ç”Ÿé”™è¯¯ï¼Œæ‰€ä»¥å¾€å¾€éœ€è¦å¼‚å¸¸ç®¡ç†å™¨æ¥è°ƒè§£çŸ›ç›¾ï¼Œæ¢å¤æ•°æ®ã€‚</p><p>ï¼ˆ2ï¼‰æ•°æ®é“¾è·¯æ›´åŠ å¤æ‚ï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å¯¹DWDå±‚çš„å®æ—¶æ•°ä»“æ•°æ®è¿›è¡Œæ•°æ®åˆ†æçš„æ—¶å€™å°±éœ€è¦å°†DWDå±‚çš„Kafkaä¸­çš„æ•°æ®</p><p>å†™å…¥åˆ°ClickHouseæˆ–è€…hiveä¸­ï¼Œå¢åŠ äº†é“¾è·¯å¤æ‚æ€§</p><p>ï¼ˆ3ï¼‰Kappaæ¶æ„æ˜¯ä¸¥é‡ä¾èµ–äºæ¶ˆæ¯é˜Ÿåˆ—çš„ï¼Œæ¶ˆæ¯é˜Ÿåˆ—æœ¬èº«çš„å‡†ç¡®æ€§ä¸¥æ ¼ä¾èµ–å®ƒä¸Šæ¸¸æ•°æ®çš„é¡ºåºï¼Œä½†æ˜¯ï¼Œæ¶ˆæ¯é˜Ÿåˆ—è¶Šå¤šï¼Œ</p><p>å‘ç”Ÿä¹±åºçš„å¯èƒ½æ€§è¶Šå¤§ã€‚</p><p>ä¸Šé¢åˆ†åˆ«è®²è¿°äº†ä¸¤ç§æ¶æ„çš„ä¼˜ç¼ºç‚¹ï¼Œè¿™æ—¶å€™æœ‰äººå°±æå‡ºäº†ï¼Œæœ‰æ²¡æœ‰ä¸€ç§æŠ€æœ¯èƒ½å¤Ÿä¿è¯æ•°æ®é«˜æ•ˆå›æº¯èƒ½åŠ›ï¼Œæ¶æ„ç¨³å®šï¼Œæ”¯æŒ</p><p>æ•°æ®æ›´æ–°ï¼Œæ”¯æŒæ•°æ®çš„æµæ‰¹è¯»å†™ï¼Œåšåˆ°åˆ†é’Ÿçº§åˆ«çš„æ•°æ®æ¥å…¥ã€‚</p><p>äºæ˜¯ä¹ï¼Œå„å¤§å‚å•†é’ˆå¯¹ä¸Šé¢çš„éœ€æ±‚ï¼Œåˆ†åˆ«æ¨å‡ºäº†è‡ªå·±çš„æ•°æ®æ¹–æ–¹æ¡ˆï¼Œç°åœ¨åŸºæœ¬å‘ˆç°ä¸‰è¶³é¼ç«‹çš„å±€åŠ¿ï¼ŒDeltaï¼ŒHudiï¼Œä»¥åŠIcebergã€‚</p><h2 id="Iceberg"><a href="#Iceberg" class="headerlink" title="Iceberg"></a>Iceberg</h2><p>â€‹    ä¸Šé¢æˆ‘ä»¬äº†è§£äº†å…³äºä¸€ä¸ªæ•°æ®æ¹–åº”è¯¥å…·æœ‰çš„ç‰¹æ€§ä»¥åŠlambdaæ¶æ„å’ŒKappaæ¶æ„ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹Netflixå‘èµ·çš„æ•°æ®æ¹–é¡¹</p><p>ç›®Icebergï¼ŒIcebergçš„è¡¨æ•°æ®æ¶æ„å›¾ï¼š</p><img src="/2021/10/20/%E6%95%B0%E6%8D%AE%E6%B9%96%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E4%B8%8E%E7%90%86%E8%AE%BA%EF%BC%8CIceberg/Iceberg%E8%A1%A8%E6%95%B0%E6%8D%AE%E7%BB%84%E7%BB%87%E6%9E%B6%E6%9E%84.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š</p><p>ï¼ˆ1ï¼‰æ–°å¿«ç…§ä¸ä¼šè¦†ç›–æ—§å¿«ç…§ï¼Œæ—§çš„å¿«ç…§ä¸­ä¾ç„¶ä¿å­˜äº†æ—©æœŸæ•°æ®çš„Manifest Fileï¼Œæ–°æ—§å¿«ç…§å…±åŒç»„æˆäº†è¡¨çš„å¿«ç…§Metadata</p><p>çš„ä¸€éƒ¨åˆ†ã€‚</p><p>ï¼ˆ2ï¼‰æ•°æ®æ–‡ä»¶datafileæ”¯æŒå¤šç§æ ¼å¼å¦‚parque,orc,avroç­‰æ ¼å¼ã€‚</p><p>ï¼ˆ3ï¼‰æœ‰äº†å¿«ç…§ï¼Œè¯»æ•°æ®çš„æ—¶å€™åªèƒ½è¯»åˆ°å¿«ç…§æ‰€èƒ½å¼•ç”¨åˆ°çš„æ•°æ®ï¼Œè¿˜åœ¨å†™çš„æ•°æ®ä¸ä¼šè¢«å¿«ç…§å¼•ç”¨åˆ°ï¼Œä¹Ÿå°±ä¸ä¼šè¯»åˆ°è„æ•°</p><p>æ®ã€‚å¤šä¸ªå¿«ç…§ä¼šå…±äº«ä»¥å‰çš„æ•°æ®æ–‡ä»¶ï¼Œé€šè¿‡å…±äº«è¿™äº› Manifest File æ¥å…±äº«ä¹‹å‰çš„æ•°æ®ã€‚</p><p>ï¼ˆ4ï¼‰Manifest Listå†å¾€ä¸Šæ˜¯å¿«ç…§å…ƒæ•°æ®ï¼ˆå¿«ç…§Metadataï¼‰ï¼Œè®°å½•äº†å½“å‰æˆ–è€…å†å²ä¸Šè¡¨æ ¼ Scheme çš„å˜åŒ–ã€åˆ†åŒºçš„é…ç½®ã€</p><p>æ‰€æœ‰å¿«ç…§ Manifest File è·¯å¾„ã€ä»¥åŠå½“å‰å¿«ç…§æ˜¯å“ªä¸€ä¸ªã€‚åŒæ—¶ï¼ŒIceberg æä¾›å‘½åç©ºé—´ä»¥åŠè¡¨æ ¼çš„æŠ½è±¡ï¼Œåšå®Œæ•´çš„æ•°æ®ç»„ç»‡</p><p>ç®¡ç†ã€‚</p><p>æœ‰äº†Icebergè¿™ç§ç¥å™¨ä¹‹åï¼Œæ–°ä¸€ä»£çš„æ•°ä»“åŸºäºFlinkä»¥åŠIcebergçš„è®¾è®¡æ¨ªç©ºå‡ºä¸–</p><img src="/2021/10/20/%E6%95%B0%E6%8D%AE%E6%B9%96%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E4%B8%8E%E7%90%86%E8%AE%BA%EF%BC%8CIceberg/%E6%96%B0%E6%95%B0%E4%BB%93%E6%9E%B6%E6%9E%84.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>è¿™æ ·æ— è®ºæ˜¯æµå¤„ç†è¿˜æ˜¯æ‰¹å¤„ç†ï¼Œæˆ‘ä»¬çš„å­˜å‚¨éƒ½æ˜¯è¿›å…¥åˆ°äº†Icebergæ•°æ®æ¹–ä¸­ï¼Œä¸ç”¨å†åˆ†å¼€åšæµæ‰¹å¤„ç†çš„ä¸¤å¥—ä»£ç ï¼Œä»¥åŠä¸ç”¨</p><p>å¤§é‡ä¾é kafkaè¿™ç§æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œä¸‹é¢æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹è¿™ä¸ªæ–°æ¶æ„çš„ä¼˜ç‚¹ã€‚</p><p>ï¼ˆ1ï¼‰è§£å†³Kafkaå­˜å‚¨æ•°æ®é‡æœ‰é™çš„é—®é¢˜ï¼Œkafkaä½¿ç”¨æˆæœ¬è¾ƒé«˜ï¼Œæ•°æ®æ¹–æ‰€æœ‰æ•°æ®éƒ½æ˜¯åŸºäºHDFSå®ç°çš„æ–‡ä»¶ç®¡ç†ç³»ç»Ÿï¼Œæ•°æ®</p><p>é‡å¯ä»¥å·¨å¤§åŸºæœ¬ä¸ç”¨æ‹…å¿ƒ</p><p>ï¼ˆ2ï¼‰DWDå±‚ï¼ŒODSå±‚ä¾ç„¶æ”¯æŒOLAPæŸ¥è¯¢ï¼ŒåŸå…ˆçš„å®æ—¶æ•°ä»“å¦‚æœæƒ³æŸ¥è¯¢è¿™ä¸¤å±‚çš„æ•°æ®éœ€è¦é€šè¿‡Flinkå°†æ•°æ®å¯¼å…¥åˆ°OLAPæŸ¥</p><p>è¯¢å¹³å°ï¼ˆClickHouseã€Druidã€Hiveï¼‰</p><p>ï¼ˆ3ï¼‰æ‰¹æµå­˜å‚¨éƒ½æ˜¯åŸºäºIcebergä»¥åŠHDFSä¹‹åï¼Œå°±å¯ä»¥å®Œå…¨å¤ç”¨ä¸€å¥—æ•°æ®è´¨é‡ç®¡ç†ä½“ç³»ï¼Œæ•°æ®è¡€ç¼˜å…³ç³»åŒæ ·ä¹Ÿåªåšä¸€å¥—</p><p>å³å¯</p><p>ï¼ˆ4ï¼‰ä¾é æ•°æ®æ¹–æ¶æ„è®¾è®¡çš„å®æ—¶æ•°ä»“å¯ä»¥çœ‹åšæ˜¯ä¸€ç§Kappaæ¶æ„çš„å‡çº§ï¼Œkappaçš„ä¼˜ç‚¹åœ¨æ•°æ®æ¹–æ•°ä»“ä¸­ä¾ç„¶å­˜åœ¨ï¼Œ</p><p>schemaç»Ÿä¸€ï¼Œæ•°æ®å¤„ç†é€»è¾‘ç»Ÿä¸€ï¼Œå¼€å‘äººå‘˜ä¸ç”¨å†ç»´æŠ¤ä¸¤å¥—ä»£ç ã€‚</p><p>ä¸Šé¢åŸºäºIcebergæ„å»ºçš„æ¶æ„çœ‹èµ·æ¥å°±åƒæ˜¯æŠŠLambdaæ¶æ„ä¸­çš„Kafkaå’ŒHDFSç»“åˆåˆ°äº†ä¸€èµ·ï¼Œå¹¶ä¸”æˆ‘ä»¬çŸ¥é“Icebergä¹Ÿæ˜¯å¯</p><p>ä»¥åŸºäºHDFSä¸Šå­˜å‚¨çš„ï¼Œé‚£ä¹ˆä»–ç©¶ç«Ÿæ˜¯åœ¨HDFSä¸Šåšäº†å“ªäº›æ“ä½œè®©å…¶å¯ä»¥ä½œä¸ºå®æ—¶æ•°ä»“çš„å­˜å‚¨äº†å‘¢ï¼Ÿ</p><p>ï¼ˆ1ï¼‰<strong>æ”¯æŒæµå¼å†™å…¥-å¢é‡æ‹‰å–</strong>ï¼Œç›®å‰ä¸»è¦åŸºäºFlinkå³å¯å®ç°æµå¼å†™å…¥ï¼Œä½†æ˜¯è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå› ä¸ºé¢‘ç¹çš„å†™æ–‡ä»¶å¯¼è‡´å°æ–‡ä»¶</p><p>å¯èƒ½ä¼šå¢å¤šï¼Œæ•°æ®æ¹–éœ€è¦åœ¨è¿™æ–¹é¢åšå‡ºå¤„ç†ï¼Œè¿˜æœ‰å°±æ˜¯å®æ—¶å¤„ç†ç¨‹åºéœ€è¦çŸ¥é“<strong>å“ªäº›æ–‡ä»¶æ˜¯æ–°å¢çš„å“ªäº›æ˜¯æ—§çš„</strong>ï¼Œæ¯æ¬¡åªéœ€è¦</p><p>å¤„ç†æ–°å¢çš„æ–‡ä»¶å³å¯ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ç¦»çº¿æ•°ä»“åšä¸åˆ°å®æ—¶çš„å…³é”®åŸå› ä¹‹ä¸€ï¼Œç¦»çº¿æ•°ä»“çš„åšæ³•å°±æ˜¯å¤„ç†å®Œä¸€æ•´æ‰¹æ•°æ®ä¹‹å’Œç»™ä¸‹æ¸¸</p><p>è¯´æˆ‘è¿™æ‰¹æ•°æ®å¤„ç†å®Œäº†ï¼Œä½ å¯ä»¥ä½¿ç”¨äº†ã€‚é‚£Icebergå¦‚ä½•å®ç°è¯»å†™å¢é‡æ‹‰å–çš„å‘¢ï¼Ÿè¿™ä¸ªéœ€è¦æˆ‘ä»¬ä¸Šé¢æåˆ°çš„è¡¨æ•°æ®ç»„ç»‡æ¶</p><p>æ„ã€‚</p><img src="/2021/10/20/%E6%95%B0%E6%8D%AE%E6%B9%96%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E4%B8%8E%E7%90%86%E8%AE%BA%EF%BC%8CIceberg/Iceberg%E8%AF%BB%E5%86%99API.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>â€‹        å…¶ä¸­çš„s0è¡¨ç¤ºç¬¬ä¸€æ¬¡äº§ç”Ÿçš„å¿«ç…§ï¼Œs1è¡¨ç¤ºç¬¬äºŒæ¬¡äº§ç”Ÿçš„å¿«ç…§ï¼ŒåŒæ ·æ–°å¿«ç…§æ˜¯åŒ…å«äº†æ—§å¿«ç…§ä¸­çš„æ•°æ®çš„ï¼Œæ ¹æ®å¿«ç…§ä¸­çš„</p><p>manifestæ–‡ä»¶Icebergå¯ä»¥ç¡®å®šå“ªäº›æ–‡ä»¶æ˜¯æ—§æ–‡ä»¶ï¼Œå“ªäº›æ˜¯æ–°æ–‡ä»¶ï¼Œæœ‰å¿«ç…§äº†æˆ‘ä»¬å°±å¯ä»¥æ ¹æ®å¿«ç…§ä¸­çš„å†…å®¹åˆ¤æ–­æ–‡ä»¶æ˜¯æ–°å¢</p><p>çš„è¿˜æ˜¯åŸå…ˆå°±å­˜åœ¨çš„ã€‚</p><p>ï¼ˆ2ï¼‰è§£å†³å°æ–‡ä»¶è¿‡å¤šçš„é—®é¢˜ï¼Œç›®å‰icebergçš„sparkä»£ç ä¸­æœ‰åŸç”Ÿçš„åˆå¹¶å°æ–‡ä»¶ä»£ç ï¼Œflinkçš„åˆå¹¶ä»£ç ç¤¾åŒºè¿˜åœ¨ç§¯æå¼€å‘</p><p>ä¸­ï¼Œè¯¦ç»†å¯ä»¥çœ‹ä¸€ä¸‹<a class="link"   href="https://github.com/apache/iceberg/pull/3213" >issue<i class="fas fa-external-link-alt"></i></a></p><h2 id="Macå®‰è£…Iceberg"><a href="#Macå®‰è£…Iceberg" class="headerlink" title="Macå®‰è£…Iceberg"></a>Macå®‰è£…Iceberg</h2><p>Versions:<br>Hive 3.1.2  (hive â€“version)<br>Hadoop 3.3.1  (hadoop version)<br>Flink Version: 1.11.1 (flink â€“version)</p><p><strong>æ³¨æ„äº‹é¡¹</strong></p><p>ï¼ˆ1ï¼‰ğŸ‘†ä¸Šé¢çš„ç‰ˆæœ¬æ˜¯æˆ‘è‡ªå·±æœ¬æœºçš„å®‰è£…ï¼Œå¯èƒ½å…¶ä»–ç‰ˆæœ¬ä¹Ÿå¯ä»¥ï¼Œä½†æ˜¯Flinkæœ€å¥½æ˜¯é€‰ç”¨1.11ç‰ˆæœ¬çš„ï¼Œå› ä¸ºIcebergå®˜ç½‘æœ‰è¿™</p><p>æ ·ä¸€å¥è¯</p><p><code>Apache Iceberg supports both [Apache Flink](https://flink.apache.org/)â€˜s DataStream API and Table API to write records into an Iceberg table. Currently, we only integrate Iceberg with Apache Flink 1.11.x.</code></p><p>ï¼ˆ2ï¼‰Macä½¿ç”¨brewå®‰è£…æŒ‡å®šç‰ˆæœ¬çš„flinkéœ€è¦å°†flinké¡¹ç›®cloneåˆ°æœ¬åœ°ç„¶åæ‰¾åˆ°flinkçš„æäº¤è®°å½•ï¼Œç„¶åå®‰è£…æŒ‡å®šç‰ˆæœ¬å¯¹åº”çš„</p><p>commit idï¼Œè¯¦ç»†å‚è€ƒ<a class="link"   href="https://blog.timeline229.com/homebrew-set-software-elder-version/" >è¿™é‡Œ!<i class="fas fa-external-link-alt"></i></a>ï¼Œä½†æ˜¯éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæˆ‘è¿™æ ·å®‰è£…åŒæ ·æ˜¯æŠ¥é”™çš„ï¼Œæ‰€ä»¥æœ€ç»ˆé‡‡ç”¨äº†ä¸‹è½½ç‰ˆæœ¬çš„å¯¹åº”å‹ç¼©åŒ…ç›´æ¥</p><p>è§£å‹åœ¨æœ¬åœ°ç›®å½•ä½¿ç”¨.</p><p>ï¼ˆ3ï¼‰ç¯å¢ƒå˜é‡å¿…é¡»è¦é…ç½®ï¼Œæˆ‘å½“æ—¶æ²¡æœ‰é…ç½®æ˜¯è¿è¡Œå¤±è´¥äº†çš„ï¼Œé…ä¸Šè‚¯å®šæ˜¯ä¿é™©çš„ï¼Œå› ä¸ºMacç¨‹åºå‘˜ä¸€èˆ¬ä¼šç”¨homebrewå®‰</p><p>è£…è½¯ä»¶ï¼Œä¼šå‘ç°ä¸ç”¨åƒåŸå…ˆLinuxï¼Œæˆ–è€…windowséœ€è¦é…ç½®ç¯å¢ƒå˜é‡æ‰èƒ½ä½¿ç”¨</p><blockquote><p>Macä½¿ç”¨Homebrewå®‰è£…è½¯ä»¶çš„æ—¶å€™ï¼Œè½¯ä»¶åŒ…çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¼šè¢«åˆ›å»ºè½¯è¿æ¥ç„¶åæ”¾åˆ°/usr/local/binä¸­ï¼Œè€ŒMacå¼€æœºæ—¶ï¼Œä¼šè‡ªåŠ¨è¯»å–è¯¥æ–‡ä»¶ï¼Œä½¿ç”¨æŸä¸ªå‘½ä»¤æ—¶ä¼šæ ¹æ®é“¾æ¥æ–‡ä»¶æ‰¾åˆ°å‘½ä»¤çš„å®é™…ä½ç½®å¹¶æ‰§è¡Œã€‚</p></blockquote><p>éœ€è¦é…ç½®çš„ç¯å¢ƒå˜é‡å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">æ³¨æ„ï¼šéœ€è¦å°†åœ°å€æ¢æˆä½ è‡ªå·±çš„å®‰è£…åœ°å€</span></span><br><span class="line"><span class="meta">#</span><span class="bash">æ·»åŠ å®Œæˆä¹‹åè®°å¾—è¿›è¡Œ <span class="built_in">source</span> æ“ä½œï¼Œè®©ä¿®æ”¹é©¬ä¸Šç”Ÿæ•ˆ</span></span><br><span class="line">export HADOOP_HOME=/usr/local/Cellar/hadoop/3.3.1/libexec</span><br><span class="line">export JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk1.8.0_291.jdk/Contents/Home</span><br><span class="line"><span class="meta">#</span><span class="bash">éœ€è¦æ³¨æ„çš„æ˜¯hadoop classpathä¼šè‡ªåŠ¨å°†ç›¸å…³åŒ…çš„è·¯å¾„æ‰“å‡ºæ¥ï¼Œä¸ç”¨ä¸€ä¸ªä¸ªæ‰‹åŠ¨æ•²</span></span><br><span class="line">export HADOOP_CLASSPATH=hadoop classpath</span><br><span class="line">export PATH=$HADOOP_CLASSPATH:$HADOOP_HOME:$JAVA_HOME/bin:$PATH</span><br></pre></td></tr></table></figure><p>ï¼ˆ4ï¼‰æˆ‘ä»¬åé¢åˆ›å»ºHiveCatlogåˆ›å»ºä¿®æ”¹Hiveè¡¨æ•°æ®åˆ™éœ€è¦è¿æ¥Hiveçš„å…ƒæ•°æ®ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€éœ€è¦å¯åŠ¨Hive metastoreæœ</p><p>åŠ¡ï¼Œæˆ‘ä»¬å¹³å¸¸å¯¹Hive metastoreå…ƒæ•°æ®æœåŠ¡æ²¡æœ‰ä»€ä¹ˆæ„Ÿè§‰ï¼Œä¸‹é¢æœ‰ä¸€æ®µå…³äºHive Metastoreçš„ç®€çŸ­ä»‹ç»ï¼Œæ›´è¯¦ç»†ä¿¡æ¯å¯ä»¥</p><p>å‚è€ƒ<a class="link"   href="https://zhuanlan.zhihu.com/p/100585524" >!çŸ¥ä¹å›ç­”<i class="fas fa-external-link-alt"></i></a> &amp; <a class="link"   href="https://docs.cloudera.com/runtime/7.2.7/hive-hms-overview/topics/hive-hms-introduction.html" >!clouderaå®˜ç½‘ä»‹ç»<i class="fas fa-external-link-alt"></i></a></p><blockquote><p>Hive Metastoreæ˜¯Hiveç”¨æ¥ç®¡ç†åº“è¡¨å…ƒæ•°æ®çš„ä¸€ä¸ªæœåŠ¡ï¼Œæœ‰äº†å®ƒä¸Šå±‚çš„æœåŠ¡ä¸ç”¨å†è·Ÿè£¸çš„æ–‡ä»¶æ•°æ®æ‰“äº¤é“ï¼Œè€Œæ˜¯å¯ä»¥åŸºäºç»“æ„åŒ–çš„åº“è¡¨ä¿¡æ¯æ„å»ºè®¡ç®—æ¡†æ¶ã€‚ç°åœ¨é™¤äº†Hiveä¹‹å¤–å¾ˆå¤šè®¡ç®—æ¡†æ¶éƒ½æ”¯æŒä»¥Hive Metastoreä¸ºå…ƒæ•°æ®ä¸­å¿ƒæ¥æŸ¥è¯¢åº•å±‚Hadoopç”Ÿæ€çš„æ•°æ®ï¼Œæ¯”å¦‚Drill, Presto, Sparkç­‰ç­‰ã€‚</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">æˆ‘ä»¬åœ¨Macä¸Šå¯åŠ¨Hive MetastoreæœåŠ¡å‘½ä»¤</span><br><span class="line">hive --service metastore</span><br></pre></td></tr></table></figure><p>äº†è§£äº†ä¸Šé¢çš„æ³¨æ„äº‹é¡¹ä¹‹åæˆ‘ä»¬å¼€å§‹ä¸‹è½½Icebergçš„jaråŒ…ï¼Œ<a class="link"   href="https://repo.maven.apache.org/maven2/org/apache/iceberg/iceberg-flink-runtime/0.11.1/" >ä¸‹è½½åœ°å€<i class="fas fa-external-link-alt"></i></a></p><p>ä¸‹è½½å¥½ä¹‹åæˆ‘ä»¬å°†Icebergçš„JaråŒ…(iceberg-flink-runtime-0.11.1.jar)å’Œç”¨æ¥è¿æ¥hiveçš„jaråŒ…(flink-sql-connector-hive-</p><p>3.1.2_2.11-1.11.0.jar)æ”¾åˆ°flinkç›®å½•ä¸­çš„libç›®å½•</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">è¿›å…¥flink-sqlï¼Œè¿›å…¥å‰è®°å¾—æ‰“å¼€Hiveå…ƒæ•°æ®æœåŠ¡</span></span><br><span class="line">./sql-client.sh embedded \\n    </span><br><span class="line">-j /Users/liu/Documents/flink-1.11.1/lib/iceberg-flink-runtime-0.11.1.jar \\n    </span><br><span class="line">-j /Users/liu/Documents/flink-1.11.1/lib/flink-sql-connector-hive-3.1.2_2.11-1.11.0.jar \\n    shell</span><br></pre></td></tr></table></figure><p>åˆ›å»ºHiveçš„Catalogï¼Œå³å¯ä»¥å»ºç«‹å·²HDFSä¸ºåŸºç¡€çš„æ•°æ®æ¹–è¡¨</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Flink <span class="keyword">SQL</span><span class="operator">&gt;</span> <span class="keyword">CREATE</span> CATALOG hive_catalog <span class="keyword">WITH</span> (</span><br><span class="line"><span class="operator">&gt;</span>   <span class="string">&#x27;type&#x27;</span><span class="operator">=</span><span class="string">&#x27;iceberg&#x27;</span>,</span><br><span class="line"><span class="operator">&gt;</span>   <span class="string">&#x27;catalog-type&#x27;</span><span class="operator">=</span><span class="string">&#x27;hive&#x27;</span>,</span><br><span class="line"><span class="operator">&gt;</span>   <span class="string">&#x27;uri&#x27;</span><span class="operator">=</span><span class="string">&#x27;thrift://localhost:9083&#x27;</span>,</span><br><span class="line"><span class="operator">&gt;</span>   <span class="string">&#x27;clients&#x27;</span><span class="operator">=</span><span class="string">&#x27;5&#x27;</span>,</span><br><span class="line"><span class="operator">&gt;</span>   <span class="string">&#x27;property-version&#x27;</span><span class="operator">=</span><span class="string">&#x27;1&#x27;</span>,</span><br><span class="line"><span class="operator">&gt;</span>   <span class="string">&#x27;warehouse&#x27;</span><span class="operator">=</span><span class="string">&#x27;hdfs://localhost:9000/user/hive/warehouse&#x27;</span></span><br><span class="line"><span class="operator">&gt;</span> );</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>â€‹        æœ¬æ–‡ä¸»è¦è®°å½•æ•°æ®æ¹–çš„åŸºç¡€çŸ¥è¯†ï¼Œä»¥åŠå¦‚ä½•åœ¨Macä¸Šå®‰è£…Icebergï¼Œå…¶ä¸­çš„æ³¨æ„äº‹é¡¹æ˜¯æˆ‘å‡ºç°è¿‡çš„é—®é¢˜ï¼Œå¦‚æœæœ‰ä»€ä¹ˆç–‘é—®æˆ–è€…ä¸ç†è§£çš„åœ°æ–¹æ¬¢è¿éšæ—¶äº¤æµã€‚</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;&lt;strong&gt;è®¡ç®—æœºç§‘å­¦é¢†åŸŸçš„ä»»ä½•é—®é¢˜éƒ½å¯ä»¥é€šè¿‡å¢åŠ ä¸€ä¸ªé—´æ¥åœ°ä¸­é—´å±‚æ¥è§£å†³&lt;/strong&gt;&lt;/p&gt;</summary>
    
    
    
    
    <category term="data Lake" scheme="http://example.com/tags/data-Lake/"/>
    
    <category term="Iceberg" scheme="http://example.com/tags/Iceberg/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨grafanaç›‘æ§é¢„è­¦è¡¨æ ¼ç±»å‹æ•°æ®</title>
    <link href="http://example.com/2021/10/20/%E4%BD%BF%E7%94%A8grafana%E7%9B%91%E6%8E%A7%E9%A2%84%E8%AD%A6%E8%A1%A8%E6%A0%BC%E7%B1%BB%E5%9E%8B%E6%95%B0%E6%8D%AE/"/>
    <id>http://example.com/2021/10/20/%E4%BD%BF%E7%94%A8grafana%E7%9B%91%E6%8E%A7%E9%A2%84%E8%AD%A6%E8%A1%A8%E6%A0%BC%E7%B1%BB%E5%9E%8B%E6%95%B0%E6%8D%AE/</id>
    <published>2021-10-20T06:19:25.000Z</published>
    <updated>2021-10-20T12:38:41.207Z</updated>
    
    <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>ç›‘æ§clickhouseæœåŠ¡ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯grafana+grafana-clickhouseæ’ä»¶ï¼Œgrafanaåªèƒ½æŠ¥è­¦graphç±»å‹æ•°æ®ï¼Œä¸èƒ½æŠ¥è­¦ç±»ä¼¼Tableæ ·å¼çš„æ•°æ®ï¼Œååº”å‡ºæ¥å°±æ˜¯panelæœ‰æ²¡æœ‰alterè¿™ä¸ªTab</p><span id="more"></span><img src="/2021/10/20/%E4%BD%BF%E7%94%A8grafana%E7%9B%91%E6%8E%A7%E9%A2%84%E8%AD%A6%E8%A1%A8%E6%A0%BC%E7%B1%BB%E5%9E%8B%E6%95%B0%E6%8D%AE/alter%E5%9B%BE%E6%A0%87.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>å¯¹äºgraphç±»å‹æ•°æ®æ¯”å¦‚CPUä½¿ç”¨ç‡ï¼Œæˆ–è€…ç³»ç»ŸIOä½¿ç”¨ç‡çš„æƒ…å†µå¾ˆå®¹æ˜“å°±å¯ä»¥è¿›è¡Œé¢„è­¦æ“ä½œï¼Œä½†æ˜¯å¯¹äºä¸€äº›è¡¨æ ¼æ•°æ®ï¼Œæ¯”å¦‚ç£ç›˜ä½¿ç”¨æƒ…å†µï¼Œå¦‚ä¸‹å›¾è¿™ç§è¡¨æ ¼ç±»å‹çš„æ•°æ®å°±ä¸èƒ½å¾ˆå¥½åœ°æ”¯æŒé¢„è­¦ï¼Œè¿™æ—¶å€™éœ€è¦æˆ‘ä»¬å¯¹ç³»ç»Ÿè¡¨ç®€å•çš„æ”¹é€ æˆ–è€…æ”¹å†™æˆ‘ä»¬çš„æŸ¥è¯¢SQLã€‚</p><img src="/2021/10/20/%E4%BD%BF%E7%94%A8grafana%E7%9B%91%E6%8E%A7%E9%A2%84%E8%AD%A6%E8%A1%A8%E6%A0%BC%E7%B1%BB%E5%9E%8B%E6%95%B0%E6%8D%AE/%E6%B2%A1%E6%9C%89alter.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><h2 id="ç”¨â€™æ•°æ®ç‚¹â€™æ¥é¢„è­¦"><a href="#ç”¨â€™æ•°æ®ç‚¹â€™æ¥é¢„è­¦" class="headerlink" title="ç”¨â€™æ•°æ®ç‚¹â€™æ¥é¢„è­¦"></a>ç”¨â€™æ•°æ®ç‚¹â€™æ¥é¢„è­¦</h2><p>æƒ³è¦æ•°æ®æˆgraphæˆ–è€…Time seriesç±»å‹æ•°æ®å±•ç¤ºï¼Œæˆ‘ä»¬è‚¯å®šéœ€è¦æ•°æ®ä¸­å­˜åœ¨ä¸€ä¸ªæ—¶é—´å­—æ®µï¼Œæœ€å¥½æ˜¯è¿ç»­çš„ï¼Œé¦–å…ˆæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯grafana-clickhouseæ’ä»¶ï¼ŒæŸ¥è¯¢çš„System.partsç³»ç»Ÿè¡¨æ¥è·å–å„ä¸ªè¡¨å¤§å°ç„¶åæ±‚å’Œï¼Œæˆ‘ä»¬å¯¹partsè¡¨è¿›è¡Œdescæ“ä½œï¼ŒæŸ¥çœ‹å…¶ä¸­çš„æ—¶é—´å­—æ®µï¼Œå‘ç°æœ‰å››ä¸ªåˆ†åˆ«æ˜¯â€˜modification_timeâ€™ï¼Œâ€˜remove_timeâ€™ï¼Œâ€˜min_timeâ€™ï¼Œâ€˜max_timeâ€™ï¼Œå››ä¸ªæ—¶é—´å­—æ®µåˆ†åˆ«çš„å«ä¹‰å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">remove_time (DateTime) â€“ æ•°æ®ç‰‡æ®µå˜ä¸ºéæ¿€æ´»çŠ¶æ€çš„æ—¶é—´ã€‚</span><br><span class="line">min_time (DateTime) â€“ æ•°æ®ç‰‡æ®µä¸­æ—¥æœŸå’Œæ—¶é—´é”®çš„æœ€å°å€¼ã€‚</span><br><span class="line">max_time(DateTime) â€“ æ•°æ®ç‰‡æ®µä¸­æ—¥æœŸå’Œæ—¶é—´é”®çš„æœ€å°å€¼ã€‚</span><br><span class="line">modification_time (DateTime) â€“ ä¿®æ”¹åŒ…å«æ•°æ®ç‰‡æ®µçš„ç›®å½•çš„æ—¶é—´ã€‚è¿™é€šå¸¸å¯¹åº”äºåˆ›å»ºæ•°æ®éƒ¨åˆ†çš„æ—¶é—´ã€‚</span><br></pre></td></tr></table></figure><p>æœ‰ç‚¹è’™ï¼Œæ²¡äº‹æˆ‘ä»¬ç›´æ¥é€‰åæ¡æ•°æ®ç®€å•çœ‹ä¸€çœ‹</p><img src="/2021/10/20/%E4%BD%BF%E7%94%A8grafana%E7%9B%91%E6%8E%A7%E9%A2%84%E8%AD%A6%E8%A1%A8%E6%A0%BC%E7%B1%BB%E5%9E%8B%E6%95%B0%E6%8D%AE/%E6%97%B6%E9%97%B4%E7%BB%93%E6%9E%9C.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>å¯ä»¥çœ‹å‡º<code>modification_time</code>å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„æ—¶é—´å­—æ®µï¼Œä»£è¡¨äº†æœ€åä¸€æ¬¡ä¿®æ”¹çš„æ—¶é—´ï¼Œè¿™ä¸ªæ˜¯æœ€åˆé€‚çš„äº†ï¼Œå½“ç„¶æ›´åˆé€‚çš„æ˜¯è¿ç»­æ—¶é—´å­—æ®µï¼Œä½†æ˜¯è¿™é‡Œæ²¡æœ‰ã€‚æœ‰äº†æ—¶é—´å­—æ®µæˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯å†™æŸ¥è¯¢SQLäº†ï¼Œæˆ‘ä»¬åœ¨grafanaä¸­å†™ä¸‹å¦‚ä¸‹çš„æŸ¥è¯¢SQLã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="built_in">max</span>(modification_time) <span class="keyword">as</span> t,</span><br><span class="line">    (<span class="built_in">sum</span>(if(active, bytes, <span class="number">0</span>))) <span class="keyword">AS</span> size_on_disk</span><br><span class="line"><span class="keyword">FROM</span> monitor.parts</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> size_on_disk <span class="keyword">desc</span></span><br></pre></td></tr></table></figure><p>æ—¶é—´æˆ‘ä½¿ç”¨çš„æ˜¯æœ€å¤§çš„ä¿®æ”¹æ—¶é—´ï¼Œè¿™æ ·çš„è¯å°±æ˜¯ä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œè¿™ä¹Ÿæ˜¯æœ€å¤§çš„ç¼ºç‚¹ï¼Œå‘ˆç°å‡ºæ¥çš„ç»“æœæ˜¯è¿™æ ·çš„</p><img src="/2021/10/20/%E4%BD%BF%E7%94%A8grafana%E7%9B%91%E6%8E%A7%E9%A2%84%E8%AD%A6%E8%A1%A8%E6%A0%BC%E7%B1%BB%E5%9E%8B%E6%95%B0%E6%8D%AE/%E7%9B%91%E6%8E%A7%E7%BB%93%E6%9E%9C.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>è¿™æ ·è®¾è®¡çš„æ€æƒ³æ˜¯<strong>è¿™ä¸ªgraphåªæ˜¯ä¸ºäº†é¢„è­¦çš„ä½œç”¨ï¼Œå¦‚æœæ•´ä½“ç£ç›˜å®¹é‡è¶…è¿‡äº†æˆ‘ä»¬è®¾ç½®çš„é™åˆ¶ï¼Œæ¯”å¦‚80%å°±ä¼šæŠ¥è­¦ï¼Œèµ·åˆ°ä¸€ä¸ªé€šçŸ¥çš„ä½œç”¨ï¼Œç„¶åä¸Šçº¿grafanaå»æŸ¥çœ‹å„ä¸ªè¡¨çš„è¯¦ç»†å®¹é‡æƒ…å†µï¼Œå†åšå‡ºä¸€äº›æ“ä½œï¼Œæ¯”å¦‚åˆ é™¤æŸäº›åˆ†åŒºæ•°æ®æˆ–è€…æ‰©å®¹ç­‰</strong></p><h2 id="æ”¹å˜æŸ¥è¯¢çš„ç³»ç»Ÿè¡¨"><a href="#æ”¹å˜æŸ¥è¯¢çš„ç³»ç»Ÿè¡¨" class="headerlink" title="æ”¹å˜æŸ¥è¯¢çš„ç³»ç»Ÿè¡¨"></a>æ”¹å˜æŸ¥è¯¢çš„ç³»ç»Ÿè¡¨</h2><p>ç¬¬äºŒç§æ–¹æ³•æ˜¯ä¿®æ”¹æˆ‘ä»¬æŸ¥è¯¢çš„ç³»ç»Ÿè¡¨ï¼Œé¦–å…ˆæˆ‘ä»¬æŸ¥è¯¢çš„æ˜¯system.partsè¡¨ï¼Œå…¶ä¸­å› ä¸ºæ²¡æœ‰åˆé€‚çš„è¿ç»­æ—¶é—´å­—æ®µå¯¼è‡´æˆ‘ä»¬ä¸èƒ½å¾ˆå¥½åœ°åˆ›å»ºå…³äºCKç£ç›˜ä½¿ç”¨æƒ…å†µçš„æ—¶åºæ•°æ®ï¼Œé‚£æ¢ä¸€ç§æ€ç»´ï¼Œæˆ‘ä»¬è‡ªå·±æ¥æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„è¡¨å‘¢ï¼Ÿéœ€è¦æ»¡è¶³çš„æ¡ä»¶æœ‰ä»¥ä¸‹å‡ ä¸ªã€‚<br>ï¼ˆ1ï¼‰æœ‰è¿ç»­çš„æ—¶é—´å­—æ®µ<br>ï¼ˆ2ï¼‰æ¯ä¸ªæ—¶é—´å­—æ®µæœ‰å¯¹åº”çš„CKå ç”¨ç£ç›˜å¤§å°<br>è¿ç»­çš„æ—¶é—´å­—æ®µåº”è¯¥æ€ä¹ˆæå®šå‘¢ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯Linuxè‡ªå¸¦çš„Crontabï¼Œæ¯éš”30sé€šè¿‡<code>clickhouse-client</code>å»æŸ¥è¯¢ä¸€æ¬¡CKå ç”¨ç£ç›˜çš„æ€»å¤§å°ï¼Œç„¶åå’Œå½“å‰æ—¶é—´å­—æ®µä¸€èµ·æ’å…¥åˆ°ä¸€ä¸ªæ–°è¡¨å³å¯ï¼Œä¸‹é¢æ˜¯æˆ‘è¿è¡Œä¸€æ®µæ—¶é—´çš„æ•ˆæœï¼Œå¯ä»¥çœ‹åˆ°è¿™æ¬¡æ˜¯è¿ç»­çš„äº†ï¼Œå¦‚æœæ€•äº§ç”Ÿçš„æ•°æ®æ¡æ•°å¤ªå¤šå¯ä»¥ç»™æ•°æ®è®¾ç½®ä¸ŠTTLï¼Œè¿™æ ·å°±å®Œæˆäº†æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœï¼ŒåŒæ ·ä¹Ÿå¯ä»¥è¿›è¡Œé¢„è­¦äº†ã€‚</p><img src="/2021/10/20/%E4%BD%BF%E7%94%A8grafana%E7%9B%91%E6%8E%A7%E9%A2%84%E8%AD%A6%E8%A1%A8%E6%A0%BC%E7%B1%BB%E5%9E%8B%E6%95%B0%E6%8D%AE/%E8%BF%9E%E7%BB%AD%E7%9B%91%E6%8E%A7.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;èƒŒæ™¯&quot;&gt;&lt;a href=&quot;#èƒŒæ™¯&quot; class=&quot;headerlink&quot; title=&quot;èƒŒæ™¯&quot;&gt;&lt;/a&gt;èƒŒæ™¯&lt;/h2&gt;&lt;p&gt;ç›‘æ§clickhouseæœåŠ¡ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯grafana+grafana-clickhouseæ’ä»¶ï¼Œgrafanaåªèƒ½æŠ¥è­¦graphç±»å‹æ•°æ®ï¼Œä¸èƒ½æŠ¥è­¦ç±»ä¼¼Tableæ ·å¼çš„æ•°æ®ï¼Œååº”å‡ºæ¥å°±æ˜¯panelæœ‰æ²¡æœ‰alterè¿™ä¸ªTab&lt;/p&gt;</summary>
    
    
    
    
    <category term="ClickHouse" scheme="http://example.com/tags/ClickHouse/"/>
    
    <category term="Grafana" scheme="http://example.com/tags/Grafana/"/>
    
  </entry>
  
  <entry>
    <title>SupersetæŸ¥è¯¢ä¼šä¸¢æ•°æ®é—®é¢˜æ’æŸ¥</title>
    <link href="http://example.com/2021/10/18/Superset%E6%9F%A5%E8%AF%A2%E4%BC%9A%E4%B8%A2%E6%95%B0%E6%8D%AE%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"/>
    <id>http://example.com/2021/10/18/Superset%E6%9F%A5%E8%AF%A2%E4%BC%9A%E4%B8%A2%E6%95%B0%E6%8D%AE%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/</id>
    <published>2021-10-18T12:22:01.000Z</published>
    <updated>2021-10-18T13:01:36.825Z</updated>
    
    <content type="html"><![CDATA[<p>Supersetç‰ˆæœ¬ 1.3.0</p><p>æŸ¥è¯¢ç»“æœä¼šæ¯”æ­£ç¡®ç»“æœå°‘ä¸¤æ¡æ•°æ®</p><span id="more"></span><p>é¦–å…ˆæˆ‘å…ˆè®²è¿°æˆ‘æ˜¯å¦‚ä½•å‘ç°è¿™ä¸ªé—®é¢˜çš„ï¼Œå‡†ç¡®çš„è¯´æ˜¯è¿è¥å¦‚ä½•å‘ç°è¿™ä¸ªé—®é¢˜çš„ã€‚</p><p>æ•°æ®æœ‰å››åˆ—ï¼Œåˆ†åˆ«æ˜¯â€™Timeâ€™ â€˜pidâ€™ â€˜eidâ€™ â€˜cntâ€™ ï¼Œé¦–å…ˆæˆ‘ä»¬åœ¨clickhouseå®¢æˆ·ç«¯è¿›è¡Œæ“ä½œï¼Œå…¶ä¸­æˆ‘é™å®špid=â€™609â€™ï¼Œç„¶åeidè¿›è¡Œgroup by æ“ä½œï¼Œç„¶åsum(cnt)ï¼Œå¯ä»¥çœ‹åˆ°æ•°æ®æœ‰ä¸‰æ¡</p><img src="/2021/10/18/Superset%E6%9F%A5%E8%AF%A2%E4%BC%9A%E4%B8%A2%E6%95%B0%E6%8D%AE%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/client%E7%BB%93%E6%9E%9C.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>æˆ‘ä»supersetè¿›è¡ŒåŒæ ·çš„æ“ä½œï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä¸Šé¢åœ¨clickhouseå®¢æˆ·ç«¯æ“ä½œçš„SQLå°±æ˜¯åœ¨supersetä¸Šæ“ä½œview sqlç”Ÿæˆçš„SQLè¯­å¥ï¼Œæ‰€ä»¥ä»–ä»¬è‚¯å®šæ˜¯ç›¸åŒçš„æ“ä½œã€‚</p><img src="/2021/10/18/Superset%E6%9F%A5%E8%AF%A2%E4%BC%9A%E4%B8%A2%E6%95%B0%E6%8D%AE%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/superset%E7%BB%93%E6%9E%9C.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>å¯ä»¥çœ‹åˆ°supersetåªæœ‰ä¸€æ¡ç»“æœè¿”å›ï¼Œç»è¿‡æˆ‘ç›‘æ§query_logæ—¥å¿—ä¸­çš„SQLè¯­å¥å‘ç°supersetè¯·æ±‚çš„SQLè¯­å¥ç¡®å®æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯ä»–åœ¨æ¥æ”¶åˆ°ç»“æœä¹‹åè¿›è¡Œäº†ä¸€äº›æ“ä½œä¼šå¯¼è‡´æ•°æ®å°‘ä¸¤æ¡ã€‚</p><p>ç»è¿‡å¤šæ–¹æ’æŸ¥ä»¥åŠè¯¢é—®ï¼Œå‘ç°æœ€åæ˜¯supersetè¿æ¥clickhouseä½¿ç”¨çš„åè®®å¯¼è‡´çš„ï¼Œé¦–å…ˆsupersetè¿æ¥clickhouseä½¿ç”¨çš„æ˜¯å¼€æºçš„ç¬¬ä¸‰æ–¹çš„åº“å«åš <strong>clickhouse-sqlalchemy</strong> ï¼Œå®ƒæ”¯æŒä¸¤ç§è¿æ¥clickhouseçš„åè®®ï¼Œåˆ†åˆ«æ˜¯httpä»¥åŠnative(TCP)åè®®å…¶ä¸­æˆ‘ä»¬é»˜è®¤ä½¿ç”¨çš„æ˜¯httpåè®®ï¼Œåæ˜ å‡ºæ¥çš„urlå°±æ˜¯è¿™ä¹ˆå†™ ï¼š</p><p><code>clickhouse://bigdata:XXXXXXXXXX@127.0.0.1:8123/default</code></p><p>è¿˜æœ‰ä¸€ç§native(TCP)åè®®ï¼Œå®ƒçš„urlæ˜¯è¿™ä¹ˆå†™ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å¿…é¡»è¦å»æ‰ç«¯å£å·ï¼ŒåŠ ä¸Šç«¯å£å·supersetä¸èƒ½æ­£å¸¸è§£æã€‚</p><p><code>clickhouse+native://bigdata:XXXXXXXXXX@127.0.0.1/default</code></p><p>è€Œç¬¬ä¸€ç§åè®®éœ€è¦æˆ‘ä»¬åœ¨æ‰§è¡Œåº•å±‚æŸ¥è¯¢çš„æ—¶å€™æŒ‡å®šæŸ¥è¯¢ç»“æœçš„formatï¼Œå¦åˆ™è¿”å›çš„ç»“æœå°±æ˜¯ä¸æ­£ç¡®çš„ã€‚</p><p><a class="link"   href="https://github.com/xzkostyan/clickhouse-sqlalchemy/issues/14#issuecomment-390755088" >https://github.com/xzkostyan/clickhouse-sqlalchemy/issues/14#issuecomment-390755088<i class="fas fa-external-link-alt"></i></a></p><p>æ”¹ç”¨ç¬¬äºŒç§nativeçš„å½¢å¼å¹¶ä¸”å»æ‰ç«¯å£å·ä¹‹å’Œsupersetè¿”å›çš„æ•°æ®å’Œclickhouseå®¢æˆ·ç«¯ä¸€è‡´äº†ã€‚</p><p>å‚è€ƒè¿æ¥ï¼š</p><p><a class="link"   href="https://github.com/apache/superset/issues/15190" >https://github.com/apache/superset/issues/15190<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://github.com/xzkostyan/clickhouse-sqlalchemy/issues/14" >https://github.com/xzkostyan/clickhouse-sqlalchemy/issues/14<i class="fas fa-external-link-alt"></i></a></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;Supersetç‰ˆæœ¬ 1.3.0&lt;/p&gt;
&lt;p&gt;æŸ¥è¯¢ç»“æœä¼šæ¯”æ­£ç¡®ç»“æœå°‘ä¸¤æ¡æ•°æ®&lt;/p&gt;</summary>
    
    
    
    
    <category term="ClickHouse" scheme="http://example.com/tags/ClickHouse/"/>
    
    <category term="Superset" scheme="http://example.com/tags/Superset/"/>
    
  </entry>
  
  <entry>
    <title>Macå®‰è£…grafana+Grafanaè¿æ¥ClickHouse</title>
    <link href="http://example.com/2021/10/13/Mac%E5%AE%89%E8%A3%85grafana-ClickHouse%E9%93%BE%E6%8E%A5Grafana/"/>
    <id>http://example.com/2021/10/13/Mac%E5%AE%89%E8%A3%85grafana-ClickHouse%E9%93%BE%E6%8E%A5Grafana/</id>
    <published>2021-10-13T09:11:29.000Z</published>
    <updated>2021-10-18T12:18:30.251Z</updated>
    
    <content type="html"><![CDATA[<p>Macå®‰è£…Grafana &amp; ä½¿ç”¨ç¬¬ä¸‰æ–¹æ’ä»¶Grafanaè¿æ¥ClickHouse</p><span id="more"></span><h2 id="Macå®‰è£…grafana"><a href="#Macå®‰è£…grafana" class="headerlink" title="Macå®‰è£…grafana"></a>Macå®‰è£…grafana</h2><p>ä½¿ç”¨brewå®‰è£…grafana</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.å®‰è£…grafana</span><br><span class="line">brew install grafana</span><br><span class="line">2.å·²å®‰è£…grafanaï¼Œéœ€è¦å‡çº§</span><br><span class="line">brew reinstall grafana</span><br></pre></td></tr></table></figure><p>å®‰è£…å®Œæˆåæˆ‘ä»¬ç”¨å‘½ä»¤æ£€æŸ¥ä¸€ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew list | grep grafana</span><br></pre></td></tr></table></figure><img src="/2021/10/13/Mac%E5%AE%89%E8%A3%85grafana-ClickHouse%E9%93%BE%E6%8E%A5Grafana/%E6%A3%80%E6%9F%A5grafana%E5%AE%89%E8%A3%85.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>ä½¿ç”¨brewå¯åŠ¨grafanaæœåŠ¡</p><img src="/2021/10/13/Mac%E5%AE%89%E8%A3%85grafana-ClickHouse%E9%93%BE%E6%8E%A5Grafana/%E5%90%AF%E5%8A%A8grafana.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">åœæ­¢grafanaæœåŠ¡:</span><br><span class="line">brew service stop grafana</span><br><span class="line">é‡å¯grafanaæœåŠ¡ï¼š</span><br><span class="line">brew service restart grafana</span><br></pre></td></tr></table></figure><p>å¯åŠ¨æˆåŠŸä¹‹åæˆ‘ä»¬å¯ä»¥åœ¨æœ¬åœ°è®¿é—®grafanaé¡µé¢ï¼Œè¾“å…¥<code>localhost:3000</code></p><img src="/2021/10/13/Mac%E5%AE%89%E8%A3%85grafana-ClickHouse%E9%93%BE%E6%8E%A5Grafana/grafana.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><h2 id="å®‰è£…grafana-clickhouseæ’ä»¶"><a href="#å®‰è£…grafana-clickhouseæ’ä»¶" class="headerlink" title="å®‰è£…grafana-clickhouseæ’ä»¶"></a>å®‰è£…grafana-clickhouseæ’ä»¶</h2><p>å‚è€ƒgrafanaå®˜ç½‘ä¸Šå®‰è£…æ•™ç¨‹<a class="link"   href="https://grafana.com/grafana/plugins/vertamedia-clickhouse-datasource/?tab=installation" >https://grafana.com/grafana/plugins/vertamedia-clickhouse-datasource/?tab=installation<i class="fas fa-external-link-alt"></i></a> æœ‰ä¸¤ç§å®‰è£…æ–¹å¼ã€‚</p><p>1.é€šè¿‡grafana cloudå®‰è£…ï¼Œåº”è¯¥æ˜¯åˆ›å»ºgrafanaè´¦å·è¿æ¥grafanaçš„åœ¨çº¿æœåŠ¡å™¨ä¸‹è½½å®‰è£…ï¼Œè¿™ä¸ªæœ‰å…´è¶£çš„å¯ä»¥ç ”ç©¶ä¸€ä¸‹ï¼Œæˆ‘è¿™é‡Œæ²¡æœ‰ç”¨åˆ°</p><p>2.<code>grafana-cli plugins install vertamedia-clickhouse-datasource</code> ä½¿ç”¨grafana-cliå®‰è£…ï¼Œç„¶åé‡å¯grafanaæœåŠ¡ï¼Œä½†æ˜¯é¡µé¢çš„plugin tabæˆ–è€…datasourceä¸­ä¾ç„¶æ˜¯æ²¡æœ‰clickhouseé€‰é¡¹çš„ï¼Œæ¥ä¸‹æ¥å¼€å§‹æ’æŸ¥é—®é¢˜å‡ºåœ¨å“ªé‡Œã€‚</p><p>æ’æŸ¥è¿‡ç¨‹ï¼š<br>ï¼ˆ1ï¼‰å¸è½½brewå®‰è£…çš„grafanaï¼Œä½¿ç”¨zipå‹ç¼©åŒ…é‡æ–°å®‰è£…grafanaï¼Œä¾ç„¶å­˜åœ¨è¿™ä¸ªé—®é¢˜<br>ï¼ˆ2ï¼‰å¸è½½<code>grafana-clickhouse</code>æ’ä»¶ï¼Œä½¿ç”¨zipå‹ç¼©åŒ…é‡æ–°å®‰è£…ä¸€æ¬¡ï¼Œæ²¡æœ‰è§£å†³<br>ï¼ˆ3ï¼‰ä½¿ç”¨findå‘½ä»¤æŸ¥æ‰¾ä½¿ç”¨grafana-cliå®‰è£…çš„<code>grafana-clickhouse</code>æ’ä»¶ä½ç½®ï¼Œå‘ç°æ˜¯åœ¨<code>/usr/local/var/lib/grafana/plugins/vertamedia-clickhouse-datasource</code>æ–‡ä»¶å¤¹ä¸‹ï¼Œå¹¶ä¸”å‘ç°åœ¨<code>/Users/liu/grafana-8.1.0/public/app/plugins/datasource/</code>ä¸­æœ‰é»˜è®¤å·²ç»å­˜åœ¨çš„æ’ä»¶çš„æ–‡ä»¶å¤¹ï¼Œæ‰‹åŠ¨å°†<code>vertamedia-clickhouse-datasource</code>ç›®å½•ç§»åˆ°é»˜è®¤çš„æ–‡ä»¶å¤¹ä¸­ï¼Œé‡å¯grafanaæœåŠ¡ï¼Œå‘ç°pluginé¡µé¢ä»¥åŠdatasourceä¸Šå‡ºç°äº†clickhouseé€‰é¡¹ï¼Œä½†æ˜¯ç‚¹å‡»æŠ¥é”™<code>Fetch error404</code>:</p><img src="/2021/10/13/Mac%E5%AE%89%E8%A3%85grafana-ClickHouse%E9%93%BE%E6%8E%A5Grafana/%E6%8A%A5%E9%94%99.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>ï¼ˆ4ï¼‰æŸ¥çœ‹grafanaé…ç½®æ–‡ä»¶default.iniï¼Œå‘ç°å…¶ä¸­æœ‰è¿™ä¹ˆä¸€è¡Œ<br><code># Directory where grafana will automatically scan and look for plugins plugins = data/plugins</code><br>å°†æ’ä»¶ç›®å½•æ‰‹åŠ¨ç§»åˆ°å¯¹åº”ç›®å½•ä¸‹é¢ï¼Œé‡å¯grafanaæœåŠ¡ï¼Œeverything is fine!</p><img src="/2021/10/13/Mac%E5%AE%89%E8%A3%85grafana-ClickHouse%E9%93%BE%E6%8E%A5Grafana/%E6%88%90%E5%8A%9F.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>æˆ‘ä¹Ÿåœ¨æ’ä»¶çš„githubæå‡ºäº†é—®é¢˜issueï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥çœ‹ä¸€ä¸‹æ’ä»¶å¼€å‘è€…è§£é‡Šï¼Œæˆ‘ä»¬éƒ½åˆæ­¥è®¤ä¸ºæ˜¯grafanaçš„bug<br><a class="link"   href="https://github.com/Vertamedia/clickhouse-grafana/issues?q=is:issue+author:@me+is:closed" >https://github.com/Vertamedia/clickhouse-grafana/issues?q=is%3Aissue+author%3A%40me+is%3Aclosed<i class="fas fa-external-link-alt"></i></a></p><p>å‚è€ƒæ–‡ç« ï¼š</p><p><a class="link"   href="https://grafana.com/docs/grafana/latest/installation/mac/" >https://grafana.com/docs/grafana/latest/installation/mac/<i class="fas fa-external-link-alt"></i></a></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;Macå®‰è£…Grafana &amp;amp; ä½¿ç”¨ç¬¬ä¸‰æ–¹æ’ä»¶Grafanaè¿æ¥ClickHouse&lt;/p&gt;</summary>
    
    
    
    
    <category term="ClickHouse" scheme="http://example.com/tags/ClickHouse/"/>
    
    <category term="Grafana" scheme="http://example.com/tags/Grafana/"/>
    
  </entry>
  
  <entry>
    <title>å­¦ä¹ clickhouseè¯¦ç»†çŸ¥è¯†</title>
    <link href="http://example.com/2021/10/08/%E5%AD%A6%E4%B9%A0clickhouse%E8%AF%A6%E7%BB%86%E7%9F%A5%E8%AF%86/"/>
    <id>http://example.com/2021/10/08/%E5%AD%A6%E4%B9%A0clickhouse%E8%AF%A6%E7%BB%86%E7%9F%A5%E8%AF%86/</id>
    <published>2021-10-08T11:21:49.000Z</published>
    <updated>2021-12-13T07:19:37.864Z</updated>
    
    <content type="html"><![CDATA[<p>ClickHouseåŸºç¡€åº”ç”¨ä¸å†…éƒ¨åŸç†</p><span id="more"></span><h1 id="MergeTreeåŸç†è§£æ"><a href="#MergeTreeåŸç†è§£æ" class="headerlink" title="MergeTreeåŸç†è§£æ"></a>MergeTreeåŸç†è§£æ</h1><p>MergeTreeæ˜¯å®¶æ—ä¸­æœ€åŸºç¡€çš„è¡¨å¼•æ“ï¼Œæä¾›äº†ä¸»é”®ç´¢å¼•ã€æ•°æ®åˆ†åŒºã€æ•°æ®å‰¯æœ¬å’Œæ•°æ®é‡‡æ ·ç­‰åŸºæœ¬èƒ½åŠ›ï¼Œè€Œå®¶æ—ä¸­å…¶ä»–çš„è¡¨å¼•æ“åˆ™åœ¨MergeTreeçš„åŸºç¡€ä¹‹ä¸Šå„æœ‰æ‰€é•¿ã€‚</p><img src="/2021/10/08/%E5%AD%A6%E4%B9%A0clickhouse%E8%AF%A6%E7%BB%86%E7%9F%A5%E8%AF%86/yinqing.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><img src="/2021/10/08/%E5%AD%A6%E4%B9%A0clickhouse%E8%AF%A6%E7%BB%86%E7%9F%A5%E8%AF%86/mtreejianbiao.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>MergeTreeå»ºè¡¨è¯­å¥ä¸­é‡è¦çš„å‚æ•°ï¼š</p><p>ï¼ˆ1ï¼‰PARTITION BY [é€‰å¡«]ï¼šåˆ†åŒºé”®ï¼Œç”¨äºæŒ‡å®šè¡¨æ•°æ®ä»¥ä½•ç§æ ‡å‡†è¿›è¡Œåˆ†åŒºã€‚åˆ†åŒºé”®æ—¢å¯ä»¥æ˜¯å•ä¸ªåˆ—å­—æ®µï¼Œä¹Ÿå¯ä»¥é€šè¿‡å…ƒç»„çš„å½¢å¼ä½¿ç”¨å¤šä¸ªåˆ—å­—æ®µï¼ŒåŒæ—¶å®ƒä¹Ÿæ”¯æŒä½¿ç”¨åˆ—è¡¨è¾¾å¼ã€‚å¦‚æœä¸å£°æ˜åˆ†åŒºé”®ï¼Œåˆ™ClickHouseä¼šç”Ÿæˆä¸€ä¸ªåä¸ºallçš„åˆ†åŒºã€‚åˆç†ä½¿ç”¨æ•°æ®åˆ†åŒºï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘æŸ¥è¯¢æ—¶æ•°æ®æ–‡ä»¶çš„æ‰«æèŒƒå›´ã€‚</p><p>ï¼ˆ2ï¼‰ORDER BY [å¿…å¡«]ï¼šæ’åºé”®ï¼Œç”¨äºæŒ‡å®šåœ¨ä¸€ä¸ªæ•°æ®ç‰‡æ®µå†…ï¼Œæ•°æ®ä»¥ä½•ç§æ ‡å‡†æ’åºã€‚é»˜è®¤æƒ…å†µä¸‹ä¸»é”®ï¼ˆPRIMARY KEYï¼‰ä¸æ’åºé”®ç›¸åŒã€‚æ’åºé”®æ—¢å¯ä»¥æ˜¯å•ä¸ªåˆ—å­—æ®µï¼Œä¾‹å¦‚ORDER BY CounterIDï¼Œä¹Ÿå¯ä»¥é€šè¿‡å…ƒç»„çš„å½¢å¼ä½¿ç”¨å¤šä¸ªåˆ—å­—æ®µï¼Œä¾‹å¦‚ORDERBYï¼ˆCounterID,EventDateï¼‰ã€‚å½“ä½¿ç”¨å¤šä¸ªåˆ—å­—æ®µæ’åºæ—¶ï¼Œä»¥ORDERBYï¼ˆCounterID,EventDateï¼‰ä¸ºä¾‹ï¼Œåœ¨å•ä¸ªæ•°æ®ç‰‡æ®µå†…ï¼Œæ•°æ®é¦–å…ˆä¼šä»¥CounterIDæ’åºï¼Œç›¸åŒCounterIDçš„æ•°æ®å†æŒ‰EventDateæ’åºã€‚</p><p>ï¼ˆ3ï¼‰PRIMARY KEY [é€‰å¡«]ï¼šä¸»é”®ï¼Œé¡¾åæ€ä¹‰ï¼Œå£°æ˜åä¼šä¾ç…§ä¸»é”®å­—æ®µç”Ÿæˆä¸€çº§ç´¢å¼•ï¼Œç”¨äºåŠ é€Ÿè¡¨æŸ¥è¯¢ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸»é”®ä¸æ’åºé”®(ORDER BY)ç›¸åŒï¼Œæ‰€ä»¥é€šå¸¸ç›´æ¥ä½¿ç”¨ORDER BYä»£ä¸ºæŒ‡å®šä¸»é”®ï¼Œæ— é¡»åˆ»æ„é€šè¿‡PRIMARY KEYå£°æ˜ã€‚æ‰€ä»¥åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨å•ä¸ªæ•°æ®ç‰‡æ®µå†…ï¼Œæ•°æ®ä¸ä¸€çº§ç´¢å¼•ä»¥ç›¸åŒçš„è§„åˆ™å‡åºæ’åˆ—ã€‚ä¸å…¶ä»–æ•°æ®åº“ä¸åŒï¼ŒMergeTreeä¸»é”®å…è®¸å­˜åœ¨é‡å¤æ•°æ®ï¼ˆReplacingMergeTreeå¯ä»¥å»é‡ï¼‰ã€‚</p><h2 id="æ•°æ®å­˜å‚¨ç»“æ„"><a href="#æ•°æ®å­˜å‚¨ç»“æ„" class="headerlink" title="æ•°æ®å­˜å‚¨ç»“æ„"></a>æ•°æ®å­˜å‚¨ç»“æ„</h2><p>â€‹    MergeTreeä¸­çš„ä¸»é”®ä¸€èˆ¬é€šè¿‡order byæŒ‡å®šï¼Œä¸»é”®å¯ä»¥æ˜¯å•ä¸ªå­—æ®µä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªå­—æ®µï¼Œæ ¹æ®ä¸»é”®å»ºç«‹ç´¢å¼•ï¼Œè¿™é‡Œæ¶‰åŠåˆ°ä¸¤ä¸ªå‚æ•°<code>index_granularity</code>ä»¥åŠ<code>enable_mixed_granularity_parts</code>ï¼Œå‰è€…æ˜¯æŒ‡å®šæˆ‘ä»¬åˆ›å»ºç¨€ç–ç´¢å¼•æ—¶å€™çš„ç´¢å¼•é—´éš”ï¼Œé»˜è®¤æ˜¯8192ï¼Œåè€…æ˜¯æˆ‘ä»¬é€‰æ‹©æ˜¯å¦å¼€å¯æ ¹æ®å†™å…¥æ•°æ®ä½“é‡å¤§å°çš„è‡ªé€‚åº”ç´¢å¼•çš„å‚æ•°ï¼Œé»˜è®¤æ˜¯å¼€å¯çš„ï¼Œä¸¤è€…æ”¯æŒåŒæ—¶å¼€å¯å¹¶åŒæ—¶ç”Ÿæ•ˆï¼Œè¯¦ç»†å‚è€ƒè¿™ç¯‡<a class="link"   href="https://blog.csdn.net/nazeniwaresakini/article/details/109143116" >æ–‡ç« <i class="fas fa-external-link-alt"></i></a>ï¼Œè®¾ç½®<code>index_granularity_bytes=0</code>å³ä¸ºå…³é—­è‡ªé€‚åº”ç´¢å¼•</p><p> æ•°æ®å­˜å‚¨ç»“æ„ä¸»è¦æ–‡ä»¶æœ‰ä»¥ä¸‹å‡ ä¸ªï¼Œ.idxæ–‡ä»¶æ˜¯ä¸€çº§ç´¢å¼•æ–‡ä»¶ï¼Œ.binæ˜¯æ•°æ®æ–‡ä»¶ï¼Œ.mrkæ˜¯æ•°æ®æ ‡è®°æ–‡ä»¶ï¼Œé¦–å…ˆæ ¹æ®idxç¨€ç–ç´¢å¼•æ–‡ä»¶æ‰¾åˆ°è¦è¯»å–çš„æ•°æ®æ®µï¼Œå› ä¸ºidxæ–‡ä»¶å’Œmrkæ–‡ä»¶æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œæ‰¾åˆ°ä¸‹ä¸€æ­¥æ‰¾åˆ°mrkæ–‡ä»¶ä¸­å‹ç¼©ååç§»é‡å’Œå‹ç¼©å‰åç§»é‡</p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;ClickHouseåŸºç¡€åº”ç”¨ä¸å†…éƒ¨åŸç†&lt;/p&gt;</summary>
    
    
    
    
    <category term="ClickHouse" scheme="http://example.com/tags/ClickHouse/"/>
    
  </entry>
  
  <entry>
    <title>å¤šçº¿ç¨‹ç¼–ç¨‹åŸºç¡€</title>
    <link href="http://example.com/2021/08/26/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/"/>
    <id>http://example.com/2021/08/26/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B%E5%9F%BA%E7%A1%80/</id>
    <published>2021-08-26T03:25:18.000Z</published>
    <updated>2021-08-26T03:27:09.550Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬æ–‡è®°è½½äº†å…³äºå¤šçº¿ç¨‹ç¼–ç¨‹çš„ä¸€äº›åŸºç¡€çŸ¥è¯†ï¼Œä¸æ–­è¡¥å……</p><span id="more"></span><h2 id="å¤šçº¿ç¨‹ç¼–ç¨‹åŸºç¡€"><a href="#å¤šçº¿ç¨‹ç¼–ç¨‹åŸºç¡€" class="headerlink" title="å¤šçº¿ç¨‹ç¼–ç¨‹åŸºç¡€"></a>å¤šçº¿ç¨‹ç¼–ç¨‹åŸºç¡€</h2><h3 id="cpu-é«˜é€Ÿç¼“å­˜"><a href="#cpu-é«˜é€Ÿç¼“å­˜" class="headerlink" title="cpu é«˜é€Ÿç¼“å­˜"></a>cpu é«˜é€Ÿç¼“å­˜</h3><p>ä¸ºäº†è§£å†³ cpu å’Œä¸»å­˜ä¹‹é—´çš„é€Ÿç‡å·®ï¼ŒCPU ä¸­çš„é«˜é€Ÿç¼“å­˜è¿è¥è€Œç”Ÿï¼Œç¨‹åºè¿ç®—æ—¶ä¼šå°†æ•°æ®å¤åˆ¶ä¸€ä»½åˆ° CPU çš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œå½“ CPU è®¡ç®—æ—¶ç›´æ¥ä»é«˜é€Ÿç¼“å­˜ä¸­å–æ•°æ®ï¼Œç„¶åè®¡ç®—å®Œæˆä¹‹åå°†æ•°æ®å†™å›é«˜é€Ÿç¼“å­˜ä¸­ï¼Œéš”ä¸€æ®µæ—¶é—´åˆ·æ–°ä¸€æ¬¡é«˜é€Ÿç¼“å­˜ä¸­å†…å®¹åˆ°ä¸»å­˜</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">val i = 0</span><br><span class="line">i = i + 1</span><br></pre></td></tr></table></figure><p>ã€€å½“çº¿ç¨‹æ‰§è¡Œè¿™ä¸ªè¯­å¥æ—¶ï¼Œä¼šå…ˆä»ä¸»å­˜å½“ä¸­è¯»å– i çš„å€¼ï¼Œç„¶åå¤åˆ¶ä¸€ä»½åˆ°é«˜é€Ÿç¼“å­˜å½“ä¸­ï¼Œç„¶å CPU æ‰§è¡ŒæŒ‡ä»¤å¯¹ i è¿›è¡ŒåŠ  1 æ“ä½œï¼Œç„¶åå°†æ•°æ®å†™å…¥é«˜é€Ÿç¼“å­˜ï¼Œæœ€åå°†é«˜é€Ÿç¼“å­˜ä¸­ i æœ€æ–°çš„å€¼åˆ·æ–°åˆ°ä¸»å­˜å½“ä¸­ã€‚</p><p> ä½†æ˜¯å¤šçº¿ç¨‹æ‰§è¡Œæ—¶å€™ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜å«åšâ€œç¼“å­˜ä¸€è‡´æ€§é—®é¢˜â€ï¼Œä»€ä¹ˆå«åšç¼“å­˜ä¸€è‡´æ€§é—®é¢˜å‘¢ï¼Ÿ</p><p> é¦–å…ˆæˆ‘ä»¬ä¸Šé¢æé«˜äº† CPU ä¸­æ˜¯æœ‰é«˜é€Ÿç¼“å­˜è¿™ä¸ªæ¦‚å¿µï¼Œé‚£ä¹ˆè¿™é‡Œçš„ç¼“å­˜ä¸€è‡´æ€§ä¸­çš„ç¼“å­˜æ˜¯å¦å°±æ˜¯æŒ‡çš„ CPU ä¸­çš„ç¼“å­˜å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼šæ˜¯çš„ï¼Œå½“å¤šçº¿ç¨‹æ‰§è¡Œä¸Šé¢çš„ i=i+1 è¯­å¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬æœŸå¾…çš„ç»“æœæ˜¯ n ä¸ªçº¿ç¨‹æ‰§è¡Œé‚£ä¹ˆ i å°±åº”è¯¥æ˜¯åŸå…ˆçš„å€¼ +nï¼Œä½†æ˜¯äº‹å®çœŸæ˜¯å¦‚æ­¤å—ï¼Ÿ</p><h3 id="ç¼“å­˜ä¸€è‡´æ€§"><a href="#ç¼“å­˜ä¸€è‡´æ€§" class="headerlink" title="ç¼“å­˜ä¸€è‡´æ€§"></a>ç¼“å­˜ä¸€è‡´æ€§</h3><p>å¤šä¸ªçº¿ç¨‹åŒæ—¶å°†å˜é‡ i æ‹·è´åˆ° CPU ä¸­ï¼Œè¿™æ—¶å€™ä»–ä»¬æ‹·è´çš„å˜é‡éƒ½æ˜¯ i çš„åˆå§‹å€¼ 0 ï¼Œçº¿ç¨‹ A ç»è¿‡è®¡ç®—å¾—åˆ° i=1ï¼Œç„¶åå°† i é‡æ–°å†™å›é«˜é€Ÿç¼“å­˜ä¸­ï¼Œé«˜é€Ÿç¼“å­˜å†å°† i é‡æ–°åˆ·æ–°å›ä¸»å­˜ä¸­ï¼Œè¿™æ—¶å€™çš„ i åº”è¯¥æ˜¯ 2ï¼ŒåŒç†çº¿ç¨‹ B è¿›è¡Œäº†ä¸Šè¿°æ“ä½œï¼Œä½ ä¼šå‘ç°ï¼Œè¿™æ—¶å€™çš„ i ä¾æ—§æ˜¯ 1ï¼Œä¸æ˜¯æˆ‘ä»¬æƒ³è±¡çš„ 2ï¼Œé€šå¸¸ç§°è¿™ç§è¢«å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®çš„å˜é‡å«åšå…±äº«å˜é‡ã€‚</p><p>ç¼“å­˜ä¸€è‡´æ€§å¯¼è‡´åŸå› ï¼šä¸€ä¸ªå˜é‡åœ¨å¤šä¸ª CPU ä¸­åŒæ—¶å­˜åœ¨ç¼“å­˜ï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´ç¨‹åºçš„ä¿®æ”¹æ²¡æœ‰èµ·ä½œç”¨æˆ–è€…è¢«è¦†ç›–</p><p> åŸå› æ‰¾åˆ°äº†ï¼Œæˆ‘ä»¬æ¥é’ˆå¯¹åŸå› æƒ³è±¡ä¸€ä¸‹å¯èƒ½ä¼šæœ‰é‚£äº›æ–¹æ³•å‘¢ï¼Ÿé¦–å…ˆå› ä¸ºçº¿ç¨‹ A å’Œçº¿ç¨‹ B éƒ½ä¼šå»å°† i å€¼ copy è¿›è‡ªå·±çš„é«˜é€Ÿç¼“å­˜ï¼Œçº¿ç¨‹ A ä¿®æ”¹äº†æ•°å€¼ï¼Œä½†æ˜¯çº¿ç¨‹ B ä¸çŸ¥é“ï¼Œåé¢é‡å¤å†™å…¥çš„æ—¶å€™å¯¼è‡´å‡ºç°é—®é¢˜ï¼Œæœ‰äººå¯èƒ½å°±ä¼šè¯´åº”è¯¥çº¿ç¨‹ A è®¿é—®è¿™ä¸ªå˜é‡çš„æ—¶å€™çº¿ç¨‹ B ä¸èƒ½è®¿é—®ï¼Œè¿™æ ·å°±ä¿è¯äº†çº¿ç¨‹ A çš„ä¿®æ”¹ä¸€å®šæ˜¯ç”Ÿæ•ˆçš„ã€‚æ²¡é”™ï¼Œè¿™ç§å°±æ˜¯åŠ é”çš„æ€æƒ³ï¼Œä½†æ˜¯è¿™ç§æ€æƒ³çš„ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œçº¿ç¨‹ A è®¿é—®å˜é‡åŠ é”ï¼Œçº¿ç¨‹ B ç­‰ç­‰çº¿ç¨‹éƒ½ä¼šè¢«å¡ä½ï¼Œåªèƒ½ç­‰å¾… A é‡Šæ”¾å…±äº«å˜é‡ä¹‹åæ‰èƒ½è®¿é—®ï¼Œæ•ˆç‡ååˆ†ä½ä¸‹ã€‚</p><h3 id="å¦‚ä½•è§£å†³ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜"><a href="#å¦‚ä½•è§£å†³ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜" class="headerlink" title="å¦‚ä½•è§£å†³ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜"></a>å¦‚ä½•è§£å†³ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜</h3><p> æˆ‘ä»¬é‡æ–°å›å¤´çœ‹ä¸€ä¸‹ç¼“å­˜ä¸€è‡´æ€§çš„åŸå› ï¼Œå¦‚æœä¸èƒ½åœ¨çº¿ç¨‹è®¿é—®å˜é‡çš„æ—¶å€™åŠ é”ï¼Œé‚£æˆ‘ä»¬èƒ½ä¸èƒ½åœ¨åé¢çš„æ“ä½œæ·»åŠ ä»¥ä¸‹é™åˆ¶å‘¢ï¼Ÿè¿™æ—¶å€™å°±æœ‰äººæå‡ºæ¥äº†ä¸€ç§å«åšç¼“å­˜ä¸€è‡´æ€§åè®®ï¼šå¦‚æœçº¿ç¨‹ A ä¿®æ”¹äº†å…±äº«å˜é‡çš„æ•°å€¼é‚£ä¹ˆå°±ä¼šé€šçŸ¥å…¶ä»–çº¿ç¨‹ä»–ä»¬ç¼“å­˜çš„å…±äº«å˜é‡æ˜¯æ— æ•ˆçš„ï¼Œè¿™æ—¶å€™å¦‚æœå…¶ä»–çº¿ç¨‹æƒ³è¦ä½¿ç”¨å…±äº«å˜é‡çš„æ•°å€¼å°±å¿…é¡»å»é€šçŸ¥çº¿ç¨‹ A å°†ä¿®æ”¹åçš„æ•°å€¼é‡å†™ä¼šä¸»å­˜ï¼Œå¹¶ä¸”ä»ä¸»å­˜ä¸­é‡æ–°è¯»å–å…±äº«å˜é‡çš„å€¼</p><p>ä¸Šé¢å°±æ˜¯è§£å†³ç¼“å­˜ä¸€è‡´æ€§çš„ä¸¤ç§å¸¸è§çš„æ–¹æ³•ï¼šï¼ˆ1ï¼‰åŠ é”ï¼ˆ2ï¼‰ç¼“å­˜ä¸€è‡´æ€§åè®®</p><p>åŠ é”çš„ç¼ºç‚¹æˆ‘ä»¬ä¸Šé¢å·²ç»è¯´è¿‡äº†ï¼Œé‚£ä¹ˆç¼“å­˜ä¸€è‡´æ€§çš„ç¼ºç‚¹æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¹ä¸€çœ‹ä»¿ä½›æ–¹æ³•å¾ˆå®Œç¾ï¼Œä½†æ˜¯ä¸è¦å¿˜æ‰äº† CPU æ˜¯ä¸€ä¸ªé«˜é€Ÿä¸æ–­è¿è¡Œçš„ç¯å¢ƒï¼Œç¼“å­˜ä¸€è‡´æ€§åè®®éœ€è¦åšçš„äº‹æƒ…å¾ˆå¤šï¼Œä¾‹å¦‚çº¿ç¨‹ A å»é€šçŸ¥æ‰€æœ‰å…¶å®ƒä½¿ç”¨äº†è¯¥å…±äº«å˜é‡çš„çº¿ç¨‹ ä½ ä»¬çš„è¿™ä¸ªå˜é‡çš„ç¼“å­˜æ— æ•ˆ å¦‚æœç”¨çš„è¯å¿…é¡»è¯´ä¸€å£°ï¼Œæˆ‘ç»™ä½ ä»¬æ›´æ–°ä¸‹å†ç”¨ï¼Œç„¶åå„è‡ªçº¿ç¨‹å°†è¯¥ç¼“å­˜å˜é‡çš„çŠ¶æ€æ›´æ”¹ä¸ºæ— æ•ˆå¹¶ä¸”è¿”å›â€æ™“å¾—äº†â€æŒ‡ä»¤ï¼ŒCPU éƒ½ä¼šç­‰å¾…æ‰€æœ‰çš„ç¼“å­˜å“åº”å®Œæˆï¼Œè¯¦ç»†å†…å®¹è´´åœ¨åé¢çš„å‚è€ƒæ–‡ç« </p><h3 id="å¹¶å‘ç¼–ç¨‹ä¸­å¸¸è§çš„ä¸‰ä¸ªæ¦‚å¿µ"><a href="#å¹¶å‘ç¼–ç¨‹ä¸­å¸¸è§çš„ä¸‰ä¸ªæ¦‚å¿µ" class="headerlink" title="å¹¶å‘ç¼–ç¨‹ä¸­å¸¸è§çš„ä¸‰ä¸ªæ¦‚å¿µ"></a>å¹¶å‘ç¼–ç¨‹ä¸­å¸¸è§çš„ä¸‰ä¸ªæ¦‚å¿µ</h3><h4 id="åŸå­æ€§"><a href="#åŸå­æ€§" class="headerlink" title="åŸå­æ€§"></a>åŸå­æ€§</h4><p>é¦–å…ˆç¬¬ä¸€ä¸ªåŸå­æ€§ï¼Œæ²¡é”™å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„åŸå­æ€§ï¼Œä¸€ä¸ªæ“ä½œè¦ä¸å°±ä¸æ‰§è¡Œï¼Œè¦ä¸å°±å…¨éƒ¨æ‰§è¡Œï¼Œä¸èƒ½è¢«æ‰“æ–­ï¼Œæœ€ç»å…¸çš„å°±æ˜¯é“¶è¡Œè½¬è´¦ï¼š</p><p>è´¦æˆ· A å‘è´¦æˆ· B è½¬è´¦ 1000 å…ƒï¼Œè´¦æˆ· A ä¸­æ‰£é’±å’Œè´¦æˆ· B ä¸­æ•°é¢å¢é•¿å¿…é¡»æ˜¯ä¸€èµ·ç”Ÿæ•ˆ</p><p>é‚£ä¹ˆæˆ‘ä»¬ç¨‹åºä¸­æœ‰å“ªäº›æ—¶å€™ä¼šç”¨åˆ°åŸå­æ€§è¿™ä¸ªæ¦‚å¿µå‘¢ï¼Ÿä¸¾ä¸ªä¾‹å­å°±æ˜¯ èµ‹å€¼æ“ä½œæ—¶å€™</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i = 0</span><br></pre></td></tr></table></figure><p>åœ¨ 64 ä½æœºå™¨ ä¸Šæˆ‘ä»¬å‡è®¾å…ˆç»™å‰ 32 ä½èµ‹å€¼ï¼Œç„¶åå†ç»™å 32 ä½èµ‹å€¼ï¼Œå¦‚æœè¿›è¡Œåˆ°ä¸€åŠï¼Œä¸€ä¸ªçº¿ç¨‹è¯»å–äº† i çš„å€¼ï¼Œé‚£ä¹ˆä»–è¯»å–çš„è‚¯å®šå°±ä¼šå‡ºé—®é¢˜ï¼Œè¿™ä¸ªå°±æ˜¯åŸå­æ€§çš„æ„ä¹‰ã€‚</p><h4 id="å¯è§æ€§"><a href="#å¯è§æ€§" class="headerlink" title="å¯è§æ€§"></a>å¯è§æ€§</h4><p>ç”¨æˆ‘ä»¬ä¸Šé¢çš„ä¾‹å­ä¸¾ä¾‹å°±æ˜¯çº¿ç¨‹ A å¯¹å…±äº«å˜é‡åšå‡ºæ”¹å˜ä¹‹åï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥ç«‹å³çŸ¥æ™“</p><h4 id="æœ‰åºæ€§"><a href="#æœ‰åºæ€§" class="headerlink" title="æœ‰åºæ€§"></a>æœ‰åºæ€§</h4><p>ä»€ä¹ˆå«åšæœ‰åºæ€§å‘¢ï¼Ÿä½ æ€è€ƒè¿‡è¿™æ ·ä¸€ä¸ªé—®é¢˜æ²¡æœ‰ï¼Œå°±æ˜¯æˆ‘ä»¬å†™ä¸‹æ¥çš„ä¸€è¡Œè¡Œçš„ä»£ç çœŸçš„æ˜¯æŒ‰ç…§é¡ºåºæ‰§è¡Œä¸‹æ¥çš„å—ï¼Ÿå¦‚æœä½ æ˜¯å†™ç¼–è¯‘å™¨çš„äººï¼Œä½ è€ƒè™‘åˆ°æœ‰æ—¶å€™æœ‰ä¸€äº›è¯­å¥æ²¡æœ‰å‰åçš„ä¾èµ–å…³ç³»ï¼Œè€Œä½ åˆå¾ˆæƒ³æé«˜ç¨‹åºçš„è¿è¡Œæ•ˆç‡ï¼Œé‚£åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿæ²¡é”™å°±æ˜¯æ”¹å˜ç¨‹åºçš„è¿è¡Œé¡ºåºï¼Œè‡³äºä¸ºä»€ä¹ˆæ”¹å˜æ‰§è¡Œé¡ºåºå°±èƒ½æé«˜æ•ˆç‡è¿™ä¸ªå¦è¯´ï¼Œå’Œåº•å±‚æŒ‡ä»¤é›†æ¯æ¯ç›¸å…³ï¼Œåæ­£ä»–ä»¬ä¹‹é—´æ²¡æœ‰ç›¸äº’ä¾èµ–å…³ç³»ï¼Œè¿™æ ·æœ€ç»ˆçš„ç»“æœä¸ä¼šå˜ï¼Œå¹¶ä¸”æˆ‘ä»¬çš„æ‰§è¡Œæ•ˆç‡å˜é«˜äº†ï¼Œä½†æ˜¯å¦‚æœåœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬çœ‹ä¸‹é¢çš„ä»£ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// çº¿ç¨‹ 1:</span><br><span class="line">var app = new Application();   // è¯­å¥ 1</span><br><span class="line">if_init = true;             // è¯­å¥ 2</span><br><span class="line"> </span><br><span class="line">// çº¿ç¨‹ 2:</span><br><span class="line">while(!if_init)&#123;</span><br><span class="line">  sleep()</span><br><span class="line">&#125;</span><br><span class="line">doSomethingwithconfig(app);</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç æ„æ€æ˜¯ï¼Œåˆ›å»º app å¯¹è±¡ï¼Œç„¶åå°† if_init é‡ç½®æˆ trueï¼Œè¡¨æ˜ç°åœ¨å¯ä»¥ä½¿ç”¨ app äº†ï¼Œä½†æ˜¯ç¼–è¯‘å™¨è®¤ä¸ºçš„æ˜¯è¯­å¥ 1 å’Œè¯­å¥ 2 ä¹‹é—´æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œé‚£ä¹ˆä»–å°±ä¼šå»å°†ä¸¤ä¸ªè¯­å¥é‡æ’åºï¼Œå¦‚æœè¯­å¥ 2 å…ˆæ‰§è¡Œï¼Œè¯­å¥ 1 è¿˜æ²¡æœ‰æ‰§è¡Œï¼Œè¿™æ—¶å€™çº¿ç¨‹ 2 æ‰§è¡Œ while()ä»£ç ï¼Œå‘ç° if_inie ä¸º true-&gt; è·³å‡ºå¾ªç¯ï¼Œä¸‹é¢çš„å‡½æ•°ä½¿ç”¨åˆ°äº† app è¿™ä¸ªå˜é‡ï¼Œææœ‰å¯èƒ½å¯¼è‡´ç¨‹åºå‡ºé”™</p><h3 id="JVM-å¯¹å¤šçº¿ç¨‹çš„-native-æ“ä½œ"><a href="#JVM-å¯¹å¤šçº¿ç¨‹çš„-native-æ“ä½œ" class="headerlink" title="JVM å¯¹å¤šçº¿ç¨‹çš„ native æ“ä½œ"></a>JVM å¯¹å¤šçº¿ç¨‹çš„ native æ“ä½œ</h3><p> é¦–å…ˆæˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯ JVM æ²¡æœ‰å¯¹ç¨‹åºä½¿ç”¨ CPU ä¸­çš„é«˜é€Ÿç¼“å­˜å™¨è¿›è¡Œé™åˆ¶ï¼Œé‚£ä¹ˆä»–å°±ä¼šå‡ºç°æˆ‘ä»¬ä¸Šé¢æåˆ°è¿‡çš„é—®é¢˜ï¼Œæ¯”å¦‚é«˜é€Ÿç¼“å­˜å’Œå†…å­˜ä¹‹é—´æ›´æ–°ä¸åŠæ—¶å¯¼è‡´çš„ç¼“å­˜ä¸€è‡´æ€§é—®é¢˜ï¼Œä»¥åŠæŒ‡ä»¤é‡æ’å¯¼è‡´çš„ç¨‹åºæ‰§è¡Œå’Œé¢„æœŸæƒ³è±¡çš„ä¸ä¸€æ ·ã€‚</p><p> Java å†…å­˜æ¨¡å‹è§„å®šæ‰€æœ‰çš„å˜é‡éƒ½æ˜¯å­˜åœ¨ä¸»å­˜å½“ä¸­ï¼ˆç±»ä¼¼äºå‰é¢è¯´çš„ç‰©ç†å†…å­˜ï¼‰ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼ˆç±»ä¼¼äºå‰é¢çš„é«˜é€Ÿç¼“å­˜ï¼‰ã€‚çº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œè€Œä¸èƒ½ç›´æ¥å¯¹ä¸»å­˜è¿›è¡Œæ“ä½œã€‚å¹¶ä¸”æ¯ä¸ªçº¿ç¨‹ä¸èƒ½è®¿é—®å…¶ä»–çº¿ç¨‹çš„å·¥ä½œå†…å­˜ã€‚</p><h4 id="JVM-åŸå­æ€§"><a href="#JVM-åŸå­æ€§" class="headerlink" title="JVM åŸå­æ€§"></a>JVM åŸå­æ€§</h4><p> java è§„å®šç»™ä¸€ä¸ªå˜é‡èµ‹å€¼ä»¥åŠè¯»å–æ˜¯åŸå­æ€§æ“ä½œï¼Œè¿™äº›æ“ä½œæ˜¯ä¸å¯ä¸­æ–­çš„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šé¢è¯´è¿‡çš„æ¯”å¦‚ç»™ 64 ä½æ•°èµ‹å€¼ï¼Œå‰ 32 ä½å’Œå 32 ä½è¦ä¸€èµ·èµ‹å€¼ï¼Œå¦‚æœæ²¡æœ‰æˆåŠŸé‚£ä¹ˆå‰å 32 ä½éƒ½æ²¡æœ‰æˆåŠŸï¼Œæ’¤é”€æ“ä½œã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// ä¸‹é¢è¿™äº›è¯­å¥å“ªäº›æ˜¯åŸå­æ€§å‘¢ï¼Ÿ</span><br><span class="line">x = 10;         // è¯­å¥ 1</span><br><span class="line">y = x;         // è¯­å¥ 2</span><br><span class="line">x++;           // è¯­å¥ 3</span><br><span class="line">x = x + 1;     // è¯­å¥ 4</span><br></pre></td></tr></table></figure><p>è¯­å¥ 1 æ˜¯åŸå­æ€§</p><p>è¯­å¥ 2 ä¸æ˜¯ï¼šå…ˆè¯»å– x çš„å€¼ï¼Œå†å»ç»™ y èµ‹å€¼</p><p>è¯­å¥ 3 ä¸æ˜¯ï¼šå…ˆè¯»å– x çš„å€¼å†åŠ  1ï¼Œå†èµ‹å€¼ç»™ x</p><p>è¯­å¥ 4ï¼šå…ˆè¯»å– x çš„å€¼å†åŠ  1ï¼Œå†é‡æ–°å†™å›</p><p>æ‰€ä»¥ä¸Šé¢åªæœ‰ç¬¬ä¸€ä¸ªæ“ä½œæ˜¯åŸå­æ€§çš„ï¼Œå‰©ä¸‹ä¸‰ä¸ªå…¶å®éƒ½æ˜¯åŸå­æ€§æ“ä½œçš„ç»„åˆ</p><h4 id="JVM-å¯è§æ€§å¦‚ä½•"><a href="#JVM-å¯è§æ€§å¦‚ä½•" class="headerlink" title="JVM å¯è§æ€§å¦‚ä½•"></a>JVM å¯è§æ€§å¦‚ä½•</h4><p>JAVA é€šè¿‡å…³é”®å­— volatile å…³é”®å­—æ¥å®ç°å¯è§æ€§ï¼Œè¢« volatile å…³é”®å­—ä¿®é¥°çš„å…±äº«å˜é‡å°†ä¼šåœ¨è¢«ä¿®æ”¹åç«‹åˆ»æ›´æ–°åˆ°ä¸»å­˜ä¸­ï¼Œå¹¶ä¸”å…¶ä»–çº¿ç¨‹å¦‚æœæƒ³è¯»å–è¿™ä¸ªè¢«ä¿®æ”¹è¿‡çš„å…±äº«å˜é‡å°±å¿…é¡»å»ä¸»å­˜ä¸­é‡æ–°åŠ è½½ä¸€éã€‚</p><p> å¦å¤–æˆ‘ä»¬ä¸Šé¢æåˆ°è¿‡çš„ synchronized å…³é”®å­—å’Œ Lock å…³é”®å­—éƒ½å¯ä»¥ä¿è¯å¯è§æ€§ï¼Œä½†æ˜¯è¿™ç§å¯è§æ€§æ˜¯è¡¨ç°å‡ºæ¥çš„å¯è§æ€§ï¼Œè¿™ä¸¤ä¸ªå…³é”®å­—é™åˆ¶äº†åŒæ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å»è®¿é—®ï¼Œä¿®æ”¹å®Œæˆä¹‹åå°†å˜é‡é‡å†™å›ä¸»å­˜ä¸­ä¹‹åæ‰ä¼šè§£é”</p><h4 id="JVM-æœ‰åºæ€§å¦‚ä½•"><a href="#JVM-æœ‰åºæ€§å¦‚ä½•" class="headerlink" title="JVM æœ‰åºæ€§å¦‚ä½•"></a>JVM æœ‰åºæ€§å¦‚ä½•</h4><p> æˆ‘ä»¬æåˆ°è¿‡ JVM æ˜¯å…è®¸æŒ‡ä»¤é‡æ’çš„ï¼Œè¿™ä¸ªæ„æ€å°±æ˜¯å…è®¸ç¼–è¯‘å™¨å¯¹æŒ‡ä»¤æ‰§è¡Œé¡ºåºè¿›è¡Œé‡æ–°æ’åºä»¥è·å¾—æ›´å¥½çš„æ€§èƒ½ï¼Œä½†æ˜¯ä¼šå¸¦æ¥çš„é—®é¢˜å°±æ˜¯ä¼šå½±å“ç¨‹åºçš„æ‰§è¡Œæ•ˆæœï¼Œé‚£ä¹ˆ JVM å¦‚ä½•æ¥ä¿è¯å¤šçº¿ç¨‹ä¸­çš„æœ‰åºæ€§å‘¢ï¼Ÿä¸»è¦é€šè¿‡ä¸‰ä¸ªå…³é”®å­— volatile ä»¥åŠ synchronized å’Œ Lockï¼Œåä¸¤ä¸ªå¾ˆå®¹æ˜“ç†è§£ï¼Œå› ä¸ºè§„å®šäº†åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹è®¿é—®æ‰€ä»¥ç›¸å½“äºå°†å¤šçº¿ç¨‹çš„é—®é¢˜ç›´æ¥è½¬å˜æˆåœ¨å•çº¿ç¨‹çš„æƒ…å†µä¸‹è¿è¡Œï¼Œè‡ªç„¶å°±ä¸ä¼šå‡ºç°é‚£æ ·çš„é—®é¢˜ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ªå…³é”®å­—ä¸»è¦æ˜¯é€šè¿‡ä»€ä¹ˆå‘¢ï¼Ÿè¿™ä¸ªæˆ‘ä»¬åé¢å†è¯´ã€‚å…¶ä¸­ JVM è¿˜è§„å®šäº†ä¸€ä¸ªæ’åºåŸåˆ™ï¼šhappens-before åŸåˆ™ï¼Œè¿™ä¸ªæ˜¯ JVM æ¨æ–­è¯­å¥å˜æ¢é¡ºåºçš„æ—¶å€™ä¼šä¸ä¼šæœ€ç»ˆæ•ˆæœä¸€æ ·çš„å‡†åˆ™ï¼Œå¦‚æœä¸¤ä¸ªæ“ä½œä¸èƒ½é€šè¿‡ happens-before æ¥è¿›è¡Œæ¨å¯¼é‚£ä¹ˆå°±è®¤ä¸ºä¸¤ä¸ªè¯­å¥æ˜¯å¯ä»¥è¿›è¡Œé‡æ’åºçš„ã€‚</p><p> æ³¨æ„ happens-before åŸåˆ™é€‚ç”¨äºæ¨å¯¼è¯­å¥çš„å‰åé¡ºåºå…³ç³»ï¼Œå¦‚æœè¯­å¥ä¸èƒ½ä» happens-beofre ä¸­æ¨å¯¼å‡ºæ¥ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºè¿™ä¸¤ä¸ªè¯­å¥æ˜¯æ— åºçš„ï¼Œä¸è¦ææ··äº†</p><p>ä¸‹é¢å°±æ¥å…·ä½“ä»‹ç»ä¸‹ happens-before åŸåˆ™ï¼ˆå…ˆè¡Œå‘ç”ŸåŸåˆ™ï¼‰ï¼š</p><ul><li>ç¨‹åºæ¬¡åºè§„åˆ™ï¼šä¸€ä¸ªçº¿ç¨‹å†…ï¼ŒæŒ‰ç…§ä»£ç é¡ºåºï¼Œä¹¦å†™åœ¨å‰é¢çš„æ“ä½œå…ˆè¡Œå‘ç”Ÿäºä¹¦å†™åœ¨åé¢çš„æ“ä½œ</li><li>é”å®šè§„åˆ™ï¼šä¸€ä¸ª unLock æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹åŒä¸€ä¸ªé”é¢ lock æ“ä½œ</li><li>volatile å˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ªå˜é‡çš„å†™æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹è¿™ä¸ªå˜é‡çš„è¯»æ“ä½œ</li><li>ä¼ é€’è§„åˆ™ï¼šå¦‚æœæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Bï¼Œè€Œæ“ä½œ B åˆå…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Cï¼Œåˆ™å¯ä»¥å¾—å‡ºæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ C</li><li>çº¿ç¨‹å¯åŠ¨è§„åˆ™ï¼šThread å¯¹è±¡çš„ start()æ–¹æ³•å…ˆè¡Œå‘ç”Ÿäºæ­¤çº¿ç¨‹çš„æ¯ä¸ªä¸€ä¸ªåŠ¨ä½œ</li><li>çº¿ç¨‹ä¸­æ–­è§„åˆ™ï¼šå¯¹çº¿ç¨‹ interrupt()æ–¹æ³•çš„è°ƒç”¨å…ˆè¡Œå‘ç”Ÿäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿ</li><li>çº¿ç¨‹ç»ˆç»“è§„åˆ™ï¼šçº¿ç¨‹ä¸­æ‰€æœ‰çš„æ“ä½œéƒ½å…ˆè¡Œå‘ç”Ÿäºçº¿ç¨‹çš„ç»ˆæ­¢æ£€æµ‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Thread.join()æ–¹æ³•ç»“æŸã€Thread.isAlive()çš„è¿”å›å€¼æ‰‹æ®µæ£€æµ‹åˆ°çº¿ç¨‹å·²ç»ç»ˆæ­¢æ‰§è¡Œ</li><li>å¯¹è±¡ç»ˆç»“è§„åˆ™ï¼šä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆå…ˆè¡Œå‘ç”Ÿäºä»–çš„ finalize()æ–¹æ³•çš„å¼€å§‹</li></ul><p>å…³äº happens-before è§£æè¯¦çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a class="link"   href="https://segmentfault.com/a/1190000011458941" >https://segmentfault.com/a/1190000011458941<i class="fas fa-external-link-alt"></i></a></p><p>åé¢æœ‰æ—¶é—´äº†æˆ‘ä¹Ÿä¼šè¯¦ç»†çš„çœ‹ä¸€çœ‹ï¼Œç„¶åæ€»ç»“ä¸€ä¸‹ï¼Œå“­ å¥½å¿™~</p><h3 id="è®²è§£å…³äº-Volatile-å…³é”®å­—"><a href="#è®²è§£å…³äº-Volatile-å…³é”®å­—" class="headerlink" title="è®²è§£å…³äº Volatile å…³é”®å­—"></a>è®²è§£å…³äº Volatile å…³é”®å­—</h3><p> è¿˜æ˜¯é’ˆå¯¹ä¸Šé¢ä¸‰ä¸ªå¤šçº¿ç¨‹ä¸­è®¨è®ºçš„åœ°æ–¹ï¼šå¯è§æ€§ï¼ŒåŸå­æ€§ï¼Œæœ‰åºæ€§ï¼Œæˆ‘ä»¬æ¥è®¨è®ºä¸€ä¸‹ Volatile å…³é”®å­—å¦‚ä½•æ“ä½œè¿™ä¸‰æ–¹é¢çš„</p><h4 id="Volatile-å¯è§æ€§ï¼Ÿ"><a href="#Volatile-å¯è§æ€§ï¼Ÿ" class="headerlink" title="Volatile å¯è§æ€§ï¼Ÿ"></a>Volatile å¯è§æ€§ï¼Ÿ</h4><p> Volatile å¯ä»¥ä¿è¯å¯è§æ€§å˜›ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œè¢« Volatile ä¿®é¥°è¿‡çš„å˜é‡åœ¨è¢«çº¿ç¨‹ A ä¿®æ”¹è¿‡åå¿…é¡»é©¬ä¸Šå†™å›åˆ°ä¸»å­˜ä¸­ï¼Œæ‰€ä»¥æ•ˆæœä¸Šæ¥çœ‹ï¼ŒVolatile è¿™ä¸ªå…³é”®å­—æ˜¯ä¿è¯äº†å˜é‡çš„å¯è§æ€§çš„ï¼Œè¿™ä¸ªæ“ä½œå’Œæˆ‘ä»¬å‰é¢æåˆ°çš„ç¼“å­˜ä¸€è‡´æ€§åè®®æœ‰ç€åƒä¸ä¸‡ç¼•çš„å…³ç³»ï¼Œå¯ä»¥è¯´ Volatile åº•å±‚å°±æ˜¯ç¼“å­˜ä¸€è‡´æ€§åè®®çš„å®ç°ï¼Œå…·ä½“å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« (å¥½æ–‡çœŸå¤š)ï¼š</p><p><a class="link"   href="https://blog.csdn.net/mashaokang1314/article/details/96571818" >https://blog.csdn.net/mashaokang1314/article/details/96571818<i class="fas fa-external-link-alt"></i></a></p><p>Volatile å®ç°å†…å­˜å¯è§æ€§æ˜¯é€šè¿‡ store å’Œ load æŒ‡ä»¤å®Œæˆçš„ï¼›ä¹Ÿå°±æ˜¯å¯¹ volatile å˜é‡æ‰§è¡Œå†™æ“ä½œæ—¶ï¼Œä¼šåœ¨å†™æ“ä½œååŠ å…¥ä¸€æ¡ store æŒ‡ä»¤ï¼Œå³å¼ºè¿«çº¿ç¨‹å°†æœ€æ–°çš„å€¼åˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ï¼›è€Œåœ¨è¯»æ“ä½œæ—¶ï¼Œä¼šåŠ å…¥ä¸€æ¡ load æŒ‡ä»¤ï¼Œå³å¼ºè¿«ä»ä¸»å†…å­˜ä¸­è¯»å…¥å˜é‡çš„å€¼ã€‚å†™æ“ä½œä¹‹åç´§è·Ÿç€å†™å›ä¸»å­˜çš„æ“ä½œï¼Œè¯»å¿…é¡»ä»ä¸»å­˜ä¸­è¯»å–ï¼Œè¿™ä¸ªå°±æ˜¯ volatile ä¿è¯å¯è§æ€§çš„æ–¹æ³•ã€‚</p><h4 id="Volatile-åŸå­æ€§ï¼Ÿ"><a href="#Volatile-åŸå­æ€§ï¼Ÿ" class="headerlink" title="Volatile åŸå­æ€§ï¼Ÿ"></a>Volatile åŸå­æ€§ï¼Ÿ</h4><p> ä¸Šé¢æˆ‘ä»¬çŸ¥é“äº† Volatile æ˜¯å…·æœ‰å¯è§æ€§çš„ï¼Œé‚£æˆ‘ä»¬æ¥æŸ¥çœ‹ä¸€ä¸‹ä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// åä¸ªçº¿ç¨‹å„è‡ªå¾ªç¯ 1000 æ¬¡å¯¹ä¸€ä¸ª volatile ä¿®é¥°çš„å…±äº«å˜é‡æ¥è¿›è¡Œè‡ªå¢</span><br><span class="line">public class Test &#123;</span><br><span class="line">    public volatile int inc = 0;</span><br><span class="line">     </span><br><span class="line">    public void increase() &#123;</span><br><span class="line">        inc++;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        final Test test = new Test();</span><br><span class="line">        for(int i=0;i&lt;10;i++)&#123;</span><br><span class="line">            new Thread()&#123;</span><br><span class="line">                public void run() &#123;</span><br><span class="line">                    for(int j=0;j&lt;1000;j++)</span><br><span class="line">                        test.increase();</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;.start();</span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">        while(Thread.activeCount()&gt;1)  // ä¿è¯å‰é¢çš„çº¿ç¨‹éƒ½æ‰§è¡Œå®Œ</span><br><span class="line">            Thread.yield();</span><br><span class="line">        System.out.println(test.inc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> ä¸Šé¢çš„ä»£ç æˆ‘ä»¬æƒ³å½“ç„¶çš„ä¼šè§‰å¾—ï¼Œæ—¢ç„¶å·²ç»è¢« Volatile ä¿®é¥°äº†ï¼Œé‚£å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹å®Œæˆå†™å›ä¹‹åå…¶ä»–çº¿ç¨‹é©¬ä¸ŠçŸ¥é“äº†ï¼Œå¹¶ä¸”é‡æ–°ä»ä¸»å­˜ä¸­è¯»å–ï¼Œé‚£ä¹ˆæœ€ç»ˆçš„ç»“æœåº”è¯¥æ˜¯ 10*1000 = 10000ï¼Œä½†æ˜¯å®éªŒå‘ç°ç»“æœä¸æ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä»¬å‘ç°æ¯æ¬¡æ¯æ¬¡è¾“å‡ºçš„éƒ½è¦æ¯” 10000 å°ï¼Œè¿™æ˜¯å› ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p> é¦–å…ˆæˆ‘ä»¬åº”è¯¥è€ƒè™‘ä¸€ä¸‹æˆ‘ä»¬ç»™ test è¿™ä¸ªå…±äº«å˜é‡ +1 çš„æ“ä½œéƒ½æœ‰å“ªäº›ï¼Œæˆ‘ä»¬æåˆ°è¿‡è‡ªå¢å˜é‡æ˜¯ä¸å…·å¤‡åŸå­æ€§çš„ï¼Œä»–éœ€è¦å…ˆå–å›è‡ªå·±å˜é‡çš„å€¼ï¼Œ+1ï¼Œå†™å›ï¼Œè¿™æ˜¯ä¸‰ä¸ªåŸå­æ€§æ“ä½œï¼Œè€Œ volatile ä¿è¯çš„æ˜¯å¦‚æœè¿™ä¸ªå…±äº«å˜é‡è¢«ä¿®æ”¹äº†ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„çº¿ç¨‹ä¸­è¿™ä¸ªç¼–ç¨‹æ— æ•ˆï¼Œé‡æ–°è¯»å–ï¼Œå¦‚æœçº¿ç¨‹ A åªæ˜¯è¯»å–äº†å…±äº«å˜é‡ testï¼Œç„¶åçº¿ç¨‹ A å»å¿™åˆ«çš„äº†ï¼Œè¿™æ—¶å€™çº¿ç¨‹ B åˆè¯»å–äº†å…±äº«å˜é‡ test è¿›è¡Œ +1 æ“ä½œï¼Œç„¶åå°†å˜é‡å†™å›ï¼Œè¿™æ—¶å€™çº¿ç¨‹ A å·²ç»è¯»å–äº†å˜é‡ testï¼Œç´§æ¥ç€ä»–ä¹Ÿè¿›è¡Œ +1 ç„¶åå†™å›ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸¤ä¸ªç¨‹åºæ‰§è¡Œå®Œæ¯•ä¹‹å test ä»…ä»…åŠ äº†ä¸€æ¬¡ï¼Œè¿™æ—¶å€™å¦‚æœæœ‰ç–‘æƒ‘å»ºè®®å›é¡¾ä¸€ä¸‹ä¸Šé¢ volatile å¦‚ä½•ä¿è¯å¯è§æ€§ã€‚</p><p> é‚£å¦‚ä½•ä¿è¯åŸå­æ€§å‘¢ï¼Ÿä½¿ç”¨ synchronizedï¼ŒLockï¼ŒAtomicIntegerï¼Œæ“ä½œéƒ½å¯ä»¥å…·ä½“ä¸å±•å¼€äº†ï¼Œå› ä¸ºæˆ‘è¿˜éœ€è¦æŸ¥~</p><h4 id="Volatile-é¡ºåºæ€§"><a href="#Volatile-é¡ºåºæ€§" class="headerlink" title="Volatile é¡ºåºæ€§"></a>Volatile é¡ºåºæ€§</h4><p> Volatile å¯ä»¥ä¿è¯ç¨‹åºçš„éƒ¨åˆ†é¡ºåºæ‰§è¡Œï¼Œä¿è¯â€œéƒ¨åˆ†â€é¡ºåºæ‰§è¡Œæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿä¸‹é¢ä¸¾ä¸€ä¸ªä¾‹å­ï¼š</p><p><a class="link"   href="https://www.cnblogs.com/dolphin0520/p/3920373.html" >å‚è€ƒé“¾æ¥<i class="fas fa-external-link-alt"></i></a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//xã€y ä¸ºé volatile å˜é‡</span><br><span class="line">//flag ä¸º volatile å˜é‡</span><br><span class="line"> </span><br><span class="line">x = 2;        // è¯­å¥ 1</span><br><span class="line">y = 0;        // è¯­å¥ 2</span><br><span class="line">flag = true;  // è¯­å¥ 3</span><br><span class="line">x = 4;         // è¯­å¥ 4</span><br><span class="line">y = -1;       // è¯­å¥ 5</span><br></pre></td></tr></table></figure><p>flag æ˜¯è¢« volatile ä¿®é¥°çš„å˜é‡ï¼Œé‚£ä»–ä¼šå¸¦æ¥ä»€ä¹ˆæ•ˆæœå‘¢ï¼Ÿ</p><p>ï¼ˆ1ï¼‰flag ä¹‹å‰çš„ä»£ç å…¨éƒ¨æ‰§è¡Œäº†ï¼Œflag åé¢çš„ä»£ç è¿˜æ²¡æœ‰å¼€å§‹æ‰§è¡Œ</p><p>ï¼ˆ2ï¼‰è¯­å¥ 1 å’Œè¯­å¥ 2 çš„é¡ºåºä¸èƒ½ç¡®å®šï¼Œä½†æ˜¯è¯­å¥ 1ï¼Œ2 è‚¯å®šä¸èƒ½æ”¾åœ¨ flag åé¢æ‰§è¡Œï¼ŒåŒç†è¯­å¥ 3ï¼Œ4 çš„é¡ºåºä¸èƒ½ç¡®å®šï¼Œä½†æ˜¯ä¸èƒ½æ”¾åœ¨ flag ä¹‹å‰æ‰§è¡Œ</p><h3 id="ä»€ä¹ˆæ—¶å€™ä½¿ç”¨-Volatileï¼Ÿ"><a href="#ä»€ä¹ˆæ—¶å€™ä½¿ç”¨-Volatileï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ Volatileï¼Ÿ"></a>ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ Volatileï¼Ÿ</h3><p> æˆ‘ä»¬çŸ¥é“å¤šçº¿ç¨‹ç»å¸¸ç”¨çš„å…³é”®å­—å°±æ˜¯ synchronized ä»¥åŠ volatileï¼Œé‚£ä¹ˆä»–ä»¬å„è‡ªéƒ½æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿsynchronized æ˜¯é˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œä¸€æ®µä»£ç ï¼Œç›¸å½“äºç»™è¿™æ®µä»£ç åŠ é”äº†ï¼Œä¸æ–­çº¿ç¨‹è¿‡æ¥è¯·æ±‚è®¿é—®è¿™æ®µä»£ç ï¼Œå¦‚æœåŠ é”äº†å°±åªèƒ½ç­‰ï¼Œæ‰€æœ‰ Volatile åœ¨æ•ˆç‡ä¸Šæ˜¯ä¼˜äº synchronized çš„ï¼Œä½†æ˜¯ Volatile æ˜¯ä¸èƒ½ä¿è¯æ“ä½œçš„åŸå­æ€§çš„ï¼Œæ‰€ä»¥æœ‰æ—¶å€™å¿…é¡»ç»“åˆ synchronized ä¸€èµ·æ¥ç”¨ï¼Œé‚£ä»€ä¹ˆæ—¶å€™å¯ä»¥åªç”¨ Volatile è¿™ä¸ªå…³é”®å­—å‘¢ï¼Ÿ</p><p>ï¼ˆ1ï¼‰å¯¹å˜é‡çš„å†™æ“ä½œä¸ä¾èµ–å½“å‰çš„å˜é‡å€¼</p><p>ï¼ˆ2ï¼‰è¯¥å˜é‡æ²¡æœ‰åŒ…å«åœ¨å…·æœ‰å…¶ä»–å˜é‡çš„ä¸å˜å¼ä¸­</p><p>ä¸Šé¢ä¸¤ä¸ªæ¡ä»¶å°±æ˜¯é’ˆå¯¹ Volatile ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œæ‰€ä»¥å°±ä¸èƒ½éšä¾¿æ”¹å˜å…±äº«å˜é‡çš„æ•°å€¼ï¼Œå“ªæ€•æ˜¯è¢« Volatile ä¿®é¥°çš„ï¼Œä¸‹é¢ä¸¾ä¾‹ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ Volatile</p><h4 id="æ›´æ”¹çŠ¶æ€æ ‡è®°é‡ï¼š"><a href="#æ›´æ”¹çŠ¶æ€æ ‡è®°é‡ï¼š" class="headerlink" title="æ›´æ”¹çŠ¶æ€æ ‡è®°é‡ï¼š"></a>æ›´æ”¹çŠ¶æ€æ ‡è®°é‡ï¼š</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">volatile boolean flag = false;</span><br><span class="line"> </span><br><span class="line">while(!flag)&#123;</span><br><span class="line">    doSomething();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">public void setFlag() &#123;</span><br><span class="line">    flag = true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™æ®µä»£ç ä¸­çš„ setFlag æ–¹æ³•å°† flag ç½®ä¸º trueï¼Œå“ªæ€•å‡ºç°äº†åŸå­æ€§é—®é¢˜ï¼Œçº¿ç¨‹ A è¯»å–äº†ç„¶ååœä¸€ä¼šï¼ŒæœŸé—´çº¿ç¨‹ B è¯»å–äº†é‡å†™ä¼šä¸»å­˜ä¸­ä¸º trueï¼Œè¿™æ—¶å€™çº¿ç¨‹ A å†å†™ä¸€é true ä¹Ÿæ˜¯æ— æ‰€è°“çš„</p><h4 id="double-check-volatile"><a href="#double-check-volatile" class="headerlink" title="double check+volatile:"></a>double check+volatile:</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">class Singleton&#123;</span><br><span class="line">    private volatile static Singleton instance = null;</span><br><span class="line">     </span><br><span class="line">    private Singleton() &#123;</span><br><span class="line">         </span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    public static Singleton getInstance() &#123;</span><br><span class="line">        if(instance==null) &#123;</span><br><span class="line">            synchronized (Singleton.class) &#123;</span><br><span class="line">                if(instance==null)</span><br><span class="line">                    instance = new Singleton();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯ä¸ºäº†å®ç°å•ä¾‹æ¨¡å¼ä½¿ç”¨äº† double checkï¼Œå› ä¸º synchronized å¦‚æœç›´æ¥ä¿®é¥°æ•´ä¸ª getInstance æ–¹æ³•ä¼šå¯¼è‡´æ•ˆç‡å˜ä½ï¼Œæˆ‘ä»¬åªéœ€è¦åˆå§‹åŒ–çš„æ—¶å€™è¿›è¡ŒåŠ é”å³å¯ï¼Œå°±æ˜¯ä¸‹é¢çš„ä»£ç ï¼š</p><figure class="highlight plaintext"><figcaption><span>a</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static Singleton getInstance() &#123;</span><br><span class="line">        if(instance==null) &#123;</span><br><span class="line">            synchronized (Singleton.class) &#123;</span><br><span class="line">                if(instance==null)</span><br><span class="line">                    instance = new Singleton();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    return uniqueSingleton;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="åŒé‡æ£€æŸ¥é”ï¼ˆdouble-checked-lockingï¼‰"><a href="#åŒé‡æ£€æŸ¥é”ï¼ˆdouble-checked-lockingï¼‰" class="headerlink" title="åŒé‡æ£€æŸ¥é”ï¼ˆdouble checked lockingï¼‰"></a>åŒé‡æ£€æŸ¥é”ï¼ˆdouble checked lockingï¼‰</h5><p>å…ˆåˆ¤æ–­å¯¹è±¡æ˜¯å¦å·²ç»è¢«åˆå§‹åŒ–ï¼Œå†å†³å®šè¦ä¸è¦åŠ é”ï¼ŒåŒé‡æ£€æŸ¥æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>æ£€æŸ¥å˜é‡æ˜¯å¦è¢«åˆå§‹åŒ–(ä¸å»è·å¾—é”)ï¼Œå¦‚æœå·²è¢«åˆå§‹åŒ–åˆ™ç«‹å³è¿”å›ã€‚</li><li>è·å–é”ã€‚</li><li>å†æ¬¡æ£€æŸ¥å˜é‡æ˜¯å¦å·²ç»è¢«åˆå§‹åŒ–ï¼Œå¦‚æœè¿˜æ²¡è¢«åˆå§‹åŒ–å°±åˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡ã€‚</li></ol><p>æ‰§è¡ŒåŒé‡æ£€æŸ¥æ˜¯å› ä¸ºï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶äº†é€šè¿‡äº†ç¬¬ä¸€æ¬¡æ£€æŸ¥ï¼Œå¹¶ä¸”å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹é¦–å…ˆé€šè¿‡äº†ç¬¬äºŒæ¬¡æ£€æŸ¥å¹¶å®ä¾‹åŒ–äº†å¯¹è±¡ï¼Œé‚£ä¹ˆå‰©ä½™é€šè¿‡äº†ç¬¬ä¸€æ¬¡æ£€æŸ¥çš„çº¿ç¨‹å°±ä¸ä¼šå†å»å®ä¾‹åŒ–å¯¹è±¡ã€‚</p><p>è¿™æ ·ï¼Œé™¤äº†åˆå§‹åŒ–çš„æ—¶å€™ä¼šå‡ºç°åŠ é”çš„æƒ…å†µï¼Œåç»­çš„æ‰€æœ‰è°ƒç”¨éƒ½ä¼šé¿å…åŠ é”è€Œç›´æ¥è¿”å›ï¼Œè§£å†³äº†æ€§èƒ½æ¶ˆè€—çš„é—®é¢˜ã€‚å¦åˆ™æ¯ä¸€æ¬¡è°ƒç”¨ getInstance()æ–¹æ³•éƒ½ä¼šåŠ é”ï¼Œæ€§èƒ½ä½ä¸‹ã€‚</p><h5 id="éšæ‚£"><a href="#éšæ‚£" class="headerlink" title="éšæ‚£"></a>éšæ‚£</h5><p>ä¸Šè¿°å†™æ³•çœ‹ä¼¼è§£å†³äº†é—®é¢˜ï¼Œä½†æ˜¯æœ‰ä¸ªå¾ˆå¤§çš„éšæ‚£ã€‚å®ä¾‹åŒ–å¯¹è±¡çš„é‚£è¡Œä»£ç ï¼ˆæ ‡è®°ä¸º error çš„é‚£è¡Œï¼‰ï¼Œå®é™…ä¸Šå¯ä»¥åˆ†è§£æˆä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š</p><ol><li>åˆ†é…å†…å­˜ç©ºé—´</li><li>åˆå§‹åŒ–å¯¹è±¡</li><li>å°†å¯¹è±¡æŒ‡å‘åˆšåˆ†é…çš„å†…å­˜ç©ºé—´</li></ol><p>ä½†æ˜¯æœ‰äº›ç¼–è¯‘å™¨ä¸ºäº†æ€§èƒ½çš„åŸå› ï¼Œå¯èƒ½ä¼šå°†ç¬¬äºŒæ­¥å’Œç¬¬ä¸‰æ­¥è¿›è¡Œ <strong>é‡æ’åº</strong>ï¼Œé¡ºåºå°±æˆäº†ï¼š</p><ol><li>åˆ†é…å†…å­˜ç©ºé—´</li><li>å°†å¯¹è±¡æŒ‡å‘åˆšåˆ†é…çš„å†…å­˜ç©ºé—´</li><li>åˆå§‹åŒ–å¯¹è±¡</li></ol><p>ç°åœ¨è€ƒè™‘é‡æ’åºåï¼Œä¸¤ä¸ªçº¿ç¨‹å‘ç”Ÿäº†ä»¥ä¸‹è°ƒç”¨ï¼š</p><table><thead><tr><th align="left">Time</th><th align="left">Thread A</th><th align="left">Thread B</th></tr></thead><tbody><tr><td align="left">T1</td><td align="left">æ£€æŸ¥åˆ° Singleton ä¸ºç©º</td><td align="left"></td></tr><tr><td align="left">T2</td><td align="left">è·å–é”</td><td align="left"></td></tr><tr><td align="left">T3</td><td align="left">å†æ¬¡æ£€æŸ¥åˆ° Singleton ä¸ºç©º</td><td align="left"></td></tr><tr><td align="left">T4</td><td align="left">ä¸º Singleton åˆ†é…å†…å­˜ç©ºé—´</td><td align="left"></td></tr><tr><td align="left">T5</td><td align="left">å°† Singleton æŒ‡å‘å†…å­˜ç©ºé—´</td><td align="left"></td></tr><tr><td align="left">T6</td><td align="left"></td><td align="left">æ£€æŸ¥åˆ° Singleton ä¸ä¸ºç©º</td></tr><tr><td align="left">T7</td><td align="left"></td><td align="left">è®¿é—® Singletonï¼ˆæ­¤æ—¶å¯¹è±¡è¿˜æœªå®Œæˆåˆå§‹åŒ–ï¼‰</td></tr><tr><td align="left">T8</td><td align="left">åˆå§‹åŒ– Singleton</td><td align="left"></td></tr></tbody></table><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒT7 æ—¶åˆ»çº¿ç¨‹ B å¯¹ Singleton çš„è®¿é—®ï¼Œè®¿é—®çš„æ˜¯ä¸€ä¸ª <strong>åˆå§‹åŒ–æœªå®Œæˆ</strong> çš„å¯¹è±¡ã€‚</p><p>ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œéœ€è¦åœ¨ Singleton å‰åŠ å…¥å…³é”®å­—<code>volatile</code>ã€‚ä½¿ç”¨äº† volatile å…³é”®å­—åï¼Œé‡æ’åºè¢«ç¦æ­¢ï¼Œæ‰€æœ‰çš„å†™ï¼ˆwriteï¼‰æ“ä½œéƒ½å°†å‘ç”Ÿåœ¨è¯»ï¼ˆreadï¼‰æ“ä½œä¹‹å‰ã€‚</p><p>è‡³æ­¤ï¼ŒåŒé‡æ£€æŸ¥é”å°±å¯ä»¥å®Œç¾å·¥ä½œäº†ã€‚</p><p>å‚è€ƒï¼š</p><p><a class="link"   href="https://www.cnblogs.com/dolphin0520/p/3920373.html" >https://www.cnblogs.com/dolphin0520/p/3920373.html<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://cloud.tencent.com/developer/article/1548942" >https://cloud.tencent.com/developer/article/1548942<i class="fas fa-external-link-alt"></i></a></p><p><a class="link"   href="https://www.cnblogs.com/xz816111/p/8470048.html" >https://www.cnblogs.com/xz816111/p/8470048.html<i class="fas fa-external-link-alt"></i></a></p><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;æœ¬æ–‡è®°è½½äº†å…³äºå¤šçº¿ç¨‹ç¼–ç¨‹çš„ä¸€äº›åŸºç¡€çŸ¥è¯†ï¼Œä¸æ–­è¡¥å……&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>Clickhouse å…¥é—¨ä¸å®è·µ</title>
    <link href="http://example.com/2021/08/26/Clickhouse-%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E8%B7%B5/"/>
    <id>http://example.com/2021/08/26/Clickhouse-%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E8%B7%B5/</id>
    <published>2021-08-26T03:09:27.000Z</published>
    <updated>2021-10-08T11:21:28.322Z</updated>
    
    <content type="html"><![CDATA[<p>ClickHouseæ˜¯ä¸€ä¸ªç”¨äºè”æœºåˆ†æ(OLAP)çš„åˆ—å¼æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ(DBMS)ã€‚</p><span id="more"></span><h1 id="OLAPå’ŒOLTPåŒºåˆ«"><a href="#OLAPå’ŒOLTPåŒºåˆ«" class="headerlink" title="OLAPå’ŒOLTPåŒºåˆ«"></a>OLAPå’ŒOLTPåŒºåˆ«</h1><p>ä¸Šé¢é‚£å¥è¯æ˜¯æ¥è‡ªClickHouseä¸­æ–‡å®˜ç½‘</p><p>å…¶ä¸­OLAPè¿™ä¸ªè¯ç†Ÿæ‚‰åˆé™Œç”Ÿï¼Œè¿˜æœ‰ä¸€ä¸ªå¯¹åº”çš„å«åšOLTPï¼Œæˆ‘ä»¬ç®€å•ä»‹ç»ä¸€ä¸‹ä¸¤è€…åŒºåˆ«ã€‚</p><p>OLTPï¼ˆon-line transaction processingï¼‰ç¿»è¯‘ä¸ºè”æœºäº‹åŠ¡å¤„ç†</p><p>OLAPï¼ˆOn-Line Analytical Processingï¼‰ç¿»è¯‘ä¸ºè”æœºåˆ†æå¤„ç†</p><p>OLTPä¸»è¦å¯¹æ•°æ®åšå¢åˆ æ”¹æ“ä½œ</p><p>OLAPä¸»è¦å¯¹æ•°æ®åšæŸ¥æ“ä½œ</p><p>OLTPç”¨äºåœ¨ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œç›´æ¥äº§ç”Ÿå­˜å‚¨ä¸šåŠ¡æ•°æ®ï¼Œå¦‚ç”µå­å•†åŠ¡ï¼Œé“¶è¡Œï¼Œè¯åˆ¸ï¼Œä¸€èˆ¬æ•°æ®é‡è¾ƒå°ï¼Œè¦æ±‚æ“ä½œå®æ—¶æ€§é«˜</p><p>OLAPä¸»è¦é›†ä¸­ä¸šåŠ¡æ•°æ®ï¼Œè¿›è¡Œç»Ÿä¸€çš„ç»¼åˆåˆ†æï¼Œåˆ†æçš„æ•°æ®é‡ä¸€èˆ¬å·¨å¤§ï¼Œä¸èƒ½åšåˆ°å¾ˆå¥½åœ°å®æ—¶æ€§</p><h2 id="OLAPåˆ†ç±»"><a href="#OLAPåˆ†ç±»" class="headerlink" title="OLAPåˆ†ç±»"></a>OLAPåˆ†ç±»</h2><p>OLAPè¿˜å¯ä»¥åˆ†ä¸ºROLAPï¼ˆå…³ç³»å‹è”æœºåˆ†æå¤„ç†ï¼‰ä»¥åŠMOLAPï¼ˆå¤šç»´è”æœºåˆ†æå¤„ç†ï¼‰</p><h3 id="ROLAP"><a href="#ROLAP" class="headerlink" title="ROLAP"></a>ROLAP</h3><p>å®Œå…¨åŸºäºå…³ç³»æ¨¡å‹è¿›è¡Œå­˜å‚¨ï¼Œåªæ˜¯æ ¹æ®åˆ†æçš„éœ€æ±‚å¯¹æ¨¡å‹çš„ç»“æ„å’Œç»„ç»‡è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä»£è¡¨æœ‰MPPåˆ†å¸ƒå¼æ•°æ®åº“ï¼Œä»¥åŠåŸºäºHadoopçš„Sparkï¼ŒHive</p><p>å› ä¸ºROLAPæ˜¯å®æ—¶æ¥éœ€æ±‚ï¼Œå®æ—¶è¿›è¡Œè®¡ç®—ï¼Œæ‰€ä»¥åœ¨æ•°æ®é‡åºå¤§çš„æƒ…å†µä¸‹é€Ÿåº¦ä¼šå˜å¾—ä¸èƒ½æ¥å—ï¼Œè€Œä¼ ç»Ÿæ•°æ®åº“æ— æ³•æ”¯æŒå¤§è§„æ¨¡é›†ç¾¤å’ŒPBçº§åˆ«æ•°æ®é‡ï¼Œæ‰€ä»¥è¿™æ—¶å€™å‡ºç°äº†MMPï¼ˆå¤§è§„æ¨¡å¹¶è¡Œï¼‰æ•°æ®åº“ï¼Œè¿™ç§æ•°æ®åº“è§£å†³äº†ä¸€éƒ¨åˆ†å¯æ‰©å±•æ€§é—®é¢˜ï¼Œåœ¨æ”¯æŒçš„æ•°æ®ä½“é‡ä¸Šæœ‰äº†å¾ˆå¤§çš„æå‡ï¼Œä½†æ˜¯åœ¨èŠ‚ç‚¹æ•°é‡å¾ˆå¤§çš„æ—¶å€™å°±ç®—å†æå‡é›†ç¾¤è§„æ¨¡æ€§èƒ½ä¹Ÿä¸ä¼šæœ‰å¾ˆå¤§æå‡</p><p>åŸºäºHadoopçš„Sparkå¯¹ç¡¬ä»¶è¦æ±‚å¾ˆä½ï¼Œä½†æ˜¯è®¡ç®—é‡çº§è¾¾åˆ°ä¸€å®šç¨‹åº¦æ— æ³•ç§’çº§å“åº”ï¼Œå¹¶ä¸”å› ä¸ºæ˜¯åŸºäºå†…å­˜è®¡ç®—å®¹æ˜“å‡ºç°å†…å­˜æº¢å‡ºç­‰é—®é¢˜</p><h3 id="MOLAP"><a href="#MOLAP" class="headerlink" title="MOLAP"></a>MOLAP</h3><p>MOLAPç†å¿µå°±æ˜¯æ—¢ç„¶è®¡ç®—èƒ½åŠ›ä¸å¤Ÿèƒ½ç§’çº§è¿”å›ç»“æœï¼Œé‚£æˆ‘å°±æŒ‰ç…§ä¸€äº›ç»´åº¦å…ˆç®—å¥½æ•°æ®ï¼Œåˆ°æ—¶å€™ç›´æ¥è¿”å›ï¼Œä¼˜ç‚¹å°±æ˜¯åŒç­‰èµ„æºä¸‹æ”¯æŒçš„æ•°æ®ä½“é‡æ›´å¤§ï¼Œå¹¶å‘æ›´å¤šï¼Œä½†æ˜¯å½“è¡¨çš„ç»´åº¦è¶Šå¤šè¶Šå¤æ‚ï¼Œéœ€è¦çš„ç£ç›˜å­˜å‚¨ç©ºé—´è¶Šå¤§ï¼Œæ„å»ºcubeä¹Ÿè¶Šå¤æ‚ã€‚å¸¸è§çš„MOLAPæœåŠ¡å™¨æœ‰SSASï¼ŒKylin</p><p>Kylinåˆ™æ˜¯ç›®å‰æŠ€æœ¯è¾ƒä¸ºå…ˆè¿›çš„ä¸€æ¬¾æˆç†Ÿäº§å“ï¼ŒåŸºäºHadoopæ¡†æ¶ï¼ŒCubeä»¥åˆ†ç‰‡çš„å½¢å¼å­˜å‚¨åœ¨ä¸åŒèŠ‚ç‚¹ä¸Šï¼ŒCubeå¤§å°ä¸å—æœåŠ¡å™¨é…ç½®é™åˆ¶ï¼Œæ‰€ä»¥å…·å¤‡å¾ˆå¥½çš„å¯æ‰©å±•æ€§å’Œå¯¹æœåŠ¡å™¨è¦æ±‚å¾ˆä½ï¼Œåœ¨æ‰©å®¹æˆæœ¬ä¸Šå°±éå¸¸ä½å»‰ã€‚å¦å¤–ä¸ºäº†æ§åˆ¶æ•´ä½“Cubeçš„å¤§å°ï¼ŒKylinç»™å®¢æˆ·æä¾›äº†å»ºæ¨¡çš„èƒ½åŠ›ï¼Œå³ç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªèº«éœ€è¦ï¼Œå¯¹æ¨¡å‹ç§çš„ç»´åº¦ä»¥åŠç»´åº¦ç»„åˆè¿›è¡Œé¢„å…ˆçš„æ„å»ºï¼ŒæŠŠä¸€äº›ä¸éœ€è¦çš„ç»´åº¦å’Œç»„åˆç­›é€‰æ‰ï¼Œä»è€Œè¾¾åˆ°é™ä½ç»´åº¦çš„ç›®çš„ï¼Œå‡å°‘ç£ç›˜ç©ºé—´çš„å ç”¨ã€‚</p><p>ä»å¯æ‰©å±•æ€§ä¸Šçœ‹ï¼š</p><p>Kylin=Impala/Spark&gt;MPPæ•°æ®åº“&gt;ä¼ ç»Ÿæ•°æ®åº“ï¼›</p><p>ä»å¯¹ç¡¬ä»¶è¦æ±‚ä¸Šçœ‹ï¼š</p><p>ä¼ ç»Ÿæ•°æ®åº“&gt;MPPæ•°æ®åº“&gt;Impala/Spark&gt;=Kylinï¼›</p><p>ä»å“åº”æ•ˆç‡ä¸Šæ¥çœ‹ï¼š</p><p>ä¸åŒçš„æ•°æ®é‡ã€å¹¶å‘æ•°ï¼Œå“åº”æ•ˆç‡å·®åˆ«ä¸ä¸€ï¼Œä½†å¯ä»¥ç¡®å®šçš„æ˜¯ï¼Œè¦è®¡ç®—çš„æ•°æ®é‡è¶Šå¤§ï¼Œå¹¶å‘çš„ç”¨æˆ·æ•°è¶Šå¤šï¼ŒåŒç­‰èµ„æºæƒ…å†µä¸‹é¢„è®¡ç®—çš„å“åº”æ•ˆç‡ä¼šè¶Šå‘æ˜æ˜¾ã€‚</p><img src="/2021/08/26/Clickhouse-%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E8%B7%B5/shujuku.jpg" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><h1 id="ClickHouse"><a href="#ClickHouse" class="headerlink" title="ClickHouse"></a>ClickHouse</h1><p>ClickHouseæ˜¯ä¸€ä¸ªç”¨äºè”æœºåˆ†æ(OLAP)çš„åˆ—å¼æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ(DBMS)</p><h2 id="å®‰è£…ä¸éƒ¨ç½²"><a href="#å®‰è£…ä¸éƒ¨ç½²" class="headerlink" title="å®‰è£…ä¸éƒ¨ç½²"></a>å®‰è£…ä¸éƒ¨ç½²</h2><p>ç³»ç»Ÿæ˜¯m1 Macï¼Œç›®å‰è¿˜ä¸èƒ½åŸç”Ÿçš„æ”¯æŒClickHouseï¼Œæ‰¾äº†ä¸ªcentos 7çš„æœåŠ¡å™¨ï¼Œä¸‹é¢æˆ‘ä»¬å…ˆæ¥å®‰è£…éƒ¨ç½²ä¸€ä¸‹ClickHouseã€‚</p><p>é¦–å…ˆæ£€æŸ¥æˆ‘ä»¬çš„ç³»ç»Ÿæ˜¯å¦æ”¯æŒ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -q sse4_2 /proc/cpuinfo &amp;&amp; echo &quot;SSE 4.2 supported&quot; || echo &quot;SSE 4.2 not supported&quot;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºå‰é¢çš„ç»“æœï¼šSSE 4.2 supported  å³ä¸ºæ”¯æŒ</p><p>centoså®‰è£…å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">é¦–å…ˆæˆ‘ä»¬æ·»åŠ å®‰è£…æº</span></span><br><span class="line">sudo yum install yum-utils</span><br><span class="line">sudo rpm --import https://repo.clickhouse.tech/CLICKHOUSE-KEY.GPG</span><br><span class="line">sudo yum-config-manager --add-repo https://repo.clickhouse.tech/rpm/stable/x86_64</span><br></pre></td></tr></table></figure><p>å¦‚æœæƒ³ä½¿ç”¨æœ€æ–°çš„ç‰ˆæœ¬ï¼Œè¯·ç”¨<code>testing</code>æ›¿ä»£<code>stable</code></p><p>è¿è¡Œå‘½ä»¤å®‰è£…ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install clickhouse-server clickhouse-client</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ï¼ˆé»˜è®¤æ˜¯./config.xmlæ‰€ä»¥éœ€è¦åœ¨ç›¸åº”ç›®å½•ä¸‹å¯åŠ¨ï¼‰</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo service clickhouse-server start</span><br><span class="line">æˆ–è€…ä½¿ç”¨</span><br><span class="line">systemctl start clickhouse-serve</span><br></pre></td></tr></table></figure><p>æœåŠ¡ç«¯æ—¥å¿—æ–‡ä»¶è·¯å¾„:/var/log/clickhouse-server/</p><p>é»˜è®¤é…ç½®æ–‡ä»¶åœ¨ï¼š/etc/clickhouse-server/config.xml</p><p>è¿è¡Œçš„æ—¶å€™ï¼Œé…ç½®æ–‡ä»¶ä¼šè‡ªåŠ¨åˆå¹¶<code>/etc/clickhouse-server/config.d</code>ç›®å½•ä¸‹çš„xmlæ–‡ä»¶</p><p>åœ¨æ§åˆ¶å°å¯åŠ¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">å®é™…ä¸Šè¿˜æœ‰config.dç›®å½•ä¸‹çš„xmlé…ç½®æ–‡ä»¶ï¼Œéœ€è¦æ³¨æ„ä¸‹</span></span><br><span class="line">clickhouse-server --config-file=/etc/clickhouse-server/config.xml</span><br></pre></td></tr></table></figure><h2 id="å¯¼å…¥ç¤ºä¾‹æ•°æ®é›†"><a href="#å¯¼å…¥ç¤ºä¾‹æ•°æ®é›†" class="headerlink" title="å¯¼å…¥ç¤ºä¾‹æ•°æ®é›†"></a>å¯¼å…¥ç¤ºä¾‹æ•°æ®é›†</h2><p>ä¸‹é¢æˆ‘ä»¬åšä¸€ä¸ªå®˜ç½‘çš„ä¸€ä¸ªæ•°æ®é›†æµ‹è¯•ï¼Œäº†è§£ä¸€ä¸‹åŸºç¡€çš„å¦‚ä½•å¯¼å…¥æ•°æ®ä»¥åŠæŸ¥è¯¢</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl https://datasets.clickhouse.tech/hits/tsv/hits_v1.tsv.xz | unxz --threads=`nproc` &gt; hits_v1.tsv</span><br><span class="line">curl https://datasets.clickhouse.tech/visits/tsv/visits_v1.tsv.xz | unxz --threads=`nproc` &gt; visits_v1.tsv</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªæ–‡ä»¶æ•°æ®é‡æœ‰10Gå·¦å³ï¼Œæˆ‘ä»¬é€šè¿‡headå‘½ä»¤æå–éƒ¨åˆ†æ•°æ®å³å¯</p><p>head -n 100000 hits_v1.tsv &gt; hits_v2.tsv</p><p>head visits_v1.tsv -n 50000 &gt; visits_v2.tsv</p><h3 id="å‡†å¤‡åº“è¡¨"><a href="#å‡†å¤‡åº“è¡¨" class="headerlink" title="å‡†å¤‡åº“è¡¨"></a>å‡†å¤‡åº“è¡¨</h3><p>ç™»å½•clickhouseå®¢æˆ·ç«¯</p><div class='spoiler collapsed'>    <div class='spoiler-title'>        clickhouse-clientå¿«é€Ÿæç¤º    </div>    <div class='spoiler-content'>        <p>äº¤äº’æ¨¡å¼:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clickhouse-client</span><br><span class="line">clickhouse-client --host=... --port=... --user=... --password=...</span><br></pre></td></tr></table></figure><p>å¯ç”¨å¤šè¡ŒæŸ¥è¯¢:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clickhouse-client -m</span><br><span class="line">clickhouse-client --multiline</span><br></pre></td></tr></table></figure><p>ä»¥æ‰¹å¤„ç†æ¨¡å¼è¿è¡ŒæŸ¥è¯¢:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clickhouse-client --query=&#x27;SELECT 1&#x27;</span><br><span class="line">echo &#x27;SELECT 1&#x27; | clickhouse-client</span><br><span class="line">clickhouse-client &lt;&lt;&lt; &#x27;SELECT 1&#x27;</span><br></pre></td></tr></table></figure><p>ä»æŒ‡å®šæ ¼å¼çš„æ–‡ä»¶ä¸­æ’å…¥æ•°æ®:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clickhouse-client --query=&#x27;INSERT INTO table VALUES&#x27; &lt; data.txt</span><br><span class="line">clickhouse-client --query=&#x27;INSERT INTO table FORMAT TabSeparated&#x27; &lt; data.tsv </span><br></pre></td></tr></table></figure>    </div></div><p>è¿™é‡Œæˆ‘ä»¬å»ºç«‹ä¸€ä¸ªåº“åå«åšadtiming</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clickhouse<span class="operator">-</span>client <span class="comment">--query &quot;CREATE DATABASE IF NOT EXISTS adtiming&quot;</span></span><br></pre></td></tr></table></figure><p>å»ºè¡¨è¯­æ³•è¦å¤æ‚çš„å¤šï¼Œ<a class="link"   href="https://clickhouse.tech/docs/zh/sql-reference/statements/create/" >å»ºè¡¨æ–‡æ¡£<i class="fas fa-external-link-alt"></i></a></p><p>åˆ†åˆ«åˆ›å»ºhitsè¡¨ä»¥åŠvisitsè¡¨</p><div class='spoiler collapsed'>    <div class='spoiler-title'>        å»ºè¡¨è¯­å¥    </div>    <div class='spoiler-content'>        <figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> adtiming.hits_v1</span><br><span class="line">(</span><br><span class="line">    `WatchID` UInt64,</span><br><span class="line">    `JavaEnable` UInt8,</span><br><span class="line">    `Title` String,</span><br><span class="line">    `GoodEvent` Int16,</span><br><span class="line">    `EventTime` DateTime,</span><br><span class="line">    `EventDate` <span class="type">Date</span>,</span><br><span class="line">    `CounterID` UInt32,</span><br><span class="line">    `ClientIP` UInt32,</span><br><span class="line">    `ClientIP6` FixedString(<span class="number">16</span>),</span><br><span class="line">    `RegionID` UInt32,</span><br><span class="line">    `UserID` UInt64,</span><br><span class="line">    `CounterClass` Int8,</span><br><span class="line">    `OS` UInt8,</span><br><span class="line">    `UserAgent` UInt8,</span><br><span class="line">    `URL` String,</span><br><span class="line">    `Referer` String,</span><br><span class="line">    `URLDomain` String,</span><br><span class="line">    `RefererDomain` String,</span><br><span class="line">    `Refresh` UInt8,</span><br><span class="line">    `IsRobot` UInt8,</span><br><span class="line">    `RefererCategories` <span class="keyword">Array</span>(UInt16),</span><br><span class="line">    `URLCategories` <span class="keyword">Array</span>(UInt16),</span><br><span class="line">    `URLRegions` <span class="keyword">Array</span>(UInt32),</span><br><span class="line">    `RefererRegions` <span class="keyword">Array</span>(UInt32),</span><br><span class="line">    `ResolutionWidth` UInt16,</span><br><span class="line">    `ResolutionHeight` UInt16,</span><br><span class="line">    `ResolutionDepth` UInt8,</span><br><span class="line">    `FlashMajor` UInt8,</span><br><span class="line">    `FlashMinor` UInt8,</span><br><span class="line">    `FlashMinor2` String,</span><br><span class="line">    `NetMajor` UInt8,</span><br><span class="line">    `NetMinor` UInt8,</span><br><span class="line">    `UserAgentMajor` UInt16,</span><br><span class="line">    `UserAgentMinor` FixedString(<span class="number">2</span>),</span><br><span class="line">    `CookieEnable` UInt8,</span><br><span class="line">    `JavascriptEnable` UInt8,</span><br><span class="line">    `IsMobile` UInt8,</span><br><span class="line">    `MobilePhone` UInt8,</span><br><span class="line">    `MobilePhoneModel` String,</span><br><span class="line">    `Params` String,</span><br><span class="line">    `IPNetworkID` UInt32,</span><br><span class="line">    `TraficSourceID` Int8,</span><br><span class="line">    `SearchEngineID` UInt16,</span><br><span class="line">    `SearchPhrase` String,</span><br><span class="line">    `AdvEngineID` UInt8,</span><br><span class="line">    `IsArtifical` UInt8,</span><br><span class="line">    `WindowClientWidth` UInt16,</span><br><span class="line">    `WindowClientHeight` UInt16,</span><br><span class="line">    `ClientTimeZone` Int16,</span><br><span class="line">    `ClientEventTime` DateTime,</span><br><span class="line">    `SilverlightVersion1` UInt8,</span><br><span class="line">    `SilverlightVersion2` UInt8,</span><br><span class="line">    `SilverlightVersion3` UInt32,</span><br><span class="line">    `SilverlightVersion4` UInt16,</span><br><span class="line">    `PageCharset` String,</span><br><span class="line">    `CodeVersion` UInt32,</span><br><span class="line">    `IsLink` UInt8,</span><br><span class="line">    `IsDownload` UInt8,</span><br><span class="line">    `IsNotBounce` UInt8,</span><br><span class="line">    `FUniqID` UInt64,</span><br><span class="line">    `HID` UInt32,</span><br><span class="line">    `IsOldCounter` UInt8,</span><br><span class="line">    `IsEvent` UInt8,</span><br><span class="line">    `IsParameter` UInt8,</span><br><span class="line">    `DontCountHits` UInt8,</span><br><span class="line">    `WithHash` UInt8,</span><br><span class="line">    `HitColor` FixedString(<span class="number">1</span>),</span><br><span class="line">    `UTCEventTime` DateTime,</span><br><span class="line">    `Age` UInt8,</span><br><span class="line">    `Sex` UInt8,</span><br><span class="line">    `Income` UInt8,</span><br><span class="line">    `Interests` UInt16,</span><br><span class="line">    `Robotness` UInt8,</span><br><span class="line">    `GeneralInterests` <span class="keyword">Array</span>(UInt16),</span><br><span class="line">    `RemoteIP` UInt32,</span><br><span class="line">    `RemoteIP6` FixedString(<span class="number">16</span>),</span><br><span class="line">    `WindowName` Int32,</span><br><span class="line">    `OpenerName` Int32,</span><br><span class="line">    `HistoryLength` Int16,</span><br><span class="line">    `BrowserLanguage` FixedString(<span class="number">2</span>),</span><br><span class="line">    `BrowserCountry` FixedString(<span class="number">2</span>),</span><br><span class="line">    `SocialNetwork` String,</span><br><span class="line">    `SocialAction` String,</span><br><span class="line">    `HTTPError` UInt16,</span><br><span class="line">    `SendTiming` Int32,</span><br><span class="line">    `DNSTiming` Int32,</span><br><span class="line">    `ConnectTiming` Int32,</span><br><span class="line">    `ResponseStartTiming` Int32,</span><br><span class="line">    `ResponseEndTiming` Int32,</span><br><span class="line">    `FetchTiming` Int32,</span><br><span class="line">    `RedirectTiming` Int32,</span><br><span class="line">    `DOMInteractiveTiming` Int32,</span><br><span class="line">    `DOMContentLoadedTiming` Int32,</span><br><span class="line">    `DOMCompleteTiming` Int32,</span><br><span class="line">    `LoadEventStartTiming` Int32,</span><br><span class="line">    `LoadEventEndTiming` Int32,</span><br><span class="line">    `NSToDOMContentLoadedTiming` Int32,</span><br><span class="line">    `FirstPaintTiming` Int32,</span><br><span class="line">    `RedirectCount` Int8,</span><br><span class="line">    `SocialSourceNetworkID` UInt8,</span><br><span class="line">    `SocialSourcePage` String,</span><br><span class="line">    `ParamPrice` Int64,</span><br><span class="line">    `ParamOrderID` String,</span><br><span class="line">    `ParamCurrency` FixedString(<span class="number">3</span>),</span><br><span class="line">    `ParamCurrencyID` UInt16,</span><br><span class="line">    `GoalsReached` <span class="keyword">Array</span>(UInt32),</span><br><span class="line">    `OpenstatServiceName` String,</span><br><span class="line">    `OpenstatCampaignID` String,</span><br><span class="line">    `OpenstatAdID` String,</span><br><span class="line">    `OpenstatSourceID` String,</span><br><span class="line">    `UTMSource` String,</span><br><span class="line">    `UTMMedium` String,</span><br><span class="line">    `UTMCampaign` String,</span><br><span class="line">    `UTMContent` String,</span><br><span class="line">    `UTMTerm` String,</span><br><span class="line">    `FromTag` String,</span><br><span class="line">    `HasGCLID` UInt8,</span><br><span class="line">    `RefererHash` UInt64,</span><br><span class="line">    `URLHash` UInt64,</span><br><span class="line">    `CLID` UInt32,</span><br><span class="line">    `YCLID` UInt64,</span><br><span class="line">    `ShareService` String,</span><br><span class="line">    `ShareURL` String,</span><br><span class="line">    `ShareTitle` String,</span><br><span class="line">    `ParsedParams` Nested(</span><br><span class="line">        Key1 String,</span><br><span class="line">        Key2 String,</span><br><span class="line">        Key3 String,</span><br><span class="line">        Key4 String,</span><br><span class="line">        Key5 String,</span><br><span class="line">        ValueDouble Float64),</span><br><span class="line">    `IslandID` FixedString(<span class="number">16</span>),</span><br><span class="line">    `RequestNum` UInt32,</span><br><span class="line">    `RequestTry` UInt8</span><br><span class="line">)</span><br><span class="line">ENGINE <span class="operator">=</span> MergeTree()</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(EventDate)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (CounterID, EventDate, intHash32(UserID))</span><br><span class="line">SAMPLE <span class="keyword">BY</span> intHash32(UserID)</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> adtiming.visits_v1</span><br><span class="line">(</span><br><span class="line">    `CounterID` UInt32,</span><br><span class="line">    `StartDate` <span class="type">Date</span>,</span><br><span class="line">    `Sign` Int8,</span><br><span class="line">    `IsNew` UInt8,</span><br><span class="line">    `VisitID` UInt64,</span><br><span class="line">    `UserID` UInt64,</span><br><span class="line">    `StartTime` DateTime,</span><br><span class="line">    `Duration` UInt32,</span><br><span class="line">    `UTCStartTime` DateTime,</span><br><span class="line">    `PageViews` Int32,</span><br><span class="line">    `Hits` Int32,</span><br><span class="line">    `IsBounce` UInt8,</span><br><span class="line">    `Referer` String,</span><br><span class="line">    `StartURL` String,</span><br><span class="line">    `RefererDomain` String,</span><br><span class="line">    `StartURLDomain` String,</span><br><span class="line">    `EndURL` String,</span><br><span class="line">    `LinkURL` String,</span><br><span class="line">    `IsDownload` UInt8,</span><br><span class="line">    `TraficSourceID` Int8,</span><br><span class="line">    `SearchEngineID` UInt16,</span><br><span class="line">    `SearchPhrase` String,</span><br><span class="line">    `AdvEngineID` UInt8,</span><br><span class="line">    `PlaceID` Int32,</span><br><span class="line">    `RefererCategories` <span class="keyword">Array</span>(UInt16),</span><br><span class="line">    `URLCategories` <span class="keyword">Array</span>(UInt16),</span><br><span class="line">    `URLRegions` <span class="keyword">Array</span>(UInt32),</span><br><span class="line">    `RefererRegions` <span class="keyword">Array</span>(UInt32),</span><br><span class="line">    `IsYandex` UInt8,</span><br><span class="line">    `GoalReachesDepth` Int32,</span><br><span class="line">    `GoalReachesURL` Int32,</span><br><span class="line">    `GoalReachesAny` Int32,</span><br><span class="line">    `SocialSourceNetworkID` UInt8,</span><br><span class="line">    `SocialSourcePage` String,</span><br><span class="line">    `MobilePhoneModel` String,</span><br><span class="line">    `ClientEventTime` DateTime,</span><br><span class="line">    `RegionID` UInt32,</span><br><span class="line">    `ClientIP` UInt32,</span><br><span class="line">    `ClientIP6` FixedString(<span class="number">16</span>),</span><br><span class="line">    `RemoteIP` UInt32,</span><br><span class="line">    `RemoteIP6` FixedString(<span class="number">16</span>),</span><br><span class="line">    `IPNetworkID` UInt32,</span><br><span class="line">    `SilverlightVersion3` UInt32,</span><br><span class="line">    `CodeVersion` UInt32,</span><br><span class="line">    `ResolutionWidth` UInt16,</span><br><span class="line">    `ResolutionHeight` UInt16,</span><br><span class="line">    `UserAgentMajor` UInt16,</span><br><span class="line">    `UserAgentMinor` UInt16,</span><br><span class="line">    `WindowClientWidth` UInt16,</span><br><span class="line">    `WindowClientHeight` UInt16,</span><br><span class="line">    `SilverlightVersion2` UInt8,</span><br><span class="line">    `SilverlightVersion4` UInt16,</span><br><span class="line">    `FlashVersion3` UInt16,</span><br><span class="line">    `FlashVersion4` UInt16,</span><br><span class="line">    `ClientTimeZone` Int16,</span><br><span class="line">    `OS` UInt8,</span><br><span class="line">    `UserAgent` UInt8,</span><br><span class="line">    `ResolutionDepth` UInt8,</span><br><span class="line">    `FlashMajor` UInt8,</span><br><span class="line">    `FlashMinor` UInt8,</span><br><span class="line">    `NetMajor` UInt8,</span><br><span class="line">    `NetMinor` UInt8,</span><br><span class="line">    `MobilePhone` UInt8,</span><br><span class="line">    `SilverlightVersion1` UInt8,</span><br><span class="line">    `Age` UInt8,</span><br><span class="line">    `Sex` UInt8,</span><br><span class="line">    `Income` UInt8,</span><br><span class="line">    `JavaEnable` UInt8,</span><br><span class="line">    `CookieEnable` UInt8,</span><br><span class="line">    `JavascriptEnable` UInt8,</span><br><span class="line">    `IsMobile` UInt8,</span><br><span class="line">    `BrowserLanguage` UInt16,</span><br><span class="line">    `BrowserCountry` UInt16,</span><br><span class="line">    `Interests` UInt16,</span><br><span class="line">    `Robotness` UInt8,</span><br><span class="line">    `GeneralInterests` <span class="keyword">Array</span>(UInt16),</span><br><span class="line">    `Params` <span class="keyword">Array</span>(String),</span><br><span class="line">    `Goals` Nested(</span><br><span class="line">        ID UInt32,</span><br><span class="line">        Serial UInt32,</span><br><span class="line">        EventTime DateTime,</span><br><span class="line">        Price Int64,</span><br><span class="line">        OrderID String,</span><br><span class="line">        CurrencyID UInt32),</span><br><span class="line">    `WatchIDs` <span class="keyword">Array</span>(UInt64),</span><br><span class="line">    `ParamSumPrice` Int64,</span><br><span class="line">    `ParamCurrency` FixedString(<span class="number">3</span>),</span><br><span class="line">    `ParamCurrencyID` UInt16,</span><br><span class="line">    `ClickLogID` UInt64,</span><br><span class="line">    `ClickEventID` Int32,</span><br><span class="line">    `ClickGoodEvent` Int32,</span><br><span class="line">    `ClickEventTime` DateTime,</span><br><span class="line">    `ClickPriorityID` Int32,</span><br><span class="line">    `ClickPhraseID` Int32,</span><br><span class="line">    `ClickPageID` Int32,</span><br><span class="line">    `ClickPlaceID` Int32,</span><br><span class="line">    `ClickTypeID` Int32,</span><br><span class="line">    `ClickResourceID` Int32,</span><br><span class="line">    `ClickCost` UInt32,</span><br><span class="line">    `ClickClientIP` UInt32,</span><br><span class="line">    `ClickDomainID` UInt32,</span><br><span class="line">    `ClickURL` String,</span><br><span class="line">    `ClickAttempt` UInt8,</span><br><span class="line">    `ClickOrderID` UInt32,</span><br><span class="line">    `ClickBannerID` UInt32,</span><br><span class="line">    `ClickMarketCategoryID` UInt32,</span><br><span class="line">    `ClickMarketPP` UInt32,</span><br><span class="line">    `ClickMarketCategoryName` String,</span><br><span class="line">    `ClickMarketPPName` String,</span><br><span class="line">    `ClickAWAPSCampaignName` String,</span><br><span class="line">    `ClickPageName` String,</span><br><span class="line">    `ClickTargetType` UInt16,</span><br><span class="line">    `ClickTargetPhraseID` UInt64,</span><br><span class="line">    `ClickContextType` UInt8,</span><br><span class="line">    `ClickSelectType` Int8,</span><br><span class="line">    `ClickOptions` String,</span><br><span class="line">    `ClickGroupBannerID` Int32,</span><br><span class="line">    `OpenstatServiceName` String,</span><br><span class="line">    `OpenstatCampaignID` String,</span><br><span class="line">    `OpenstatAdID` String,</span><br><span class="line">    `OpenstatSourceID` String,</span><br><span class="line">    `UTMSource` String,</span><br><span class="line">    `UTMMedium` String,</span><br><span class="line">    `UTMCampaign` String,</span><br><span class="line">    `UTMContent` String,</span><br><span class="line">    `UTMTerm` String,</span><br><span class="line">    `FromTag` String,</span><br><span class="line">    `HasGCLID` UInt8,</span><br><span class="line">    `FirstVisit` DateTime,</span><br><span class="line">    `PredLastVisit` <span class="type">Date</span>,</span><br><span class="line">    `LastVisit` <span class="type">Date</span>,</span><br><span class="line">    `TotalVisits` UInt32,</span><br><span class="line">    `TraficSource` Nested(</span><br><span class="line">        ID Int8,</span><br><span class="line">        SearchEngineID UInt16,</span><br><span class="line">        AdvEngineID UInt8,</span><br><span class="line">        PlaceID UInt16,</span><br><span class="line">        SocialSourceNetworkID UInt8,</span><br><span class="line">        Domain String,</span><br><span class="line">        SearchPhrase String,</span><br><span class="line">        SocialSourcePage String),</span><br><span class="line">    `Attendance` FixedString(<span class="number">16</span>),</span><br><span class="line">    `CLID` UInt32,</span><br><span class="line">    `YCLID` UInt64,</span><br><span class="line">    `NormalizedRefererHash` UInt64,</span><br><span class="line">    `SearchPhraseHash` UInt64,</span><br><span class="line">    `RefererDomainHash` UInt64,</span><br><span class="line">    `NormalizedStartURLHash` UInt64,</span><br><span class="line">    `StartURLDomainHash` UInt64,</span><br><span class="line">    `NormalizedEndURLHash` UInt64,</span><br><span class="line">    `TopLevelDomain` UInt64,</span><br><span class="line">    `URLScheme` UInt64,</span><br><span class="line">    `OpenstatServiceNameHash` UInt64,</span><br><span class="line">    `OpenstatCampaignIDHash` UInt64,</span><br><span class="line">    `OpenstatAdIDHash` UInt64,</span><br><span class="line">    `OpenstatSourceIDHash` UInt64,</span><br><span class="line">    `UTMSourceHash` UInt64,</span><br><span class="line">    `UTMMediumHash` UInt64,</span><br><span class="line">    `UTMCampaignHash` UInt64,</span><br><span class="line">    `UTMContentHash` UInt64,</span><br><span class="line">    `UTMTermHash` UInt64,</span><br><span class="line">    `FromHash` UInt64,</span><br><span class="line">    `WebVisorEnabled` UInt8,</span><br><span class="line">    `WebVisorActivity` UInt32,</span><br><span class="line">    `ParsedParams` Nested(</span><br><span class="line">        Key1 String,</span><br><span class="line">        Key2 String,</span><br><span class="line">        Key3 String,</span><br><span class="line">        Key4 String,</span><br><span class="line">        Key5 String,</span><br><span class="line">        ValueDouble Float64),</span><br><span class="line">    `Market` Nested(</span><br><span class="line">        Type UInt8,</span><br><span class="line">        GoalID UInt32,</span><br><span class="line">        OrderID String,</span><br><span class="line">        OrderPrice Int64,</span><br><span class="line">        PP UInt32,</span><br><span class="line">        DirectPlaceID UInt32,</span><br><span class="line">        DirectOrderID UInt32,</span><br><span class="line">        DirectBannerID UInt32,</span><br><span class="line">        GoodID String,</span><br><span class="line">        GoodName String,</span><br><span class="line">        GoodQuantity Int32,</span><br><span class="line">        GoodPrice Int64),</span><br><span class="line">    `IslandID` FixedString(<span class="number">16</span>)</span><br><span class="line">)</span><br><span class="line">ENGINE <span class="operator">=</span> CollapsingMergeTree(Sign)</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> toYYYYMM(StartDate)</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> (CounterID, StartDate, intHash32(UserID), VisitID)</span><br><span class="line">SAMPLE <span class="keyword">BY</span> intHash32(UserID)</span><br></pre></td></tr></table></figure>    </div></div><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸¤å¼ è¡¨åˆ†åˆ«ä½¿ç”¨äº†ä¸åŒçš„è¡¨å¼•æ“ï¼Œå…¶ä¸­ <code>hits_v1</code>ä½¿ç”¨ <a class="link"   href="https://clickhouse.tech/docs/zh/engines/table-engines/mergetree-family/mergetree/" >MergeTreeå¼•æ“<i class="fas fa-external-link-alt"></i></a>ï¼Œè€Œ<code>visits_v1</code>ä½¿ç”¨ <a class="link"   href="https://clickhouse.tech/docs/zh/engines/table-engines/mergetree-family/collapsingmergetree/" >Collapsing<i class="fas fa-external-link-alt"></i></a>å¼•æ“</p><p>å¯¹äºæˆ‘ä»¬éœ€è¦ä¸åŒåŠŸèƒ½çš„è¡¨æˆ–è€…ä¸åŒä½¿ç”¨é€”å¾„çš„è¡¨Clickhouseå…·æœ‰ä¸åŒçš„è¡¨å¼•æ“æ¥åº”å¯¹ï¼Œ<a class="link"   href="https://developer.aliyun.com/article/762461" >è¡¨å¼•æ“æ–‡æ¡£<i class="fas fa-external-link-alt"></i></a> <a class="link"   href="https://clickhouse.tech/docs/zh/engines/table-engines/mergetree-family/mergetree/" >è¡¨å¼•æ“å®˜æ–¹æ–‡æ¡£<i class="fas fa-external-link-alt"></i></a></p><p><code>MergeTree</code> ç³»åˆ—çš„å¼•æ“è¢«è®¾è®¡ç”¨äºæ’å…¥æå¤§é‡çš„æ•°æ®åˆ°ä¸€å¼ è¡¨å½“ä¸­ã€‚æ•°æ®å¯ä»¥ä»¥æ•°æ®ç‰‡æ®µçš„å½¢å¼ä¸€ä¸ªæ¥ç€ä¸€ä¸ªçš„å¿«é€Ÿå†™å…¥ï¼Œæ•°æ®ç‰‡æ®µåœ¨åå°æŒ‰ç…§ä¸€å®šçš„è§„åˆ™è¿›è¡Œåˆå¹¶ã€‚ç›¸æ¯”åœ¨æ’å…¥æ—¶ä¸æ–­ä¿®æ”¹ï¼ˆé‡å†™ï¼‰å·²å­˜å‚¨çš„æ•°æ®ï¼Œè¿™ç§ç­–ç•¥ä¼šé«˜æ•ˆå¾ˆå¤šã€‚æ‰€ä»¥ç›¸å½“äºè¿™ç§è¡¨ç»“æ„é€‚ç”¨äºæ’å…¥æ“ä½œè¾ƒå¤šï¼Œå¹¶ä¸”ä¸€æ¬¡æ’å…¥æ•°æ®è¾ƒå¤§çš„æƒ…å†µã€‚</p><p><code>CollapsingMergeTree</code> ä¼šå¼‚æ­¥çš„åˆ é™¤ï¼ˆæŠ˜å ï¼‰ <code>Sign</code> æœ‰ <code>1</code> å’Œ <code>-1</code> ä¸”å…¶ä½™æ‰€æœ‰å­—æ®µçš„å€¼éƒ½ç›¸ç­‰çš„æˆå¯¹çš„è¡Œã€‚æ²¡æœ‰æˆå¯¹çš„è¡Œä¼šè¢«ä¿ç•™ã€‚</p><p>æ¯ä¸ªå¼•æ“å®é™…ä¸Šå°±ä»£è¡¨ä¸€ç§éœ€æ±‚ï¼Œæ¯”å¦‚CollapsingMergeTreeå°±æ˜¯å»é‡ä½œç”¨ã€‚</p><h3 id="æ’å…¥æ•°æ®"><a href="#æ’å…¥æ•°æ®" class="headerlink" title="æ’å…¥æ•°æ®"></a>æ’å…¥æ•°æ®</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clickhouse-client --query &quot;INSERT INTO adtiming.hits_v1 FORMAT TSV&quot; --max_insert_block_size=100000 &lt; hits_v2.tsv</span><br><span class="line">clickhouse-client --query &quot;INSERT INTO adtiming.visits_v1 FORMAT TSV&quot; --max_insert_block_size=100000 &lt; visits_v2.tsv</span><br></pre></td></tr></table></figure><p>æ£€éªŒæ’å…¥æ˜¯å¦æˆåŠŸ(å¦‚æœç›´æ¥ç”¨å¤§æ•°æ®é‡æ–‡ä»¶å¯èƒ½ä¼šå¯¼è‡´æ’å…¥å¤±è´¥)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clickhouse-client --query &quot;SELECT COUNT(*) FROM adtiming.hits_v1&quot;</span><br><span class="line">clickhouse-client --query &quot;SELECT COUNT(*) FROM adtiming.visits_v1&quot;</span><br></pre></td></tr></table></figure><img src="/2021/08/26/Clickhouse-%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E8%B7%B5/jiancha.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><h2 id="æŸ¥è¯¢"><a href="#æŸ¥è¯¢" class="headerlink" title="æŸ¥è¯¢"></a>æŸ¥è¯¢</h2><p>ä¸‹é¢å¯¹æ•°æ®è¿›è¡Œç®€å•çš„æŸ¥è¯¢</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    StartURL <span class="keyword">AS</span> URL,</span><br><span class="line">    <span class="built_in">AVG</span>(Duration) <span class="keyword">AS</span> AvgDuration</span><br><span class="line"><span class="keyword">FROM</span> tutorial.visits_v1</span><br><span class="line"><span class="keyword">WHERE</span> StartDate <span class="keyword">BETWEEN</span> <span class="string">&#x27;2014-03-23&#x27;</span> <span class="keyword">AND</span> <span class="string">&#x27;2014-03-30&#x27;</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> URL</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> AvgDuration <span class="keyword">DESC</span></span><br><span class="line">LIMIT <span class="number">10</span></span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢ç»“æœå¦‚ä¸‹å›¾æ‰€ç¤º</p><img src="/2021/08/26/Clickhouse-%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E8%B7%B5/chaxunjieguo.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><h2 id="ç®€å•æ€è€ƒ"><a href="#ç®€å•æ€è€ƒ" class="headerlink" title="ç®€å•æ€è€ƒ"></a>ç®€å•æ€è€ƒ</h2><p>å®˜ç½‘å®ä¾‹è¿™ä¸ªsqlç¬¬ä¸€çœ¼çœ‹ä¸Šå»æ„Ÿè§‰æœ‰ç‚¹æ€ªï¼Œå› ä¸ºgroup byåé¢çš„å­—æ®µæ˜¯åˆ«åå­—æ®µURLï¼Œè¿™ä¸ªåœ¨Hiveæˆ–è€…Mysqlä¸­åº”è¯¥éƒ½æ˜¯ä¸å¯ä»¥çš„ï¼Œgroup byåé¢ç›´æ¥ä½¿ç”¨åˆ«åæ˜¯ä¼šæŠ¥é”™çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä»SQLçš„æ‰§è¡Œé¡ºåºå‡ºå‘æ¥çœ‹è¿™ä¸ªé—®é¢˜ã€‚</p><div class='spoiler collapsed'>    <div class='spoiler-title'>        æ‰§è¡Œé¡ºåº    </div>    <div class='spoiler-content'>        <p>Mysqlçš„å®è¡Œé¡ºåºï¼š</p><p>(1)    FROM <left_table></p><p>(2)    ON <join_condition></p><p>(3)    <join_type> JOIN <right_table></p><p>(4)    WHERE <where_condition></p><p>(5)    GROUP BY <group_by_list></p><p>(6)    HAVING <having_condition></p><p>(7)    SELECT</p><p>(8)    DISTINCT <select_list></p><p>(9)    ORDER BY <order_by_condition></p><p>(10)   LIMIT <limit_number> </p><p>Hiveæ‰§è¡Œé¡ºåº</p><p><code>from â€¦ on â€¦ join â€¦ where â€¦ group by â€¦ having â€¦</code></p><p><code>select â€¦ distinct â€¦ order by â€¦ limit</code></p><p>ä¸Šé¢å±•ç¤ºäº†Hiveä»¥åŠMysqlä¸­éƒ½æ˜¯group byåœ¨selectåé¢ï¼Œæ‰€ä»¥group byä¸èƒ½ä½¿ç”¨åˆ«åæ¥æ“ä½œï¼Œä½†æ˜¯order byæ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨åˆ«åçš„ï¼Œè¯´æ˜ClickHouseçš„SQLæ‰§è¡Œå’Œå¸¸è§çš„æ•°æ®åº“ä¸å¤ªä¸€æ ·ï¼Œå…·ä½“å·®åˆ«éƒ½æœ‰ä»€ä¹ˆæˆ‘ä»¬åé¢å­¦ä¹ åˆ°äº†å†æ¥æ€»ç»“ã€‚</p>    </div></div><h2 id="ClickHouseè¡¨å¼•æ“"><a href="#ClickHouseè¡¨å¼•æ“" class="headerlink" title="ClickHouseè¡¨å¼•æ“"></a>ClickHouseè¡¨å¼•æ“</h2><p>é¦–å…ˆæˆ‘ä»¬äº†è§£åˆ°ClickHouseçš„æ ¸å¿ƒå¼•æ“æ˜¯MergeTreeç³»åˆ—å¼•æ“ï¼Œå› ä¸ºMTç³»åˆ—å¼•æ“æ”¯æŒäº†åƒæ•°æ®æŒ‰ç…§ä¸»é”®æ’åºï¼ŒæŒ‡å®šåˆ†åŒºé”®å®ç°åˆ†åŒºï¼Œæ•°æ®å‰¯æœ¬ï¼Œæ•°æ®é‡‡æ ·ç­‰åŠŸèƒ½ï¼Œè¿™æ˜¯å…¶ä»–åƒLogï¼ŒIntegrationå¼•æ“æ‰€ä¸å…·å¤‡çš„åŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆå­¦ä¹ MergeTreeç³»åˆ—å¼•æ“ï¼Œä¹Ÿæ˜¯æœ€éš¾çš„ã€‚</p><p>MergeTreeç³»åˆ—å¼•æ“ç§ç±»ç¹å¤šï¼Œæœ‰ä»¥ä¸‹MergeTreeã€ReplacingMergeTreeã€SummingMergeTreeã€AggregatingMergeTreeã€CollapsingMergeTreeã€VersionedCollapsingMergeTreeã€GraphiteMergeTree ç­‰ 7 ç§ä¸åŒç±»å‹çš„ MergeTree å¼•æ“ï¼Œä»¥åŠå…¶å¯¹åº”æ”¯æŒå‰¯æœ¬çš„Replicated*ç³»åˆ—å¼•æ“</p><img src="/2021/08/26/Clickhouse-%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E8%B7%B5/clickhouse_yinqing.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><p>ä¸‹é¢æˆ‘ä»¬ä»‹ç»æ¯ä¸€ç§å¼•æ“çš„ä¸šåŠ¡åœºæ™¯</p><p><strong>ReplacingMergeTree</strong>ï¼š åœ¨åå°æ•°æ®åˆå¹¶æœŸé—´ï¼Œå¯¹åŒä¸€ä¸ªåˆ†åŒºå†…å…·æœ‰ç›¸åŒ <code>æ’åºé”®</code> çš„æ•°æ®è¿›è¡Œå»é‡æ“ä½œï¼Œ<code>ReplacingMergeTree</code> é€‚ç”¨äºåœ¨åå°æ¸…é™¤é‡å¤çš„æ•°æ®ä»¥èŠ‚çœç©ºé—´ï¼Œä½†æ˜¯å®ƒåªèƒ½ä¿è¯åŒä¸€ä¸ªåˆ†åŒºå†…æ²¡æœ‰é‡å¤çš„æ•°æ®å‡ºç°</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db.]table_name [<span class="keyword">ON</span> CLUSTER cluster]</span><br><span class="line">(</span><br><span class="line">    name1 [type1] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr1],</span><br><span class="line">    name2 [type2] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr2],</span><br><span class="line">    ...</span><br><span class="line">) ENGINE <span class="operator">=</span> ReplacingMergeTree([ver])</span><br><span class="line">[<span class="keyword">PARTITION</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[<span class="keyword">ORDER</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[SAMPLE <span class="keyword">BY</span> expr]</span><br><span class="line">[SETTINGS name<span class="operator">=</span><span class="keyword">value</span>, ...]</span><br></pre></td></tr></table></figure><p>ENGINE = ReplacingMergeTree([ver])ï¼Œå…¶ä¸­verä¸ºé€‰å¡«å‚æ•°ï¼Œå®ƒéœ€è¦æŒ‡å®šä¸€ä¸ªUInt8/UInt16ã€Dateæˆ–DateTimeç±»å‹çš„å­—æ®µï¼Œå®ƒå†³å®šäº†æ•°æ®å»é‡æ—¶æ‰€ç”¨çš„ç®—æ³•ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®è¯¥å‚æ•°ï¼Œåˆå¹¶æ—¶ä¿ç•™åˆ†ç»„å†…çš„æœ€åä¸€æ¡æ•°æ®ï¼›å¦‚æœæŒ‡å®šäº†è¯¥å‚æ•°ï¼Œåˆ™ä¿ç•™verå­—æ®µå–å€¼æœ€å¤§çš„é‚£ä¸€è¡Œã€‚</p><p><strong>SummingMergeTree</strong>ï¼š å½“åˆå¹¶æ•°æ®æ—¶ï¼Œä¼šæŠŠåŒä¸€ä¸ªåˆ†åŒºå†…çš„å…·æœ‰ç›¸åŒä¸»é”®çš„è®°å½•åˆå¹¶ä¸ºä¸€æ¡è®°å½•ã€‚æ ¹æ®èšåˆå­—æ®µè®¾ç½®ï¼Œè¯¥å­—æ®µçš„å€¼ä¸ºèšåˆåçš„æ±‡æ€»å€¼ï¼Œéèšåˆå­—æ®µä½¿ç”¨ç¬¬ä¸€æ¡è®°å½•çš„å€¼ï¼Œèšåˆå­—æ®µç±»å‹å¿…é¡»ä¸ºæ•°å€¼ç±»å‹ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šèšåˆå­—æ®µï¼Œåˆ™ä¼šæŒ‰ç…§<code>éä¸»é”®çš„æ•°å€¼ç±»å‹å­—æ®µ</code>è¿›è¡Œèšåˆ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db.]table_name [<span class="keyword">ON</span> CLUSTER cluster]</span><br><span class="line">(</span><br><span class="line">    name1 [type1] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr1],</span><br><span class="line">    name2 [type2] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr2],</span><br><span class="line">    ...</span><br><span class="line">) ENGINE <span class="operator">=</span> SummingMergeTree([columns])</span><br><span class="line">[<span class="keyword">PARTITION</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[<span class="keyword">ORDER</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[SAMPLE <span class="keyword">BY</span> expr]</span><br><span class="line">[SETTINGS name<span class="operator">=</span><span class="keyword">value</span>, ...]</span><br></pre></td></tr></table></figure><p>SummingMergeTreeè¡¨å¼•æ“ä¾æ®ORDER BYæŒ‡å®šçš„å­—æ®µè¿›è¡Œèšåˆï¼ŒPRIMARY KEYæŒ‡å®šä¸»é”®ï¼Œä½†æ˜¯ORDER BYå¯ä»¥æŒ‡ä»£ä¸»é”®ï¼Œä¸€èˆ¬åªå£°æ˜ORDER BYå³å¯ï¼Œè¡¨æ•°æ®ä¼šæŒ‰ç…§orderbyçš„ç»´åº¦è¿›è¡Œæ’åºï¼Œè€Œç´¢å¼•æ•°æ®ä¼šæŒ‰ç…§ä¸»é”®è¿›è¡Œæ’åºç”Ÿæˆï¼Œç´¢å¼•çš„é¡ºåºå¿…é¡»å’Œè¡¨æ•°æ®å¯¹åº”ä¸Šï¼Œé‚£ä¹ˆå«ä¹‰å°±æ˜¯order byçš„ç»´åº¦ä¸­ä¸»é”®å¿…é¡»æ˜¯æœ€å·¦å‰ç¼€ï¼Œä¸‹é¢ä¸¾ä¸€ä¸ªä¾‹å­ã€‚</p><p>å‡è®¾æˆ‘ä»¬æœ‰col1,col2,col3ä¸‰åˆ—ï¼Œä¸šåŠ¡ä¸Šæˆ‘ä»¬åªéœ€è¦å¯¹col1è¿›è¡ŒæŸ¥è¯¢è¿‡æ»¤ï¼Œå°±æ˜¯æˆ‘ä»¬åªéœ€è¦col1å½“åšä¸»é”®ï¼Œç„¶åæ ¹æ®col1æ•°æ®ä»¥åŠindex_granularityï¼ˆç´¢å¼•é—´éš”ï¼‰å‚æ•°ç”Ÿæˆæˆ‘ä»¬çš„ç´¢å¼•æ–‡ä»¶ï¼Œä¸ºäº†ä¿è¯æ•°æ®ä¹Ÿæ˜¯ç´¢å¼•çš„é¡ºåºï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å†™order by(col1,col2).</p><p>è¿™æ ·å¸¦æ¥çš„å¥½å¤„è¿˜æœ‰å°±æ˜¯ä¸»é”®å’Œç»´åº¦åˆ†å¼€ï¼Œæˆ‘ä»¬ä»¥åå¯ä»¥æ ¹æ®ä¸šåŠ¡æƒ…å†µä¿®æ”¹ç»´åº¦</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> test_summing MODIFY <span class="keyword">ORDER</span> <span class="keyword">BY</span> (col1,col2,col3);</span><br></pre></td></tr></table></figure><p><strong>AggregatingMergeTree</strong>ï¼š åœ¨åŒä¸€æ•°æ®åˆ†åŒºä¸‹ï¼Œå¯ä»¥å°†å…·æœ‰ç›¸åŒä¸»é”®çš„æ•°æ®è¿›è¡Œèšåˆã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db.]table_name [<span class="keyword">ON</span> CLUSTER cluster]</span><br><span class="line">(</span><br><span class="line">    name1 [type1] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr1],</span><br><span class="line">    name2 [type2] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr2],</span><br><span class="line">    ...</span><br><span class="line">) ENGINE <span class="operator">=</span> AggregatingMergeTree()</span><br><span class="line">[<span class="keyword">PARTITION</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[<span class="keyword">ORDER</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[SAMPLE <span class="keyword">BY</span> expr]</span><br><span class="line">[TTL expr]</span><br><span class="line">[SETTINGS name<span class="operator">=</span><span class="keyword">value</span>, ...]</span><br></pre></td></tr></table></figure><p>ä¸<code>SummingMergeTree</code>çš„åŒºåˆ«åœ¨äºï¼š<code>SummingMergeTree</code>å¯¹éä¸»é”®åˆ—è¿›è¡Œ<code>sum</code>èšåˆï¼Œè€Œ<code>AggregatingMergeTree</code>åˆ™å¯ä»¥æŒ‡å®šå„ç§èšåˆå‡½æ•°ã€‚å¯¹äº<code>AggregateFunction</code>ç±»å‹çš„åˆ—å­—æ®µï¼Œåœ¨è¿›è¡Œæ•°æ®çš„å†™å…¥å’ŒæŸ¥è¯¢æ—¶ä¸å…¶ä»–çš„è¡¨å¼•æ“æœ‰å¾ˆå¤§åŒºåˆ«ï¼Œåœ¨å†™å…¥æ•°æ®æ—¶ï¼Œéœ€ä½¿ç”¨å¸¦æœ‰ -State- èšåˆå‡½æ•°çš„ INSERT SELECTè¯­å¥ï¼›è€Œåœ¨æŸ¥è¯¢æ•°æ®æ—¶ï¼Œåˆ™éœ€è¦è°ƒç”¨ç›¸åº”çš„-Mergeå‡½æ•°ã€‚</p><p>ä¸€èˆ¬AggregatingMergeTreeéƒ½æ˜¯éœ€è¦å’Œæ™®é€šçš„MergeTreeè¿›è¡Œåˆç”¨ï¼ŒMergeTreeä½œä¸ºåº•è¡¨ï¼Œé˜²æ­¢å› ä¸ºèšåˆå‡½æ•°é”™è¯¯å¯¼è‡´æ•°æ®ä¸¢å¤±ï¼Œè€ŒAggregatingMergeTreeä½œä¸º<code>ç‰©åŒ–è§†å›¾</code>ï¼Œç›¸å½“äºåœ¨åº•è¡¨ä¸Šè¿›è¡ŒèšåˆæŸ¥è¯¢</p><p><strong>CollapsingMergeTree</strong>ï¼š åœ¨åŒä¸€æ•°æ®åˆ†åŒºä¸‹ï¼Œå¯¹å…·æœ‰ç›¸åŒä¸»é”®çš„æ•°æ®è¿›è¡ŒæŠ˜å åˆå¹¶ã€‚</p><p>å»ºè¡¨è¯­æ³•ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db.]table_name [<span class="keyword">ON</span> CLUSTER cluster]</span><br><span class="line">(</span><br><span class="line">    name1 [type1] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr1],</span><br><span class="line">    name2 [type2] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr2],</span><br><span class="line">    ...</span><br><span class="line">) ENGINE <span class="operator">=</span> VersionedCollapsingMergeTree(sign, version)</span><br><span class="line">[<span class="keyword">PARTITION</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[<span class="keyword">ORDER</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[SAMPLE <span class="keyword">BY</span> expr]</span><br><span class="line">[SETTINGS name<span class="operator">=</span><span class="keyword">value</span>, ...]</span><br></pre></td></tr></table></figure><p>CollapsingMergeTreeåŒæ ·ä¹Ÿæ ¹æ®order byå­—æ®µè¿›è¡Œå”¯ä¸€æ€§åˆ¤å®šï¼Œå®é™…ä¸Šè¿™ç§å¼•æ“æ˜¯æ ¹æ®ä»¥èµ ä»£åˆ çš„æ€è·¯ï¼Œæ”¯æŒè¡Œçº§åˆ«ä¿®æ”¹å’Œåˆ é™¤ï¼Œé€šè¿‡å®šä¹‰ä¸€ä¸ªsignæ ‡è®°ä¸ºå­—æ®µï¼Œè®°å½•æ•°æ®è¡ŒçŠ¶æ€ï¼Œå¦‚æœsignæ ‡è®°ä¸º1ï¼Œåˆ™è¡¨ç¤ºè¿™æ˜¯ä¸€è¡Œæœ‰æ•ˆæ•°æ®ï¼Œå¦‚æœsignä¸º-1è¡¨ç¤ºè¿™è¡Œæ•°æ®éœ€è¦è¢«åˆ é™¤ï¼Œå½“åˆ†åŒºåˆå¹¶çš„æ—¶å€™ï¼ŒåŒä¸€ä¸ªåˆ†åŒºå†…signæ ‡è®°ä¸º1å’Œ-1çš„ä¸€ç»„æ•°æ®ä¼šè¢«æŠµæ¶ˆåˆ é™¤æ‰ã€‚</p><p>åˆ†åŒºæ•°æ®åˆå¹¶æŠ˜å ä¸æ˜¯å®æ—¶æ“ä½œï¼Œéœ€è¦åœ¨åå°å®è¡ŒCompactionæ“ä½œï¼Œç”¨æˆ·å¯ä»¥è¿›è¡Œæ‰‹åŠ¨æ“ä½œï¼Œä½†æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¸é€‚åˆä½¿ç”¨æ•ˆç‡å¾ˆä½ï¼Œä¸€èˆ¬å»ºè®®group byå®Œæ¯•ä¹‹å’Œè¿›è¡Œhaving countã€‚eg:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> emp_id,name,<span class="built_in">sum</span>(salary <span class="operator">*</span> sign)<span class="keyword">FROM</span> emp_collapsingmergetree <span class="keyword">GROUP</span> <span class="keyword">BY</span> emp_id, name <span class="keyword">HAVING</span> <span class="built_in">sum</span>(sign) <span class="operator">&gt;</span> <span class="number">0</span>;</span><br><span class="line">â”Œâ”€emp_idâ”€â”¬â”€nameâ”€â”¬â”€<span class="built_in">sum</span>(multiply(salary, sign))â”€â”</span><br><span class="line">â”‚      <span class="number">1</span> â”‚ tom  â”‚                    <span class="number">30000.00</span> â”‚</span><br><span class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æˆ‘ä»¬çŸ¥é“äº†CollapsingMergeTreeçš„åˆå¹¶åŸç†ï¼Œä¸éš¾æƒ³è±¡ï¼Œè¿™ç§åˆå¹¶å¯¹å†™å…¥é¡ºåºæœ‰ç€ä¸¥æ ¼è¦æ±‚ï¼Œå¦åˆ™å°±ä¼šå¯¼è‡´æ•°æ®æ— æ³•æ­£å¸¸æŠ˜å ï¼Œæ¯”å¦‚æˆ‘ä»¬å…ˆå†™å…¥çš„æ˜¯sign=-1çš„æ•°æ®ï¼Œç„¶åå†å†™å…¥sign=1çš„æ•°æ®ï¼Œè¿™æ—¶å€™æˆ‘ä»¬åˆå¹¶åˆ†åŒºä¹‹å’Œå†è¿›è¡Œæ’æŸ¥ä¾æ—§æ˜¯ä¼šå‡ºç°ä¸¤æ¡æ•°æ®ã€‚</p><p>æ‰€ä»¥è¿™ç§è¡¨ç»“æ„åªé€‚åˆå•çº¿ç¨‹å†™å…¥ï¼Œå¯ä»¥å¾ˆå¥½åœ°æ§åˆ¶é¡ºåºå†™å…¥ï¼Œä½†æ˜¯å¦‚æœæ˜¯å¤šçº¿ç¨‹çš„çŠ¶æ€å°±ä¸èƒ½å¾ˆå¥½åœ°æ§åˆ¶æ•°æ®å†™å…¥é¡ºåºäº†ï¼Œè¿™æ—¶å€™å°±éœ€è¦å¦ä¸€ç§è¡¨ç»“æ„äº†ï¼Œå°±æ˜¯ä¸‹é¢æˆ‘ä»¬è¦æåˆ°çš„VersionedCollapsingMergeTree</p><p><strong>VersionedCollapsingMergeTree</strong>ï¼š</p><p>åŸºäº CollapsingMergeTree å¼•æ“ï¼Œå¢æ·»äº†æ•°æ®ç‰ˆæœ¬ä¿¡æ¯å­—æ®µ(version)é…ç½®é€‰é¡¹ã€‚åœ¨æ•°æ®ä¾æ® ORDER BY è®¾ç½®å¯¹æ•°æ®è¿›è¡Œæ’åºçš„åŸºç¡€ä¸Šï¼Œå¦‚æœæ•°æ®çš„ç‰ˆæœ¬ä¿¡æ¯åˆ—ä¸åœ¨æ’åºå­—æ®µä¸­ï¼Œé‚£ä¹ˆç‰ˆæœ¬ä¿¡æ¯ä¼šè¢«éšå¼çš„ä½œä¸º ORDER BY çš„æœ€åä¸€åˆ—ä»è€Œå½±å“æ•°æ®æ’åºã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> [IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] [db.]table_name [<span class="keyword">ON</span> CLUSTER cluster]</span><br><span class="line">(</span><br><span class="line">    name1 [type1] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr1],</span><br><span class="line">    name2 [type2] [<span class="keyword">DEFAULT</span><span class="operator">|</span>MATERIALIZED<span class="operator">|</span>ALIAS expr2],</span><br><span class="line">    ...</span><br><span class="line">) ENGINE <span class="operator">=</span> VersionedCollapsingMergeTree(sign, version)</span><br><span class="line">[<span class="keyword">PARTITION</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[<span class="keyword">ORDER</span> <span class="keyword">BY</span> expr]</span><br><span class="line">[SAMPLE <span class="keyword">BY</span> expr]</span><br><span class="line">[SETTINGS name<span class="operator">=</span><span class="keyword">value</span>, ...]</span><br></pre></td></tr></table></figure><p>versionå­—æ®µä¼šè‡ªåŠ¨çš„æ·»åŠ åˆ°order byæœ«å°¾ï¼Œæˆ‘ä»¬åœ¨æ’å…¥æ•°æ®çš„ä¹‹å’Œåªè¦ä¿è¯åŒä¸€æ¡æ•°æ®çš„versionå¤§å°ï¼Œå°±ç›¸å½“äºå¯ä»¥ä¿è¯å®ƒçš„é¡ºåºå…³ç³»ã€‚</p><p><strong>GraphiteMergeTree</strong>ï¼š ç”¨æ¥å­˜å‚¨æ—¶åºæ•°æ®åº“ Graphites çš„æ•°æ®ã€‚</p><p>ClickHouseè¡¨å¼•æ“ç§ç±»ç¹å¤šï¼Œå…¶ä¸­æ¯ä¸€ç§é€‚åˆçš„ä¸šåŠ¡åœºæ™¯éƒ½ä¸ç›¸åŒï¼Œè¯¦ç»†å¯ä»¥å‚è€ƒ<a class="link"   href="https://clickhouse.tech/docs/zh/engines/table-engines/mergetree-family/collapsingmergetree/" >å®˜æ–¹æ–‡æ¡£<i class="fas fa-external-link-alt"></i></a> æˆ–è€…ä¸€äº›<a class="link"   href="https://developer.aliyun.com/article/762461" >ä¸‰æ–¹æ–‡æ¡£<i class="fas fa-external-link-alt"></i></a>ï¼Œ</p><img src="/2021/08/26/Clickhouse-%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E8%B7%B5/yinqing.png" class="" title="ä¸­äºŒæ˜¯æœ€åçš„çƒ­è¡€"><h2 id="æ­å»ºClickHouseé›†ç¾¤"><a href="#æ­å»ºClickHouseé›†ç¾¤" class="headerlink" title="æ­å»ºClickHouseé›†ç¾¤"></a>æ­å»ºClickHouseé›†ç¾¤</h2><p>æ­å»ºClickHouseéœ€è¦ä¾èµ–Zookeeperé›†ç¾¤ï¼Œè¿™é‡Œæˆ‘ä»¬åªåœ¨ä¸€å°æœºå™¨ä¸Šæ­å»ºZookeeperï¼Œç»™å‡ºZookeeperï¼ŒClickHouseï¼ŒKafkaç‰ˆæœ¬ä½œå‚è€ƒ</p><table><thead><tr><th>Zookeeper</th><th>ClickHouse</th></tr></thead><tbody><tr><td>zookeeper-3.4.10</td><td>21.8.4.51(21.8.4.51)</td></tr></tbody></table><p>å¯åŠ¨Zookeeperå¹¶æŸ¥çœ‹çŠ¶æ€</p><img src="/2021/08/26/Clickhouse-%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E8%B7%B5/zookeeper.png" class=""><p>æ¥ä¸‹æ¥éœ€è¦åœ¨ClickHouseä¸­é…ç½®é›†ç¾¤ä¿¡æ¯ï¼Œåœ¨é…ç½®ä¹‹å‰æˆ‘ä»¬éœ€è¦æ˜ç™½ä»¥ä¸‹å‡ ä¸ªå…³é”®ä¿¡æ¯</p><p>1.ä¸»è¦è¯»å–çš„é…ç½®æ–‡ä»¶æ˜¯/etc/clickhouse-server/config.xml</p><p>2.ClickHouseä¼šå°†/etc/clickhouse-server/conf.d/metrika.xmlé…ç½®æ–‡ä»¶å’Œä¸Šé¢æåˆ°çš„é…ç½®æ–‡ä»¶åˆå¹¶ï¼Œä½†æ˜¯ä¸ºäº†ä¿é™©ï¼Œå»ºè®®è¿˜æ˜¯æ‰§è¡Œç¬¬äºŒæ¡</p><p>3.é€šç”¨çš„é…ç½®ä¿¡æ¯å¯ä»¥å†™åˆ°metrika.xmlé…ç½®æ–‡ä»¶ä¸­ï¼Œå¦‚æœæ²¡æœ‰çš„è¯éœ€è¦åˆ›å»ºä¸€ä¸ªï¼Œç„¶ååœ¨config.xmlä¸­å¼•å…¥</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--å¼•å…¥æ–¹æ³•--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">include_from</span>&gt;</span>/etc/clickhouse-server/conf.d/metrika.xml<span class="tag">&lt;/<span class="name">include_from</span>&gt;</span></span><br></pre></td></tr></table></figure><p>4.å¦‚æœä¸Šé¢çš„æ–¹æ³•æ²¡æœ‰ç”Ÿæ•ˆï¼Œç›´æ¥ä¿®æ”¹config.xmlæ–‡ä»¶</p><p>5.è¦æ¸…æ¥šä½ åœ¨ä¿®æ”¹é…ç½®æ–‡ä»¶çš„å“ªäº›åœ°æ–¹ï¼Œæˆ‘ä»¬ä¸ç®¡æ˜¯ç›´æ¥ä¿®æ”¹config.xmlè¿˜æ˜¯å†™ä¸€ä¸ªmetrika.xmlæ–‡ä»¶éƒ½æ˜¯ä¸ºäº†ä¿®æ”¹<remote_servers>,<zookeeper>ç­‰å‡ ä¸ªå…³é”®ä¿¡æ¯ï¼Œè¦ç¡®ä¿æˆ‘ä»¬çš„ä¿®æ”¹æˆåŠŸç”Ÿæ•ˆ</p><p>äº†è§£ä¸Šé¢å‡ ç‚¹ä¹‹å’Œæˆ‘ä»¬å¼€å§‹é…ç½®ClickHouseé›†ç¾¤ï¼š</p><ul><li><p>ä¿®æ”¹/etc/clickhouse-server/config.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- å¦‚æœç¦ç”¨äº†ipv6ï¼Œä½¿ç”¨ä¸‹é¢é…ç½® --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">listen_host</span>&gt;</span>0.0.0.0<span class="tag">&lt;/<span class="name">listen_host</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- å¦‚æœæ²¡æœ‰ç¦ç”¨ipv6ï¼Œä½¿ç”¨ä¸‹é¢é…ç½®ï¼Œæˆ‘ä½¿ç”¨çš„ä¸‹é¢çš„é…ç½® --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">listen_host</span>&gt;</span>::<span class="tag">&lt;/<span class="name">listen_host</span>&gt;</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªé…ç½®æ˜¯ä¸ºäº†æˆ‘ä»¬èƒ½æ­£å¸¸çš„ç™»å½•clickhouse-clientï¼ŒæœåŠ¡å™¨ä½¿ç”¨äº†ipv6ä½†æ˜¯æˆ‘ä¸å°å¿ƒç”¨äº†ä¸Šé¢çš„<listen_host>ï¼Œç™»å½•çš„æ—¶å€™æŠ¥é”™ 9000 connection refusedï¼Œæœ€ç»ˆå®šä½åˆ°äº†è¿™é‡Œã€‚</p></li><li><p>åˆ›å»º/etc/clickhouse-server/conf.d/metrika.xmlæ–‡ä»¶</p><p>æ ¹æ®é›†ç¾¤ä¿¡æ¯ï¼Œå°†ä¸‹é¢çš„xmlæ”¹å†™æˆè‡ªå·±é›†ç¾¤ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼Œæ”¾åˆ°å¯¹åº”ç›®å½•ä¸‹ï¼Œéœ€è¦æ³¨æ„ä¸€ä¸‹å‡ ç‚¹ï¼š</p><p>ï¼ˆ1ï¼‰ä¸‹é¢xmlä¿¡æ¯ä¸­çš„é›†ç¾¤åç§°å«åšâ€˜doit_ch_cluster1â€™ï¼Œå¯ä»¥éšæ„ä¿®æ”¹ï¼Œä½†æ˜¯è¦è®°ä½åç§°</p><p>ï¼ˆ2ï¼‰<shard>ä»£è¡¨åˆ†ç‰‡ï¼Œ<replica>ä»£è¡¨å‰¯æœ¬ï¼Œä¸€ä¸ªåˆ†ç‰‡å¯èƒ½æœ‰å¤šä¸ªå‰¯æœ¬ï¼Œé›†ç¾¤è¡¨ä¹Ÿå¯ä»¥æœ‰å¤šä¸ªåˆ†ç‰‡</p><p>ï¼ˆ3ï¼‰ä¸‹é¢é…ç½®æ–‡ä»¶é›†ç¾¤ä¿¡æ¯æ˜¯<clickhouse_remote_servers>æ ‡ç­¾ï¼Œæ³¨æ„config.xmlä¸­çš„é›†ç¾¤ä¿¡æ¯å«åšä»€ä¹ˆï¼Œä¸€èˆ¬éœ€è¦åœ¨config.xmlä¸­è¿›è¡Œä¸€è¡Œé…ç½® <code>&lt;remote_servers incl=&quot;clickhouse_remote_servers&quot; /&gt;</code>ï¼Œæ„æ€ç›¸å½“äº<remote_servers>æ ‡ç­¾å†…å®¹å–è‡ª<clickhouse_remote_servers>ï¼Œå…¶ä»–æ ‡ç­¾ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œè™½ç„¶å¬èµ·æ¥å¤šæ­¤ä¸€ä¸¾ï¼Œä½†æ˜¯å¯ä»¥å°†é€šç”¨çš„é…ç½®ä¿¡æ¯æ‘˜å–å‡ºæ¥ï¼Œä¹‹å’Œç›´æ¥scpç»™å„ä¸ªæœåŠ¡å™¨å°±è¡Œï¼Œä½†æ˜¯æˆ‘ä¸¤å°æœºå™¨ä¸­çš„ä¸€å°è¿™æ ·é…ç½®ä¸€ç›´æ²¡æœ‰ç”Ÿæ•ˆã€‚ã€‚ã€‚æ²¡é”™ä¸¤å°ä¸­çš„ä¸€å°æ²¡æœ‰ç”Ÿæ•ˆï¼Œå¦ä¸€å°ç”Ÿæ•ˆäº†ï¼Œå°±å¾ˆæ— è¯­ï¼Œåªèƒ½å°†å…¶ä¸­çš„é…ç½®ç›´æ¥ä¿®æ”¹åˆ°config.xmlä¸­ï¼Œä¹Ÿç®—æ˜¯è§£å†³äº†</p><p>ï¼ˆ4ï¼‰macrosé…ç½®ï¼Œè¿™ä¸ªé…ç½®åˆ›å»ºæ•°æ®å‰¯æœ¬è¡¨çš„æ—¶å€™è·¯å¾„å¯ä»¥ç›´æ¥ä½¿ç”¨å®æ›¿æ¢æ›¿æ¢ï¼Œå› ä¸ºæˆ‘ä»¬åˆ›å»ºé›†ç¾¤è¡¨çš„æ—¶å€™éœ€è¦ä¿è¯ä¸åŒçš„è¡¨ä»¥åŠä¸åŒå‰¯æœ¬åœ¨Zookeeperä¸­çš„è·¯å¾„ä¸åŒï¼Œå…¶ä¸­<code>&lt;shard&gt;</code>æ ‡ç­¾ä»£è¡¨çš„æ˜¯æˆ‘ä»¬æƒ³è®©å“ªå‡ å°æœºå™¨ç»„æˆä¸€ä¸ªåˆ†ç‰‡é›†åˆï¼ŒåŒä¸€ä¸ªåˆ†ç‰‡çš„åˆ†ç‰‡åç§°æ˜¯ä¸€æ ·çš„æ¯”å¦‚éƒ½æ˜¯01ï¼Œæˆ–è€…02ï¼Œè€Œ<code>&lt;replica&gt;</code>æ ‡ç­¾ä»£è¡¨çš„æ˜¯æœ¬å°æœºå™¨çš„åˆ›å»ºçš„å‰¯æœ¬çš„åç§°æ ‡è¯†ï¼Œå‰¯æœ¬æ˜¯å³ä½¿æ˜¯åŒä¸€ä¸ªåˆ†ç‰‡çš„å‰¯æœ¬åç§°ä¹Ÿä¸èƒ½ä¸€æ ·ï¼Œæ‰€ä»¥è¿™ä¸ªå‰¯æœ¬åç§°ä¸€èˆ¬é‡‡ç”¨ä¸»æœºåæˆ–è€…ipï¼Œè¿™æ˜¯éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œè¿™å—ç†è§£èµ·æ¥éœ€è¦ç»“åˆå®˜æ–¹æ–‡æ¡£](<a class="link"   href="https://clickhouse.tech/docs/zh/engines/table-engines/mergetree-family/replication/" >https://clickhouse.tech/docs/zh/engines/table-engines/mergetree-family/replication/<i class="fas fa-external-link-alt"></i></a>)</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">yandex</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- /etc/clickhouse-server/config.xml ä¸­é…ç½®çš„remote_serversçš„inclå±æ€§å€¼ï¼Œ--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">clickhouse_remote_servers</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- é›†ç¾¤åç§°ï¼Œå¯ä»¥ä¿®æ”¹ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">doit_ch_cluster1</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- é…ç½®ä¸‰ä¸ªåˆ†ç‰‡ï¼Œæ¯ä¸ªåˆ†ç‰‡å¯¹åº”ä¸€å°æœºå™¨ï¼Œä¸ºæ¯ä¸ªåˆ†ç‰‡é…ç½®ä¸€ä¸ªå‰¯æœ¬ --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="name">internal_replication</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">host</span>&gt;</span>master<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="name">internal_replication</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">host</span>&gt;</span>slaver1<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">shard</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">internal_replication</span>&gt;</span>true<span class="tag">&lt;/<span class="name">internal_replication</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">replica</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">host</span>&gt;</span>slaver2<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">port</span>&gt;</span>9000<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">shard</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">doit_ch_cluster1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">clickhouse_remote_servers</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- zookeeperç›¸å…³é…ç½® --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- è¯¥æ ‡ç­¾ä¸config.xmlçš„&lt;zookeeper incl=&quot;zookeeper-servers&quot; optional=&quot;true&quot; /&gt; ä¿æŒä¸€è‡´ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">zookeeper-servers</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">index</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">host</span>&gt;</span>master<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">port</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">index</span>=<span class="string">&quot;2&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">host</span>&gt;</span>slaver1<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">port</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">node</span> <span class="attr">index</span>=<span class="string">&quot;3&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">host</span>&gt;</span>slaver2<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">port</span>&gt;</span>2181<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">node</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">zookeeper-servers</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- åˆ†ç‰‡å’Œå‰¯æœ¬æ ‡è¯†ï¼Œshardæ ‡ç­¾é…ç½®åˆ†ç‰‡ç¼–å·ï¼Œ&lt;replica&gt;é…ç½®åˆ†ç‰‡å‰¯æœ¬ä¸»æœºåï¼Œéœ€è¦ä¿®æ”¹å¯¹åº”ä¸»æœºä¸Šçš„é…ç½® --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">macros</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">replica</span>&gt;</span>doit01<span class="tag">&lt;/<span class="name">replica</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">macros</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">networks</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">ip</span>&gt;</span>::/0<span class="tag">&lt;/<span class="name">ip</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">networks</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">clickhouse_compression</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">case</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">min_part_size</span>&gt;</span>10000000000<span class="tag">&lt;/<span class="name">min_part_size</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">min_part_size_ratio</span>&gt;</span>0.01<span class="tag">&lt;/<span class="name">min_part_size_ratio</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">method</span>&gt;</span>lz4<span class="tag">&lt;/<span class="name">method</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">case</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">clickhouse_compression</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">yandex</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨ClickHouseé›†ç¾¤</p><p>æˆ‘ä»¬åœ¨ClickHouseæœºå™¨ä¸Šéƒ½é…ç½®å®Œæˆä¹‹åï¼Œç¡®ä¿æˆ‘ä»¬çš„Zookeeperæ˜¯å¼€å¯çŠ¶æ€ï¼Œç„¶åé‡å¯ClickHouseé›†ç¾¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart clickhouse-server</span><br></pre></td></tr></table></figure><p>ç¡®ä¿æ‰€æœ‰çš„ClickhouseçŠ¶æ€éƒ½æ­£å¸¸ï¼Œå¦‚æœå‡ºç°é—®é¢˜å°±å»æŸ¥çœ‹ä¸€ä¸‹/var/log/clickhouse/ä¸­çš„erræ—¥å¿—</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status clickhouse-server</span><br></pre></td></tr></table></figure><img src="/2021/08/26/Clickhouse-%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E8%B7%B5/clickhouse.png" class=""><p>ç¡®è®¤æ‰€æœ‰æ­£å¸¸ä¹‹åæˆ‘ä»¬ç™»å½•ä»»æ„ä¸€å°clickhouseå®¢æˆ·ç«¯ï¼ŒæŸ¥çœ‹clickhouseé›†ç¾¤ä»¥åŠZookeeperä¿¡æ¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œsystem.zookeeperè¡¨åªæœ‰åœ¨å…³äºZookeeperé…ç½®ç”Ÿæ•ˆä¹‹åæ‰ä¼šå‡ºç°</p><img src="/2021/08/26/Clickhouse-%E5%85%A5%E9%97%A8%E4%B8%8E%E5%AE%9E%E8%B7%B5/jiqunxinxi.png" class=""></li></ul><h2 id="åˆ›å»ºDistribute-Localè¡¨"><a href="#åˆ›å»ºDistribute-Localè¡¨" class="headerlink" title="åˆ›å»ºDistribute+Localè¡¨"></a>åˆ›å»ºDistribute+Localè¡¨</h2><p>Distributeæ˜¯Clickhouseæ¯”è¾ƒç‰¹æ®Šçš„ä¸€ç§è¡¨å¼•æ“ï¼Œæ˜¯ClickHouseåˆ†å¸ƒå¼è¡¨çš„ä»£è¨€è¯ï¼Œdistributeè¡¨å¼•æ“åˆ›å»ºçš„è¡¨ä¸å­˜å‚¨æ•°æ®ï¼Œå®ƒèµ·åˆ°ä¸€ä¸ªè·¯ç”±çš„ä½œç”¨ï¼Œå°†æ•°æ®è·¯ç”±åˆ°é›†ç¾¤æœºå™¨ä¸Šçš„æœ¬åœ°è¡¨ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Distributed(cluster_name, database_name, table_name[, sharding_key])</span><br></pre></td></tr></table></figure><p>cluster_nameï¼šé›†ç¾¤åç§°ï¼Œä¸é›†ç¾¤é…ç½®ä¸­çš„è‡ªå®šä¹‰åç§°ç›¸å¯¹åº”ã€‚<br>database_nameï¼šæ•°æ®åº“åç§°ã€‚<br>table_nameï¼šè¡¨åç§°ï¼Œéœ€è¦é›†ç¾¤ä¸­çš„æœºå™¨ä¸Šéƒ½å­˜åœ¨è¿™ä¸ªè¡¨<br>sharding_keyï¼šå¯é€‰çš„ï¼Œç”¨äºåˆ†ç‰‡çš„keyå€¼ï¼Œåœ¨æ•°æ®å†™å…¥çš„è¿‡ç¨‹ä¸­ï¼Œåˆ†å¸ƒå¼è¡¨ä¼šä¾æ®åˆ†ç‰‡keyçš„è§„åˆ™ï¼Œå°†æ•°æ®åˆ†å¸ƒåˆ°å„ä¸ªèŠ‚ç‚¹çš„æœ¬åœ°è¡¨ï¼Œè¿™ä¸ªå‚æ•°å¯é€‰</p><ul><li><p>å»ºç«‹distributeè¡¨</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> user_cluster <span class="keyword">ON</span> CLUSTER doit_ch_cluster1</span><br><span class="line">(</span><br><span class="line">    id Int32,</span><br><span class="line">    name String</span><br><span class="line">)ENGINE <span class="operator">=</span> Distributed(doit_ch_cluster1, <span class="keyword">default</span>, user_local,id);</span><br><span class="line"></span><br><span class="line"><span class="comment">--ä¸Šé¢å»ºè¡¨è¯­å¥ä»£è¡¨äº†æ•°æ®æ˜¯è¦åˆ†å‘åˆ°doit_ch_cluster1é›†ç¾¤ä¸­default.user_localè¡¨ï¼Œæ ¹æ®idå†³å®šåˆ†å‘åˆ°å“ªå°æœºå™¨ä¸Š</span></span><br></pre></td></tr></table></figure><p>è¿™é‡Œæˆ‘ä»¬ä¸ºäº†ç®€å•ï¼Œå°±åªè®¾è®¡ä¸¤ä¸ªè¡¨å­—æ®µï¼Œå…¶ä¸­idæ˜¯æˆ‘ä»¬ç”¨æ¥å°†æ•°æ®åˆ†åˆ°é›†ç¾¤æœºå™¨ä¸Šçš„sharding_keyï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨rand()å‡½æ•°è®©ckéšæœºçš„å†³å®šå°†æ•°æ®å‘é€åˆ°å“ªå°æœºå™¨</p></li><li><p>å»ºç«‹æœ¬åœ°è¡¨</p><p>å¾—ç›Šäºæˆ‘ä»¬çš„é›†ç¾¤é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>ON CLUSTER doit_ch_cluster1</code>è¯­æ³•è‡ªåŠ¨åœ¨é›†ç¾¤ä¸­å»ºè¡¨ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨æ­£å¸¸çš„æŸ¥è¯¢å¼•æ“MergeTree()</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> IF <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> user_local <span class="keyword">ON</span> CLUSTER doit_ch_cluster1</span><br><span class="line">(</span><br><span class="line">    `id` Int32,</span><br><span class="line">    `name` String</span><br><span class="line">)</span><br><span class="line">ENGINE <span class="operator">=</span> MergeTree()</span><br><span class="line"><span class="keyword">PARTITION</span> <span class="keyword">BY</span> id</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY id</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> id</span><br></pre></td></tr></table></figure></li></ul><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    
    <summary type="html">&lt;p&gt;ClickHouseæ˜¯ä¸€ä¸ªç”¨äºè”æœºåˆ†æ(OLAP)çš„åˆ—å¼æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ(DBMS)ã€‚&lt;/p&gt;</summary>
    
    
    
    
    <category term="ClickHouse" scheme="http://example.com/tags/ClickHouse/"/>
    
  </entry>
  
</feed>
